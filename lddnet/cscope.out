cscope 15 $HOME/qdev/CloudSrv/trunk/trunk/src/ldd/net -q 0000001333 0000298453
	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/address.cc

4 
	~<¬·/š‘.h
>

5 
	~<glog/loggšg.h
>

6 
	~"add»ss.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gAdd»ss
::
Add»ss
(
Famy
 
çmy
)

12 : 
çmy_
(
çmy
)

14 
CHECK
(
çmy
 =ğ
V4
 || famy =ğ
V6
);

15 
mem£t
(&
addr_
, 0, (addr_));

18 
	gAdd»ss
::
Add»ss
(cÚ¡ 
š_addr
& 
addr
)

19 : 
çmy_
(
V4
)

21 
addr_
.
v4
.
s_addr
 = 
addr
.s_addr;

24 
	gAdd»ss
::
Add»ss
(
ušt32_t
 
addr
)

25 : 
çmy_
(
V4
)

27 
addr_
.
v4
.
s_addr
 = 
htÚl
(
addr
);

30 
	gAdd»ss
::
Add»ss
(cÚ¡ 
š6_addr
& 
addr
)

31 : 
çmy_
(
V6
)

33 
memıy
(&
addr_
.
v6
, &
addr
, (
š6_addr
));

36 cÚ¡ 
	gš_addr
& 
	gAdd»ss
::
ToV4
() const {

37 
CHECK_EQ
(
çmy_
, 
V4
);

38  
	gaddr_
.
	gv4
;

41 cÚ¡ 
	gš6_addr
& 
	gAdd»ss
::
ToV6
() const {

42 
CHECK_EQ
(
çmy_
, 
V6
);

43  
	gaddr_
.
	gv6
;

46 
ušt32_t
 
	gAdd»ss
::
ToU32
() const {

47 
CHECK_EQ
(
çmy_
, 
V4
);

48  
Áohl
(
addr_
.
v4
.
s_addr
);

51 
Add»ss
 
	gAdd»ss
::
FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
s
, 
Famy
 
çmy
) {

52 
CHECK
(
çmy
 =ğ
V4
 || famy =ğ
V6
);

53 
Add»ss
 
	g‹mp
;

54 
š‘_±Ú
(
çmy
, 
s
.
c_¡r
(), &
‹mp
.
addr_
);

55  
	g‹mp
;

58 
Add»ss
 
	gAdd»ss
::
Any
(
Famy
 
çmy
) {

59  
Add»ss
(
çmy
);

62 
Add»ss
 
	gAdd»ss
::
Loİback
(
Famy
 
çmy
) {

63 ià(
çmy
 =ğ
V4
) {

64  
Add»ss
(0x7F000001);

65 } ià(
	gçmy
 =ğ
V6
) {

66 
Add»ss
 
tmp
(
V6
);

67 
	gtmp
.
	gaddr_
.
	gv6
.
	gs6_addr
[15] = 1;

68  
	gtmp
;

70 
LOG
(
FATAL
è<< "Inv®id famy " << 
	gçmy
;

74 
	g¡d
::
¡ršg
 
Add»ss
::
ToSŒšg
() const {

75 ià(
çmy
(è=ğ
V4
) {

76 
addr_¡r
[
INET_ADDRSTRLEN
];

77 cÚ¡ * 
	gaddr
 =

78 
š‘_Áİ
(
çmy
(), &
addr_
, 
addr_¡r
, 
INET_ADDRSTRLEN
);

79 ià(!
	gaddr
) {

80  
	g¡d
::
¡ršg
();

82  
	gaddr_¡r
;

84 
	gaddr_¡r
[
INET6_ADDRSTRLEN
];

85 cÚ¡ * 
	gaddr
 =

86 
š‘_Áİ
(
çmy
(), &
addr_
, 
addr_¡r
, 
INET6_ADDRSTRLEN
);

87 ià(!
	gaddr
) {

88  
	g¡d
::
¡ršg
();

90  
	gaddr_¡r
;

94 
boŞ
 
	gAdd»ss
::
IsCÏssA
() const {

95 
CHECK_EQ
(
çmy_
, 
V4
);

96  (
ToU32
() & 0x80000000) == 0;

99 
boŞ
 
	gAdd»ss
::
IsCÏssB
() const {

100 
CHECK_EQ
(
çmy_
, 
V4
);

101  (
ToU32
() & 0xC0000000) == 0x80000000;

103 
boŞ
 
	gAdd»ss
::
IsCÏssC
() const {

104 
CHECK_EQ
(
çmy_
, 
V4
);

105  (
ToU32
() & 0xE0000000) == 0xC0000000;

107 
boŞ
 
	gAdd»ss
::
IsMuÉiÿ¡
() const {

108 
CHECK_EQ
(
çmy_
, 
V4
);

109  (
ToU32
() & 0xF0000000) == 0xE0000000;

112 
boŞ
 
	gAdd»ss
::
IsUn¥ecif›d
() const {

113 ià(
çmy_
 =ğ
V4
) {

114  
addr_
.
v4
.
s_addr
 == 0;

116  ((
	gaddr_
.
	gv6
.
	gs6_addr
[0] =ğ0è&& (
addr_
.
v6
.
s6_addr
[1] == 0)

117 && (
addr_
.
v6
.
s6_addr
[2] == 0) && (addr_.v6.s6_addr[3] == 0)

118 && (
addr_
.
v6
.
s6_addr
[4] == 0) && (addr_.v6.s6_addr[5] == 0)

119 && (
addr_
.
v6
.
s6_addr
[6] == 0) && (addr_.v6.s6_addr[7] == 0)

120 && (
addr_
.
v6
.
s6_addr
[8] == 0) && (addr_.v6.s6_addr[9] == 0)

121 && (
addr_
.
v6
.
s6_addr
[10] == 0) && (addr_.v6.s6_addr[11] == 0)

122 && (
addr_
.
v6
.
s6_addr
[12] == 0) && (addr_.v6.s6_addr[13] == 0)

123 && (
addr_
.
v6
.
s6_addr
[14] == 0) && (addr_.v6.s6_addr[15] == 0));

127 
boŞ
 
	gAdd»ss
::
IsLoİback
() const {

128 ià(
çmy_
 =ğ
V4
) {

129  (
ToU32
() & 0xFF000000) == 0x7F000000;

131  ((
	gaddr_
.
	gv6
.
	gs6_addr
[0] =ğ0è&& (
addr_
.
v6
.
s6_addr
[1] == 0)

132 && (
addr_
.
v6
.
s6_addr
[2] == 0) && (addr_.v6.s6_addr[3] == 0)

133 && (
addr_
.
v6
.
s6_addr
[4] == 0) && (addr_.v6.s6_addr[5] == 0)

134 && (
addr_
.
v6
.
s6_addr
[6] == 0) && (addr_.v6.s6_addr[7] == 0)

135 && (
addr_
.
v6
.
s6_addr
[8] == 0) && (addr_.v6.s6_addr[9] == 0)

136 && (
addr_
.
v6
.
s6_addr
[10] == 0) && (addr_.v6.s6_addr[11] == 0)

137 && (
addr_
.
v6
.
s6_addr
[12] == 0) && (addr_.v6.s6_addr[13] == 0)

138 && (
addr_
.
v6
.
s6_addr
[14] == 0) && (addr_.v6.s6_addr[15] == 1));

142 
boŞ
 
	gAdd»ss
::
İ”©Ü
==(cÚ¡ 
Add»ss
& 
rhs
) const {

143 ià(
çmy_
 !ğ
rhs
.family_) {

144  
çl£
;

146 ià(
	gçmy_
 =ğ
V4
) {

147  (
memcmp
(&
addr_
, &
rhs
.addr_, ×ddr_.
v4
)) == 0);

149  (
memcmp
(&
addr_
, &
rhs
.addr_, ×ddr_.
v6
)) == 0);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/address.h

4 #iâdeà
LDD_NET_ADDRESS_H_


5 
	#LDD_NET_ADDRESS_H_


	)

7 
	~<Ãtš‘/š.h
>

8 
	~<¡ršg
>

9 
	~<boo¡/İ”©Üs.hµ
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
şass
 
	gAdd»ss
 : 
boo¡
::
equ®™y_com·¿bË
<
Add»ss
> {

15 
public
:

16 
	eFamy
 {

17 
V4
 = 
AF_INET
,

18 
	gV6
 = 
AF_INET6
,

21 
Add»ss
(
Famy
 
çmy
 = 
V4
);

22 
Add»ss
(cÚ¡ 
š_addr
& 
addr
);

23 
Add»ss
(cÚ¡ 
š6_addr
& 
addr
);

24 
Add»ss
(
ušt32_t
 
addr
);

26 
Add»ss
 
FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
s
, 
Famy
 
çmy
 = 
V4
);

27 
Add»ss
 
Any
(
Famy
 
çmy
 = 
V4
);

28 
Add»ss
 
Loİback
(
Famy
 
çmy
 = 
V4
);

30 
Famy
 
çmy
(ècÚ¡ {  
	gçmy_
; }

31 
boŞ
 
IsUn¥ecif›d
() const;

32 
boŞ
 
IsLoİback
() const;

33 
boŞ
 
IsV4
(ècÚ¡ {  
	gçmy_
 =ğ
V4
; }

34 
boŞ
 
IsV6
(ècÚ¡ {  
	gçmy_
 =ğ
V6
; }

35 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

38 cÚ¡ 
	gš_addr
& 
ToV4
() const;

39 
ušt32_t
 
ToU32
() const;

40 
boŞ
 
IsCÏssA
() const;

41 
boŞ
 
IsCÏssB
() const;

42 
boŞ
 
IsCÏssC
() const;

43 
boŞ
 
IsMuÉiÿ¡
() const;

46 cÚ¡ 
	gš6_addr
& 
ToV6
() const;

48 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Add»ss
& 
rhs
) const;

49 
	g´iv©e
:

51 
š_addr
 
v4
;

52 
š6_addr
 
	gv6
;

53 } 
	gaddr_
;

54 
Famy
 
	gçmy_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/backtrace.cc

1 
	~<execšfo.h
>

2 
	~<¡dlib.h
>

3 
	~<glog/loggšg.h
>

4 
	~<o¡»am
>

6 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

9 
	#DUMP_STACK_DEPTH_MAX
 16

	)

12 
dump_Œaû
(cÚ¡ 
¡d
::
¡ršg
 &
func_Çme
)

14 *
¡ack_Œaû
[
DUMP_STACK_DEPTH_MAX
] = {0};

15 **
	g¡ack_¡ršgs
 = 
NULL
;

16 
	g¡ack_d•th
 = 0;

17 
	gi
 = 0;

20 
	g¡ack_d•th
 = 
backŒaû
(
¡ack_Œaû
, 
DUMP_STACK_DEPTH_MAX
);

23 
	g¡ack_¡ršgs
 = (**)
backŒaû_symbŞs
(
¡ack_Œaû
, 
¡ack_d•th
);

24 ià(
	gNULL
 =ğ
¡ack_¡ršgs
) {

25 
LOG
(
ERROR
) << "Memory is‚otƒnough while dump Stack Trace, func‚ame: "

26 << 
func_Çme
;

31 
	g¡d
::
o¡ršg¡»am
 
os
;

32 
	gos
 << 
	gfunc_Çme
 << " backrace: \n";

33 
	gi
 = 0; i < 
	g¡ack_d•th
; ++i) {

34 
	gos
 << "\t[" << 
	gi
 << "] " << 
	g¡ack_¡ršgs
[
i
] << "\n";

37 
LOG
(
INFO
è<< 
	gos
.
¡r
();

40 
ä“
(
¡ack_¡ršgs
);

41 
	g¡ack_¡ršgs
 = 
NULL
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/backtrace.h

4 #iâdeà
__BACK_TRACE__


5 
	#__BACK_TRACE__


	)

7 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

9 
dump_Œaû
(cÚ¡ 
¡d
::
¡ršg
 &
func_Çme
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/buffer.cc

4 
	~<¡ršg.h
>

5 
	~<¡dlib.h
>

6 
	~<glog/loggšg.h
>

7 
	~"bufãr.h
"

8 
	~"backŒaû.h
"

9 
	~<o¡»am
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 #ifdeà
RES_COUNTER


15 
	gut
::
Atomic
<
ušt64_t
> 
Bufãr
::
Ãxt_id_
;

16 
	gut
::
Atomic
<
ušt64_t
> 
Bufãr
::
ä“_id_
;

19 
	gBufãr
::
Bufãr
()

20 : 
size_
(0)

22 #ifdeà
RES_COUNTER


23 
Ãxt_id_
++;

27 
	gBufãr
::
Bufãr
(
size_t
 
size
)

28 : 
d©a_
((*)
m®loc
(
size
), 
ä“
),

29 
size_
(
size
)

31 #ifdeà
RES_COUNTER


32 
	gÃxt_id_
++;

36 
	gBufãr
::
Bufãr
(cÚ¡ * 
d©a
, 
size_t
 
size
)

37 : 
d©a_
((*)
m®loc
(
size
), 
ä“
),

38 
size_
(
size
)

40 
memıy
(
d©a_
.
g‘
(), 
d©a
, 
size_
);

42 #ifdeà
RES_COUNTER


43 
	gÃxt_id_
++;

47 
	gBufãr
::
Bufãr
(cÚ¡ 
¡d
::
¡ršg
& 
s
)

48 : 
d©a_
((*)
m®loc
(
s
.
size
()), 
ä“
),

49 
size_
(
s
.
size
())

51 
memıy
(
d©a_
.
g‘
(), 
s
.
d©a
(), 
size_
);

53 #ifdeà
RES_COUNTER


54 
	gÃxt_id_
++;

60 
	gBufãr
::
Bufãr
(cÚ¡ Bufã¸&
bufãr
)

62 
d©a_
 = 
bufãr
.data_;

63 
	gsize_
 = 
bufãr
.
size_
;

65 #ifdeà
RES_COUNTER


66 
	gÃxt_id_
++;

79 
	gBufãr
::~
Bufãr
()

81 #ifdeà
RES_COUNTER


82 
ä“_id_
++;

86 
	gBufãr
::
Shršk
(
size_t
 
n
) {

87 
CHECK_LE
(
n
, 
size_
);

88 ià(
	gn
 < 
	gsize_
) {

89 * 
	gp
 = 
»®loc
(
d©a_
.
g‘
(), 
n
);

90 
	gsize_
 = 
n
;

91 
CHECK_EQ
(
p
, 
d©a_
.
g‘
());

95 
	gBufãr
::
ReSize
(
size_t
 
n
) {

96 
Shršk
(
n
);

99 
	gBufãr
::
Re£t
() {

100 
d©a_
.
»£t
();

101 
	gsize_
 = 0;

104 
	gBufãr
::
Re£t
(
size_t
 
Ën
) {

105 
d©a_
.
»£t
((*)
m®loc
(
Ën
), 
ä“
);

106 
	gsize_
 = 
Ën
;

109 
	gBufãr
::
Re£t
(cÚ¡ 
¡d
::
¡ršg
& 
s
) {

110 ià(!
s
.
em±y
()) {

111 
d©a_
.
»£t
((*)
m®loc
(
s
.
size
()));

112 
	gsize_
 = 
s
.
size
();

113 
memıy
(
d©a_
.
g‘
(), 
s
.
d©a
(), s.
size
());

115 
Re£t
();

119 
	g¡d
::
¡ršg
 
Bufãr
::
ToSŒšg
() const {

120  
¡d
::
¡ršg
(
d©a_
.
g‘
(), 
size_
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/buffer.h

1 #iâdeà
LDD_NET_BUFFER_H_


2 
	#LDD_NET_BUFFER_H_


	)

4 
	~<¡ršg
>

5 
	~<m­
>

6 
	~<boo¡/sh¬ed_±r.hµ
>

7 
	~<ldd/ut/©omic.h
>

9 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

11 şas 
	cBufãr
 {

12 
	gpublic
:

13 
Bufãr
();

14 
ex¶ic™
 
Bufãr
(
size_t
 
size
);

15 
ex¶ic™
 
Bufãr
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

16 
ex¶ic™
 
Bufãr
(cÚ¡ * 
p
, 
size_t
 
l
);

18 
Bufãr
(cÚ¡ Bufã¸&
bufãr
);

21 ~
Bufãr
();

23 
Re£t
(
size_t
 
size
);

24 
Re£t
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

25 
Re£t
();

27 
boŞ
 
IsEm±y
(ècÚ¡ {  
size
() == 0u; }

29 * 
d©a
(è{  
	gd©a_
.
g‘
(); }

30 cÚ¡ * 
d©a
(ècÚ¡ {  
	gd©a_
.
g‘
(); }

31 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

33 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

36 
Shršk
(
size_t
 
n
);

39 
ReSize
(
size_t
 
n
);

40 * 
±r
(è{  
	gd©a_
.
g‘
(); }

41 cÚ¡ * 
±r
(ècÚ¡ {  
	gd©a_
.
g‘
(); }

42 
size_t
 
Ën
(ècÚ¡ {  
	gsize_
; }

44 
	g´iv©e
:

45 
boo¡
::
sh¬ed_±r
<> 
d©a_
;

46 
size_t
 
	gsize_
;

49 #ifdeà
RES_COUNTER


50 
	g´iv©e
:

51 
ä›nd
 
şass
 
St
;

52 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

53 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

54 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

55 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

59 
	g¡d
::
	tm­
<
	tušt8_t
, 
	tBufãr
> 
	tBufãrM­
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/channel.cc

1 
	~<glog/loggšg.h
>

2 
	~<boo¡/bšd.hµ
>

3 
	~"ldd/Ãt/chªÃl.h
"

4 
	~"ldd/Ãt/outgošg_msg.h
"

5 
	~"ldd/Ãt/šcomšg_msg.h
"

6 
	~"š‹º®/chªÃl_im¶.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gChªÃl
::
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
S”v”
::
Im¶
* 
£rv”
)

12 : 
im¶_
(
Ãw
 
IncomšgChªÃl
(
this
, 
ev’t_loİ
, 
£rv”
))

16 
	gChªÃl
::
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
Cl›Á
::
Im¶
* 
ş›Á
,

17 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
)

18 : 
im¶_
(
Ãw
 
OutgošgChªÃl
(
this
, 
ev’t_loİ
, 
ş›Á
, 
ho¡
, 
pÜt
))

22 
	gChªÃl
::
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
Cl›Á
::
Im¶
* 
ş›Á
,

23 cÚ¡ 
Endpošt
& 
»mÙe
)

24 : 
im¶_
(
Ãw
 
OutgošgChªÃl
(
this
, 
ev’t_loİ
, 
ş›Á
, 
»mÙe
))

28 
	gChªÃl
::~
ChªÃl
() {

29 
d–‘e
 
im¶_
;

32 
Ev’tLoİ
 *
	gChªÃl
::
ev’t_loİ
() const {

33  
im¶_
->
ev’t_loİ
();

36 
	gChªÃl
::
S‹
 
ChªÃl
::
¡©e
() const {

37  
im¶_
->
¡©e
();

40 
	gChªÃl
::
Ty³
 
ChªÃl
::
ty³
() const {

41  
im¶_
->
ty³
();

44 
	g¡d
::
¡ršg
 
ChªÃl
::
Çme
() const {

45  
im¶_
->
Çme
();

48 cÚ¡ 
	gEndpošt
& 
	gChªÃl
::
³”_’dpošt
() const {

49  
im¶_
->
³”_’dpošt
();

52 cÚ¡ 
	gEndpošt
& 
	gChªÃl
::
£lf_’dpošt
() const {

53  
im¶_
->
£lf_’dpošt
();

56 
boŞ
 
	gChªÃl
::
Po¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
omsg
,

57 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
, 
boŞ
 
fÜû
) {

58 
CHECK_LT
(
omsg
->
id
(), 0);

59 
CHECK
(!
omsg
->
chªÃl
());

60 ià(
¡©e
(è=ğ
kClo£d
 || (¡©e(è=ğ
kCÚÃùšg
 && !
fÜû
)) {

61  
çl£
;

63 
ev’t_loİ
()->
QueueInLoİ
(

64 
boo¡
::
bšd
(&
ChªÃl
::
DoPo¡
, 
sh¬ed_äom_this
(),

65 
omsg
, 
timeout
));

66  
	gŒue
;

69 
	gChªÃl
::
DoPo¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
mes§ge
,

70 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

71 
im¶_
->
Po¡
(
mes§ge
, 
timeout
);

74 
	gChªÃl
::
Clo£
() {

75 
ev’t_loİ
()->
QueueInLoİ
(

76 
boo¡
::
bšd
(&
ChªÃl
::
DoClo£
, 
sh¬ed_äom_this
()));

79 
	gChªÃl
::
DoClo£
() {

80 
im¶_
->
Clo£
();

83 
	gChªÃl
::
£t_cÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
) {

84 
im¶_
->
£t_cÚ‹xt
(
cÚ‹xt
);

86 
	gChªÃl
::
sock‘
()

88  
im¶_
->
sock‘
();

92 cÚ¡ 
	gboo¡
::
ªy
& 
ChªÃl
::
cÚ‹xt
() const {

93  
im¶_
->
cÚ‹xt
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/channel.h

1 #iâdeà
LDD_NET_CHANNEL_H_


2 
	#LDD_NET_CHANNEL_H_


	)

4 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~<boo¡/ªy.hµ
>

9 
	~<ldd/ut/time_diff.h
>

10 
	~"ldd/Ãt/£rv”.h
"

11 
	~"ldd/Ãt/ş›Á.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

16 
şass
 
	gEv’tLoİ
;

17 
şass
 
	gOutgošgMsg
;

18 
şass
 
	gEndpošt
;

20 
şass
 
	gChªÃl
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
ChªÃl
>,

21 
´iv©e
 
	gboo¡
::
nÚcİyabË


23 
public
:

24 
şass
 
Im¶
;

25 
	eTy³
 {

26 
	gkIncomšg
,

27 
	gkOutgošg
,

29 
	eS‹
 {

30 
	gkClo£d
 = 0,

31 
	gkCÚÃùšg
 = 1,

32 
	gkCÚÃùed
 = 2,

34 
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
S”v”
::
Im¶
* 
£rv”
);

35 
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
Cl›Á
::
Im¶
* 
ş›Á
,

36 cÚ¡ 
¡d
::
¡ršg
&, 
ušt16_t
);

37 
ChªÃl
(
Ev’tLoİ
* 
ev’t_loİ
, 
Cl›Á
::
Im¶
* 
ş›Á
,

38 cÚ¡ 
Endpošt
&);

39 ~
ChªÃl
();

41 
	g¡d
::
¡ršg
 
Çme
() const;

42 
Ty³
 
ty³
() const;

43 
S‹
 
¡©e
() const;

44 
boŞ
 
IsCÚÃùed
(ècÚ¡ {  
¡©e
(è=ğ
kCÚÃùed
; }

45 
boŞ
 
IsCÚÃùšg
(ècÚ¡ {  
¡©e
(è=ğ
kCÚÃùšg
; }

46 
boŞ
 
IsClo£d
(ècÚ¡ {  
¡©e
(è=ğ
kClo£d
; }

47 
Ev’tLoİ
 *
ev’t_loİ
() const;

48 cÚ¡ 
	gEndpošt
& 
£lf_’dpošt
() const;

49 cÚ¡ 
	gEndpošt
& 
³”_’dpošt
() const;

51 
Clo£
();

52 
boŞ
 
Po¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
mes§ge
,

53 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
 = util::TimeDiff(),

54 
boŞ
 
fÜû
 = 
çl£
);

56 
sock‘
();

57 
£t_cÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
);

58 cÚ¡ 
	gboo¡
::
ªy
& 
cÚ‹xt
() const;

60 
	g´iv©e
:

61 
DoClo£
();

62 
DoPo¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
mes§ge
,

63 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

64 
ä›nd
 
şass
 
	gCl›Á
;

65 
ä›nd
 
şass
 
	gS”v”
;

66 
ä›nd
 
şass
 
	gIncomšgMsg
;

67 
ä›nd
 
şass
 
	gOutgošgMsg
;

68 
Im¶
 *
	gim¶_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/client.cc

4 
	~"ş›Á.h
"

5 
	~"š‹º®/ş›Á_im¶.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

10 
	gCl›Á
::
Cl›Á
(cÚ¡ 
O±iÚs
& 
İtiÚs
)

11 : 
im¶_
(
Ãw
 
Im¶
(
this
, 
İtiÚs
))

15 
	gCl›Á
::~
Cl›Á
() {

16 
d–‘e
 
im¶_
;

20 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
Cl›Á
::
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

21 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
) {

22  
	gim¶_
->
C»©e
(
ev’t_loİ
, 
ho¡
, 
pÜt
);

25 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
Cl›Á
::
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

26 cÚ¡ 
Endpošt
& 
»mÙe
) {

27  
	gim¶_
->
C»©e
(
ev’t_loİ
, 
»mÙe
);

30 cÚ¡ 
	gCl›Á
::
O±iÚs
& 
Cl›Á
::
İtiÚs
() const {

31  
im¶_
->
İtiÚs
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/client.h

4 #iâdeà
LDD_NET_CLIENT_H_


5 
	#LDD_NET_CLIENT_H_


	)

7 
	~<boo¡/funùiÚ.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<ldd/Ãt/šcomšg_msg_»gi¡ry.h
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
şass
 
	gEv’tLoİ
;

15 
şass
 
	gEndpošt
;

16 
şass
 
	gChªÃl
;

18 şas 
	cCl›Á
 : 
public
 
IncomšgMsgRegi¡ry
 {

19 
public
:

20 
şass
 
Im¶
;

21 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

22 
	sO±iÚs
 {

25 
	gpul£_š‹rv®
;

29 
boŞ
 
	gpul£_»Ïxed_checkšg
;

33 
boŞ
 
	gpul£_Ïzy_em™tšg
;

37 
	g»sŞve_timeout
;

41 
	gcÚÃù_timeout
;

45 
	gcÚÃù_d–ay_couÁ
;

49 
	gcÚÃù_d–ay_time_š™Ÿl
;

53 
	gcÚÃù_d–ay_time_fš®
;

58 
	gcÚÃù_d–ay_time_¡•
;

62 
NÙif›r
 
	gnÙify_cÚÃùed
;

66 
NÙif›r
 
	gnÙify_cÚÃùšg
;

70 
NÙif›r
 
	gnÙify_şo£d
;

74 
	gsock‘_»ad_bufãr_size
;

76 
O±iÚs
();

79 
ex¶ic™
 
Cl›Á
(cÚ¡ 
O±iÚs
& 
İtiÚs
);

80 ~
Cl›Á
();

82 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

83 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

84 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

85 cÚ¡ 
Endpošt
& 
»mÙe
);

87 cÚ¡ 
	gO±iÚs
& 
İtiÚs
() const;

88 
	g´iv©e
:

89 
Im¶
 *
im¶_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/endpoint.cc

4 
	~<s¡»am
>

5 
	~"ldd/Ãt/’dpošt.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

10 
	g¡d
::
¡ršg
 
Endpošt
::
ToSŒšg
() const {

11 
¡d
::
¡ršg¡»am
 
ss
;

12 
	gss
 << 
	gadd»ss_
.
ToSŒšg
(è<< ":" << 
	gpÜt_
;

13  
	gss
.
¡r
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/endpoint.h

4 #iâdeà
LDD_NET_ENDPOING_H_


5 
	#LDD_NET_ENDPOING_H_


	)

7 
	~"ldd/Ãt/add»ss.h
"

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 şas 
	cEndpošt
 {

13 
	gpublic
:

14 
Endpošt
(): 
add»ss_
(
Add»ss
::
V4
), 
pÜt_
(0) {}

15 
Endpošt
(
ušt16_t
 
pÜt
): 
add»ss_
(
Add»ss
::
V4
), 
pÜt_
(port) {}

16 
Endpošt
(
Add»ss
::
Famy
 
çmy
, 
ušt16_t
 
pÜt
)

17 : 
add»ss_
(
çmy
), 
pÜt_
(
pÜt
) {}

18 
Endpošt
(cÚ¡ 
Add»ss
& 
add»ss
, 
ušt16_t
 
pÜt
)

19 : 
add»ss_
(
add»ss
), 
pÜt_
(
pÜt
) {}

21 cÚ¡ 
	gAdd»ss
& 
add»ss
(ècÚ¡ {  
	gadd»ss_
; }

22 
ušt16_t
 
pÜt
(ècÚ¡ {  
	gpÜt_
; }

24 
£t_pÜt
(
ušt16_t
 
pÜt
è{ 
	gpÜt_
 =…ort; }

25 
£t_add»ss
(cÚ¡ 
Add»ss
& 
add»ss
è{ 
	gadd»ss_
 =‡ddress; }

27 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

28 
	g´iv©e
:

29 
Add»ss
 
add»ss_
;

30 
ušt16_t
 
	gpÜt_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event.cc

4 
	~"ev’t.h
"

5 
	~"ev’t_loİ.h
"

6 
	~"š‹º®/ev’t_im¶.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gFdEv’t
::
FdEv’t
(
Ev’tLoİ
* 
loİ
)

12 : 
im¶_
(
Ãw
 
Im¶
(
loİ
->impl_))

15 
FdEv’t
::~FdEvent() {

16 
d–‘e
 
im¶_
;

19 
	gFdEv’t
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
) {

20 
	gim¶_
->
AsyncWa™
(
fd
, 
ev’ts
, 
hªdËr
);

23 
	gFdEv’t
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

24 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
) {

25 
im¶_
->
AsyncWa™
(
fd
, 
ev’ts
, 
hªdËr
, 
timeout
);

28 
	gFdEv’t
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

29 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

30 
im¶_
->
AsyncWa™
(
fd
, 
ev’ts
, 
hªdËr
, 
timeout
);

33 
	gFdEv’t
::
Cªûl
() {

34 
im¶_
->
Cªûl
();

37 
	gSigÇlEv’t
::
SigÇlEv’t
(
Ev’tLoİ
* 
loİ
)

38 : 
im¶_
(
Ãw
 
Im¶
(
loİ
->impl_)) {}

40 
SigÇlEv’t
::~SignalEvent() {

41 
d–‘e
 
im¶_
;

44 
boŞ
 
	gSigÇlEv’t
::
Add
(
signo
) {

45  
im¶_
->
Add
(
signo
);

48 
boŞ
 
	gSigÇlEv’t
::
Remove
(
signo
) {

49  
im¶_
->
Remove
(
signo
);

52 
boŞ
 
	gSigÇlEv’t
::
CË¬
() {

53  
im¶_
->
CË¬
();

56 
	gSigÇlEv’t
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
) {

57 
im¶_
->
AsyncWa™
(
hªdËr
);

60 
	gSigÇlEv’t
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

61 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
) {

62 
im¶_
->
AsyncWa™
(
hªdËr
, 
timeout
);

65 
	gSigÇlEv’t
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

66 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

67 
im¶_
->
AsyncWa™
(
hªdËr
, 
timeout
);

70 
	gSigÇlEv’t
::
Cªûl
() {

71 
im¶_
->
Cªûl
();

74 
	gTim”Ev’t
::
Tim”Ev’t
(
Ev’tLoİ
* 
loİ
)

75 : 
im¶_
(
Ãw
 
Im¶
(
loİ
->impl_)) {}

77 
Tim”Ev’t
::~TimerEvent() {

78 
d–‘e
 
im¶_
;

81 
boŞ
 
	gTim”Ev’t
::
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
) {

82  
im¶_
->
ExpœesAt
(
time
);

85 
	gTim”Ev’t
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

86 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
) {

87 
im¶_
->
AsyncWa™
(
hªdËr
, 
timeout
);

90 
	gTim”Ev’t
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

91 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

92 
im¶_
->
AsyncWa™
(
hªdËr
, 
timeout
);

95 
	gTim”Ev’t
::
Cªûl
() {

96 
im¶_
->
Cªûl
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event.h

4 #iâdeà
LDD_NET_EVENT_H_


5 
	#LDD_NET_EVENT_H_


	)

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<ldd/ut/time¡amp.h
>

10 
	~<ldd/ut/time_diff.h
>

12 
Çme¥aû
 
	gldd
 {

13 
Çme¥aû
 
	gÃt
 {

15 
şass
 
	gEv’tLoİ
;

17 şas 
	cFdEv’t
 : 
boo¡
::
nÚcİyabË
 {

18 
public
:

19 
şass
 
Im¶
;

20 
	eTy³
 {

21 
	gkR—dabË
 = 1,

22 
	gkWr™abË
 = 2,

24 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

25 
FdEv’t
(
Ev’tLoİ
* 
loİ
);

26 ~
FdEv’t
();

27 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
);

28 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

29 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

30 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

31 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

32 
Cªûl
();

33 
	g´Ùeùed
:

34 
Im¶
* 
im¶_
;

37 şas 
	cTim”Ev’t
 : 
boo¡
::
nÚcİyabË
 {

38 
public
:

39 
şass
 
Im¶
;

40 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

41 
Tim”Ev’t
(
Ev’tLoİ
* 
loİ
);

42 ~
Tim”Ev’t
();

44 
boŞ
 
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
);

45 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

46 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

47 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

48 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

49 
Cªûl
();

50 
	g´iv©e
:

51 
Im¶
* 
im¶_
;

54 şas 
	cSigÇlEv’t
 : 
boo¡
::
nÚcİyabË
 {

55 
public
:

56 
şass
 
Im¶
;

57 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

58 
SigÇlEv’t
(
Ev’tLoİ
* 
loİ
);

59 ~
SigÇlEv’t
();

61 
boŞ
 
Add
(
signo
);

62 
boŞ
 
Remove
(
signo
);

63 
boŞ
 
CË¬
();

65 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
);

66 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

67 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

68 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

69 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

70 
Cªûl
();

71 
	g´iv©e
:

72 
Im¶
* 
im¶_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"ev’t_loİ.h
"

7 
	~"š‹º®/ev’t_loİ_im¶.h
"

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 
	gEv’tLoİ
::
Ev’tLoİ
()

13 : 
im¶_
(
Ãw
 
Im¶
)

17 
Ev’tLoİ
::Ev’tLoİ(::
ev’t_ba£
 *
ba£
)

18 : 
im¶_
(
Ãw
 
Im¶
(
ba£
))

22 
Ev’tLoİ
::~EventLoop() {

23 
d–‘e
 
im¶_
;

26 
	gEv’tLoİ
::
Run
() {

27 
im¶_
->
Run
();

30 
	gEv’tLoİ
::
Stİ
() {

31 
im¶_
->
Stİ
();

34 
	gEv’tLoİ
::
Aá”FÜk
() {

35 
im¶_
->
Aá”FÜk
();

38 
	gEv’tLoİ
::
RunInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
) {

39 
im¶_
->
RunInLoİ
(
hªdËr
);

42 
	gEv’tLoİ
::
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
) {

43 
im¶_
->
QueueInLoİ
(
hªdËr
);

46 
ev’t_ba£
 *
	gEv’tLoİ
::event_base()

48  
im¶_
->
ev’t_ba£
();

51 
	gEv’tLoİTh»ad
::
Ev’tLoİTh»ad
()

52 : 
ev’t_loİ_
(
Ãw
 
Ev’tLoİ
),

53 
th»ad_
(
NULL
),

54 
¡©e_
(
kStİ³d
)

58 
	gEv’tLoİTh»ad
::~
Ev’tLoİTh»ad
() {

59 
Stİ
();

60 
Još
();

63 
boŞ
 
	gEv’tLoİTh»ad
::
S¹
(cÚ¡ 
FunùÜ
& 
´e
, cÚ¡ FunùÜ& 
po¡
) {

64 
S‹
 
	gŞd¡©e
 = 
kStİ³d
;

65 
CHECK
(
¡©e_
.
Com·»ExchªgeSŒÚg
(&
Şd¡©e
, 
kS¹šg
))

67 
CHECK
(!
th»ad_
);

69 
	gth»ad_
.
»£t
(
Ãw
 
ut
::
Th»ad
(

70 
boo¡
::
bšd
(&
Ev’tLoİTh»ad
::
Run
, 
this
, 
´e
, 
po¡
)));

71 
boŞ
 
	gr
 = 
th»ad_
->
S¹
();

72 ià(!
	gr
) {

73 
	g¡©e_
 = 
kStİ³d
;

74 
	gth»ad_
.
»£t
();

76 
	g¡©e_
 = 
kRuÂšg
;

78  
	gr
;

81 
	gEv’tLoİTh»ad
::
Run
(cÚ¡ 
FunùÜ
& 
´e
, cÚ¡ FunùÜ& 
po¡
) {

82 ià(
	g´e
) {

83 
´e
();

85 
	gev’t_loİ_
->
Run
();

86 ià(
	gpo¡
) {

87 
po¡
();

91 
	gEv’tLoİTh»ad
::
Stİ
() {

92 
S‹
 
Şd¡©e
 = 
kRuÂšg
;

93 ià(
	g¡©e_
.
Com·»ExchªgeSŒÚg
(&
Şd¡©e
, 
kStİpšg
)) {

94 
	gev’t_loİ_
->
Stİ
();

98 
	gEv’tLoİTh»ad
::
Još
() {

99 
S‹
 
Şd¡©e
 = 
kStİpšg
;

100 ià(
	g¡©e_
.
Com·»ExchªgeSŒÚg
(&
Şd¡©e
, 
kJoššg
)) {

101 
	gth»ad_
->
Još
();

102 
	gth»ad_
.
»£t
();

103 
	g¡©e_
 = 
kStİ³d
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop.h

4 #iâdeà
LDD_NET_EVENT_LOOP_H_


5 
	#LDD_NET_EVENT_LOOP_H_


	)

7 
	~<ev’t2/ev’t.h
>

8 
	~<boo¡/nÚcİyabË.hµ
>

9 
	~<boo¡/funùiÚ.hµ
>

10 
	~<boo¡/scİed_±r.hµ
>

11 
	~<ldd/ut/©omic.h
>

12 
	~<ldd/ut/th»ad.h
>

14 
Çme¥aû
 
	gldd
 {

15 
Çme¥aû
 
	gÃt
 {

17 şas 
	cEv’tLoİ
 : 
´iv©e
 
boo¡
::
nÚcİyabË
 {

18 
public
:

19 
şass
 
Im¶
;

20 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

21 
Ev’tLoİ
();

22 
ex¶ic™
 
Ev’tLoİ
(::
ev’t_ba£
 *
ba£
);

23 ~
Ev’tLoİ
();

25 
Run
();

26 
Stİ
();

27 
Aá”FÜk
();

29 
RunInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

30 
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

31 
ev’t_ba£
 *event_base();

32 
	g´iv©e
:

33 
ä›nd
 
şass
 
FdEv’t
;

34 
ä›nd
 
şass
 
	gSigÇlEv’t
;

35 
ä›nd
 
şass
 
	gTim”Ev’t
;

36 
ä›nd
 
şass
 
	gChªÃl
;

37 
ä›nd
 
şass
 
	gLi¡’”
;

38 
ä›nd
 
şass
 
	gS”v”
;

39 
ä›nd
 
şass
 
	gCl›Á
;

40 
Im¶
* 
	gim¶_
;

43 şas 
	cEv’tLoİTh»ad
 : 
´iv©e
 
boo¡
::
nÚcİyabË
 {

44 
public
:

45 
boo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

46 
Ev’tLoİTh»ad
();

47 ~
Ev’tLoİTh»ad
();

49 
boŞ
 
S¹
(cÚ¡ 
FunùÜ
& 
´e
 = 
NULL
, cÚ¡ FunùÜ& 
po¡
 = NULL);

50 
Stİ
();

51 
Još
();

53 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
.
g‘
(); }

54 cÚ¡ 
	gut
::
Th»ad
* 
th»ad
(ècÚ¡ {  
th»ad_
.
g‘
(); }

55 
	g´iv©e
:

56 
Run
(cÚ¡ 
FunùÜ
& 
´e
, cÚ¡ FunùÜ& 
po¡
);

57 
	eS‹
 {

58 
	gkS¹šg
,

59 
	gkRuÂšg
,

60 
	gkStİpšg
,

61 
	gkJoššg
,

62 
	gkStİ³d
,

64 
	gboo¡
::
scİed_±r
<
Ev’tLoİ
> 
ev’t_loİ_
;

65 
	gboo¡
::
scİed_±r
<
ut
::
Th»ad
> 
th»ad_
;

66 
	gut
::
Atomic
<
S‹
> 
¡©e_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop_thread_pool.cc

1 
	~"ldd/Ãt/ev’t_loİ_th»ad_poŞ.h
"

2 
	~"ldd/Ãt/ev’t_loİ.h
"

4 
	~<glog/loggšg.h
>

6 
Çme¥aû
 
	gldd
 {

7 
Çme¥aû
 
	gÃt
 {

10 
	gEv’tLoİTh»adPoŞ
::
Ev’tLoİTh»adPoŞ
(
Ev’tLoİ
* 
ba£Loİ
)

11 : 
ba£_loİ_
(
ba£Loİ
),

12 
¡¬‹d_
(
çl£
),

13 
th»ads_num_
(0),

14 
Ãxt_
(0)

18 
	gEv’tLoİTh»adPoŞ
::~
Ev’tLoİTh»adPoŞ
()

22 
boŞ
 
Ev’tLoİTh»adPoŞ
::
S¹
()

24 
as£¹
(!
¡¬‹d_
);

26 
	gi
 = 0; i < 
	gth»ads_num_
; ++i)

28 
Ev’tLoİTh»ad
* 
	gt
 = 
Ãw
 EventLoopThread();

29 ià(!
	gt
->
S¹
()) {

31 
LOG
(
ERROR
) << "starthread failed!";

32  
	gçl£
;

34 
	gth»ads_
.
push_back
(
t
);

37 
	g¡¬‹d_
 = 
Œue
;

38  
	gŒue
;

41 
	gEv’tLoİTh»adPoŞ
::
Stİ
()

44 
i
 = 0; 
	gi
 < 
	gth»ads_num_
; ++i)

46 
	gEv’tLoİTh»ad
& 
	gt
 = 
th»ads_
[
Ãxt_
];

47 
	gt
.
Stİ
();

48 
	gt
.
Još
();

50 
	gth»ads_
.
ş—r
();

53 
Ev’tLoİ
* 
	gEv’tLoİTh»adPoŞ
::
G‘NextLoİ
()

55 
Ev’tLoİ
* 
loİ
 = 
ba£_loİ_
;

57 ià(!
	gth»ads_
.
em±y
())

63 
	gloİ
 = (
th»ads_
[
Ãxt_
]).
ev’t_loİ
();

64 ++
	gÃxt_
;

65 ià(
	gÃxt_
 >ğ
th»ads_
.
size
())

67 
Ãxt_
 = 0;

70  
	gloİ
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop_thread_pool.h

2 #iâdeà
LDD_NET_EVENT_LOOP_THREAD_POOL_H_


3 
	#LDD_NET_EVENT_LOOP_THREAD_POOL_H_


	)

5 
	~<boo¡/nÚcİyabË.hµ
>

6 
	~<boo¡/funùiÚ.hµ
>

7 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 
şass
 
	gEv’tLoİ
;

13 
şass
 
	gEv’tLoİTh»ad
;

15 şas 
	cEv’tLoİTh»adPoŞ
 : 
´iv©e
 
boo¡
::
nÚcİyabË


17 
public
:

18 
Ev’tLoİTh»adPoŞ
(
Ev’tLoİ
* 
ba£Loİ
);

19 ~
Ev’tLoİTh»adPoŞ
();

20 
S‘Th»adNum
(
numTh»ads
è{ 
	gth»ads_num_
 =‚umThreads; }

21 
boŞ
 
S¹
();

22 
Stİ
();

23 
Ev’tLoİ
* 
G‘NextLoİ
();

25 
	gpublic
:

26 
boo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
>* 
th»ads
(è{  &
th»ads_
; }

28 
	g´iv©e
:

29 
Ev’tLoİ
* 
ba£_loİ_
;

30 
boŞ
 
	g¡¬‹d_
;

31 
	gth»ads_num_
;

32 
size_t
 
	gÃxt_
;

33 
	gboo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
> 
th»ads_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/factory.h

4 #iâdeà
LDD_NET_FACTORY_H_


5 
	#LDD_NET_FACTORY_H_


	)

7 
	~<boo¡/sh¬ed_±r.hµ
>

8 
	~<boo¡/make_sh¬ed.hµ
>

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
	gNÚeArg
;

18 
	g‹m¶©e
 <
şass
 
	gT
>

19 
	sFaùÜy
 {

20 
	gvœtu®
 ~
FaùÜy
() {}

21 
vœtu®
 
T
* 
New
() const = 0;

22 
vœtu®
 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
() const = 0;

24 
	g‹m¶©e
 <
şass
 
	gD
>

25 
FaùÜy
* 
NewFaùÜy
();

27 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
>

28 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
);

30 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
>

31 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
);

33 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

34 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
);

36 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

37 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
);

39 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

40 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
);

42 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

43 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
);

45 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

46 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
);

48 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

49 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
);

51 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

52 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
);

54 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

55 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
);

58 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
,

59 
şass
 
	gA1
 = 
NÚeArg
, cÏs 
	gA2
 = NÚeArg, cÏs 
	gA3
 = NoneArg,

60 
şass
 
	gA4
 = 
NÚeArg
, cÏs 
	gA5
 = NÚeArg, cÏs 
	gA6
 = NoneArg,

61 
şass
 
	gA7
 = 
NÚeArg
, cÏs 
	gA8
 = NÚeArg, cÏs 
	gA9
 = NoneArg,

62 
şass
 
	gA10
 = 
NÚeArg
>

63 
FaùÜyIm¶
;

65 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
>

66 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

67 
FaùÜyIm¶
() {}

68 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(); }

69 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(); }

72 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
>

73 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

74 
FaùÜyIm¶
(
A1
 
a1
)

75 :
a1_
(
a1
) {}

76 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
); }

77 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
); }

78 
A1
 
	ga1_
;

81 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
>

82 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

83 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
)

84 :
a1_
(
a1
), 
a2_
(
a2
) {}

85 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
); }

86 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
); }

87 
A1
 
	ga1_
; 
A2
 
	ga2_
;

90 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

91 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

92 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
)

93 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
) {}

94 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
); }

95 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
); }

96 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
;

99 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

100 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

101 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
)

102 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
) {}

103 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
); }

104 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
); }

105 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
;

108 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

109 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

110 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
)

111 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
) {}

112 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
); }

113 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
); }

114 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
;

117 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

118 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gNÚeArg
, NÚeArg, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

119 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
)

120 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
), 
a6_
(
a6
) {}

121 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
, 
a6_
); }

122 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
, 
	ga6_
); }

123 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
; 
A6
 
	ga6_
;

126 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

127 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gNÚeArg
, NÚeArg, NÚeArg> : 
public
 
FaùÜy
<
T
> {

128 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
)

129 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
), 
a6_
(
a6
), 
a7_
(
a7
) {}

130 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
, 
a6_
, 
a7_
); }

131 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
, 
	ga6_
, 
	ga7_
); }

132 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
; 
A6
 
	ga6_
; 
A7
 
	ga7_
;

135 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

136 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gA8
, 
	gNÚeArg
, NÚeArg> : 
public
 
FaùÜy
<
T
> {

137 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
)

138 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
), 
a6_
(
a6
), 
a7_
(
a7
), 
a8_
(
a8
) {}

139 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
, 
a6_
, 
a7_
, 
a8_
); }

140 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
, 
	ga6_
, 
	ga7_
, 
	ga8_
); }

141 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
; 
A6
 
	ga6_
; 
A7
 
	ga7_
; 
A8
 
	ga8_
;

144 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

145 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gA8
, 
	gA9
, 
	gNÚeArg
> : 
public
 
FaùÜy
<
T
> {

146 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
)

147 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
), 
a6_
(
a6
), 
a7_
(
a7
), 
a8_
(
a8
), 
a9_
(
a9
) {}

148 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
, 
a6_
, 
a7_
, 
a8_
, 
a9_
); }

149 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
, 
	ga6_
, 
	ga7_
, 
	ga8_
, 
	ga9_
); }

150 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
; 
A6
 
	ga6_
; 
A7
 
	ga7_
; 
A8
 
	ga8_
; 
A9
 
	ga9_
;

153 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

154 
	gFaùÜyIm¶
 : 
public
 
FaùÜy
<
T
> {

155 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
)

156 :
a1_
(
a1
), 
a2_
(
a2
), 
a3_
(
a3
), 
a4_
(
a4
), 
a5_
(
a5
), 
a6_
(
a6
), 
a7_
(
a7
), 
a8_
(
a8
), 
a9_
(
a9
), 
a10_
(
a10
) {}

157 
T
* 
New
(ècÚ¡ {  
Ãw
 
D
(
a1_
, 
a2_
, 
a3_
, 
a4_
, 
a5_
, 
a6_
, 
a7_
, 
a8_
, 
a9_
, 
a10_
); }

158 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(ècÚ¡ {  
boo¡
::
make_sh¬ed
<
D
>(
a1_
, 
	ga2_
, 
	ga3_
, 
	ga4_
, 
	ga5_
, 
	ga6_
, 
	ga7_
, 
	ga8_
, 
	ga9_
, 
	ga10_
); }

159 
A1
 
	ga1_
; 
A2
 
	ga2_
; 
A3
 
	ga3_
; 
A4
 
	ga4_
; 
A5
 
	ga5_
; 
A6
 
	ga6_
; 
A7
 
	ga7_
; 
A8
 
	ga8_
; 
A9
 
	ga9_
; 
A10
 
	ga10_
;

162 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
>

163 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
() {

164  
Ãw
 
FaùÜyIm¶
<
T
, 
	gD
>();

166 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
>

167 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
) {

168  
Ãw
 
FaùÜyIm¶
<
T
, 
	gD
, 
	gA1
>(
	ga1
);

170 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
>

171 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
) {

172  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
>(
	ga1
, 
	ga2
);

174 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

175 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
) {

176  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
>(
	ga1
, 
	ga2
, 
	ga3
);

178 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

179 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
) {

180  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
);

182 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

183 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
) {

184  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
);

186 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

187 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
) {

188  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
);

190 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

191 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
) {

192  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
);

194 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

195 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
) {

196  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gA8
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
);

198 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

199 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
) {

200  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gA8
, 
	gA9
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
);

202 
	g‹m¶©e
 <
şass
 
	gT
>em¶©<şas 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

203 
šlše
 
	gFaùÜy
<
	gT
>* FaùÜy<T>::
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
) {

204  
Ãw
 
	gFaùÜyIm¶
<
	gT
, 
	gD
, 
	gA1
, 
	gA2
, 
	gA3
, 
	gA4
, 
	gA5
, 
	gA6
, 
	gA7
, 
	gA8
, 
	gA9
, 
	gA10
>(
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
, 
	ga10
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg.cc

1 
	~<glog/loggšg.h
>

2 
	~<boo¡/bšd.hµ
>

3 
	~"ldd/Ãt/chªÃl.h
"

4 
	~"ldd/Ãt/šcomšg_msg.h
"

5 
	~"š‹º®/šcomšg_msg_im¶.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

11 
	g¡d
::
m­
<
IncomšgMsg
::
Ty³
, 
	gDyÇmicIncomšgMsg
::
NextF»e
> 
DyÇmicIncomšgMsg
::
¡©_
;

14 
	gIncomšgMsg
::
IncomšgMsg
()

15 : 
im¶_
(
Ãw
 
Im¶
(
this
))

19 
IncomšgMsg
::~IncomingMsg() {

20 
d–‘e
 
im¶_
;

23 
	gIncomšgMsg
::
Id
 
IncomšgMsg
::
id
() const {

24  
im¶_
->
id
();

27 
boŞ
 
	gIncomšgMsg
::
IsCªûËd
() const {

28  
im¶_
->
IsCªûËd
();

31 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
IncomšgMsg
::
chªÃl
() const {

32  
im¶_
->
chªÃl
();

35 
	gIncomšgMsg
::
NÙify
(
boŞ
 
dÚe
) {

36 
chªÃl
()->
ev’t_loİ
()->
QueueInLoİ
(

37 
boo¡
::
bšd
(&
IncomšgMsg
::
DoNÙify
, 
sh¬ed_äom_this
(), 
dÚe
));

40 
	gIncomšgMsg
::
DoNÙify
(
boŞ
 
dÚe
) {

41 
im¶_
->
NÙify
(
dÚe
);

44 
	gDyÇmicIncomšgMsg
::~
DyÇmicIncomšgMsg
()

47 
Dec
(
ty³_
);

51 
	gDyÇmicIncomšgMsg
::
£t_ty³
(
Ty³
 
ty³
)

53 
ty³_
 = 
ty³
;

56 
Inc
(
ty³_
);

61 
	gDyÇmicIncomšgMsg
::
Inc
(
Ty³
 
ty³
)

63 
STAT_IT
 
pos
 = 
¡©_
.
fšd
(
ty³
);

64 ià(
	gpos
 !ğ
¡©_
.
’d
()) {

65 (*(
pos
->
£cÚd
.
Ãxt_id_
))++;

72 
	g¡d
::
·œ
<
STAT_IT
, 
	gboŞ
> 
	g»s
 =

73 
¡©_
.
š£¹
(
¡d
::
make_·œ
(
ty³
, 
NextF»e
() ));

75 ià(
	g»s
.
	g£cÚd
) {

76 
	gpos
 = 
»s
.
fœ¡
;

77 (*(
	gpos
->
	g£cÚd
.
	gÃxt_id_
))++;

84 
LOG
(
ERROR
) << "insert‡tomic uint64_t failed";

89 
	gDyÇmicIncomšgMsg
::
Dec
(
Ty³
 
ty³
)

91 
STAT_IT
 
pos
 = 
¡©_
.
fšd
(
ty³
);

92 ià(
	gpos
 !ğ
¡©_
.
’d
()) {

96 (*(
pos
->
£cÚd
.
ä“_id_
))++;

98 
LOG
(
ERROR
è<< "nÙ found dyÇmiømsgy³: " << 
	gty³
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg.h

1 #iâdeà
LDD_NET_INCOMING_MSG_H_


2 
	#LDD_NET_INCOMING_MSG_H_


	)

4 
	~<m­
>

5 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~"ldd/Ãt/·ylßd.h
"

8 
	~"ldd/Ãt/mes§ge.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gChªÃl
;

15 
şass
 
	gIncomšgMsg
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
IncomšgMsg
>,

16 
´iv©e
 
	gboo¡
::
nÚcİyabË
 {

17 
public
:

18 
şass
 
Im¶
;

19 
	gldd
::
	tÃt
::
	tPaylßd
 Payload;

20 
	gldd
::
	tÃt
::
	tMes§geId
 
	tId
;

21 
	gldd
::
	tÃt
::
	tMes§geTy³
 
	tTy³
;

22 
	gldd
::
	tÃt
::
	tCode
 Code;

24 
	eAùiÚ
 { 
	gkWa™
, 
	gkEm™
, 
	gkDÚe
 };

26 
	gvœtu®
 ~
IncomšgMsg
();

27 
vœtu®
 
Ty³
 
ty³
() const = 0;

29 
Id
 
id
() const;

30 
boŞ
 
IsCªûËd
() const;

31 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
() const;

35 
NÙify
(
boŞ
 
dÚe
 = 
çl£
);

36 
	g´Ùeùed
:

37 
IncomšgMsg
();

39 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

41 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

43 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

45 
vœtu®
 
Cªûl
() = 0;

46 
	g´iv©e
:

47 
DoNÙify
(
boŞ
);

48 
Im¶
* 
	gim¶_
;

49 
ä›nd
 
şass
 
	gChªÃl
;

50 
ä›nd
 
şass
 
	gIncomšgReque¡
;

51 
ä›nd
 
şass
 
	gIncomšgCªûl
;

54 
	g‹m¶©e
 <
Mes§geTy³
 
	gN
>

55 şas 
	cTy³dIncomšgMsg
 : 
public
 
IncomšgMsg
 {

56 
public
:

57 cÚ¡ 
Ty³
 
kTy³
 = 
N
;

58 
Ty³
 
ty³
(ècÚ¡ {  
	gkTy³
; }

59 
	g´Ùeùed
:

60 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

61 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

62 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

63 
vœtu®
 
Cªûl
() {}

67 şas 
	cDyÇmicIncomšgMsg
 : 
public
 
IncomšgMsg
 {

68 
public
:

69 ~
DyÇmicIncomšgMsg
();

70 
£t_ty³
(
Ty³
 
ty³
);

71 
Ty³
 
ty³
(ècÚ¡ {  
	gty³_
; }

72 
	g´Ùeùed
:

73 
DyÇmicIncomšgMsg
(è: 
ty³_
(0) {}

74 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

75 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

76 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

77 
vœtu®
 
Cªûl
() {}

78 
	g´iv©e
:

79 
Ty³
 
ty³_
;

82 
	g´iv©e
:

83 
ä›nd
 
şass
 
St
;

85 
	sNextF»e
 {

86 
NextF»e
()

87 : 
Ãxt_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>()),

88 
ä“_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>())

89 { *
Ãxt_id_
 = 0; *
	gä“_id_
 = 0; }

90 ~
NextF»e
() {}

92 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
Ãxt_id_
;

93 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
ä“_id_
;

96 
	g¡d
::
m­
<
Ty³
, 
	gNextF»e
> 
	g¡©_
;

98 
	g¡d
::
	tm­
<
	tTy³
, 
	tNextF»e
>::
	t™”©Ü
 
	tSTAT_IT
;

100 
Inc
(
Ty³
 
ty³
);

101 
Dec
(
Ty³
 
ty³
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg_registry.h

4 #iâdeà
LDD_NET_INCOMING_MSG_REGISTRY_H_


5 
	#LDD_NET_INCOMING_MSG_REGISTRY_H_


	)

7 
	~"ldd/Ãt/mes§ge.h
"

8 
	~"ldd/Ãt/»gi¡ry.h
"

9 
	~"ldd/Ãt/šcomšg_msg.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

21 
şass
 
	gIncomšgMsgRegi¡ry
 : 
´iv©e
 
Regi¡ry
<
IncomšgMsg
, 
	gMes§geTy³
> {

22 
	gpublic
:

23 
IncomšgMsgRegi¡ry
(è: 
deçuÉ_
(
NULL
) {}

24 
vœtu®
 ~
IncomšgMsgRegi¡ry
(è{ 
d–‘e
 
deçuÉ_
; }

26 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
NewIncomšgMsg
(
Mes§geTy³
 
t
è{  
MakeSh¬ed
(t); }

28 
	gboo¡
::
sh¬ed_±r
<
DyÇmicIncomšgMsg
> 
NewDeçuÉIncomšgMsg
() {

29 ià(
deçuÉ_
 !ğ
NULL
) {

30  
deçuÉ_
->
MakeSh¬ed
();

32  
	gboo¡
::
sh¬ed_±r
<
DyÇmicIncomšgMsg
>();

37 
	g‹m¶©e
 <
şass
 
	gMsg
>

38 
Regi¡”IncomšgMsg
(è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
); }

39 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
>

40 
Regi¡”IncomšgMsg
(
A1
 
a1
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
); }

41 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
>

42 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
); }

43 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

44 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
); }

45 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

46 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
); }

47 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

48 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
); }

49 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

50 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
); }

51 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

52 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
); }

53 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

54 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
); }

55 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

56 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
); }

57 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

58 
Regi¡”IncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
è{ 
	gRegi¡”
<
	gMsg
>(Msg::
kTy³
, 
	ga1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
, 
	ga10
); }

60 
	g‹m¶©e
 <
şass
 
	gMsg
>

61 
Regi¡”DeçuÉIncomšgMsg
() {

62 
as£¹
(!
deçuÉ_
);

63 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>();

65 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
>

66 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
) {

67 
as£¹
(!
deçuÉ_
);

68 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
);

70 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
>

71 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
) {

72 
as£¹
(!
deçuÉ_
);

73 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
);

75 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

76 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
) {

77 
as£¹
(!
deçuÉ_
);

78 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
);

80 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

81 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
) {

82 
as£¹
(!
deçuÉ_
);

83 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
);

85 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

86 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
) {

87 
as£¹
(!
deçuÉ_
);

88 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
);

90 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

91 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
) {

92 
as£¹
(!
deçuÉ_
);

93 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
);

95 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

96 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
) {

97 
as£¹
(!
deçuÉ_
);

98 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
);

100 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

101 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
) {

102 
as£¹
(!
deçuÉ_
);

103 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
);

105 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

106 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
) {

107 
as£¹
(!
deçuÉ_
);

108 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
);

110 
	g‹m¶©e
 <
şass
 
	gMsg
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

111 
Regi¡”DeçuÉIncomšgMsg
(
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
) {

112 
as£¹
(!
deçuÉ_
);

113 
	gdeçuÉ_
 = 
FaùÜy
<
DyÇmicIncomšgMsg
>::
NewFaùÜy
<
Msg
>(
a1
, 
	ga2
, 
	ga3
, 
	ga4
, 
	ga5
, 
	ga6
, 
	ga7
, 
	ga8
, 
	ga9
, 
	ga10
);

115 
	g´iv©e
:

116 
FaùÜy
<
DyÇmicIncomšgMsg
>* 
deçuÉ_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/channel_impl.cc

4 
	~<ev’t2/dns.h
>

5 
	~<ev’t2/ut.h
>

6 
	~<ev’t2/ev’t.h
>

8 
	~<¡ršg.h
>

9 
	~<glog/loggšg.h
>

10 
	~<sys/sock‘.h
>

12 
	~<s¡»am
>

13 
	~<boo¡/bšd.hµ
>

14 
	~<boo¡/make_sh¬ed.hµ
>

15 
	~"ldd/Ãt/outgošg_msg.h
"

16 
	~"ldd/Ãt/šcomšg_msg.h
"

17 
	~"ldd/ut/cÚ¡_bufãr.h
"

18 
	~"chªÃl_im¶.h
"

19 
	~"ev’t_loİ_im¶.h
"

20 
	~"outgošg_msg_im¶.h
"

21 
	~"šcomšg_msg_im¶.h
"

22 
	~"šcomšg_·ck‘.h
"

23 
	~"outgošg_·ck‘.h
"

24 
	~"pul£_em™‹r.h
"

25 
	~"pul£_check”.h
"

27 
Çme¥aû
 
	gldd
 {

28 
Çme¥aû
 
	gÃt
 {

30 
usšg
 
Çme¥aû
 
	g¡d
;

31 
usšg
 
Çme¥aû
 
	gboo¡
;

32 
usšg
 
Çme¥aû
 
	gldd
::
ut
;

34 #ifdeà
RES_COUNTER


35 
	gut
::
Atomic
<
ušt64_t
> 
Ev’tCtx
::
Ãxt_id_
;

36 
	gut
::
Atomic
<
ušt64_t
> 
Ev’tCtx
::
ä“_id_
;

38 
	gut
::
Atomic
<
ušt64_t
> 
DnsCtx
::
Ãxt_id_
;

39 
	gut
::
Atomic
<
ušt64_t
> 
DnsCtx
::
ä“_id_
;

42 
	gut
::
Atomic
<
ušt64_t
> 
IncomšgChªÃl
::
Ãxt_id_
;

43 
	gut
::
Atomic
<
ušt64_t
> 
IncomšgChªÃl
::
ä“_id_
;

45 
	gut
::
Atomic
<
ušt64_t
> 
OutgošgChªÃl
::
Ãxt_id_
;

46 
	gut
::
Atomic
<
ušt64_t
> 
OutgošgChªÃl
::
ä“_id_
;

49 
	gut
::
Atomic
<
ušt64_t
> 
ChªÃl
::
Im¶
::
Ãxt_id_
;

51 
	gChªÃl
::
Im¶
::
Ev’tNÙify
(
fd
, 
wh©
, *
¬g
)

53 
CHECK_NOTNULL
(
¬g
);

55 
Ev’tCtx
 *
	gùx
 = (Ev’tCtx *)
¬g
;

57 ià(
	gwh©
 & 
	gEV_READ
) {

58 
DLOG
(
INFO
è<< "»adƒv’ˆnÙify, fd: " << 
	gfd
;

59 
	gùx
->
	gim¶_
->
OnR—d
();

61 ià(
	gwh©
 & 
	gEV_WRITE
) {

62 
DLOG
(
INFO
è<< "wr™ev’ˆnÙify, fd: " << 
	gfd
;

63 
	gùx
->
	gim¶_
->
OnWr™e
();

66 
LOG
(
FATAL
è<< "unknowÀev’ˆš Ev’tNÙify, fd: " << 
	gfd
;

71 cÚ¡ * 
	gkNÙif›rNames
[] = {

77 
	gChªÃl
::
Im¶
::Im¶(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
)

78 : 
sock‘_
(-1),

79 
ev’t_ùx_
(
NULL
),

80 
owÃr_
(
owÃr
),

81 
ev’t_loİ_
(
ev’t_loİ
),

82 
¡©e_
(
ChªÃl
::
kClo£d
),

83 
ev’ts_
(0),

84 
»ad_¡©e_
(
kR—dH—d”
),

85 
sock‘_ev_
(
NULL
),

86 
h—d”_
(
Ãw
 
Bufãr
(
H—d”
::
kBy‹Size
)),

87 
outgošg_msg_id_
(-1),

88 
id_
(
Ãxt_id_
++)

90 
DLOG
(
INFO
è<< "chªÃÈim¶ ctÜ, id: " << 
	gid_
;

91 
CHECK_NOTNULL
(
ev’t_loİ_
);

93 
	gsock‘_ev_
 = 
ev’t_Ãw
(
ev’t_loİ_
->
im¶_
->
ev’t_ba£
(),

94 
sock‘_
, 0, 
Ev’tNÙify
, (*)
this
);

95 
CHECK_NOTNULL
(
sock‘_ev_
);

98 
	gChªÃl
::
Im¶
::~Impl() {

99 
DLOG
(
INFO
è<< "chªÃÈim¶ dtÜ, id: " << 
id
();

102 ià(
	gsock‘_ev_
 !ğ
NULL
) {

103 
ev’t_ä“
(
sock‘_ev_
);

104 
	gsock‘_ev_
 = 
NULL
;

107 ià(
	gev’t_ùx_
 !ğ
NULL
) {

108 
d–‘e
 
ev’t_ùx_
;

109 
	gev’t_ùx_
 = 
NULL
;

113 
ev’t_ba£
 *
	gChªÃl
::
Im¶
::event_base() {

114  
ev’t_loİ
()->
im¶_
->
ev’t_ba£
();

117 
boŞ
 
	gChªÃl
::
Im¶
::
FlEndpošts
(boŞ 
»mÙe
) {

118 ià(
sock‘_
 == -1) {

119 
DLOG
(
WARNING
è<< "šv®id sock‘ fd: " << 
sock‘_
;

120  
	gçl£
;

123 
	grc
 = 0;

124 
	gpÜt
 = 0;

125 
sockaddr_š
 
	gaddr
;

126 
sockËn_t
 
	gadd¾’
 = 0;

128 ià(
	g»mÙe
) {

129 
mem£t
(&
addr
, 0, (addr));

130 
	gadd¾’
 = (
addr
);

131 
	grc
 = 
g‘³”Çme
(
sock‘_
, (
sockaddr
 *)&
addr
, &
add¾’
);

132 ià(
	grc
 != 0) {

134 
LOG
(
ERROR
è<< "g‘„emÙho¡ƒ¼Ü: " << 
¡»¼Ü
(
rc
);

135  
	gçl£
;

138 
	gpÜt
 = 
Áohs
(
addr
.
sš_pÜt
);

140 
	g³”_’dpošt_
.
£t_add»ss
(
Add»ss
(
addr
.
sš_addr
));

141 
	g³”_’dpošt_
.
£t_pÜt
(
pÜt
);

144 
mem£t
(&
addr
, 0, (addr));

145 
	gadd¾’
 = (
addr
);

146 
	grc
 = 
g‘sockÇme
(
sock‘_
, (
sockaddr
 *)&
addr
, &
add¾’
);

147 ià(
	grc
 != 0) {

149 
LOG
(
ERROR
) << "get†ocal hostƒrror";

150  
	gçl£
;

153 
	gpÜt
 = 
Áohs
(
addr
.
sš_pÜt
);

155 
	g£lf_’dpošt_
.
£t_add»ss
(
Add»ss
(
addr
.
sš_addr
));

156 
	g£lf_’dpošt_
.
£t_pÜt
(
pÜt
);

158  
	gŒue
;

161 
	gChªÃl
::
Im¶
::
NÙify
(cÚ¡ 
NÙif›r
& 
nÙif›r
) {

162 ià(
nÙif›r
) {

163 
Œy
 {

164 
nÙif›r
(
owÃr_
->
sh¬ed_äom_this
());

165 } 
ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

166 
LOG
(
FATAL
è<< "NÙify " << 
kNÙif›rNames
[
¡©e
()] << "ƒxception: "

167 << 
e
.
wh©
();

168 } 
ÿtch
 (...) {

169 
LOG
(
FATAL
è<< "NÙify " << 
	gkNÙif›rNames
[
¡©e
()] << "ƒrror";

174 
	gChªÃl
::
Im¶
::
Po¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
omsg
,

175 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
)

177 
DLOG
(
INFO
) << "enter Post";

179 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

180 
DLOG
(
INFO
) << "channel is closed when Post";

181 
	gomsg
->
	gim¶_
->
OnFaed
();

185 
št32_t
 
	gid
 = 
NextOutgošgMsgId
();

186 
	g¡d
::
·œ
<
OutgošgMsgM­
::
™”©Ü
, 
	gboŞ
> 
	gr
 =

187 
omsgs_
.
š£¹
(
¡d
::
make_·œ
(
id
, 
omsg
));

188 ià(
	gr
.
	g£cÚd
) {

189 
DLOG
(
INFO
) << "call outgoing msg Init method withimeout: "

190 << 
	gtimeout
.
ToMli£cÚds
();

192 
	gomsg
->
	gim¶_
->
In™
(
id
, 
owÃr
(), 
timeout
);

194 
LOG
(
FATAL
è<< 
Çme
(è<< "du¶iÿ‹d outgošg mes§gid = " << 
	gid
;

198 
	gChªÃl
::
Im¶
::
Wr™e
(
OutgošgPack‘
* 
·ck‘
) {

200 
DLOG
(
INFO
) << "enter Write";

202 
CHECK_NOTNULL
(
·ck‘
);

203 
	g³ndšg_·ck‘s_
.
push_back
(
·ck‘
);

205 
DoWr™e
();

207 
DLOG
(
INFO
) << "call OnOutgoingPacket in Write";

208 
OnOutgošgPack‘
();

211 
	gChªÃl
::
Im¶
::
DoWr™e
()

213 
DLOG
(
INFO
) << "enter DoWrite";

215 ià(
¡©e
(è!ğ
ChªÃl
::
kCÚÃùed
) {

216 
DLOG
(
INFO
) << "channel is‚ot connect when DoWrite";

220 
	gboo¡
::
	t±r_deque
<
	tOutgošgPack‘
>::
	tauto_ty³
‡uto_type;

222 
size_t
 
	gby‹s
 = 0;

223 
	g¡d
::
veùÜ
<
CÚ¡Bufãr
> 
bufãrs
;

225 
DLOG
(
INFO
è<< "³ndšg…ack‘s: " << 
	g³ndšg_·ck‘s_
.
size
();

227 !
	g³ndšg_·ck‘s_
.
em±y
()) {

229 
auto_ty³
 
	g·ck‘
 = 
³ndšg_·ck‘s_
.
pİ_äÚt
();

230 
size_t
 
	gn
 = 
·ck‘
->
S”ŸlizeTo
(&
bufãrs
);

231 ià(
	gn
 == 0) {

236 
	gby‹s
 +ğ
n
;

237 
	gwr™šg_·ck‘s_
.
push_back
(
·ck‘
.
»Ëa£
());

240 ià(
	gby‹s
 == 0) {

241 
DLOG
(
INFO
) << "there is‚o datao write when DoWrite";

245 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
lßd
(
Ãw
 Bufãr(
by‹s
));

246 *
	gp
 = 
lßd
->
d©a
();

247 
	g¡d
::
veùÜ
<
CÚ¡Bufãr
>::
™”©Ü
 
™
 = 
bufãrs
.
begš
();

249 ; 
	g™
 !ğ
bufãrs
.
’d
(); it++) {

250 
DLOG
(
INFO
) << "size: "

251 << 
	g™
->
size
()

253 << 
	g™
->
ToSŒšg
();

255 *
	g¤c
 = 
cÚ¡_ÿ¡
<*>(
™
->
d©a
());

256 
	gsize
 = 
™
->
size
();

257 
memıy
(
p
, 
¤c
, 
size
);

258 
	gp
 +ğ
size
;

261 
	gwr™šg_bufãrs_
.
push_back
(
lßd
);

263 ià(
¡©e
(è!ğ
ChªÃl
::
kCÚÃùed
) {

264 
DLOG
(
INFO
) << "channel is‚ot connected when wirte";

268 
R—lWr™e
();

271 
	gChªÃl
::
Im¶
::
R—lWr™e
()

273 
DLOG
(
INFO
) << "enter RealWrite";

275 ià(!
	gwr™e_sk_
.
IsS‘
()) {

276 ià(
	gwr™šg_bufãrs_
.
em±y
()) {

277 
DoWr™e
();

282 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
obuff
 = 
wr™šg_bufãrs_
.
äÚt
();

283 
	gwr™e_sk_
.
Re£t
();

284 
	gwr™e_sk_
.
S‘
(
obuff
, 
sock‘
());

285 
DLOG
(
INFO
) << "create‡ writeask,ask write bytes: "

286 << 
	gwr™e_sk_
.
bufãr
()->
size
();

289 
	grc
 = 
wr™e_sk_
.
Wr™e
();

290 ià(
	grc
 == 0) {

291 
DLOG
(
INFO
) << "complete‡ writeask in„ealime,ask bytes: "

292 << 
wr™e_sk_
.
bufãr
()->
size
();

293 ià(!
	gwr™šg_bufãrs_
.
em±y
()) {

294 
	gwr™šg_bufãrs_
.
pİ_äÚt
();

296 ià(
	gwr™šg_bufãrs_
.
em±y
()) {

297 
	gwr™šg_·ck‘s_
.
ş—r
();

299 
	gwr™e_sk_
.
Re£t
();

301 
DoWr™e
();

304 ià(
	grc
 =ğ
EAGAIN
 || 
rc
 =ğ
EWOULDBLOCK
) {

305 
DLOG
(
INFO
) << "call AddEvent with EV_WRITE, in RealWrite";

306 
AddEv’t
(
EV_WRITE
);

307 
DLOG
(
INFO
) << "wait for writeƒvent";

311 
LOG
(
ERROR
è<< 
Çme
(è<< " wœ‹ƒ¼Ü: " << 
¡»¼Ü
(
rc
);

312 
OnE¼Ü
();

316 
	gChªÃl
::
Im¶
::
Clo£Sock‘
()

318 
DLOG
(
INFO
è<< "şo£ sock‘: " << 
sock‘_
;

319 ià(
	gsock‘_
 != -1) {

320 
»ad_h—d”_sk_
.
Re£t
();

321 
	g»ad_body_sk_
.
Re£t
();

322 
	gwr™e_sk_
.
Re£t
();

323 
D–Ev’t
(
EV_READ
 | 
EV_WRITE
);

324 
evut_şo£sock‘
(
sock‘_
);

325 
	gsock‘_
 = -1;

329 
	gChªÃl
::
Im¶
::
Clo£
() {

330 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

333 
OnClo£
();

336 
	gChªÃl
::
Im¶
::
CË¬IncomšgMsg
() {

337 
IncomšgMsgM­
::
™”©Ü
 
i™
 = 
imsgs_
.
begš
();

338 ; 
	gi™
 !ğ
imsgs_
.
’d
();) {

339 
LOG
(
INFO
è<< "ÿnûlšg incomšg msg id = " << 
	gi™
->
	gfœ¡
;

340 (
	gi™
++)->
	g£cÚd
->
	gim¶_
->
DoCªûl
();

342 
	gimsgs_
.
ş—r
();

344 
	g³ndšg_·ck‘s_
.
ş—r
();

345 
	gwr™šg_bufãrs_
.
ş—r
();

346 
	gwr™šg_·ck‘s_
.
ş—r
();

349 
	gChªÃl
::
Im¶
::
CË¬OutgošgMsg
() {

350 
DLOG
(
INFO
è<< "CË¬Outgošgmsg c®Ëd, omsg size: " << 
omsgs_
.
size
();

351 
	gOutgošgMsgM­
::
™”©Ü
 
o™
 = 
omsgs_
.
begš
();

352 ; 
	go™
 !ğ
omsgs_
.
’d
();) {

353 (
	go™
++)->
	g£cÚd
->
	gim¶_
->
OnFaed
();

355 
	gomsgs_
.
ş—r
();

357 
	g³ndšg_·ck‘s_
.
ş—r
();

358 
	gwr™šg_bufãrs_
.
ş—r
();

359 
	gwr™šg_·ck‘s_
.
ş—r
();

362 
boŞ
 
	gChªÃl
::
Im¶
::
AddIncomšgMsg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
IncomšgMsg
>& 
msg
) {

363 
CHECK_GE
(
msg
->
id
(), 0);

364 
	g¡d
::
·œ
<
IncomšgMsgM­
::
™”©Ü
, 
	gboŞ
> 
	gr
 =

365 
imsgs_
.
š£¹
(
¡d
::
make_·œ
(
msg
->
id
(), msg));

366  
	gr
.
	g£cÚd
;

369 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
ChªÃl
::
Im¶
::
G‘IncomšgMsg
(

370 
št32_t
 
id
, 
boŞ
 
»move
) {

371 
	gIncomšgMsgM­
::
™”©Ü
 
™
 = 
imsgs_
.
fšd
(
id
);

372 ià(
	g™
 =ğ
imsgs_
.
’d
()) {

373  
boo¡
::
sh¬ed_±r
<
IncomšgMsg
>();

375 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
imsg
 = 
™
->
£cÚd
;

376 ià(
	g»move
) {

377 
	gimsgs_
.
”a£
(
™
);

379  
	gimsg
;

382 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
ChªÃl
::
Im¶
::
G‘OutgošgMsg
(

383 
št32_t
 
id
, 
boŞ
 
»move
) {

384 
	gOutgošgMsgM­
::
™”©Ü
 
™
 = 
omsgs_
.
fšd
(
id
);

385 ià(
	g™
 =ğ
omsgs_
.
’d
()) {

386  
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>();

388 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
omsg
 = 
™
->
£cÚd
;

389 ià(
	g»move
) {

390 
	gomsgs_
.
”a£
(
™
);

392  
	gomsg
;

395 
	gChªÃl
::
Im¶
::
OnIncomšgPack‘
() {

396 
DLOG
(
INFO
) << "enter OnIncomingPacket";

397 
	gpul£_check”_
->
NÙifyIncomšgPack‘
();

398 
	gpul£_em™‹r_
->
NÙifyIncomšgPack‘
();

401 
	gChªÃl
::
Im¶
::
OnOutgošgPack‘
() {

402 
DLOG
(
INFO
) << "enter OnOutgoingPacket";

403 
	gpul£_em™‹r_
->
NÙifyOutgošgPack‘
();

406 
	gChªÃl
::
Im¶
::
OnPul£Faed
() {

407 
LOG
(
ERROR
è<< 
Çme
() << "pulseimeout";

408 
OnE¼Ü
();

411 
	gChªÃl
::
Im¶
::
S‘Ev’t
(
ev’ts
)

413 
DLOG
(
INFO
) << "enter SetEvent, "

414 << "´evƒv’ts: " << 
ev’ts_


415 << ",‚ewƒv’ts: " << 
ev’ts
;

417 
CHECK_GE
(
sock‘_
, 0);

419 ià(
	gev’ts
 =ğ
ev’ts_
) {

423 ià(
	gev’t_ùx_
 =ğ
NULL
) {

424 
ev’t_ùx_
 = 
Ãw
 
Ev’tCtx
(
owÃr
(), 
this
);

425 
CHECK_NOTNULL
(
ev’t_ùx_
);

428 ià(
	gev’ts_
 != 0 ) {

429 
CHECK
(
ev’t_d–
(
sock‘_ev_
) == 0);

432 
	gev’ts_
 = 
ev’ts
;

433 ià(
	gev’ts_
 == 0) {

437 
CHECK
(
ev’t_assign
(
sock‘_ev_


438 , 
owÃr_
->
im¶_
->
ev’t_ba£
()

439 , 
sock‘_


440 , 
ev’ts_
 | 
EV_PERSIST


441 , 
Ev’tNÙify


442 , (*)
ev’t_ùx_
) == 0);

444 
CHECK
(
ev’t_add
(
sock‘_ev_
, 
NULL
) == 0);

447 
	gChªÃl
::
Im¶
::
OnR—d
()

449 
DLOG
(
INFO
è<< "OnR—d c®Ëd, fd: " << 
sock‘_
;

451 ià(
¡©e
(è!ğ
ChªÃl
::
kCÚÃùed
) {

452 
LOG
(
WARNING
è<< 
Çme
()

454 << 
¡©e
();

458 
	g»ad_¡©e_
) {

459 
	gkR—dH—d”
:

460 
R—dH—d”
();

462 
	gkR—dBody
:

463 
R—dBody
();

466 
LOG
(
FATAL
) << "unknown„ead state";

471 
	gChªÃl
::
Im¶
::
R—dH—d”
()

473 
DLOG
(
INFO
) << "enter ReadHeader";

475 
	grc
 = 0;

476 ià(!
	g»ad_h—d”_sk_
.
IsS‘
()) {

477 
DLOG
(
INFO
) << "create‡„ead headerask,ask„ead bytes: "

478 << 
	gh—d”_
->
size
();

479 
	g»ad_h—d”_sk_
.
S‘
(
h—d”_
, 
sock‘
());

482 
DLOG
(
INFO
) << "starto„ead‡ header";

483 
	grc
 = 
»ad_h—d”_sk_
.
R—d
();

484 ià(
	grc
 != 0) {

485 ià(
rc
 !ğ
EAGAIN
 &&„ø!ğ
EWOULDBLOCK
) {

486 
DLOG
(
INFO
è<< 
Çme
(è<< "R—d h—d”ƒ¼Ü: " << 
¡»¼Ü
(
rc
);

487 
OnE¼Ü
();

491 
DLOG
(
INFO
) << "continue„ead header";

497 
DLOG
(
INFO
) << "read header bytes: "

498 << 
	g»ad_h—d”_sk_
.
bufãr
()->
size
()

499 << ", magic: " << ()
	g»ad_h—d”_sk_
.
bufãr
()->
d©a
()[0]

501 << ()
	gh—d”_
->
d©a
()[0];

503 
	g»ad_h—d”_sk_
.
Re£t
();

506 
	gH—d”
::
P¬£r
 
hdr
(
h—d”_
->
d©a
());

507 ià(!
	ghdr
.
IsV®id
()) {

508 
LOG
(
ERROR
è<< 
Çme
() << "Parse invalid header";

509 
OnE¼Ü
();

513 
DLOG
(
INFO
è<< 
Çme
()

514 << "R—dšg "<< 
Çme
(è<< " (id=" << 
	ghdr
.
id
()

515 << " body_ty³=" << ()
	ghdr
.
body_ty³
()

516 << " body_size=" << 
	ghdr
.
body_size
()

517 << "ƒxt_couÁ=" << ()
	ghdr
.
ext_couÁ
()

518 << "ƒxt_Ën=" << 
	ghdr
.
ext_Ën
()

522 
	gtÙ®
 = 
hdr
.
body_size
();

523 ià(
	ghdr
.
ext_couÁ
(è> 0 && hdr.
ext_Ën
() > 0) {

525 
	gtÙ®
 +ğ
ExtH—d”
::
size
(
hdr
.
ext_couÁ
());

527 
	gtÙ®
 +ğ
hdr
.
ext_Ën
();

530 
	g·ck‘_size_
 = 
tÙ®
;

532 ià(
	gtÙ®
 == 0) {

533 
DLOG
(
INFO
) << "no…ayload,‡nd…rocess control…acket";

534 
ProûssPack‘
();

538 
	g·ck‘_
.
»£t
(
Ãw
 
Bufãr
(
tÙ®
));

539 
DLOG
(
INFO
è<< "m®loø·ck‘: " << (
	gušt64_t
)
	g·ck‘_
->
d©a
(è<< ", size: " << 
	gtÙ®
;

541 
DLOG
(
INFO
è<< "ü—‹‡„—dask,ask by‹s: " << 
	gtÙ®
;

542 
	g»ad_body_sk_
.
S‘
(
·ck‘_
, 
sock‘
());

544 
	g»ad_¡©e_
 = 
kR—dBody
;

546 
R—dBody
();

549 
	gChªÃl
::
Im¶
::
R—dBody
()

551 
DLOG
(
INFO
) << "enter ReadBody";

553 ià(!
	g»ad_body_sk_
.
IsS‘
()) {

554 
LOG
(
FATAL
) << "uninit„eadask";

558 
DLOG
(
INFO
) << "starto„ead‡ body";

559 
	grc
 = 
»ad_body_sk_
.
R—d
();

560 ià(
	grc
 != 0) {

561 ià(
rc
 !ğ
EAGAIN
 &&„ø!ğ
EWOULDBLOCK
) {

562 
LOG
(
ERROR
è<< 
Çme
(è<< "sock‘ƒ¼Ü: " << 
¡»¼Ü
(
rc
);

563 
OnE¼Ü
();

567 
DLOG
(
INFO
) << "continue„ead body";

571 
	g»ad_body_sk_
.
Re£t
();

572 
	g»ad_¡©e_
 = 
kR—dH—d”
;

575 
DLOG
(
INFO
) << "start…rocess…acket";

577 
ProûssPack‘
();

580 
	gChªÃl
::
Im¶
::
ProûssPack‘
()

582 
DLOG
(
INFO
) << "enter ProcessPacket";

584 
	gboo¡
::
sh¬ed_±r
<
IncomšgPack‘
> 
·ck‘
;

585 
h—d”
().
ty³
()) {

586 
	gH—d”
::
kPšg
:

587 
DLOG
(
INFO
) << "packet:…ing";

588 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgPšg
>(
this
);

590 
	gH—d”
::
kPÚg
:

591 
DLOG
(
INFO
) << "packet:…ong";

592 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgPÚg
>(
this
);

594 
	gH—d”
::
kReque¡
:

595 
DLOG
(
INFO
) << "packet:„equest";

596 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgReque¡
>(
this


597 , 
	g·ck‘_
);

598 
	g·ck‘_
.
»£t
();

600 
	gH—d”
::
kRe¥Ú£
:

601 
H—d”
::
kLa¡
:

602 
DLOG
(
INFO
) << "packet:„esponse or†ast";

603 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgRe¥Ú£
>(
this


604 , 
	g·ck‘_
);

605 
	g·ck‘_
.
»£t
();

607 
	gH—d”
::
kCªûl
:

608 
DLOG
(
INFO
) << "packet: cancel";

609 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgCªûl
>(
this
);

611 
	gH—d”
::
kEnd
:

612 
DLOG
(
INFO
) << "packet:ƒnd";

613 
	g·ck‘
 = 
make_sh¬ed
<
IncomšgEnd
>(
this
);

616 
LOG
(
ERROR
è<< 
Çme
()

617 << "P¬£d inv®id h—d”y³ = " << ()
h—d”
().
ty³
();

618 
OnE¼Ü
();

622 
	g·ck‘
->
Proûss
();

625 
	gChªÃl
::
Im¶
::
OnWr™e
()

627 
DLOG
(
INFO
è<< "’‹¸OnWr™e, fd: " << 
sock‘_
;

630 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

631 
LOG
(
WARNING
è<< 
Çme
() << "receive writeƒvent when socket is closed";

633 } ià(
¡©e
(è=ğ
ChªÃl
::
kCÚÃùšg
) {

635 
D–Ev’t
(
EV_WRITE
);

637 
DLOG
(
INFO
) << "receive connectƒvent";

638 
	gËn
 = 0;

639 
	g”r
 = 0;

640 
	gËn
 = (
”r
);

641 ià(
g‘sockİt
(
sock‘_
, 
SOL_SOCKET
, 
SO_ERROR
, &
”r
, (
sockËn_t
 *)&
Ën
)

643 
LOG
(
ERROR
è<< 
Çme
(è<< " g‘ SO_ERRORƒ¼Ü:" << 
¡»¼Ü
(
”ºo
);

644 
	g”r
 = 
”ºo
;

647 
OnCÚÃù
(
”r
);

651 
D–Ev’t
(
EV_WRITE
);

653 
R—lWr™e
();

657 
	gChªÃl
::
Im¶
::
£t_sock‘
(
sock‘
)

659 
DLOG
(
INFO
è<< "’‹¸£t_sock‘, fd: " << 
sock‘
;

660 
evut_make_sock‘_nÚblockšg
(
sock‘
);

661 
	gsock‘_
 = 
sock‘
;

665 
	gIncomšgChªÃl
::
IncomšgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

666 
S”v”
::
Im¶
* 
£rv”
)

667 : 
Su³r
(
owÃr
, 
ev’t_loİ
),

668 
£rv”_
(
£rv”
)

670 
DLOG
(
INFO
) << "IncomingChannel ctor called";

672 #ifdeà
RES_COUNTER


673 
	gÃxt_id_
++;

676 
In™Pul£
();

679 
	g¡d
::
¡ršg
 
IncomšgChªÃl
::
Çme
() const {

680 
¡d
::
¡ršg¡»am
 
ss
;

681 
	gss
 << '[' << 
id
() << '@'

682 << 
£lf_’dpošt
().
ToSŒšg
()

683 << ((
ty³
(è=ğ
ChªÃl
::
kIncomšg
) ? " <- " : " -> ")

684 << 
³”_’dpošt
().
ToSŒšg
()

686  
	gss
.
¡r
();

689 
	gIncomšgChªÃl
::
In™Pul£
()

691 
DLOG
(
INFO
) << "enter InitPulse";

693 
	gPul£Check”
::
R•Ü‹r
 
»pÜ‹r
 =

694 
boo¡
::
bšd
(&
IncomšgChªÃl
::
OnPul£Faed
, 
this
);

695 ià(
İtiÚs
().
	gpul£_»Ïxed_checkšg
) {

696 
DLOG
(
INFO
) << "create RelaxedPulseChecker in InitPulse";

697 
	gpul£_check”_
.
»£t
(
Ãw
 
R–axedPul£Check”
(
ev’t_loİ
(),

698 
»pÜ‹r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

699 
İtiÚs
().
pul£_š‹rv®
)));

701 
DLOG
(
INFO
) << "create StrictPulseChecker in InitPulse";

702 
	gpul£_check”_
.
»£t
(
Ãw
 
SŒiùPul£Check”
(
ev’t_loİ
(),

703 
»pÜ‹r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

704 
İtiÚs
().
pul£_š‹rv®
)));

707 
	gPul£Em™‹r
::
Pul£r
 
pul£r
 =

708 
boo¡
::
bšd
(&
IncomšgChªÃl
::
DoPul£
, 
this
);

709 ià(
İtiÚs
().
	gpul£_Ïzy_em™tšg
) {

710 
DLOG
(
INFO
) << "create LazyPulseEmitter in InitPulse";

711 
	gpul£_em™‹r_
.
»£t
(
Ãw
 
LazyPul£Em™‹r
(
ev’t_loİ
(),

712 
pul£r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

713 
İtiÚs
().
pul£_š‹rv®
)));

715 
DLOG
(
INFO
) << "create ReplyPulseEmitter in InitPulse";

716 
	gpul£_em™‹r_
.
»£t
(
Ãw
 
R•lyPul£Em™‹r
(
ev’t_loİ
(),

717 
pul£r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

718 
İtiÚs
().
pul£_š‹rv®
)));

722 
	gIncomšgChªÃl
::~
IncomšgChªÃl
() {

723 
DLOG
(
INFO
) << "IncomingChannel dtor called";

724 #ifdeà
RES_COUNTER


725 
	gä“_id_
++;

729 
	gIncomšgChªÃl
::
O³n
() {

730 ià(!
FlEndpošts
(
Œue
)) {

734 
LOG
(
INFO
è<< 
Çme
() << "opening";

735 
£t_¡©e
(
ChªÃl
::
kCÚÃùed
);

736 
AddEv’t
(
EV_READ
);

737 
	gpul£_check”_
->
S¹
();

738 
	gpul£_em™‹r_
->
S¹
();

739 
NÙify
(
İtiÚs
().
nÙify_cÚÃùed
);

743 
	gIncomšgChªÃl
::
OnPšg
() {

744 
DLOG
(
INFO
) << "Ping„ecved";

745 
	gpul£_check”_
->
NÙifyIncomšgPul£
();

746 
	gpul£_em™‹r_
->
NÙifyIncomšgPul£
();

749 
	gIncomšgChªÃl
::
OnPÚg
() {

750 
DLOG
(
ERROR
è<< 
Çme
() << "recved…ong message";

751 
OnE¼Ü
();

754 
	gIncomšgChªÃl
::
OnE¼Ü
() {

755 
DLOG
(
INFO
) << "IncomingChannel::OnError called";

756 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

759 
OnClo£
();

762 
	gIncomšgChªÃl
::
OnClo£
() {

763 
LOG
(
INFO
è<< 
Çme
() << "closed";

764 
CHECK_NE
(
¡©e
(), 
ChªÃl
::
kClo£d
);

766 
£t_¡©e
(
ChªÃl
::
kClo£d
);

769 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
c
 = 
owÃr
();

771 
CË¬IncomšgMsg
();

772 
CË¬OutgošgMsg
();

774 
	gpul£_check”_
->
Stİ
();

775 
	gpul£_em™‹r_
->
Stİ
();

777 ià(
	gsock‘_
 != -1) {

780 #ifdeà
RES_COUNTER


781 
S”v”
::
Im¶
::
ä“_id_
++;

784 
Clo£Sock‘
();

787 
NÙify
(
İtiÚs
().
nÙify_şo£d
);

789 
DLOG
(
INFO
è<< "šcomšg chªÃÈu£ couÁ: " << 
	gc
.
u£_couÁ
();

791 ià(
	gev’t_ùx_
 !ğ
NULL
) {

792 
d–‘e
 
ev’t_ùx_
;

793 
	gev’t_ùx_
 = 
NULL
;

797 
	gIncomšgChªÃl
::
DoPul£
() {

798 
DLOG
(
INFO
) << "Pong is sending";

799 
OutgošgPÚg
* 
	gpÚg
 = 
Ãw
 OutgošgPÚg(
NextOutgošgMsgId
());

800 
Wr™e
(
pÚg
);

804 
	gOutgošgChªÃl
::
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

805 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
)

806 : 
Su³r
(
owÃr
, 
ev’t_loİ
),

807 
ş›Á_
(
ş›Á
),

808 
tim”_
(
ev’t_loİ
),

809 
ho¡_
(
ho¡
),

810 
pÜt_
(
pÜt
),

811 
Ãed_»sŞve_
(
çl£
),

812 
cÚÃù_çu»_
(0),

813 
cÚÃù_d–ay_
(
çl£
),

814 
dns_»q_
(
NULL
),

815 
dns_ùx_
(
NULL
)

818 #ifdeà
RES_COUNTER


819 
	gÃxt_id_
++;

822 
Add»ss
 
	gaddr
 = Add»ss::
FromSŒšg
(
ho¡
);

823 ià(!
	gaddr
.
ToU32
()) {

825 
	gÃed_»sŞve_
 = 
Œue
;

827 
	gÃed_»sŞve_
 = 
çl£
;

828 
	g³”_’dpošt_
.
£t_add»ss
(
addr
);

830 
	g³”_’dpošt_
.
£t_pÜt
(
pÜt
);

831 
In™Pul£
();

834 
	gOutgošgChªÃl
::
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

835 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
Endpošt
& 
»mÙe
)

836 : 
Su³r
(
owÃr
, 
ev’t_loİ
),

837 
ş›Á_
(
ş›Á
),

838 
tim”_
(
ev’t_loİ
),

839 
dns_»q_
(
NULL
),

840 
dns_ùx_
(
NULL
)

842 #ifdeà
RES_COUNTER


843 
	gÃxt_id_
++;

846 
	g³”_’dpošt_
 = 
»mÙe
;

847 
In™Pul£
();

850 
	gOutgošgChªÃl
::
In™Pul£
() {

851 
Pul£Check”
::
R•Ü‹r
 
»pÜ‹r
 =

852 
boo¡
::
bšd
(&
OutgošgChªÃl
::
OnPul£Faed
, 
this
);

853 ià(
İtiÚs
().
	gpul£_»Ïxed_checkšg
) {

854 
	gpul£_check”_
.
»£t
(
Ãw
 
R–axedPul£Check”
(
ev’t_loİ
(),

855 
»pÜ‹r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

856 
İtiÚs
().
pul£_š‹rv®
)));

858 
	gpul£_check”_
.
»£t
(
Ãw
 
SŒiùPul£Check”
(
ev’t_loİ
(),

859 
»pÜ‹r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

860 
İtiÚs
().
pul£_š‹rv®
)));

863 
	gPul£Em™‹r
::
Pul£r
 
pul£r
 =

864 
boo¡
::
bšd
(&
OutgošgChªÃl
::
DoPul£
, 
this
);

865 ià(
İtiÚs
().
	gpul£_Ïzy_em™tšg
) {

866 
	gpul£_em™‹r_
.
»£t
(
Ãw
 
LazyPul£Em™‹r
(
ev’t_loİ
(),

867 
pul£r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

868 
İtiÚs
().
pul£_š‹rv®
)));

870 
	gpul£_em™‹r_
.
»£t
(
Ãw
 
ClockPul£Em™‹r
(
ev’t_loİ
(),

871 
pul£r
, 
ut
::
TimeDiff
::
Mli£cÚds
(

872 
İtiÚs
().
pul£_š‹rv®
)));

876 
	gOutgošgChªÃl
::~
OutgošgChªÃl
() {

878 #ifdeà
RES_COUNTER


879 
ä“_id_
++;

884 
	gOutgošgChªÃl
::
AsyncCÚÃù
(cÚ¡ 
¡d
::
¡ršg
 &
ho¡


885 , 
ušt16_t
 
pÜt


886 , 
timeout
)

888 
DLOG
(
INFO
) << "AsyncConnect called";

890 
CHECK_EQ
(
¡©e
(), 
ChªÃl
::
kCÚÃùšg
);

892 
	grc
 = 0;

893 
	g»u£addr
 = 1;

894 
	gk“·live
 = 1;

895 
sockaddr_š
 
	gaddr
;

899 
	gsock‘_
 = ::
sock‘
(
AF_INET
, 
SOCK_STREAM
, 
IPPROTO_TCP
);

900 ià(
	gsock‘_
 == -1) {

901 
DLOG
(
ERROR
è<< "sock‘ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
);

902 
OnCÚÃù
(
”ºo
);

906 
	grc
 = 
evut_make_sock‘_nÚblockšg
(
sock‘_
);

907 ià(
	grc
 == -1) {

908 
LOG
(
ERROR
è<< "£ˆsock‘‚Úblockƒ¼Ü: " << 
¡»¼Ü
(
”ºo
);

909 
OnCÚÃù
(
”ºo
);

913 
£tsockİt
(
sock‘_


914 , 
SOL_SOCKET


915 , 
SO_REUSEADDR


916 , (*)&
»u£addr


917 , (
»u£addr
));

919 
£tsockİt
(
sock‘_


920 , 
SOL_SOCKET


921 , 
SO_KEEPALIVE


922 , (*)&
k“·live


923 , (
k“·live
));

932 
	gaddr
.
	gsš_çmy
 = 
AF_INET
;

933 
	gaddr
.
	gsš_addr
 = 
³”_’dpošt
().
add»ss
().
ToV4
();

934 
	gaddr
.
	gsš_pÜt
 = 
htÚs
(
pÜt
);

936 
	grc
 = 
cÚÃù
(
sock‘_
, (
sockaddr
 *)&
addr
, (sockaddr));

937 ià(
	grc
 != 0) {

938 
”r
 = 
”ºo
;

939 ià(
	g”r
 !ğ
EINPROGRESS
 && 
”r
 !ğ
EWOULDBLOCK
) {

940 
LOG
(
ERROR
è<< "cÚÃùƒ¼Ü: " << 
¡»¼Ü
(
”r
);

941 
Clo£Sock‘
();

942 
OnCÚÃù
(
”r
);

947 #ifdeà
RES_COUNTER


948 
	gCl›Á
::
Im¶
::
Ãxt_id_
++;

951 
DLOG
(
INFO
) << "create‡ writeask,ask size: 0, for connectƒvent";

952 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
cÚn_buff
(
Ãw
 Buffer());

953 
	gwr™e_sk_
.
Re£t
();

954 
	gwr™e_sk_
.
S‘
(
cÚn_buff
, 
sock‘
());

955 
DLOG
(
INFO
) << "call AddEvent with EV_WRITE, in AsyncConnect";

956 
AddEv’t
(
EV_WRITE
);

958 
	gtim”_
.
AsyncWa™
(

959 
boo¡
::
bšd
(&
OutgošgChªÃl
::
OnCÚÃùTimeout
, 
this
, 
owÃr
()),

960 
ut
::
TimeDiff
::
Mli£cÚds
(
timeout
));

963 
	gOutgošgChªÃl
::
O³n
() {

964 
£t_¡©e
(
ChªÃl
::
kCÚÃùšg
);

965 
DoCÚÃù
();

968 
	gOutgošgChªÃl
::
DoCÚÃù
() {

969 ià(
Ãed_»sŞve_
) {

970 
ResŞve
();

972 
CÚÃù
();

976 
	gOutgošgChªÃl
::
RecÚÃù
() {

978 
DLOG
(
INFO
è<< "’‹¸RecÚÃù, s‹: " << 
¡©e
();

980 
CHECK_EQ
(
¡©e
(), 
ChªÃl
::
kCÚÃùšg
);

982 ià(
	gcÚÃù_çu»_
 >ğ
İtiÚs
().
cÚÃù_d–ay_couÁ
) {

983 
D–ayCÚÃù
();

985 
DoCÚÃù
();

989 
	gOutgošgChªÃl
::
D–ayCÚÃù
() {

990 
CHECK_GE
(
cÚÃù_çu»_
, 
İtiÚs
().
cÚÃù_d–ay_couÁ
);

992 
	gn
 = 
İtiÚs
().
cÚÃù_d–ay_time_š™Ÿl
 +

993 
İtiÚs
().
cÚÃù_d–ay_time_¡•
 *

994 (
cÚÃù_çu»_
 - 
İtiÚs
().
cÚÃù_d–ay_couÁ
);

995 
	gn
 = 
¡d
::
mš
(
n
, 
İtiÚs
().
cÚÃù_d–ay_time_fš®
);

996 
	gut
::
TimeDiff
 
timeout
 = 
ut
::TimeDiff::
Mli£cÚds
(
n
);

997 
LOG
(
INFO
è<< "D–ay cÚÃù fÜ " << 
	gn
 << " ms";

999 
DLOG
(
INFO
è<< "OutgošgChªÃl::D–ayCÚÃù c®ÈAsyncWa™, obj: " << &
	gtim”_
;

1000 
	gtim”_
.
AsyncWa™
(

1001 
boo¡
::
bšd
(&
OutgošgChªÃl
::
DoD–ayCÚÃù
, 
this
, 
owÃr
()),

1002 
timeout
);

1005 
	gcÚÃù_d–ay_
 = 
Œue
;

1008 
	gOutgošgChªÃl
::
DoD–ayCÚÃù
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>&) {

1009 
cÚÃù_d–ay_
 = 
çl£
;

1010 
DoCÚÃù
();

1015 
	gOutgošgChªÃl
::
ResŞve
() {

1017 
evdns_ba£
 *
dnsba£
 = 
evdns_ba£_Ãw
(
ev’t_ba£
(), 1);

1018 
CHECK_NOTNULL
(
dnsba£
);

1021 
	gdns_ùx_
 = 
Ãw
 
DnsCtx
(
this
, 
owÃr
(), 
dnsba£
);

1022 
CHECK_NOTNULL
(
dns_ùx_
);

1024 
evut_addršfo
 
	ghšts
;

1025 
mem£t
(&
hšts
, 0, (hints));

1026 
	ghšts
.
	gai_çmy
 = 
AF_UNSPEC
;

1027 
	ghšts
.
	gai_æags
 = 
EVUTIL_AI_CANONNAME
;

1028 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

1029 
	ghšts
.
	gai_´ÙocŞ
 = 
IPPROTO_TCP
;

1031 
DLOG
(
INFO
è<< "ÿÎƒvnds_g‘addršfo,…Œ: " << 
	gthis
;

1032 
	gdns_»q_
 = 
evdns_g‘addršfo
(
dnsba£


1033 , 
ho¡_
.
c_¡r
()

1034 , 
NULL


1035 , &
hšts


1036 , 
OnResŞve


1037 , 
this
);

1039 ià(
	gdns_»q_
 =ğ
NULL
) {

1040 
LOG
(
INFO
è<< "dn »que¡ fÜ " << 
ho¡_
 << "„eturned immediately";

1044 
	gtim”_
.
AsyncWa™
(

1045 
boo¡
::
bšd
(&
OutgošgChªÃl
::
OnResŞveTimeout
, 
this
, 
owÃr
()),

1046 
ut
::
TimeDiff
::
Mli£cÚds
(
İtiÚs
().
»sŞve_timeout
));

1049 
	gOutgošgChªÃl
::
OnResŞveTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
) {

1050 
DLOG
(
INFO
) << "OnResolveTimeout called";

1052 ià(
	gdns_»q_
 !ğ
NULL
) {

1053 
evdns_g‘addršfo_ÿnûl
(
dns_»q_
);

1054 
	gdns_»q_
 = 
NULL
;

1057 
	gcÚÃù_çu»_
++;

1059 
LOG
(
ERROR
è<< 
Çme
() << "DNS„esolveimeout";

1063 
	gOutgošgChªÃl
::
CÚÃù
() {

1064 
DLOG
(
INFO
è<< 
Çme
() << "Connecting...";

1066 
AsyncCÚÃù
(
³”_’dpošt_
.
add»ss
().
ToSŒšg
()

1067 , 
³”_’dpošt_
.
pÜt
()

1068 , 
İtiÚs
().
cÚÃù_timeout
);

1071 
	gOutgošgChªÃl
::
OnCÚÃùTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
) {

1072 
LOG
(
INFO
è<< 
Çme
() << " Connectimeout";

1073 
	gcÚÃù_çu»_
++;

1074 
OnE¼Ü
();

1077 
	gOutgošgChªÃl
::
OnCÚÃù
(
”rÜ
)

1079 
DLOG
(
INFO
) << "enter OnConnect";

1082 
	gwr™e_sk_
.
Re£t
();

1084 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

1085 
tim”_
.
Cªûl
();

1086 
LOG
(
WARNING
è<< 
Çme
() << "Connect canceled because channel is closed";

1090 ià(
	g”rÜ
 !ğ0 || !
FlEndpošts
(
çl£
)) {

1091 
cÚÃù_çu»_
++;

1092 
	gtim”_
.
Cªûl
();

1093 
LOG_IF
(
ERROR
, 
”rÜ
è<< 
Çme
(è<< "CÚÃù faed: " << 
¡»¼Ü
(error);

1094 
OnE¼Ü
();

1098 
	gcÚÃù_çu»_
 = 0;

1099 
LOG
(
INFO
è<< 
Çme
() << "Connected";

1100 
	gtim”_
.
Cªûl
();

1102 
£t_¡©e
(
ChªÃl
::
kCÚÃùed
);

1104 
	gpul£_check”_
->
S¹
();

1105 
	gpul£_em™‹r_
->
S¹
();

1106 
NÙify
(
İtiÚs
().
nÙify_cÚÃùed
);

1109 
DLOG
(
INFO
è<< "ÿÎ AddEv’ˆw™h EV_READ, iÀOnCÚÃù, fd: " << 
sock‘
();

1110 
AddEv’t
(
EV_READ
);

1112 
R—lWr™e
();

1115 
	gOutgošgChªÃl
::
OnPšg
() {

1116 
LOG
(
ERROR
è<< 
Çme
() << "recved…ing message";

1117 
OnE¼Ü
();

1120 
	gOutgošgChªÃl
::
OnPÚg
() {

1121 
pul£_check”_
->
NÙifyIncomšgPul£
();

1122 
	gpul£_em™‹r_
->
NÙifyIncomšgPul£
();

1125 
	gOutgošgChªÃl
::
OnE¼Ü
() {

1127 
DLOG
(
INFO
è<< "’‹¸OnE¼Ü, s‹: " << 
¡©e
();

1129 
CHECK_NE
(
¡©e
(), 
ChªÃl
::
kClo£d
);

1131 
	gChªÃl
::
S‹
 
Şd_¡©e
 = 
¡©e
();

1132 
£t_¡©e
(
ChªÃl
::
kCÚÃùšg
);

1134 ià(
	gŞd_¡©e
 =ğ
ChªÃl
::
kCÚÃùšg
) {

1135 
CË¬OutgošgMsg
();

1136 ià(
	gsock‘_
 != -1) {

1137 #ifdeà
RES_COUNTER


1138 
Cl›Á
::
Im¶
::
ä“_id_
++;

1140 
Clo£Sock‘
();

1142 
	gtim”_
.
Cªûl
();

1143 } ià(
	gŞd_¡©e
 =ğ
ChªÃl
::
kCÚÃùed
) {

1144 
CË¬IncomšgMsg
();

1145 
CË¬OutgošgMsg
();

1146 
	gpul£_check”_
->
Stİ
();

1147 
	gpul£_em™‹r_
->
Stİ
();

1148 ià(
	gsock‘_
 != -1) {

1150 #ifdeà
RES_COUNTER


1151 
Cl›Á
::
Im¶
::
ä“_id_
++;

1153 
Clo£Sock‘
();

1155 ià(
	gŞd_¡©e
 !ğ
¡©e
()) {

1156 
NÙify
(
İtiÚs
().
nÙify_cÚÃùšg
);

1159 
LOG
(
FATAL
è<< 
Çme
(è<< "Inv®id old s‹ = " << 
	gŞd_¡©e
;

1162 
DLOG
(
INFO
è<< "¡©e: " << 
¡©e
();

1164 
RecÚÃù
();

1167 
	gOutgošgChªÃl
::
OnClo£
() {

1168 
LOG
(
INFO
è<< 
Çme
() << " closed";

1169 
CHECK_NE
(
¡©e
(), 
ChªÃl
::
kClo£d
);

1171 
	gChªÃl
::
S‹
 
Şd_¡©e
 = 
¡©e
();

1172 
£t_¡©e
(
ChªÃl
::
kClo£d
);

1174 ià(
	gŞd_¡©e
 =ğ
ChªÃl
::
kCÚÃùšg
) {

1176 
DLOG
(
INFO
) << "OnClose, channel in connecting";

1177 
CË¬OutgošgMsg
();

1179 ià(
	gsock‘_
 != -1) {

1180 #ifdeà
RES_COUNTER


1181 
Cl›Á
::
Im¶
::
ä“_id_
++;

1183 
Clo£Sock‘
();

1185 
	gtim”_
.
Cªûl
();

1187 } ià(
	gŞd_¡©e
 =ğ
ChªÃl
::
kCÚÃùed
) {

1188 
DLOG
(
INFO
) << "OnClose, channel is closed";

1190 
CË¬IncomšgMsg
();

1191 
CË¬OutgošgMsg
();

1192 
	gpul£_check”_
->
Stİ
();

1193 
	gpul£_em™‹r_
->
Stİ
();

1195 ià(
	gsock‘_
 != -1) {

1197 #ifdeà
RES_COUNTER


1198 
Cl›Á
::
Im¶
::
ä“_id_
++;

1200 
Clo£Sock‘
();

1204 
LOG
(
FATAL
è<< 
Çme
(è<< "Inv®id old s‹ = " << 
	gŞd_¡©e
;

1207 
NÙify
(
İtiÚs
().
nÙify_şo£d
);

1209 ià(
	gev’t_ùx_
 !ğ
NULL
) {

1210 
d–‘e
 
ev’t_ùx_
;

1211 
	gev’t_ùx_
 = 
NULL
;

1215 
	gOutgošgChªÃl
::
DoPul£
() {

1216 
DLOG
(
INFO
) << "Ping is sending";

1217 
OutgošgPšg
* 
	gpšg
 = 
Ãw
 OutgošgPšg(
NextOutgošgMsgId
());

1218 
Wr™e
(
pšg
);

1221 
	g¡d
::
¡ršg
 
OutgošgChªÃl
::
Çme
() const {

1222 
¡d
::
¡ršg¡»am
 
ss
;

1223 
	gss
 << '[' << 
id
() << "@"

1224 << 
£lf_’dpošt
().
ToSŒšg
()

1225 << ((
ty³
(è=ğ
ChªÃl
::
kIncomšg
) ? " <- " : " -> ")

1226 << 
³”_’dpošt
().
ToSŒšg
()

1228  
	gss
.
¡r
();

1231 
	gOutgošgChªÃl
::
OnResŞve
(
”rcode


1232 , 
evut_addršfo
 *
addr


1233 , *
±r
)

1235 
DLOG
(
INFO
è<< "OutgošgChªÃl::OnResŞvÿÎed,…Œ: " << 
	g±r
;

1237 
CHECK_NOTNULL
(
±r
);

1238 
OutgošgChªÃl
 *
	goc
 = (OutgošgChªÃÈ*)
±r
;

1239 
CHECK_NOTNULL
(
oc
->
dns_ùx_
);

1241 
DnsCtx
 *
	gdns
 = 
oc
->
dns_ùx_
;

1244 
	gboo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
chªÃl
 = 
oc
->
owÃr
();

1246 ià(
	g”rcode
 != 0) {

1247 ià(
”rcode
 !ğ
EVUTIL_EAI_CANCEL
) {

1248 
oc
->
tim”_
.
Cªûl
();

1249 
LOG
(
ERROR
) << "dns„esolve failed, "

1250 << ",ƒ¼Ü code: " << 
	g”rcode


1251 << ",ƒ¼Ü msg: " << 
evut_gai_¡»¼Ü
(
”rcode
);

1253 
LOG
(
WARNING
) << "dns„esolve cancel, may beimeout";

1257 
DLOG
(
INFO
) << "delete dns ctx";

1258 
evdns_ba£_ä“
(
dns
->
dns_ba£_
, 0);

1259 
	goc
->
	gdns_ùx_
 = 
NULL
;

1260 
d–‘e
 
	gdns
;

1262 
	goc
->
OnE¼Ü
();

1267 ià(
	gaddr
 =ğ
NULL
) {

1268 
LOG
(
ERROR
) << "dns„esolveƒrror,‡ddr can‚ot be‚ull";

1270 
DLOG
(
INFO
) << "delete dns ctx";

1271 
evdns_ba£_ä“
(
dns
->
dns_ba£_
, 0);

1272 
	goc
->
	gdns_ùx_
 = 
NULL
;

1273 
d–‘e
 
	gdns
;

1275 
	goc
->
OnE¼Ü
();

1280 
	goc
->
DoResŞve
(
”rcode
, 
addr
);

1281 
evut_ä“addršfo
(
addr
);

1283 
DLOG
(
INFO
) << "delete dns ctx";

1284 
evdns_ba£_ä“
(
dns
->
dns_ba£_
, 0);

1285 
	goc
->
	gdns_ùx_
 = 
NULL
;

1286 
d–‘e
 
	gdns
;

1289 
DLOG
(
INFO
è<< "OutgošgChªÃl::OnResŞvÿÎed,…Œ: " << 
	g±r
;

1291 
CHECK_NOTNULL
(
±r
);

1292 
OutgošgChªÃl
 *
	goc
 = (OutgošgChªÃÈ*)
±r
;

1293 
CHECK_NOTNULL
(
oc
->
dns_ùx_
);

1296 ià(
	g”rcode
 != 0) {

1297 ià(
”rcode
 !ğ
EVUTIL_EAI_CANCEL
) {

1298 
oc
->
tim”_
.
Cªûl
();

1299 
LOG
(
ERROR
) << "dns„esolve failed, "

1300 << ",ƒ¼Ü code: " << 
	g”rcode


1301 << ",ƒ¼Ü msg: " << 
evut_gai_¡»¼Ü
(
”rcode
);

1303 
LOG
(
WARNING
) << "dns„esolve cancel, may beimeout";

1309 ià(
	gaddr
 =ğ
NULL
) {

1310 
LOG
(
ERROR
) << "dns„esolveƒrror,‡ddr can‚ot be‚ull";

1314 
	goc
->
DoResŞve
(
”rcode
, 
addr
);

1316 
evut_ä“addršfo
(
addr
);

1320 
	gboo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
chªÃl
;

1322 ià(
	goc
->
	gdns_ùx_
 !ğ
NULL
) {

1323 
DLOG
(
INFO
) << "delete dns ctx";

1324 
	gchªÃl
 = 
oc
->
owÃr
();

1325 
evdns_ba£_ä“
(
oc
->
dns_ùx_
->
dns_ba£_
, 0);

1326 
d–‘e
 
	goc
->
	gdns_ùx_
;

1327 
	goc
->
	gdns_ùx_
 = 
NULL
;

1330 
	goc
->
OnE¼Ü
();

1334 
	gOutgošgChªÃl
::
DoResŞve
(
”rcode
, 
evut_addršfo
 *
addr
)

1336 ià(
¡©e
(è=ğ
ChªÃl
::
kClo£d
) {

1337 
tim”_
.
Cªûl
();

1338 
LOG
(
INFO
) << "channel is closed when„esolve host: "

1339 << 
	gho¡_
;

1340 } ià(
	g”rcode
) {

1341 
LOG
(
ERROR
)

1342 << 
³”_’dpošt
().
ToSŒšg
()

1343 << 
evut_gai_¡»¼Ü
(
”rcode
);

1344 
	gcÚÃù_çu»_
++;

1345 
	gtim”_
.
Cªûl
();

1346 
OnE¼Ü
();

1348 
evut_addršfo
 *
	gai
;

1349 ià(
	gaddr
->
	gai_ÿnÚÇme
) {

1350 
LOG
(
INFO
è<< "»sŞvÿnÚ‚amÃ: " << 
	gaddr
->
	gai_ÿnÚÇme
;

1353 
	gai
 = 
addr
;

1354 ià(
	gai
 !ğ
NULL
) {

1355 
buf
[128];

1356 cÚ¡ *
	gs
 = 
NULL
;

1357 ià(
	gai
->
	gai_çmy
 =ğ
AF_INET
) {

1358 
sockaddr_š
 *
sš
 = (sockaddr_š *)
ai
->
ai_addr
;

1359 
	gs
 = 
evut_š‘_Áİ
(
AF_INET
, &
sš
->
sš_addr
, 
buf
, 128);

1361 ià(
	gai
->
	gai_çmy
 =ğ
AF_INET6
) {

1362 
sockaddr_š6
 *
sš6
 = (sockaddr_š6 *)
ai
->
ai_addr
;

1363 
	gs
 = 
evut_š‘_Áİ
(
AF_INET6
, &
sš6
->
sš6_addr
, 
buf
, 128);

1366 
LOG
(
FATAL
) << "invalidcp family";

1370 ià(
	gs
) {

1373 
Add»ss
 
	gaddr
 = Add»ss::
FromSŒšg
(
s
);

1374 ià(!
	gaddr
.
ToU32
()) {

1375 
LOG
(
FATAL
è<< "šv®id„esŞved ip: " << 
	gs
;

1379 
	g³”_’dpošt_
.
£t_add»ss
(
addr
);

1381 
LOG
(
INFO
è<< "ResŞved " << 
	gho¡_
 << " = "

1382 << 
	g³”_’dpošt_
.
ToSŒšg
();

1384 
	gÃed_»sŞve_
 = 
çl£
;

1387 
LOG
(
FATAL
) << "invalid„esolve„esult, host: "

1388 << 
	gho¡_
;

1394 
	gÃed_»sŞve_
 = 
çl£
;

1395 
CÚÃù
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/channel_impl.h

4 #iâdeà
LDD_INTERNAL_CHANNEL_IMPL_H_


5 
	#LDD_INTERNAL_CHANNEL_IMPL_H_


	)

7 
	~<boo¡/ªy.hµ
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<boo¡/scİed_±r.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

11 
	~<boo¡/±r_cÚš”/±r_deque.hµ
>

13 
	~"ldd/Ãt/šcomšg_msg_»gi¡ry.h
"

14 
	~"ldd/Ãt/chªÃl.h
"

15 
	~"ldd/Ãt/ev’t.h
"

16 
	~"ldd/Ãt/’dpošt.h
"

17 
	~"ldd/Ãt/£rv”.h
"

18 
	~"ldd/Ãt/ş›Á.h
"

19 
	~"£rv”_im¶.h
"

20 
	~"ş›Á_im¶.h
"

21 
	~"´ÙocŞ.h
"

22 
	~"sk.h
"

25 
Çme¥aû
 
	gldd
 {

26 
Çme¥aû
 
	gÃt
 {

28 
şass
 
	gOutgošgPack‘
;

29 
şass
 
	gPul£Em™‹r
;

30 
şass
 
	gPul£Check”
;

31 
şass
 
	gOutgošgChªÃl
;

33 şas 
	cEv’tCtx
 {

34 
	gpublic
:

35 
Ev’tCtx
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
> &
owÃr


36 , 
ChªÃl
::
Im¶
 *
im¶
)

37 : 
owÃr_
(
owÃr
)

38 , 
im¶_
(
im¶
)

40 #ifdeà
RES_COUNTER


41 
	gÃxt_id_
++;

45 ~
Ev’tCtx
() {

46 #ifdeà
RES_COUNTER


47 
	gä“_id_
++;

51 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr_
;

52 
	gChªÃl
::
Im¶
 *
im¶_
;

54 #ifdeà
RES_COUNTER


55 
	g´iv©e
:

56 
ä›nd
 
şass
 
St
;

57 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

58 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

59 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

60 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

64 şas 
	cDnsCtx
 {

65 
	gpublic
:

66 
DnsCtx
(
OutgošgChªÃl
 *
oc


67 , cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
> &
owÃr


68 , 
evdns_ba£
 *
dns_ba£
)

69 : 
oc_
(
oc
)

70 , 
owÃr_
(
owÃr
)

71 , 
dns_ba£_
(
dns_ba£
)

73 #ifdeà
RES_COUNTER


74 
	gÃxt_id_
++;

77 ~
DnsCtx
() {

78 #ifdeà
RES_COUNTER


79 
	gä“_id_
++;

83 
OutgošgChªÃl
 *
	goc_
;

84 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr_
;

85 
evdns_ba£
 *
	gdns_ba£_
;

87 #ifdeà
RES_COUNTER


88 
	g´iv©e
:

89 
ä›nd
 
şass
 
St
;

90 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

91 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

92 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

93 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

97 şas 
	cChªÃl
::
Im¶
 {

98 
public
:

99 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

100 
ChªÃl
 
	tOwÃr
;

101 
	gChªÃl
::
	tTy³
 Type;

104 
	gkR—dH—d”
=0,

105 
	gkR—dBody
,

109 
Im¶
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
);

110 
	gvœtu®
 ~
Im¶
();

112 
vœtu®
 
Ty³
 
ty³
() const = 0;

113 
vœtu®
 
O³n
() = 0;

114 
Clo£
();

115 
Clo£Sock‘
();

116 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
() const = 0;

118 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const = 0;

119 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
; }

120 
ev’t_ba£
 *event_base();

121 
S‹
 
¡©e
(ècÚ¡ {  
	g¡©e_
; }

122 
£t_¡©e
(
S‹
 
¡©e
è{ 
	g¡©e_
 = state; }

123 
£t_sock‘
(
sock‘
);

125 
	gH—d”
::
P¬£r
 
h—d”
(è{  
H—d”
::P¬£r(
h—d”_
->
d©a
()); }

127 cÚ¡ 
	gEndpošt
& 
£lf_’dpošt
(ècÚ¡ {  
	g£lf_’dpošt_
; }

128 cÚ¡ 
	gEndpošt
& 
³”_’dpošt
(ècÚ¡ {  
	g³”_’dpošt_
; }

129 
ušt64_t
 
id
(ècÚ¡ {  
	gid_
; }

131 
Po¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
mes§ge
,

132 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

134 
boŞ
 
AddIncomšgMsg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
IncomšgMsg
>& 
šcomšg_msg
);

135 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
G‘IncomšgMsg
(

136 
št32_t
 
id
, 
boŞ
 
»move
 = 
çl£
);

137 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
G‘OutgošgMsg
(

138 
št32_t
 
id
, 
boŞ
 
»move
 = 
çl£
);

139 
Wr™e
(
OutgošgPack‘
* 
·ck‘
);

141 
sock‘
(è{  
	gsock‘_
; }

142 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr
(è{  
owÃr_
->
sh¬ed_äom_this
(); }

144 
št32_t
 
NextOutgošgMsgId
() {

145  (++
	goutgošg_msg_id_
) & 0x7fffffff;

148 
£t_cÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

149 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

151 cÚ¡ 
	gboo¡
::
ªy
& 
cÚ‹xt
() const

152 {  
cÚ‹xt_
; }

154 
vœtu®
 
OnPšg
() = 0;

155 
vœtu®
 
OnPÚg
() = 0;

156 
vœtu®
 
OnE¼Ü
() = 0;

157 
vœtu®
 
OnClo£
() = 0;

158 
vœtu®
 
DoPul£
() = 0;

159 
vœtu®
 
OnCÚÃù
(
”rÜ
) = 0;

161 
OnIncomšgPack‘
();

162 
OnOutgošgPack‘
();

163 
OnPul£Faed
();

165 
	g´Ùeùed
:

166 
ä›nd
 
şass
 
Pack‘R—d”
;

167 
boŞ
 
FlEndpošts
(boŞ 
»mÙe
);

168 
NÙify
(cÚ¡ 
NÙif›r
& 
nÙif›r
);

169 
CË¬IncomšgMsg
();

170 
CË¬OutgošgMsg
();

172 
AddEv’t
(
æag
è{ 
S‘Ev’t
(
ev’ts_
 | flag); }

173 
D–Ev’t
(
æag
è{ 
S‘Ev’t
(
ev’ts_
 & ~flag); }

174 
S‘Ev’t
(
ev’ts
);

176 
OnR—d
();

177 
OnWr™e
();

178 
R—dH—d”
();

179 
R—dBody
();

180 
ProûssPack‘
();

181 
DoWr™e
();

183 
Ev’tNÙify
(
fd
, 
wh©
, *
¬g
);

185 
R—lWr™e
();

187 
	gsock‘_
;

188 
R—dTask
 
	g»ad_h—d”_sk_
;

189 
R—dTask
 
	g»ad_body_sk_
;

190 
Wr™eTask
 
	gwr™e_sk_
;

191 
Ev’tCtx
 *
	gev’t_ùx_
;

193 
	g´iv©e
:

194 
¡d
::
	tm­
<
	tšt32_t
, 
	tboo¡
::
	tsh¬ed_±r
<
	tOutgošgMsg
> > 
	tOutgošgMsgM­
;

195 
	g¡d
::
	tm­
<
	tšt32_t
, 
	tboo¡
::
	tsh¬ed_±r
<
	tIncomšgMsg
> > 
	tIncomšgMsgM­
;

197 
OwÃr
* 
	gowÃr_
;

198 
Ev’tLoİ
* 
	gev’t_loİ_
;

199 
S‹
 
	g¡©e_
;

201 
	gev’ts_
;

202 
	g»ad_¡©e_
;

203 
ev’t
 *
	gsock‘_ev_
;

205 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
h—d”_
;

206 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
·ck‘_
;

207 
	g·ck‘_size_
;

209 
IncomšgMsgM­
 
	gimsgs_
;

210 
OutgošgMsgM­
 
	gomsgs_
;

212 
	gboo¡
::
±r_deque
<
OutgošgPack‘
> 
³ndšg_·ck‘s_
;

213 
	gboo¡
::
±r_veùÜ
<
OutgošgPack‘
> 
wr™šg_·ck‘s_
;

214 
	g¡d
::
deque
<
boo¡
::
sh¬ed_±r
<
Bufãr
> > 
wr™šg_bufãrs_
;

216 
št32_t
 
	goutgošg_msg_id_
;

218 
	gboo¡
::
ªy
 
cÚ‹xt_
;

219 
ušt64_t
 
	gid_
;

221 
	g´Ùeùed
:

222 
Endpošt
 
£lf_’dpošt_
;

223 
Endpošt
 
	g³”_’dpošt_
;

224 
	gboo¡
::
scİed_±r
<
Pul£Em™‹r
> 
pul£_em™‹r_
;

225 
	gboo¡
::
scİed_±r
<
Pul£Check”
> 
pul£_check”_
;

227 
	g´iv©e
:

228 
ut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

231 şas 
	cIncomšgChªÃl
 : 
public
 
ChªÃl
::
Im¶
 {

232 
ChªÃl
::
	tIm¶
 
	tSu³r
;

233 
	gpublic
:

234 
ChªÃl
::
	tTy³
 Type;

235 
IncomšgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

236 
S”v”
::
Im¶
* 
£rv”
);

237 
	gvœtu®
 ~
IncomšgChªÃl
();

238 
vœtu®
 
Ty³
 
ty³
(ècÚ¡ {  
	gChªÃl
::
kIncomšg
; }

239 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const;

241 
vœtu®
 
O³n
();

242 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
(ècÚ¡ {  
	g£rv”_
->
owÃr
(); }

243 
	g´iv©e
:

244 
In™Pul£
();

245 
vœtu®
 
OnPšg
();

246 
vœtu®
 
OnPÚg
();

247 
vœtu®
 
OnE¼Ü
();

248 
vœtu®
 
OnClo£
();

249 
vœtu®
 
DoPul£
();

250 
vœtu®
 
OnCÚÃù
(
”rÜ
) {}

252 cÚ¡ 
	gS”v”
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
£rv”_
->options(); }

253 
	g´iv©e
:

254 
S”v”
::
Im¶
* 
£rv”_
;

256 #ifdeà
RES_COUNTER


257 
	g´iv©e
:

258 
ä›nd
 
şass
 
St
;

259 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

260 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

261 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

262 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

266 şas 
	cOutgošgChªÃl
 : 
public
 
ChªÃl
::
Im¶
 {

267 
public
:

268 
ChªÃl
::
	tIm¶
 
	tSu³r
;

269 
	gChªÃl
::
	tTy³
 Type;

272 
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

273 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

274 
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

275 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
Endpošt
& 
»mÙe
);

276 
	gvœtu®
 ~
OutgošgChªÃl
();

278 
vœtu®
 
Ty³
 
ty³
(ècÚ¡ {  
	gChªÃl
::
kOutgošg
; }

279 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const;

281 
vœtu®
 
O³n
();

282 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
(ècÚ¡ {  
	gş›Á_
->
owÃr
(); }

283 
	g´iv©e
:

284 
In™Pul£
();

285 
vœtu®
 
OnPšg
();

286 
vœtu®
 
OnPÚg
();

287 
vœtu®
 
OnE¼Ü
();

288 
vœtu®
 
OnClo£
();

289 
vœtu®
 
DoPul£
();

291 
DoCÚÃù
();

292 
RecÚÃù
();

293 
ResŞve
();

294 
OnResŞveTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
);

295 
OnResŞve
(
”rcode


296 , 
evut_addršfo
 *
addr


297 , *
±r
);

298 
DoResŞve
(
”rcode
, 
evut_addršfo
 *
addr
);

299 
CÚÃù
();

300 
OnCÚÃùTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
);

301 
vœtu®
 
OnCÚÃù
(
”rÜ
);

303 
AsyncCÚÃù
(cÚ¡ 
¡d
::
¡ršg
 &
ho¡


304 , 
ušt16_t
 
pÜt


305 , 
timeout
);

307 
D–ayCÚÃù
();

308 
DoD–ayCÚÃù
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>&);

310 cÚ¡ 
	gCl›Á
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
ş›Á_
->options(); }

312 
	g´iv©e
:

313 
Cl›Á
::
Im¶
* 
ş›Á_
;

314 
Tim”Ev’t
 
	gtim”_
;

316 
	g¡d
::
¡ršg
 
ho¡_
;

317 
ušt16_t
 
	gpÜt_
;

318 
boŞ
 
	gÃed_»sŞve_
;

319 
	gcÚÃù_çu»_
;

320 
boŞ
 
	gcÚÃù_d–ay_
;

321 
evdns_g‘addršfo_»que¡
 *
	gdns_»q_
;

322 
DnsCtx
 *
	gdns_ùx_
;

324 #ifdeà
RES_COUNTER


325 
	g´iv©e
:

326 
ä›nd
 
şass
 
St
;

327 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

328 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

329 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

330 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/client_impl.cc

4 
	~"ş›Á_im¶.h
"

5 
	~"ev’t_loİ_im¶.h
"

6 
	~"chªÃl_im¶.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gÇme¥aû
 {

13 cÚ¡ 
	gkDeçuÉPul£IÁ”v®
 = 100;

14 cÚ¡ 
	gkDeçuÉResŞveTimeout
 = 10;

15 cÚ¡ 
	gkDeçuÉCÚÃùTimeout
 = 10;

16 cÚ¡ 
	gkDeçuÉCÚÃùD–ayCouÁ
 = 3;

17 cÚ¡ 
	gkDeçuÉCÚÃùD–ayTimeIn™Ÿl
 = 100;

18 cÚ¡ 
	gkDeçuÉCÚÃùD–ayTimeFš®
 = 2000;

19 cÚ¡ 
	gkDeçuÉCÚÃùD–ayTimeS‹p
 = 100;

20 cÚ¡ 
	gkDeçuÉSock‘R—dBufãrSize
 = 4;

22 
	gCl›Á
::
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
Cl›Á
::O±iÚs& 
İtiÚs
) {

23 
Cl›Á
::
O±iÚs
 
o
(
İtiÚs
);

24 ià(
	go
.
	gpul£_š‹rv®
 <= 0) {

25 
o
.
pul£_š‹rv®
 = 
kDeçuÉPul£IÁ”v®
;

27 ià(
	go
.
	g»sŞve_timeout
 <= 0) {

28 
o
.
»sŞve_timeout
 = 
kDeçuÉResŞveTimeout
;

30 ià(
	go
.
	gcÚÃù_timeout
 <= 0) {

31 
o
.
cÚÃù_timeout
 = 
kDeçuÉCÚÃùTimeout
;

33 ià(
	go
.
	gcÚÃù_d–ay_couÁ
 <= 0) {

34 
o
.
cÚÃù_d–ay_couÁ
 = 
kDeçuÉCÚÃùD–ayCouÁ
;

36 ià(
	go
.
	gcÚÃù_d–ay_time_š™Ÿl
 <= 0) {

37 
o
.
cÚÃù_d–ay_time_š™Ÿl
 = 
kDeçuÉCÚÃùD–ayTimeIn™Ÿl
;

39 ià(
	go
.
	gcÚÃù_d–ay_time_fš®
 <= 0) {

40 
o
.
cÚÃù_d–ay_time_fš®
 = 
kDeçuÉCÚÃùD–ayTimeFš®
;

42 ià(
	go
.
	gcÚÃù_d–ay_time_¡•
 <= 0) {

43 
o
.
cÚÃù_d–ay_time_¡•
 = 
kDeçuÉCÚÃùD–ayTimeS‹p
;

46  
	go
;

51 #ifdeà
RES_COUNTER


52 
	gut
::
Atomic
<
ušt64_t
> 
Cl›Á
::
Im¶
::
Ãxt_id_
;

53 
	gut
::
Atomic
<
ušt64_t
> 
Cl›Á
::
Im¶
::
ä“_id_
;

56 
	gCl›Á
::
O±iÚs
::Options()

57 : 
pul£_š‹rv®
(
kDeçuÉPul£IÁ”v®
),

58 
pul£_»Ïxed_checkšg
(
çl£
),

59 
pul£_Ïzy_em™tšg
(
çl£
),

60 
»sŞve_timeout
(
kDeçuÉResŞveTimeout
),

61 
cÚÃù_timeout
(
kDeçuÉCÚÃùTimeout
),

62 
cÚÃù_d–ay_couÁ
(
kDeçuÉCÚÃùD–ayCouÁ
),

63 
cÚÃù_d–ay_time_š™Ÿl
(
kDeçuÉCÚÃùD–ayTimeIn™Ÿl
),

64 
cÚÃù_d–ay_time_fš®
(
kDeçuÉCÚÃùD–ayTimeFš®
),

65 
cÚÃù_d–ay_time_¡•
(
kDeçuÉCÚÃùD–ayTimeS‹p
),

66 
nÙify_cÚÃùed
(
NULL
),

67 
nÙify_cÚÃùšg
(
NULL
),

68 
nÙify_şo£d
(
NULL
),

69 
sock‘_»ad_bufãr_size
(
kDeçuÉSock‘R—dBufãrSize
)

73 
	gCl›Á
::
Im¶
::Im¶(
Cl›Á
* 
ş›Á
, cÚ¡ Cl›Á::
O±iÚs
& 
İtiÚs
)

74 : 
ş›Á_
(
ş›Á
),

75 
İtiÚs_
(
Sª™izeO±iÚs
(
İtiÚs
))

79 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
Cl›Á
::
Im¶
::
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

80 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
) {

81 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl
 =

82 
boo¡
::
make_sh¬ed
<
ChªÃl
>(
ev’t_loİ
, 
	gthis
, 
	gho¡
, 
	gpÜt
);

83 
	gchªÃl
->
	gim¶_
->
O³n
();

84  
	gchªÃl
;

87 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
Cl›Á
::
Im¶
::
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

88 cÚ¡ 
Endpošt
& 
»mÙe
) {

89 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl
 =

90 
boo¡
::
make_sh¬ed
<
ChªÃl
>(
ev’t_loİ
, 
	gthis
, 
	g»mÙe
);

91 
	gchªÃl
->
	gim¶_
->
O³n
();

92  
	gchªÃl
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/client_impl.h

4 #iâdeà
LDD_NET_INTERNAL_CLIENT_IMPL_H_


5 
	#LDD_NET_INTERNAL_CLIENT_IMPL_H_


	)

7 
	~"ldd/Ãt/ş›Á.h
"

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 şas 
	cCl›Á
::
Im¶
 {

13 
public
:

14 
Im¶
(
Cl›Á
* 
ş›Á
, cÚ¡ Cl›Á::
O±iÚs
& 
İtiÚs
);

16 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

17 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

18 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

19 cÚ¡ 
Endpošt
& 
»mÙe
);

21 
Cl›Á
* 
owÃr
(ècÚ¡ {  
	gş›Á_
; }

22 cÚ¡ 
	gCl›Á
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
İtiÚs_
; }

24 
	g´iv©e
:

25 
Cl›Á
* 
ş›Á_
;

26 
	gCl›Á
::
O±iÚs
 
İtiÚs_
;

28 #ifdeà
RES_COUNTER


29 
	g´iv©e
:

31 
ä›nd
 
şass
 
St
;

32 
ä›nd
 
şass
 
	gOutgošgChªÃl
;

33 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

34 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

35 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

36 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_impl.cc

4 
	~<glog/loggšg.h
>

5 
	~<ev’t2/ev’t.h
>

7 
	~<boo¡/sh¬ed_±r.hµ
>

8 
	~<boo¡/make_sh¬ed.hµ
>

9 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

10 
	~<boo¡/bšd.hµ
>

12 
	~"ldd/ut/time¡amp.h
"

13 
	~"ev’t_im¶.h
"

15 
Çme¥aû
 
	gldd
 {

16 
Çme¥aû
 
	gÃt
 {

18 
usšg
 
Çme¥aû
 
	gboo¡
;

20 #ifdeà
RES_COUNTER


21 
	gut
::
Atomic
<
ušt64_t
> 
FdEv’t
::
Im¶
::
Ãxt_id_
;

22 
	gut
::
Atomic
<
ušt64_t
> 
FdEv’t
::
Im¶
::
ä“_id_
;

24 
	gut
::
Atomic
<
ušt64_t
> 
Tim”Ev’t
::
Im¶
::
Ãxt_id_
;

25 
	gut
::
Atomic
<
ušt64_t
> 
Tim”Ev’t
::
Im¶
::
ä“_id_
;

27 
	gut
::
Atomic
<
ušt64_t
> 
SigÇlEv’t
::
Im¶
::
Ãxt_id_
;

28 
	gut
::
Atomic
<
ušt64_t
> 
SigÇlEv’t
::
Im¶
::
ä“_id_
;

31 
	gFdEv’t
::
Im¶
::Im¶(
Ev’tLoİ
::Im¶* 
loİ
)

32 : 
loİ_
(
loİ
)

33 , 
ev_
(
NULL
)

34 , 
time_æag_
(
kNoTime
)

35 , 
æags_
(0)

36 , 
aùive_
(
çl£
)

38 #ifdeà
RES_COUNTER


39 
	gÃxt_id_
++;

43 
	gFdEv’t
::
Im¶
::~Impl() {

44 
DLOG
(
INFO
) << "FdEvent::Impl::~Impl called, call Cancel";

45 #ifdeà
RES_COUNTER


46 
	gä“_id_
++;

48 
Cªûl
();

51 
	gFdEv’t
::
Im¶
::
S¹
(
fd
, 
ev’ts
) {

53 
DLOG
(
INFO
è<< "FdEv’ˆS¹ c®Ëd, fd: " << 
	gfd
;

55 ià((
	gev’ts
 & (
	gkR—dabË
 | 
	gkWr™abË
)) == 0 ) {

56 
LOG
(
WARNING
è<< "šv®idƒv’ts,ƒv’ts: " << 
ev’ts
;

60 
Cªûl
();

62 ià(
	gfd
 >= 0) {

63 
e
 = 0;

64 ià(
	gev’ts
 & 
	gkR—dabË
) {

65 
DLOG
(
INFO
è<< "¡¬ˆw™h„—dƒv’t, fd: " << 
	gfd
;

66 
	ge
 |ğ
EV_READ
;

69 ià(
	gev’ts
 & 
	gkWr™abË
) {

70 
DLOG
(
INFO
è<< "¡¬ˆw™h wr™ev’t, fd: " << 
	gfd
;

71 
	ge
 |ğ
EV_WRITE
;

74 
	gev_
 = 
ev’t_Ãw
(
loİ_
->
ev’t_ba£
()

75 , 
fd


76 , 
e


77 , 
NÙify


78 , (*)
this
);

79 
CHECK_NOTNULL
(
ev_
);

81 
DLOG
(
INFO
è<< "ev’t_Ãw c®Ëd,ƒv_ : " << 
	gev_
;

83 ià(
	gtime_æag_
 =ğ
kNoTime
) {

84 
DLOG
(
INFO
è<< "¡¬ˆev’ˆw™h‚Øtime, fd: " << 
fd
;

85 
	grc
 = 
ev’t_add
(
ev_
, 
NULL
);

86 ià(
	grc
 != 0) {

87 
LOG
(
FATAL
) << "event_addƒrror";

92 
timev®
 
	gtv
;

93 ià(
	gtime_æag_
 =ğ
kTimeDiff
) {

94 
time_diff_
.
To
(&
tv
);

95 
DLOG
(
INFO
) << "startƒvent withime diff: "

96 << 
	gtime_diff_
.
ToMli£cÚds
()

97 << ", fd: " << 
	gfd
;

99 ià(
	gtime_æag_
 =ğ
FdEv’t
::
Im¶
::
kTime¡amp
) {

100 
ldd
::
ut
::
TimeDiff
 
td


101 ğ
time_¡amp_
 - 
ldd
::
ut
::
Time¡amp
::
Now
();;

102 
DLOG
(
INFO
) << "startƒvent withime stamp: "

103 << 
	gtd
.
ToMli£cÚds
()

104 << ", fd: " << 
	gfd
;

106 
	gtd
.
To
(&
tv
);

109 
LOG
(
FATAL
) << "invalueimeype";

113 
	grc
 = 
ev’t_add
(
ev_
, &
tv
);

114 ià(
	grc
 != 0) {

115 
LOG
(
FATAL
) << "event_addƒrror";

120 
	gaùive_
 = 
Œue
;

125 
LOG
(
FATAL
è<< "šv®id fd: " << 
	gfd
;

130 
	gFdEv’t
::
Im¶
::
Cªûl
() {

132 
DLOG
(
INFO
) << "FdEvent Cancel called";

134 ià(!
	gaùive_
) {

139 
	gaùive_
 = 
çl£
;

141 ià(
	gev_
 !ğ
NULL
) {

142 
DLOG
(
INFO
è<< "ÿÎƒv’t_d–‡ndƒv’t_ä“,ƒv_: " << 
ev_
;

143 
	grc
 = 
ev’t_d–
(
ev_
);

144 ià(
	grc
 != 0) {

145 
LOG
(
FATAL
) << "event_addƒrror";

148 
ev’t_ä“
(
ev_
);

149 
	gev_
 = 
NULL
;

152 
DLOG
(
INFO
) << "ev_ is NULL,‚othingo do";

155 
	ghªdËr_
 = 
NULL
;

156 
	gtime_æag_
 = 
kNoTime
;

159 
	gFdEv’t
::
Im¶
::
NÙify
(
fd
, 
wh©
, *
¬g
) {

161 
CHECK_NOTNULL
(
¬g
);

165 
	gFdEv’t
::
Im¶
 *
£lf
 = 
¡©ic_ÿ¡
<
FdEv’t
::Im¶ *>(
¬g
);

167 ià(
	gwh©
 & 
	gEV_READ
) {

168 
DLOG
(
INFO
è<< "»adƒv’ˆoccu»d, fd: " << 
	gfd
;

169 
	g£lf
->
	gæags_
 |ğ
kR—dabË
;

171 ià(
	gwh©
 & 
	gEV_WRITE
) {

172 
DLOG
(
INFO
è<< "wr™ev’ˆoccu»d, fd: " << 
	gfd
;

173 
	g£lf
->
	gæags_
 |ğ
kWr™abË
;

175 ià(
	gwh©
 & 
	gEV_TIMEOUT
) {

176 
DLOG
(
INFO
è<< "timeouˆev’ˆoccu»d, fd: " << 
	gfd
;

179 
LOG
(
FATAL
è<< "šv®idƒv’ˆty³:" << 
	gwh©


180 << ", fd: " << 
	gfd
;

186 
	gŒy
 {

187 
DLOG
(
INFO
) << "active: "

188 << 
	g£lf
->
	gaùive_


189 << ", fd: " << 
	gfd
;

191 ià(
	g£lf
->
	gaùive_
) {

192 
DLOG
(
INFO
è<< "NÙify c®ÈhªdËr, fd: " << 
	gfd
;

193 
	g£lf
->
hªdËr_
(
£lf
->
æags_
);

196 
DLOG
(
WARNING
è<< "FDEv’t, NÙify‚ÙhšgØdo, fd: " << 
	gfd
;

199 } 
ÿtch
 (cÚ¡ 
¡d
::
exû±iÚ
& 
e
) {

200 
LOG
(
FATAL
è<< "FdEv’ˆhªdË¸exû±iÚ: " << 
e
.
wh©
();

201 } 
ÿtch
 (...) {

202 
LOG
(
FATAL
) << "FdEvent handlerƒrror";

208 
	gFdEv’t
::
Im¶
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
) {

209 
CHECK
(
hªdËr
 !ğ
NULL
);

210 
DLOG
(
INFO
è<< "FdEv’ˆAsyncWa™ w™h‚Øtime, fd: " << 
	gfd
;

212 ià(
	gaùive_
) {

213 
Cªûl
();

216 
	gtime_æag_
 = 
kNoTime
;

217 
	ghªdËr_
 = 
hªdËr
;

219 
S¹
(
fd
, 
ev’ts
);

222 
	gFdEv’t
::
Im¶
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

223 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
) {

224 
CHECK
(
hªdËr
 !ğ
NULL
);

225 
DLOG
(
INFO
è<< "FdEv’ˆAsyncWa™ w™hime¡amp, fd: " << 
	gfd
;

227 ià(
	gaùive_
) {

228 
Cªûl
();

231 
	gtime_¡amp_
 = 
timeout
;

232 
	gtime_æag_
 = 
kTime¡amp
;

233 
	ghªdËr_
 = 
hªdËr
;

235 
S¹
(
fd
, 
ev’ts
);

238 
	gFdEv’t
::
Im¶
::
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

239 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

241 
CHECK
(
hªdËr
 !ğ
NULL
);

243 
DLOG
(
INFO
è<< "FdEv’ˆAsyncWa™ w™himediff, fd: " << 
	gfd
;

244 ià(
	gaùive_
) {

245 
Cªûl
();

248 
	gtime_diff_
 = 
timeout
;

249 
	gtime_æag_
 = 
kTimeDiff
;

250 
	ghªdËr_
 = 
hªdËr
;

252 
S¹
(
fd
, 
ev’ts
);

256 
	gTim”Ev’t
::
Im¶
::Im¶(
Ev’tLoİ
::Im¶* 
loİ
)

257 : 
loİ_
(
loİ
)

258 , 
tim”_ev_
(
NULL
)

259 , 
time_æag_
(
kNoTime
)

260 , 
aùive_
(
çl£
)

262 #ifdeà
RES_COUNTER


263 
	gÃxt_id_
++;

267 
	gTim”Ev’t
::
Im¶
::~Impl() {

268 #ifdeà
RES_COUNTER


269 
ä“_id_
++;

271 
Cªûl
();

274 
	gTim”Ev’t
::
Im¶
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

275 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
) {

276 
CHECK
(
hªdËr
 !ğ
NULL
);

278 
Cªûl
();

280 
	gtime_¡amp_
 = 
timeout
;

281 
	gtime_æag_
 = 
kTime¡amp
;

282 
	ghªdËr_
 = 
hªdËr
;

284 
DLOG
(
INFO
) << "AsyncWait withimestamp, call start, stamp: "

285 << 
	gtime_¡amp_
.
ToSecÚds
();

286 
S¹
();

289 
	gTim”Ev’t
::
Im¶
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

290 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
) {

292 
CHECK
(
hªdËr
 !ğ
NULL
);

294 
Cªûl
();

296 
	gtime_diff_
 = 
timeout
;

297 
	gtime_æag_
 = 
kTimeDiff
;

298 
	g¡¬t_¡amp_
 = 
ldd
::
ut
::
Time¡amp
::
Now
();

299 
	ghªdËr_
 = 
hªdËr
;

301 
DLOG
(
INFO
) << "AsyncWait withimediff, call start,imeout: "

302 << 
	gtime_diff_
.
ToMli£cÚds
();

304 
S¹
();

307 
	gTim”Ev’t
::
Im¶
::
S¹
() {

311 ià(
aùive_
) {

312 
LOG
(
FATAL
è<< "»³©ed c®È¡¬ˆobj: " << 
this
;

316 
	gtim”_ev_
 = 
evtim”_Ãw
(
loİ_
->
ev’t_ba£
()

317 , 
OnTim”


318 , (*)
this
);

320 
CHECK_NOTNULL
(
tim”_ev_
);

322 
timev®
 
	gtv
;

324 ià(
	gtime_æag_
 =ğ
kTimeDiff
) {

325 
time_diff_
.
To
(&
tv
);

327 ià(
	gtime_æag_
 =ğ
kTime¡amp
) {

328 
ldd
::
ut
::
TimeDiff
 
td


329 ğ(
time_¡amp_
 - 
ldd
::
ut
::
Time¡amp
::
Now
());

330 
	gtd
.
To
(&
tv
);

333 
LOG
(
FATAL
) << "invalidimeype";

336 
evtim”_add
(
tim”_ev_
, &
tv
);

338 
	gaùive_
 = 
Œue
;

341 
	gTim”Ev’t
::
Im¶
::
Cªûl
() {

345 ià(!
aùive_
) {

350 
	gaùive_
 = 
çl£
;

352 ià(
	gtim”_ev_
 !ğ
NULL
) {

353 
rc
 = 
evtim”_d–
(
tim”_ev_
);

354 ià(
	grc
 != 0) {

355 
LOG
(
FATAL
) << "evtimer_delƒrror";

358 
ev’t_ä“
(
tim”_ev_
);

359 
	gtim”_ev_
 = 
NULL
;

362 
	gtime_æag_
 = 
kNoTime
;

363 
	ghªdËr_
 = 
NULL
;

366 
boŞ
 
	gTim”Ev’t
::
Im¶
::
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
) {

367 ià(
time_æag_
 =ğ
kTime¡amp
) {

368 *
time
 = 
time_¡amp_
;

370 ià(
	gtime_æag_
 =ğ
kTimeDiff
) {

371 *
time
 = (
¡¬t_¡amp_
 +ğ
time_diff_
);

374  
	gŒue
;

377 
	gTim”Ev’t
::
Im¶
::
OnTim”
(
fd
, 
wh©
, *
¬g
) {

378 
CHECK_NOTNULL
(
¬g
);

380 
	gTim”Ev’t
::
Im¶
 *
£lf
 = 
¡©ic_ÿ¡
<
Tim”Ev’t
::Im¶ *>(
¬g
);

391 ià(!(
	gwh©
 & 
	gEV_TIMEOUT
)) {

392 
LOG
(
FATAL
) << "notime outƒvent";

396 
	g£lf
->
	gaùive_
 = 
çl£
;

397 ià(
	g£lf
->
	gtim”_ev_
 !ğ
NULL
) {

398 
rc
 = 
evtim”_d–
(
£lf
->
tim”_ev_
);

399 ià(
	grc
 != 0) {

400 
LOG
(
FATAL
) << "evtimer_delƒrror";

403 
ev’t_ä“
(
£lf
->
tim”_ev_
);

404 
	g£lf
->
	gtim”_ev_
 = 
NULL
;

407 
	g£lf
->
hªdËr_
();

413 
	gSigÇlEv’t
::
Im¶
::Im¶(
Ev’tLoİ
::Im¶* 
loİ
)

414 : 
loİ_
(
loİ
)

415 , 
tim”_ev_
(
NULL
)

417 #ifdeà
RES_COUNTER


418 
	gÃxt_id_
++;

422 
	gSigÇlEv’t
::
Im¶
::~Impl()

424 #ifdeà
RES_COUNTER


425 
ä“_id_
++;

427 
CË¬
();

430 
boŞ
 
	gSigÇlEv’t
::
Im¶
::
Add
(
signo
) {

432 
¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
 
pos
 = 
sig_ev_
.
fšd
(
signo
);

433 ià(
	gpos
 !ğ
sig_ev_
.
’d
()) {

434 
LOG
(
ERROR
è<< "»³©ed‡dd sigÇl: " << 
signo
;

435  
	gçl£
;

438 
ev’t
 *
	gsig_ev
 = 
evsigÇl_Ãw
(
loİ_
->
ev’t_ba£
()

439 , 
signo


440 , 
OnSigÇl


441 , (*)
this
);

443 
CHECK_NOTNULL
(
sig_ev
);

445 
	g¡d
::
·œ
<
¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
, 
	gboŞ
> 
	g»t
;

446 
	g»t
 = 
sig_ev_
.
š£¹
(
¡d
::
make_·œ
(
signo
, 
sig_ev
));

447 ià(
	g»t
.
	g£cÚd
 =ğ
çl£
) {

448 
LOG
(
ERROR
è<< "add sigÇÈev’ˆçed, sigÇÈno: " << 
signo
;

449  
	gçl£
;

452  
	gŒue
;

455 
boŞ
 
	gSigÇlEv’t
::
Im¶
::
Remove
(
signo
) {

457 
¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
 
pos
 = 
sig_ev_
.
fšd
(
signo
);

458 ià(
	gpos
 =ğ
sig_ev_
.
’d
()) {

459 
LOG
(
ERROR
è<< "»mvÛ sigÇÈ" << 
signo
 << " failed, it is‚otƒxist";

460  
	gçl£
;

463 
evsigÇl_d–
(
pos
->
£cÚd
);

464 
ev’t_ä“
(
pos
->
£cÚd
);

466 
	gsig_ev_
.
”a£
(
pos
);

468  
	gŒue
;

471 
boŞ
 
	gSigÇlEv’t
::
Im¶
::
CË¬
() {

473 ià(
tim”_ev_
 !ğ
NULL
) {

474 
rc
 = 
evtim”_d–
(
tim”_ev_
);

475 ià(
	grc
 != 0) {

476 
LOG
(
FATAL
) << "evtimer_delƒrror";

477  
	gçl£
;

479 
ev’t_ä“
(
tim”_ev_
);

480 
	gtim”_ev_
 = 
NULL
;

483 
	g¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
 
™
;

484 
	g™
 = 
sig_ev_
.
begš
(); iˆ!ğsig_ev_.
’d
(); it++) {

485 
evsigÇl_d–
(
™
->
£cÚd
);

486 
ev’t_ä“
(
™
->
£cÚd
);

489 
	gsig_ev_
.
ş—r
();

491 
	ghªdËr_
 = 
NULL
;

493  
	gŒue
;

496 
	gSigÇlEv’t
::
Im¶
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
)

498 
hªdËr_
 = 
hªdËr
;

500 
	g¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
 
™
;

501 
	g™
 = 
sig_ev_
.
begš
(); iˆ!ğsig_ev_.
’d
(); it++) {

502 
	grc
 = 
evsigÇl_add
(
™
->
£cÚd
, 
NULL
);

503 ià(
	grc
 != 0) {

504 
LOG
(
FATAL
) << "evsignal_addƒrror";

510 
	gSigÇlEv’t
::
Im¶
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

511 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
)

513 
ldd
::
ut
::
TimeDiff
 
time_diff


514 ğ(
timeout
 - 
ldd
::
ut
::
Time¡amp
::
Now
());

515 
timev®
 
	gtv
;

516 
	gtime_diff
.
To
(&
tv
);

518 
	gtim”_ev_
 = 
evtim”_Ãw
(
loİ_
->
ev’t_ba£
()

519 , 
OnTim”


520 , (*)
this
);

521 
CHECK_NOTNULL
(
tim”_ev_
);

523 
	ghªdËr_
 = 
hªdËr
;

524 
evtim”_add
(
tim”_ev_
, &
tv
);

526 
AsyncWa™
(
hªdËr
);

529 
	gSigÇlEv’t
::
Im¶
::
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

530 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
)

532 
timev®
 
tv
;

533 
	gtimeout
.
To
(&
tv
);

534 
	gtim”_ev_
 = 
evtim”_Ãw
(
loİ_
->
ev’t_ba£
()

535 , 
OnTim”


536 , (*)
this
);

538 
CHECK_NOTNULL
(
tim”_ev_
);

540 
	ghªdËr_
 = 
hªdËr
;

541 
evtim”_add
(
tim”_ev_
, &
tv
);

543 
AsyncWa™
(
hªdËr
);

546 
	gSigÇlEv’t
::
Im¶
::
Cªûl
()

548 
CË¬
();

551 
	gSigÇlEv’t
::
Im¶
::
OnSigÇl
(
fd
, 
wh©
, *
¬g
)

553 
CHECK_NOTNULL
(
¬g
);

555 
	gsig
 = 
fd
;

556 
	gSigÇlEv’t
::
Im¶
 *
£lf
 = 
¡©ic_ÿ¡
<
SigÇlEv’t
::Im¶ *>(
¬g
);

558 
	g¡d
::
m­
<, 
	gev’t
 *>::
™”©Ü
 
pos
 = 
£lf
->
sig_ev_
.
fšd
(
sig
);

559 ià(
	gpos
 =ğ
£lf
->
sig_ev_
.
’d
()) {

560 
LOG
(
ERROR
è<< "»cv uÄegi¡”ed sigÇl: " << 
sig
;

564 
	g£lf
->
hªdËr_
(
sig
);

567 
	gSigÇlEv’t
::
Im¶
::
OnTim”
(
fd
, 
wh©
, *
¬g
)

569 
CHECK_NOTNULL
(
¬g
);

571 
	gSigÇlEv’t
::
Im¶
 *
£lf
 = 
¡©ic_ÿ¡
<
SigÇlEv’t
::Im¶ *>(
¬g
);

573 
	g£lf
->
hªdËr_
(0);

575 
	g£lf
->
CË¬
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_impl.h

4 #iâdeà
LDD_NET_INTERNAL_EVENT_IMPL_H_


5 
	#LDD_NET_INTERNAL_EVENT_IMPL_H_


	)

7 
	~<ev’t2/ev’t.h
>

9 
	~<£t
>

10 
	~<m­
>

12 
	~<boo¡/sh¬ed_±r.hµ
>

13 
	~<boo¡/w—k_±r.hµ
>

14 
	~"ldd/Ãt/ev’t.h
"

15 
	~"ev’t_loİ_im¶.h
"

17 
Çme¥aû
 
	gldd
 {

18 
Çme¥aû
 
	gÃt
 {

20 şas 
	cFdEv’t
::
Im¶
 {

21 cÚ¡ 
kTimedOut
 = 4;

22 
	gpublic
:

23 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

24 ~
Im¶
();

27 
	gkNoTime
 = 0,

28 
	gkTimeDiff
,

29 
	gkTime¡amp


32 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
);

33 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

34 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

35 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

36 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

37 
Cªûl
();

39 
	g´Ùeùed
:

40 
S¹
(
fd
, 
ev’ts
);

41 
NÙify
(
fd
, 
wh©
, *
¬g
);

43 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

45 
ev’t
 *
	gev_
;

47 
	gldd
::
ut
::
TimeDiff
 
time_diff_
;

48 
	gldd
::
ut
::
Time¡amp
 
time_¡amp_
;

50 
	gtime_æag_
;

52 
FunùÜ
 
	ghªdËr_
;

53 
št8_t
 
	gæags_
;

54 
boŞ
 
	gaùive_
;

56 #ifdeà
RES_COUNTER


57 
	g´iv©e
:

58 
ä›nd
 
şass
 
St
;

59 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

60 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

61 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

62 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

66 şas 
	cTim”Ev’t
::
Im¶
 {

67 
public
:

68 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

69 ~
Im¶
();

72 
	gkNoTime
 = 0,

73 
	gkTimeDiff
,

74 
	gkTime¡amp


77 
boŞ
 
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
);

78 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

79 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

80 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

81 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

82 
Cªûl
();

84 
	g´iv©e
:

85 
S¹
();

86 
OnTim”
(
fd
, 
wh©
, *
¬g
);

88 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

90 
ev’t
 *
	gtim”_ev_
;

91 
	gldd
::
ut
::
TimeDiff
 
time_diff_
;

92 
	gldd
::
ut
::
Time¡amp
 
time_¡amp_
;

93 
	gtime_æag_
;

95 
	gldd
::
ut
::
Time¡amp
 
¡¬t_¡amp_
;

97 
FunùÜ
 
	ghªdËr_
;

98 
boŞ
 
	gaùive_
;

100 #ifdeà
RES_COUNTER


101 
	g´iv©e
:

102 
ä›nd
 
şass
 
St
;

103 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

104 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

105 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

106 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

110 şas 
	cSigÇlEv’t
::
Im¶
 {

111 
public
:

112 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

113 ~
Im¶
();

115 
boŞ
 
Add
(
signo
);

116 
boŞ
 
Remove
(
signo
);

117 
boŞ
 
CË¬
();

119 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
);

120 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

121 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

122 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

123 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

124 
Cªûl
();

126 
	g´iv©e
:

127 
OnSigÇl
(
fd
, 
wh©
, *
¬g
);

128 
OnTim”
(
fd
, 
wh©
, *
¬g
);

130 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

131 
ev’t
 *
	gtim”_ev_
;

132 
	g¡d
::
m­
<, 
	gev’t
 *> 
	gsig_ev_
;

134 
FunùÜ
 
	ghªdËr_
;

136 #ifdeà
RES_COUNTER


137 
	g´iv©e
:

138 
ä›nd
 
şass
 
St
;

139 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

140 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

141 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

142 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_loop_impl.cc

4 
	~<uni¡d.h
>

5 
	~<glog/loggšg.h
>

6 
	~<ev’t2/ev’t.h
>

7 
	~<ev’t2/ut.h
>

8 
	~<boo¡/bšd.hµ
>

9 
	~"ev’t_loİ_im¶.h
"

12 
Çme¥aû
 
	gldd
 {

13 
Çme¥aû
 
	gÃt
 {

15 #ifdeà
RES_COUNTER


16 
	gut
::
Atomic
<
ušt64_t
> 
Ev’tLoİ
::
Im¶
::
Ãxt_id_
;

17 
	gut
::
Atomic
<
ušt64_t
> 
Ev’tLoİ
::
Im¶
::
ä“_id_
;

20 
	gEv’tLoİ
::
Im¶
::Impl()

21 : 
»ad_fd_
(
fd_
[0])

22 , 
wr™e_fd_
(
fd_
[1])

23 , 
tid_
(0)

25 
	gev’t_ba£_
 = 
ev’t_ba£_Ãw
();

26 
CHECK_NOTNULL
(
ev’t_ba£_
);

28 
In™
();

31 
	gEv’tLoİ
::
Im¶
::Im¶(::
ev’t_ba£
 *
ba£
)

32 : 
ev’t_ba£_
(
ba£
),

33 
»ad_fd_
(
fd_
[0]),

34 
wr™e_fd_
(
fd_
[1]),

35 
tid_
(0)

37 
CHECK_NOTNULL
(
ev’t_ba£_
);

39 
In™
();

42 
	gEv’tLoİ
::
Im¶
::~Impl()

44 ià(
»ad_ev_
 !ğ
NULL
) {

45 
ev’t_d–
(
»ad_ev_
);

46 
ev’t_ä“
(
»ad_ev_
);

49 
evut_şo£sock‘
(
wr™e_fd_
);

50 
evut_şo£sock‘
(
»ad_fd_
);

52 ià(
	gev’t_ba£_
 !ğ
NULL
) {

53 
ev’t_ba£_ä“
(
ev’t_ba£_
);

57 
	gEv’tLoİ
::
Im¶
::
In™
()

60 
rc
 = 
sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
fd_
);

61 
CHECK_NE
(
rc
, -1);

63 
	gbuff_size
 = 64*1024*1024;

65 
	grc
 = 
£tsockİt
(
wr™e_fd_
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buff_size
, ());

66 
CHECK_NE
(
rc
, -1);

68 
	grc
 = 
evut_make_sock‘_nÚblockšg
(
fd_
[0]);

69 
CHECK_NE
(
rc
, -1);

70 
	grc
 = 
evut_make_sock‘_nÚblockšg
(
fd_
[1]);

71 
CHECK_NE
(
rc
, -1);

73 
	g»ad_ev_
 = 
ev’t_Ãw
(
ev’t_ba£_


74 , 
»ad_fd_


75 , 
EV_READ
 | 
EV_PERSIST


76 , 
PeNÙify


77 , (*)
this
);

79 
CHECK_NOTNULL
(
»ad_ev_
);

83 
	gEv’tLoİ
::
Im¶
::
Run
() {

85 
tid_
 = 
±h»ad_£lf
();

87 
	grc
 = 
ev’t_add
(
»ad_ev_
, 
NULL
);

88 ià(
	grc
 != 0) {

89 
LOG
(
FATAL
) << "event_addƒrror";

94 
	grc
 = 
ev’t_ba£_di¥©ch
(
ev’t_ba£_
);

95 ià(
	grc
 == 1) {

96 
LOG
(
ERROR
) << "event_base_dispatchƒrror:‚oƒvent„egistered";

99 ià(
	grc
 == -1) {

100 
LOG
(
FATAL
) << "event_base_dispatchƒrror";

105 
	gEv’tLoİ
::
Im¶
::
Stİ
() {

106 
LOG
(
INFO
è<< "ev’ˆloİ„—dyØ¡İ,id: " << 
±h»ad_£lf
();

107 
RunInLoİ
(
boo¡
::
bšd
(&
Ev’tLoİ
::
Im¶
::
R—lStİ
, 
this
));

110 
	gEv’tLoİ
::
Im¶
::
R—lStİ
() {

112 
LOG
(
INFO
è<< "ev’ˆloİ stİ,id: " << 
±h»ad_£lf
();

114 
CHECK
(
ev’t_d–
(
»ad_ev_
) == 0);

115 
CHECK
(
ev’t_ba£_loİb»ak
(
ev’t_ba£_
) == 0);

118 
	gŒue
) {

120 
FunùÜ
* 
	gâ
[32] = {0};

122 
ssize_t
 
	gËn
 = 
»ad
(
»ad_fd_
, 
â
, (fn));

123 ià(
	gËn
 <= 0) {

124 
DLOG
(
INFO
) << "no datao„ead from…ipe";

128 
CHECK_EQ
(
Ën
 % (
â
[0]), 0U);

129 
	gn
 = 
Ën
 / (
â
[0]);

130 #ifdeà
RES_COUNTER


131 
	gä“_id_
 +ğ
n
;

133 
DLOG
(
INFO
è<< "»ad " << 
	gn
 << " object from…ipe in„eal stop";

135 
	gi
 = 0; i < 
	gn
; ++i) {

136 (*
	gâ
[
i
])();

137 
d–‘e
 
	gâ
[
i
];

143 
	gEv’tLoİ
::
Im¶
::
Aá”FÜk
() {

144 
rc
 = 
ev’t_»š™
(
ev’t_ba£_
);

145 
CHECK
(
rc
 == 0) << "event_reinit" <<„c;

148 
	gEv’tLoİ
::
Im¶
::
RunInLoİ
(cÚ¡ 
FunùÜ
& 
funùÜ
) {

149 
±h»ad_t
 
cur_tid
 = 
±h»ad_£lf
();

150 ià(
	gcur_tid
 =ğ
tid_
) {

151 
funùÜ
();

153 
QueueInLoİ
(
funùÜ
);

157 
	gEv’tLoİ
::
Im¶
::
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
funùÜ
) {

158 
FunùÜ
 *
â
 = 
Ãw
 FunùÜ(
funùÜ
);

159 
CHECK_NOTNULL
(
â
);

160 
	gdo_£nd
:

161 
ssize_t
 
Ën
 = 
wr™e
(
wr™e_fd_
, &
â
, (fn));

162 ià(
	gËn
 !ğ(
â
)) {

163 ià(
Ën
 < 0) {

164 ià(
”ºo
 =ğ
EINTR
) {

165 
do_£nd
;

166 } ià(
	g”ºo
 =ğ
EAGAIN
 || 
”ºo
 =ğ
EWOULDBLOCK
) {

168 
buff_size
 = 0;

169 
sockËn_t
 
	gİt_Ën
 = ();

170 
	grc
 = 
g‘sockİt
(
wr™e_fd_
, 
SOL_SOCKET
, 
SO_SNDBUF
, &
buff_size
, &
İt_Ën
);

171 
CHECK_NE
(
rc
, -1);

173 
LOG
(
FATAL
è<< "£nd bufã¸oàunix domaš sock‘ i fuÎ, s’d bufã¸size: " << 
	gbuff_size
;

174 
	gdo_£nd
;

176 
LOG
(
FATAL
è<< "wr™pe: " << 
¡»¼Ü
(
”ºo
);

179 
LOG
(
FATAL
) << "write full…ipe";

183 #ifdeà
RES_COUNTER


184 
	gÃxt_id_
++;

188 
	gEv’tLoİ
::
Im¶
::
PeNÙify
(
fd
, 
wh©
, *
¬g
)

190 
FunùÜ
* 
	gâ
[32] = {0};

192 
ssize_t
 
	gËn
 = 
»ad
(
fd
, 
â
, (fn));

193 
LOG_IF
(
FATAL
, 
Ën
 < 0è<< "»ad…e: " << 
¡»¼Ü
(
”ºo
);

194 
CHECK_EQ
(
Ën
 % (
â
[0]), 0U);

195 
	gn
 = 
Ën
 / (
â
[0]);

196 #ifdeà
RES_COUNTER


197 
	gä“_id_
 +ğ
n
;

199 
	gi
 = 0; i < 
	gn
; ++i) {

200 (*
	gâ
[
i
])();

201 
d–‘e
 
	gâ
[
i
];

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_loop_impl.h

4 #iâdeà
LDD_NET_INTERNAL_EVENT_LOOP_IMPL_H_


5 
	#LDD_NET_INTERNAL_EVENT_LOOP_IMPL_H_


	)

7 
	~<±h»ad.h
>

8 
	~<ev’t2/ev’t.h
>

9 
	~"ldd/Ãt/ev’t_loİ.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cEv’tLoİ
::
Im¶
 {

15 
public
:

16 
Im¶
();

17 
ex¶ic™
 
Im¶
(::
ev’t_ba£
 *
ba£
);

18 ~
Im¶
();

20 
Run
();

21 
Stİ
();

22 
Aá”FÜk
();

23 
RunInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

24 
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

26 
ev’t_ba£
 *ev’t_ba£(è{  
	gev’t_ba£_
; }

28 
	g´iv©e
:

29 
Po¡
(cÚ¡ 
FunùÜ
& 
funùÜ
);

30 
PeNÙify
(
fd
, 
wh©
, *
¬g
);

31 
R—lStİ
();

32 
In™
();

34 
	g´iv©e
:

35 
ev’t_ba£
 *
ev’t_ba£_
;

37 
	gfd_
[2];

38 &
	g»ad_fd_
;

39 &
	gwr™e_fd_
;

40 
ev’t
 *
	g»ad_ev_
;

42 
±h»ad_t
 
	gtid_
;

44 #ifdeà
RES_COUNTER


45 
	g´iv©e
:

46 
ä›nd
 
şass
 
St
;

47 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

48 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

49 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

50 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_msg_impl.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"šcomšg_msg_im¶.h
"

7 
	~"chªÃl_im¶.h
"

8 
	~"outgošg_·ck‘.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 #ifdeà
RES_COUNTER


14 
	gut
::
Atomic
<
ušt64_t
> 
IncomšgMsg
::
Im¶
::
Ãxt_id_
;

15 
	gut
::
Atomic
<
ušt64_t
> 
IncomšgMsg
::
Im¶
::
ä“_id_
;

18 
	gIncomšgMsg
::
Im¶
::~Impl() {

19 ià(
»¥Ú£_
) {

20 
d–‘e
 
»¥Ú£_
;

22 #ifdeà
RES_COUNTER


23 
	gä“_id_
++;

27 
	gIncomšgMsg
::
Im¶
::
In™
(
Id
 
id
,

28 cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
) {

29 
DLOG
(
INFO
) << "enter Init";

30 
	gid_
 = 
id
;

31 
	gchªÃl_
 = 
chªÃl
;

34 
	gIncomšgMsg
::
Im¶
::
NÙify
(
boŞ
 
dÚe
) {

36 
DLOG
(
INFO
) << "enter Notify";

38 ià(
	gwa™šg_
) {

39 ià(
	gdÚe
) {

40 
DoDÚe
();

42 
DoEm™
();

47 
	gIncomšgMsg
::
Im¶
::
OnReque¡
(cÚ¡ 
Paylßd
& 
·ylßd
)

49 
DLOG
(
INFO
) << "enter OnRequest";

53 
AùiÚ
 
	gÃxt
 = 
kWa™
;

54 
	gowÃr_
->
In™
(
·ylßd
, &
Ãxt
);

55 ià(
	gÃxt
 =ğ
kEm™
) {

56 
DoEm™
();

57 } ià(
	gÃxt
 =ğ
kDÚe
) {

58 
DoDÚe
();

59 } ià(
	gÃxt
 =ğ
kWa™
) {

60 
wa™šg_
 = 
Œue
;

62 
LOG
(
FATAL
è<< 
chªÃl
()->
Çme
()

64 << 
	gÃxt
;

68 
	gIncomšgMsg
::
Im¶
::
DoEm™
() {

69 
DLOG
(
INFO
) << "enter DoEmit";

70 
	gwa™šg_
 = 
çl£
;

71 
AùiÚ
 
	gÃxt
;

73 
Paylßd
 
	g·ylßd
;

74 
	gÃxt
 = 
kWa™
;

75 
	gowÃr_
->
Em™
(&
·ylßd
, &
Ãxt
);

76 
Wr™eRe¥Ú£
(
·ylßd
);

77 } 
	gÃxt
 =ğ
kEm™
);

78 ià(
	gÃxt
 =ğ
kDÚe
) {

79 
DoDÚe
();

80 } ià(
	gÃxt
 =ğ
kWa™
) {

81 
wa™šg_
 = 
Œue
;

83 
LOG
(
FATAL
è<< 
chªÃl
()->
Çme
()

85 << 
	gÃxt
;

89 
	gIncomšgMsg
::
Im¶
::
DoDÚe
() {

91 
DLOG
(
INFO
) << "enter DoDone";

93 
	gwa™šg_
 = 
çl£
;

94 
Code
 
	gcode
 = 0;

95 
	gowÃr_
->
DÚe
(&
code
);

96 
Wr™eDÚe
(
code
);

99 
	gIncomšgMsg
::
Im¶
::
DoCªûl
() {

101 
DLOG
(
INFO
) << "enter DoCancel";

103 ià(!
	gÿnûËd_
) {

104 
	gÿnûËd_
 = 
Œue
;

105 
	gowÃr_
->
Cªûl
();

106 
chªÃl
()->
	gim¶_
->
G‘IncomšgMsg
(
id
(), 
Œue
);

110 
	gIncomšgMsg
::
Im¶
::
Wr™eRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
) {

111 
DLOG
(
INFO
) << "enter WriteResponse";

112 ià(
	gÿnûËd_
) {

115 
OutgošgRe¥Ú£
* 
	g»¥Ú£
 = 
Ãw
 OutgošgRe¥Ú£(
id
(), 
·ylßd
);

116 ià(
	g»¥Ú£_
) {

117 
chªÃl
()->
	gim¶_
->
Wr™e
(
»¥Ú£_
);

119 
	g»¥Ú£_
 = 
»¥Ú£
;

122 
	gIncomšgMsg
::
Im¶
::
Wr™eDÚe
(
Code
 
code
) {

123 
DLOG
(
INFO
) << "enter WriteDone";

124 ià(
	gÿnûËd_
) {

127 ià(
	g»¥Ú£_
) {

128 
DLOG
(
INFO
) << "response is‚otƒmpty";

129 
	g»¥Ú£_
->
£t_Ï¡
(
Œue
);

130 
	g»¥Ú£_
->
£t_code
(
code
);

131 
chªÃl
()->
	gim¶_
->
Wr™e
(
»¥Ú£_
);

132 
	g»¥Ú£_
 = 
NULL
;

134 
DLOG
(
INFO
) << "response isƒmpty‡nd ctor‡ outgoingƒnd…acket";

135 
OutgošgEnd
* 
	g’d
 = 
Ãw
 OutgošgEnd(
id
(), 
code
);

136 
chªÃl
()->
	gim¶_
->
Wr™e
(
’d
);

138 
chªÃl
()->
	gim¶_
->
G‘IncomšgMsg
(
id
(), 
Œue
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_msg_impl.h

4 #iâdeà
LDD_NET_INTERNAL_INCOMING_MSG_IMPL_H_


5 
	#LDD_NET_INTERNAL_INCOMING_MSG_IMPL_H_


	)

7 
	~"ldd/Ãt/šcomšg_msg.h
"

8 
	~"ldd/ut/©omic.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gChªÃl
;

14 
şass
 
	gOutgošgRe¥Ú£
;

16 şas 
	cIncomšgMsg
::
Im¶
 {

17 
public
:

18 
ldd
::
	tÃt
::
	tPaylßd
 Payload;

19 
	gldd
::
	tÃt
::
	tCode
 Code;

20 
	gldd
::
	tÃt
::
	tMes§geId
 
	tId
;

21 
	gldd
::
	tÃt
::
	tMes§geTy³
 
	tTy³
;

23 
Im¶
(
IncomšgMsg
* 
m
)

24 : 
owÃr_
(
m
), 
id_
(-1), 
ÿnûËd_
(
çl£
),

25 
wa™šg_
(
çl£
),

26 
»¥Ú£_
(
NULL
)

28 #ifdeà
RES_COUNTER


29 
	gÃxt_id_
++;

33 
	gvœtu®
 ~
Im¶
();

35 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
owÃr
() const {

36  
owÃr_
->
sh¬ed_äom_this
();

38 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
(ècÚ¡ {  
chªÃl_
; }

39 
Id
 
id
(ècÚ¡ {  
	gid_
; }

40 
boŞ
 
IsCªûËd
(ècÚ¡ {  
	gÿnûËd_
; }

42 
In™
(
Id
 
id
, cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

43 
NÙify
(
boŞ
 
dÚe
);

45 
OnReque¡
(cÚ¡ 
Paylßd
& 
·ylßd
);

46 
DoEm™
();

47 
DoDÚe
();

48 
DoCªûl
();

49 
	g´iv©e
:

50 
Wr™eRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
);

51 
Wr™eDÚe
(
Code
 
code
);

53 
	g´iv©e
:

54 
IncomšgMsg
* 
owÃr_
;

55 
Id
 
	gid_
;

56 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl_
;

57 
boŞ
 
	gÿnûËd_
;

58 
boŞ
 
	gwa™šg_
;

59 
OutgošgRe¥Ú£
* 
	g»¥Ú£_
;

62 #ifdeà
RES_COUNTER


63 
	g´iv©e
:

64 
ä›nd
 
şass
 
St
;

65 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

66 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

67 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

68 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_packet.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"šcomšg_·ck‘.h
"

7 
	~"šcomšg_msg_im¶.h
"

8 
	~"outgošg_msg_im¶.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
	gIncomšgPack‘
::~
IncomšgPack‘
() {

16 
IncomšgPšg
::
Proûss
() {

17 
chªÃl
()->
OnPšg
();

20 
	gIncomšgPÚg
::
Proûss
() {

21 
chªÃl
()->
OnPÚg
();

24 
	gIncomšgPack‘W™hPaylßd
::
Proûss
() {

25 
ProûssPack‘
();

28 
	gIncomšgPack‘W™hPaylßd
::
ProûssPack‘
() {

30 ià(!
·ck‘_
) {

32 
DLOG
(
INFO
) << "receive„esponse without…ayload,ype: "

33 << ()
h—d”
().
ty³
();

34 
DÚe
();

39 *
	gp
 = 
·ck‘_
->
d©a
();

42 ià(
h—d”
().
body_size
() > 0) {

43 
Bufãr
 
body
(
p
, 
h—d”
().
body_size
());

44 
	g·ylßd_
.
S‘Body
(
body
);

45 
	gp
 +ğ
h—d”
().
body_size
();

48 ià(
h—d”
().
ext_couÁ
() > 0) {

51 *
	gext_h—d”
 = 
p
;

52 
	gp
 +ğ
ExtH—d”
::
size
(
h—d”
().
ext_couÁ
());

54 
	gExtH—d”
::
P¬£r
 
exthdr
(
h—d”
().
ext_couÁ
(), 
ext_h—d”
);

55 ià(!
	gexthdr
.
IsV®id
(
h—d”
().
ext_Ën
())) {

56 
LOG
(
ERROR
è<< 
Çme
()

57 << "P¬£ " << 
Çme
(è<< " (id=" << ()
h—d”
().
id
()

59 
chªÃl
()->
OnE¼Ü
();

63 
	gext_Ën
 = 0;

64 
	gi
 = 0; i < 
h—d”
().
ext_couÁ
(); ++i) {

65 
ušt8_t
 
	gty³
, 
	gËn
;

66 
	gexthdr
.
G‘ExtI‹m
(
i
, &
ty³
, &
Ën
);

67 
	gext_Ën
 +ğ
Ën
;

71 ià(
	gext_Ën
 !ğ
h—d”
().
ext_Ën
()) {

72 
LOG
(
ERROR
) << "invalidƒxt header†en";

73 
chªÃl
()->
OnE¼Ü
();

78 
	gi
 = 0; i < 
h—d”
().
ext_couÁ
(); ++i) {

79 
ušt8_t
 
	gty³
, 
	gËn
;

80 
	gexthdr
.
G‘ExtI‹m
(
i
, &
ty³
, &
Ën
);

82 
Bufãr
 
ext
(
p
, 
Ën
);

83 
	gp
 +ğ
Ën
;

85 
	g·ylßd_
.
S‘ExŒa
(
ty³
, 
ext
);

89 
DLOG
(
INFO
è<< 
chªÃl
()->
Çme
()

90 << "R—dšg "<< 
Çme
(è<< " (id=" << 
h—d”
().
id
()

91 << " body_ty³=" << ()
h—d”
().
body_ty³
()

92 << " body_size=" << 
h—d”
().
body_size
()

93 << "ƒxt_couÁ=" << ()
h—d”
().
ext_couÁ
()

94 << "ƒxt_Ën=" << 
h—d”
().
ext_Ën
()

97 
DÚe
();

100 
	gIncomšgReque¡
::
DÚe
()

102 
boo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
msg
 =

103 
chªÃl
()->
»gi¡ry
()->
NewIncomšgMsg
(
h—d”
().
body_ty³
());

104 ià(!
	gmsg
) {

105 
DLOG
(
INFO
) << "no valid„egister incoming msg,ryo create dyanmic incoming";

106 
	gboo¡
::
sh¬ed_±r
<
DyÇmicIncomšgMsg
> 
dyÇmic_msg
 =

107 
chªÃl
()->
»gi¡ry
()->
NewDeçuÉIncomšgMsg
();

108 ià(!
	gdyÇmic_msg
) {

109 
LOG
(
ERROR
è<< 
chªÃl
()->
Çme
()

110 << "Reque¡ (id=" << ()
h—d”
().
id
()

111 << "èha unkowÀbody_ty³ = " << 
h—d”
().
body_ty³
();

112 
chªÃl
()->
OnE¼Ü
();

115 
	gdyÇmic_msg
->
£t_ty³
(
h—d”
().
body_ty³
());

116 
	gmsg
 = 
dyÇmic_msg
;

119 
DLOG
(
INFO
) << "call msg impl Init method";

120 
	gmsg
->
	gim¶_
->
In™
(
h—d”
().
id
(), 
chªÃl
()->
owÃr
());

121 ià(!
chªÃl
()->
AddIncomšgMsg
(
msg
)) {

122 
LOG
(
ERROR
è<< 
chªÃl
()->
Çme
()

123 << "Incomšg "<< 
Çme
(è<< " (id=" << ()
h—d”
().
id
()

125 
chªÃl
()->
OnE¼Ü
();

129 
DLOG
(
INFO
) << "call channel OnIncomingPacket()";

130 
chªÃl
()->
OnIncomšgPack‘
();

132 
DLOG
(
INFO
) << "call channel impl OnReqeust method";

133 
	gmsg
->
	gim¶_
->
OnReque¡
(
·ylßd
());

136 
	gIncomšgRe¥Ú£
::
DÚe
() {

137 
boŞ
 
Ï¡
 = 
h—d”
().
ty³
(è=ğ
H—d”
::
kLa¡
;

138 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
msg
 = 
chªÃl
()->
G‘OutgošgMsg
(
h—d”
().
id
(), 
Ï¡
);

139 ià(!
	gmsg
) {

140 
LOG
(
ERROR
è<< 
chªÃl
()->
Çme
()

141 << "Incomšg " << 
Çme
(è<< " (id=" << ()
h—d”
().
id
()

145 
chªÃl
()->
OnIncomšgPack‘
();

147 
	gmsg
->
	gim¶_
->
OnRe¥Ú£
(
·ylßd
(), 
Ï¡
, 
h—d”
().
body_ty³
());

150 
	gIncomšgEnd
::
Proûss
() {

151 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
msg
 =

152 
chªÃl
()->
G‘OutgošgMsg
(
h—d”
().
id
(), 
Œue
);

153 ià(!
	gmsg
) {

154 
LOG
(
ERROR
è<< 
chªÃl
()->
Çme
()

155 << "Incomšgƒnd (id=" << ()
h—d”
().
id
()

159 
chªÃl
()->
OnIncomšgPack‘
();

161 
	gmsg
->
	gim¶_
->
OnOk
(
h—d”
().
body_ty³
());

164 
	gIncomšgCªûl
::
Proûss
() {

165 
boo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
msg
 =

166 
chªÃl
()->
G‘IncomšgMsg
(
h—d”
().
id
(), 
Œue
);

167 ià(!
	gmsg
) {

168 
LOG
(
ERROR
è<< 
chªÃl
()->
Çme
()

169 << "Incomšg cªûÈ(id=" << ()
h—d”
().
id
()

173 
chªÃl
()->
OnIncomšgPack‘
();

174 
LOG
(
INFO
è<< 
chªÃl
()->
Çme
()

175 << "Cªûlšg incomšg msg (id=" << ()
h—d”
().
id
() << ")";

176 
	gmsg
->
	gim¶_
->
DoCªûl
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_packet.h

4 #iâdeà
LDD_NET_INTERNAL_INCOMING_PACKET_H_


5 
	#LDD_NET_INTERNAL_INCOMING_PACKET_H_


	)

7 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

10 
	~"´ÙocŞ.h
"

11 
	~"chªÃl_im¶.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

18 
şass
 
	gIncomšgPack‘
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
IncomšgPack‘
> {

19 
public
:

20 
IncomšgPack‘
(
ChªÃl
::
Im¶
* 
chªÃl
)

21 : 
chªÃl_
(
chªÃl
), 
chªÃl_owÃr_
(chªÃl->
owÃr
())

23 
	gvœtu®
 ~
IncomšgPack‘
();

25 
vœtu®
 
Proûss
() = 0;

26 
	gChªÃl
::
Im¶
* 
chªÃl
(ècÚ¡ {  
chªÃl_
; }

27 
	gH—d”
::
P¬£r
 
h—d”
(ècÚ¡ {  
chªÃl_
->header(); }

28 
	g´iv©e
:

29 
ChªÃl
::
Im¶
* 
chªÃl_
;

30 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl_owÃr_
;

33 şas 
	cIncomšgPack‘W™hPaylßd
 : 
public
 
IncomšgPack‘
 {

34 
public
:

35 
IncomšgPack‘W™hPaylßd
(
ChªÃl
::
Im¶
* 
chªÃl


36 , cÚ¡ * 
Çme


37 , cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
·ck‘
)

38 : 
IncomšgPack‘
(
chªÃl
), 
Çme_
(
Çme
), 
·ck‘_
(
·ck‘
) {}

40 
vœtu®
 
Proûss
();

41 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
·ck‘
(è{  
·ck‘_
; }

43 
	g´Ùeùed
:

44 
ProûssPack‘
();

46 
vœtu®
 
DÚe
() = 0;

48 cÚ¡ * 
Çme
(ècÚ¡ {  
	gÇme_
; }

49 cÚ¡ 
	gPaylßd
& 
·ylßd
(ècÚ¡ {  
	g·ylßd_
; }

50 
	g´iv©e
:

51 cÚ¡ * 
Çme_
;

52 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
·ck‘_
;

53 
Paylßd
 
	g·ylßd_
;

56 şas 
	cIncomšgPšg
: 
public
 
IncomšgPack‘
 {

57 
public
:

58 
IncomšgPšg
(
ChªÃl
::
Im¶
* 
chªÃl
)

59 : 
IncomšgPack‘
(
chªÃl
) {}

60 
vœtu®
 
Proûss
();

63 şas 
	cIncomšgPÚg
: 
public
 
IncomšgPack‘
 {

64 
public
:

65 
IncomšgPÚg
(
ChªÃl
::
Im¶
* 
chªÃl
)

66 : 
IncomšgPack‘
(
chªÃl
) {}

67 
vœtu®
 
Proûss
();

70 şas 
	cIncomšgReque¡
: 
public
 
IncomšgPack‘W™hPaylßd
 {

71 
public
:

72 
IncomšgReque¡
(
ChªÃl
::
Im¶
* 
chªÃl


73 , cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
·ck‘
)

74 : 
IncomšgPack‘W™hPaylßd
(
chªÃl
, "»que¡", 
·ck‘
) {}

75 
	g´iv©e
:

76 
vœtu®
 
DÚe
();

79 şas 
	cIncomšgRe¥Ú£
: 
public
 
IncomšgPack‘W™hPaylßd
 {

80 
public
:

81 
IncomšgRe¥Ú£
(
ChªÃl
::
Im¶
* 
chªÃl
, cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
·ck‘
)

82 : 
IncomšgPack‘W™hPaylßd
(
chªÃl
,

83 
chªÃl
->
h—d”
().
ty³
(è=ğ
H—d”
::
kLa¡
? "last" : "response",

84 
·ck‘
)

86 
	g´iv©e
:

87 
vœtu®
 
DÚe
();

90 şas 
	cIncomšgEnd
: 
public
 
IncomšgPack‘
 {

91 
public
:

92 
IncomšgEnd
(
ChªÃl
::
Im¶
* 
chªÃl
)

93 : 
IncomšgPack‘
(
chªÃl
) {}

94 
vœtu®
 
Proûss
();

97 şas 
	cIncomšgCªûl
: 
public
 
IncomšgPack‘
 {

98 
public
:

99 
IncomšgCªûl
(
ChªÃl
::
Im¶
* 
chªÃl
)

100 : 
IncomšgPack‘
(
chªÃl
) {}

101 
vœtu®
 
Proûss
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/listener_impl.cc

4 
	~<uni¡d.h
>

5 
	~<fú.h
>

6 
	~<glog/loggšg.h
>

7 
	~"li¡’”_im¶.h
"

8 
	~"ev’t_loİ_im¶.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
	gLi¡’”
::
Im¶
::Im¶(
Ev’tLoİ
* 
ev’t_loİ
)

14 : 
ev’t_loİ_
(
ev’t_loİ
),

15 
fd_
(-1)

19 
	gLi¡’”
::
Im¶
::~Impl() {

20 
Clo£
();

23 
boŞ
 
	gLi¡’”
::
Im¶
::
O³n
(cÚ¡ 
Endpošt
& 
’dpošt
) {

24 
CHECK
(!
IsO³n
());

25 
	gfd
 = 
sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

26 ià(
	gfd
 < 0) {

27 
PLOG
(
ERROR
) << "socket()";

28  
	gçl£
;

30 
	g»u£
 = 1;

31 ià(
£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
»u£
, (reuse)) < 0) {

32 
PLOG
(
ERROR
) << "setsockopt()";

33 
şo£
(
fd
);

34  
	gçl£
;

36 
	gæags
 = 0;

37 ià((
	gæags
 = 
fú
(
fd
, 
F_GETFL
, 0)) < 0) {

38 
PLOG
(
ERROR
) << "fcntl(F_GETFL)";

39 
şo£
(
fd
);

40  
	gçl£
;

42 ià(
fú
(
fd
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) < 0) {

43 
PLOG
(
ERROR
) << "fcntl(F_SETFL, O_NONBLOCK)";

44 
şo£
(
fd
);

45  
	gçl£
;

47 
sockaddr_š
 
	gaddr
;

48 
	gaddr
.
	gsš_çmy
 = 
’dpošt
.
add»ss
().
çmy
();

49 
	gaddr
.
	gsš_addr
 = 
’dpošt
.
add»ss
().
ToV4
();

50 
	gaddr
.
	gsš_pÜt
 = 
htÚs
(
’dpošt
.
pÜt
());

51 ià(
bšd
(
fd
, (cÚ¡ 
sockaddr
*)&
addr
, (addr)) < 0) {

52 
PLOG
(
ERROR
) << "bind()";

53 
şo£
(
fd
);

54  
	gçl£
;

56 ià(
li¡’
(
fd
, 
SOMAXCONN
) < 0) {

57 
PLOG
(
ERROR
) << "listen()";

58 
şo£
(
fd
);

59  
	gçl£
;

61 
	gfd_
 = 
fd
;

63 
DLOG
(
INFO
è<< "İ’†i¡’ fd: " << 
	gfd_
;

65  
	gŒue
;

68 
	gLi¡’”
::
Im¶
::
Clo£
() {

69 ià(
IsO³n
()) {

70 ià(
şo£
(
fd_
) < 0) {

71 
PLOG
(
ERROR
) << "close()";

73 
	gfd_
 = -1;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/listener_impl.h

4 #iâdeà
LDD_NET_INTERNAL_LISTENER_IMPL_H_


5 
	#LDD_NET_INTERNAL_LISTENER_IMPL_H_


	)

7 
	~"ldd/Ãt/’dpošt.h
"

8 
	~"ldd/Ãt/li¡’”.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 şas 
	cLi¡’”
::
Im¶
 {

14 
public
:

15 
Im¶
(
Ev’tLoİ
* 
ev’t_loİ
);

16 ~
Im¶
();

18 
boŞ
 
O³n
(cÚ¡ 
Endpošt
& 
’dpošt
);

19 
Clo£
();

21 
boŞ
 
IsO³n
(ècÚ¡ {  
	gfd_
 >= 0; }

22 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
; }

23 
fd
(ècÚ¡ {  
	gfd_
; }

24 
	g´iv©e
:

25 
Ev’tLoİ
* 
ev’t_loİ_
;

26 
	gfd_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_msg_impl.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"outgošg_msg_im¶.h
"

7 
	~"outgošg_·ck‘.h
"

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 #ifdeà
RES_COUNTER


13 
	gut
::
Atomic
<
ušt64_t
> 
OutgošgMsg
::
Im¶
::
Ãxt_id_
;

14 
	gut
::
Atomic
<
ušt64_t
> 
OutgošgMsg
::
Im¶
::
ä“_id_
;

17 
	gOutgošgMsg
::
Im¶
::
In™
(
Id
 
id
,

18 cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
c
,

19 cÚ¡ 
ut
::
TimeDiff
& 
£nd_timeout
) {

20 
id_
 = 
id
;

21 
	gchªÃl_
 = 
c
;

22 
	gtim”1_
.
»£t
(
Ãw
 
Tim”Ev’t
(
chªÃl
()->
ev’t_loİ
()));

23 
	gtim”2_
.
»£t
(
Ãw
 
Tim”Ev’t
(
chªÃl
()->
ev’t_loİ
()));

25 
	g»que¡_
 = 
Ãw
 
OutgošgReque¡
(
owÃr
());

26 
S‘Tim”
(
tim”1_
.
g‘
(), 
£nd_timeout
,

27 
ut
::
TimeDiff
::
Mli£cÚds
(
kDeçuÉS’dTimeout
));

28 
chªÃl
()->
	gim¶_
->
Wr™e
(
»que¡_
);

30 
	gš™_
 = 
Œue
;

33 
	gOutgošgMsg
::
Im¶
::
Cªûl
() {

34 
DoCªûl
();

37 
	gOutgošgMsg
::
Im¶
::
DoCªûl
() {

38 
CHECK_GE
(
id
(), 0);

39 
CHECK
(
chªÃl
());

41 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
msg
 =

42 
chªÃl
()->
im¶_
->
G‘OutgošgMsg
(
id
(), 
Œue
);

43 ià(!
	gmsg
 || 
owÃr
(è!ğ
msg
) {

44 
LOG
(
INFO
è<< 
chªÃl
()->
Çme
()

45 << " cªûÈnÚ-aùivOutgošgMsg id = " << 
id
();

48 
OutgošgCªûl
* 
	gÿnûl
 = 
Ãw
 OutgošgCªûl(
id
());

49 
chªÃl
()->
	gim¶_
->
Wr™e
(
ÿnûl
);

50 
OnCªûl
();

53 
boŞ
 
	gOutgošgMsg
::
Im¶
::
OnReque¡
(
Paylßd
* 
·ylßd
) {

55 
DLOG
(
INFO
) << "enter OnRequest";

57 
CHECK_NOTNULL
(
»que¡_
);

58 
	g»que¡_
 = 
NULL
;

60 
	gut
::
TimeDiff
 
»cv_timeout
;

61 
	gut
::
TimeDiff
 
dÚe_timeout
;

62 
boŞ
 
	gok
 = 
owÃr_
->
In™
(
·ylßd
, &
»cv_timeout
, &
dÚe_timeout
);

63 ià(
	gok
) {

64 
S‘Tim”
(
tim”1_
.
g‘
(), 
»cv_timeout
,

65 
ut
::
TimeDiff
::
Mli£cÚds
(
kDeçuÉRecvTimeout
));

66 
S‘Tim”
(
tim”2_
.
g‘
(), 
dÚe_timeout
,

67 
ut
::
TimeDiff
::
Mli£cÚds
(
kDeçuÉDÚeTimeout
));

68  
	gŒue
;

70 
OnCªûl
();

71  
	gçl£
;

75 
	gOutgošgMsg
::
Im¶
::
OnRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
, 
boŞ
 
Ï¡
,

76 
Code
 
code
) {

77 
	gut
::
TimeDiff
 
Ãxt_timeout
;

78 
boŞ
 
	gok
 = 
owÃr_
->
Recv
(
·ylßd
, &
Ãxt_timeout
);

79 ià(
	gok
) {

80 ià(
	gÏ¡
) {

81 
OnOk
(
code
);

83 
S‘Tim”
(
tim”1_
.
g‘
(), 
Ãxt_timeout
,

84 
ut
::
TimeDiff
::
Mli£cÚds
(
kDeçuÉNextTimeout
));

87 
DoCªûl
();

91 
	gOutgošgMsg
::
Im¶
::
OnOk
(
Code
 
code
) {

92 
CHECK
(!
dÚe_
);

93 
	gowÃr_
->
DÚe
(
ResuÉ
::
Ok
(
code
));

94 
CËªUp
();

97 
	gOutgošgMsg
::
Im¶
::
OnCªûl
() {

98 
CHECK
(!
dÚe_
);

99 
	gowÃr_
->
DÚe
(
ResuÉ
::
CªûËd
());

100 
CËªUp
();

103 
	gOutgošgMsg
::
Im¶
::
OnFaed
() {

104 
CHECK
(!
dÚe_
);

105 
	gowÃr_
->
DÚe
(
ResuÉ
::
Faed
());

106 
CËªUp
();

109 
	gOutgošgMsg
::
Im¶
::
OnTimeout
() {

110 
CHECK
(!
dÚe_
);

111 
LOG
(
INFO
è<< 
chªÃl
()->
Çme
(è<< "id = " << 
id
() << "imeout";

112 
	gowÃr_
->
DÚe
(
ResuÉ
::
TimedOut
());

113 
CËªUp
();

115 
	gOutgošgMsg
::
Im¶
::
OnTimeout
(
Tim”Ev’t
* 
tim”
) {

116 ià(
tim”
 =ğ
tim”1_
.
g‘
()) {

117 
tim”2_
->
Cªûl
();

119 
	gtim”1_
->
Cªûl
();

121 
OnTimeout
();

124 
	gOutgošgMsg
::
Im¶
::
S‘Tim”
(
Tim”Ev’t
* 
tim”
,

125 cÚ¡ 
ut
::
TimeDiff
& 
timeout
,

126 cÚ¡ 
ut
::
TimeDiff
& 
deçuÉ_timeout
) {

127 ià(
timeout
.
ToMiüo£cÚds
() > 0) {

128 
DLOG
(
INFO
è<< "S‘Tim” c®ÈAsyncWa™, obj: " << 
tim”
;

129 
	gtim”
->
AsyncWa™
(
boo¡
::
bšd
(&
Im¶
::
OnTimeout
, 
this
, 
tim”
),

130 
timeout
);

132 
DLOG
(
INFO
è<< "S‘Tim” c®ÈAsyncWa™, obj: " << 
	gtim”
;

133 
	gtim”
->
AsyncWa™
(
boo¡
::
bšd
(&
Im¶
::
OnTimeout
, 
this
, 
tim”
),

134 
deçuÉ_timeout
);

138 
	gOutgošgMsg
::
Im¶
::
CË¬Tim”
() {

140 ià(!
š™_
) {

141 
LOG
(
WARNING
) << "Uninit outgoing msg when clearimer";

145 ià(
	gtim”1_
) {

146 
	gtim”1_
->
Cªûl
();

149 ià(
	gtim”2_
) {

150 
	gtim”2_
->
Cªûl
();

154 
	gOutgošgMsg
::
Im¶
::
CË¬Reque¡
() {

155 ià(
»que¡_
) {

156 
»que¡_
->
Di§bË
();

157 
	g»que¡_
 = 
NULL
;

161 
	gOutgošgMsg
::
Im¶
::
CËªUp
() {

162 ià(!
š™_
) {

163 
LOG
(
WARNING
) << "uninit outgoing msg when clean up";

167 
CË¬Reque¡
();

168 
CË¬Tim”
();

169 
	gdÚe_
 = 
Œue
;

170 
chªÃl
()->
	gim¶_
->
G‘OutgošgMsg
(
id
(), 
Œue
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_msg_impl.h

4 #iâdeà
LDD_NET_INTERNAL_OUTGOING_MSG_IMPL_H_


5 
	#LDD_NET_INTERNAL_OUTGOING_MSG_IMPL_H_


	)

7 
	~<boo¡/sh¬ed_±r.hµ
>

8 
	~<boo¡/scİed_±r.hµ
>

9 
	~"ldd/Ãt/ev’t.h
"

10 
	~"ldd/Ãt/outgošg_msg.h
"

11 
	~"chªÃl_im¶.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

16 
şass
 
	gOutgošgReque¡
;

17 
şass
 
	gChªÃl
;

19 şas 
	cOutgošgMsg
::
Im¶
 {

20 cÚ¡ 
kDeçuÉS’dTimeout
 = 5;

21 cÚ¡ 
	gkDeçuÉRecvTimeout
 = 200;

22 cÚ¡ 
	gkDeçuÉNextTimeout
 = 100;

23 cÚ¡ 
	gkDeçuÉDÚeTimeout
 = 300;

24 
	gpublic
:

25 
Im¶
(
OutgošgMsg
* 
owÃr
)

26 : 
owÃr_
(
owÃr
), 
id_
(-1), 
»que¡_
(
NULL
), 
dÚe_
(
çl£
), 
š™_
(false)

28 #ifdeà
RES_COUNTER


29 
	gÃxt_id_
++;

33 ~
Im¶
() {

34 #ifdeà
RES_COUNTER


35 
	gä“_id_
++;

40 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
owÃr
() const {

41  
owÃr_
->
sh¬ed_äom_this
();

44 
Id
 
id
(ècÚ¡ {  
	gid_
; }

45 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
(ècÚ¡ {  
chªÃl_
; }

47 
In™
(
Id
 
id
, cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
,

48 cÚ¡ 
ut
::
TimeDiff
& 
£nd_timeout
);

49 
boŞ
 
OnReque¡
(
Paylßd
* 
·ylßd
);

50 
OnRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
, 
boŞ
 
Ï¡
, 
Code
 
code
);

51 
OnOk
(
Code
 
code
);

52 
OnCªûl
();

53 
OnFaed
();

54 
OnTimeout
();

56 
Cªûl
();

57 
	g´iv©e
:

58 
DoCªûl
();

59 
OnTimeout
(
Tim”Ev’t
* 
tim”
);

60 
S‘Tim”
(
Tim”Ev’t
* 
tim”
, cÚ¡ 
ut
::
TimeDiff
& 
timeout
,

61 cÚ¡ 
ut
::
TimeDiff
& 
deçuÉ_timeout
);

63 
CË¬Tim”
();

64 
CË¬Reque¡
();

65 
CËªUp
();

66 
	g´iv©e
:

67 
OutgošgMsg
* 
owÃr_
;

68 
Id
 
	gid_
;

69 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl_
;

70 
	gboo¡
::
scİed_±r
<
Tim”Ev’t
> 
tim”1_
;

71 
	gboo¡
::
scİed_±r
<
Tim”Ev’t
> 
tim”2_
;

72 
OutgošgReque¡
* 
	g»que¡_
;

73 
boŞ
 
	gdÚe_
;

74 
boŞ
 
	gš™_
;

76 #ifdeà
RES_COUNTER


77 
	g´iv©e
:

78 
ä›nd
 
şass
 
St
;

79 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

80 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

81 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

82 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_packet.cc

4 
	~<glog/loggšg.h
>

5 
	~"ldd/Ãt/šcomšg_msg.h
"

6 
	~"ldd/Ãt/outgošg_msg.h
"

7 
	~"outgošg_·ck‘.h
"

8 
	~"outgošg_msg_im¶.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
	gOutgošgPack‘
::
OutgošgPack‘
()

14 : 
di§bËd_
(
çl£
)

16 
mem£t
(
h—d”_
, 0, 
H—d”
::
kBy‹Size
);

19 
size_t
 
	gOutgošgPack‘
::
S”ŸlizeTo
(

20 
¡d
::
veùÜ
<
CÚ¡Bufãr
>* 
bufãrs
) {

21 ià(
di§bËd_
) {

22 
LOG
(
WARNING
) << "disable serialize";

25 
	gbufãrs
->
push_back
(
CÚ¡Bufãr
(
h—d”_
, 
H—d”
::
kBy‹Size
));

26 
size_t
 
	gsize
 = 0;

27 ià(
S”Ÿlize
(
bufãrs
, &
size
)) {

28  
	gH—d”
::
kBy‹Size
 + 
size
;

30 
LOG
(
WARNING
) << "serialize const buffers vector failed";

31 
	gbufãrs
->
pİ_back
();

36 
boŞ
 
	gOutgošgPack‘W™hPaylßd
::
S”Ÿlize
(

37 
¡d
::
veùÜ
<
CÚ¡Bufãr
>* 
bufãrs
, 
size_t
* 
size
) {

39 
DLOG
(
INFO
) << "enter Serialize";

41 ià(!
In™Paylßd
()) {

42 *
	gsize
 = 0;

43 
LOG
(
WARNING
) << "init…ayload failed";

44  
	gçl£
;

47 cÚ¡ 
	gBufãr
& 
	gbody
 = 
·ylßd_
.
body
();

48 cÚ¡ 
	g¡d
::
m­
<
ušt8_t
, 
	gBufãr
>& 
	gexŒas
 = 
·ylßd_
.
exŒas
();

50 
size_t
 
	gtÙ®
 = 0;

51 
size_t
 
	gext_Ën
 = 0;

52 ià(
	gbody
.
size
() > 0) {

53 
DLOG
(
INFO
è<< "£rŸlizbody, size: " << 
	gbody
.
size
();

54 
	gbufãrs
->
push_back
(
CÚ¡Bufãr
(
body
.
d©a
(), body.
size
()));

55 
	gtÙ®
 +ğ
body
.
size
();

58 ià(!
	gexŒas
.
em±y
()) {

59 
size_t
 
	gext_hdr_size
 = 
ExtH—d”
::
size
(
exŒas
.size());

61 
DLOG
(
INFO
è<< "£rŸlizexŒas,ƒxˆhd¸size: " << 
	gext_hdr_size
;

62 
	gexthdr_
.
Re£t
(
ext_hdr_size
);

64 
	gbufãrs
->
push_back
(
CÚ¡Bufãr
(
exthdr_
.
d©a
(), 
ext_hdr_size
));

65 
	gtÙ®
 +ğ
ext_hdr_size
;

67 
	gExtH—d”
::
Bud”
 
ext_hdr
(
exthdr_
.
d©a
());

68 
	g¡d
::
m­
<
ušt8_t
, 
	gBufãr
>::
cÚ¡_™”©Ü
 
™
 = 
exŒas
.
begš
();

69 ; 
	g™
 !ğ
exŒas
.
’d
(); ++it) {

70 
	gext_hdr
.
AddExtI‹m
(
™
->
fœ¡
, it->
£cÚd
.
size
());

71 
	gext_Ën
 +ğ
™
->
£cÚd
.
size
();

72 
	gbufãrs
->
push_back
(
CÚ¡Bufãr
(

73 
™
->
£cÚd
.
d©a
(), it->£cÚd.
size
()));

75 
	gtÙ®
 +ğ
ext_Ën
;

76 
CHECK_LE
(
ext_Ën
, 256*255U);

79 
	gH—d”
::
Bud”
 
hdr
(
h—d”_
);

80 
	ghdr
.
£t_body_size
(
body
.
size
());

81 
	ghdr
.
£t_ext_couÁ
(
exŒas
.
size
());

82 
	ghdr
.
£t_ext_Ën
(
ext_Ën
);

83 
	ghdr
.
Bud
();

84 *
	gsize
 = 
tÙ®
;

86 
	gH—d”
::
P¬£r
 
hdr_1
(
h—d”_
);

87 ià(!
	ghdr_1
.
IsV®id
()) {

88 
LOG
(
FATAL
) << "builder headerƒrror";

89  
	gçl£
;

92 
DLOG
(
INFO
è<< "S”Ÿlizšg " << " (id=" << 
	ghdr_1
.
id
()

93 << " body_ty³=" << ()
	ghdr_1
.
body_ty³
()

94 << " body_size=" << 
	ghdr_1
.
body_size
()

95 << "ƒxt_couÁ=" << ()
	ghdr_1
.
ext_couÁ
()

96 << "ƒxt_Ën=" << 
	ghdr_1
.
ext_Ën
()

99 
DLOG
(
INFO
è<< "h—d” magic: " << ()(*
	gbufãrs
)[0].
d©a
()[0];

101  
	gŒue
;

104 
	gOutgošgReque¡
::
OutgošgReque¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
msg
)

105 : 
msg_
(
msg
)

107 
H—d”
::
Bud”
 
hdr
(
h—d”_
);

108 
	ghdr
.
£t_ty³
(
H—d”
::
kReque¡
);

109 
	ghdr
.
£t_id
(
msg
->
id
());

110 
	ghdr
.
£t_body_ty³
(
msg
->
ty³
());

113 
boŞ
 
	gOutgošgReque¡
::
In™Paylßd
() {

114 
DLOG
(
INFO
) << "enter InitPayload";

115  
	gmsg_
->
	gim¶_
->
OnReque¡
(&
·ylßd_
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_packet.h

4 #iâdeà
LDD_NET_INTERNAL_OUTGOING_PACKET_H_


5 
	#LDD_NET_INTERNAL_OUTGOING_PACKET_H_


	)

7 
	~<veùÜ
>

8 
	~<ldd/ut/cÚ¡_bufãr.h
>

9 
	~"´ÙocŞ.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
usšg
 
Çme¥aû
 
	gldd
::
ut
;

16 
şass
 
	gIncomšgMsg
;

17 
şass
 
	gOutgošgMsg
;

19 şas 
	cOutgošgPack‘
 {

20 
	gpublic
:

21 
OutgošgPack‘
();

22 
	gvœtu®
 ~
OutgošgPack‘
() {}

23 
size_t
 
S”ŸlizeTo
(
¡d
::
veùÜ
<
CÚ¡Bufãr
>* 
bufãrs
);

24 
Di§bË
(è{ 
	gdi§bËd_
 = 
Œue
; }

25 
	g´Ùeùed
:

26 
vœtu®
 
boŞ
 
S”Ÿlize
(
¡d
::
veùÜ
<
CÚ¡Bufãr
>* 
bufãrs
,

27 
size_t
* 
size
) {

28 *
	gsize
 = 0;

29  
	gŒue
;

32 
	gh—d”_
[
H—d”
::
kBy‹Size
];

33 
boŞ
 
	gdi§bËd_
;

36 şas 
	cOutgošgPšg
 : 
public
 
OutgošgPack‘
 {

37 
public
:

38 
OutgošgPšg
(
Mes§geId
 
id
) {

39 
H—d”
::
Bud”
 
hdr
(
h—d”_
);

40 
	ghdr
.
£t_ty³
(
H—d”
::
kPšg
);

41 
	ghdr
.
£t_id
(
id
);

42 
	ghdr
.
Bud
();

46 şas 
	cOutgošgPÚg
 : 
public
 
OutgošgPack‘
 {

47 
public
:

48 
OutgošgPÚg
(
Mes§geId
 
id
) {

49 
H—d”
::
Bud”
 
hdr
(
h—d”_
);

50 
	ghdr
.
£t_ty³
(
H—d”
::
kPÚg
);

51 
	ghdr
.
£t_id
(
id
);

52 
	ghdr
.
Bud
();

56 şas 
	cOutgošgPack‘W™hPaylßd
 : 
public
 
OutgošgPack‘
 {

57 
public
:

58 
OutgošgPack‘W™hPaylßd
(cÚ¡ 
Paylßd
& 
·ylßd
)

59 : 
·ylßd_
(
·ylßd
)

61 
OutgošgPack‘W™hPaylßd
() {}

63 
´Ùeùed
:

64 
boŞ
 
S”Ÿlize
(
¡d
::
veùÜ
<
CÚ¡Bufãr
>* 
bufãrs
,

65 
size_t
* 
size
);

66 
vœtu®
 
boŞ
 
In™Paylßd
() = 0;

67 
Paylßd
 
	g·ylßd_
;

68 
Bufãr
 
	gexthdr_
;

71 şas 
	cOutgošgReque¡
 : 
public
 
OutgošgPack‘W™hPaylßd
 {

72 
public
:

73 
OutgošgReque¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
msg
);

74 
vœtu®
 
boŞ
 
In™Paylßd
();

75 
	g´iv©e
:

76 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
msg_
;

79 şas 
	cOutgošgRe¥Ú£
: 
public
 
OutgošgPack‘W™hPaylßd
 {

80 
public
:

81 
OutgošgRe¥Ú£
(
Mes§geId
 
id
, cÚ¡ 
Paylßd
& 
·ylßd
)

82 : 
OutgošgPack‘W™hPaylßd
(
·ylßd
), 
Ï¡_
(
çl£
), 
code_
(0) {

83 
	gH—d”
::
Bud”
 
hdr
(
h—d”_
);

84 
	ghdr
.
£t_ty³
(
H—d”
::
kRe¥Ú£
);

85 
	ghdr
.
£t_id
(
id
);

87 
vœtu®
 
boŞ
 
In™Paylßd
() {

88 ià(
Ï¡
()) {

89 
DLOG
(
INFO
) << "InitPayload,ype: "

90 << 
	gH—d”
::
kLa¡


91 << ", bodyy³: " << 
code
();

92 
	gH—d”
::
Bud”
 
hdr
(
h—d”_
);

93 
	ghdr
.
£t_ty³
(
H—d”
::
kLa¡
);

94 
	ghdr
.
£t_body_ty³
(
code
());

96  
	gŒue
;

98 
£t_Ï¡
(
boŞ
 
Ï¡
è{ 
	gÏ¡_
 =†ast; }

99 
£t_code
(
Code
 
code
è{ 
	gcode_
 = code; }

101 
boŞ
 
Ï¡
(ècÚ¡ {  
	gÏ¡_
; }

102 
Code
 
code
(ècÚ¡ {  
	gcode_
; }

103 
	g´iv©e
:

104 
boŞ
 
Ï¡_
;

105 
Code
 
	gcode_
;

108 şas 
	cOutgošgEnd
 : 
public
 
OutgošgPack‘
 {

109 
public
:

110 
OutgošgEnd
(
Mes§geId
 
id
, 
Code
 
code
) {

111 
	gH—d”
::
Bud”
 
hdr
(
h—d”_
);

112 
	ghdr
.
£t_ty³
(
H—d”
::
kEnd
);

113 
	ghdr
.
£t_id
(
id
);

114 
	ghdr
.
£t_body_ty³
(
code
);

115 
	ghdr
.
Bud
();

119 şas 
	cOutgošgCªûl
 : 
public
 
OutgošgPack‘
 {

120 
public
:

121 
OutgošgCªûl
(
Mes§geId
 
id
) {

122 
H—d”
::
Bud”
 
hdr
(
h—d”_
);

123 
	ghdr
.
£t_ty³
(
H—d”
::
kCªûl
);

124 
	ghdr
.
£t_id
(
id
);

125 
	ghdr
.
Bud
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/protocol.cc

1 
	~<¬·/š‘.h
>

2 
	~<boo¡/üc.hµ
>

3 
	~<glog/loggšg.h
>

4 
	~"´ÙocŞ.h
"

6 
Çme¥aû
 
	gldd
 {

7 
Çme¥aû
 
	gÃt
 {

9 
	gH—d”
::
P¬£r
::P¬£r(cÚ¡ * 
buf
)

10 : 
buf_
(
buf
) {

11 
CHECK_NOTNULL
(
buf_
);

14 
boŞ
 
	gH—d”
::
P¬£r
::
IsV®id
() const

16 
ušt8_t
 
by‹
 = 
buf_
[0];

17 ià(
	gby‹
 !ğ
kMagic
) {

18 
LOG
(
ERROR
è<< "P¬£d invlŸd h—d” magic: " << ()
by‹
;

19  
	gçl£
;

22 
	gboo¡
::
üc_cc™t_ty³
 
»suÉ
;

23 
	g»suÉ
.
´oûss_by‹s
(
buf_
, 14);

24 
ušt16_t
 
	güc16_Ãw
 = 
»suÉ
.
checksum
();

25 
ušt16_t
 
	güc16_Üigš
 = 
Áohs
(

26 *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
 *>(&
buf_
[
kBy‹Size
 - 2]));

28 ià(
	güc16_Ãw
 !ğ
üc16_Üigš
) {

29 
LOG
(
ERROR
) << "invalid header, wrong crc16 ";

30  
	gçl£
;

33  
	gŒue
;

36 
ušt8_t
 
	gH—d”
::
P¬£r
::
ty³
() const {

37  
buf_
[1];

40 
ušt32_t
 
	gH—d”
::
P¬£r
::
id
() const {

41  
Áohl
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt32_t
*>(
buf_
 + 2));

44 
ušt16_t
 
	gH—d”
::
P¬£r
::
body_ty³
() const {

45  
Áohs
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
*>(
buf_
 + 6));

48 
ušt32_t
 
	gH—d”
::
P¬£r
::
body_size
() const {

49  
Áohl
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt32_t
*>(
buf_
 + 8)) >> 8;

52 
ušt8_t
 
	gH—d”
::
P¬£r
::
ext_couÁ
() const {

53  *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
*>(
buf_
 + 11);

56 
ušt16_t
 
	gH—d”
::
P¬£r
::
ext_Ën
() const {

57  
Áohs
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
*>(
buf_
 + 12));

61 
	gH—d”
::
Bud”
::Bud”(* 
buf
)

62 : 
buf_
(
buf
) {

63 
CHECK_NOTNULL
(
buf_
);

66 
	gH—d”
::
Bud”
::
Bud
() {

67 
buf_
[0] = 
kMagic
;

68 
	gboo¡
::
üc_cc™t_ty³
 
»suÉ
;

69 
	g»suÉ
.
´oûss_by‹s
(
buf_
, 14);

70 
ušt16_t
 
	güc16
 = 
»suÉ
.
checksum
();

71 *
	g»š‹½»t_ÿ¡
<
	gušt16_t
*>(&
	gbuf_
[
kBy‹Size
 - 2]èğ
htÚs
(
üc16
);

74 
	gH—d”
::
Bud”
::
£t_ty³
(
ušt8_t
 
ty³
) {

75 
buf_
[1] = 
¡©ic_ÿ¡
<>(
ty³
);

78 
	gH—d”
::
Bud”
::
£t_id
(
ušt32_t
 
id
) {

79 *
»š‹½»t_ÿ¡
<
ušt32_t
*>(
buf_
 + 2èğ
htÚl
(
id
);

82 
	gH—d”
::
Bud”
::
£t_body_ty³
(
ušt16_t
 
body_ty³
) {

83 *
»š‹½»t_ÿ¡
<
ušt16_t
*>(
buf_
 + 6èğ
htÚs
(
body_ty³
);

86 
	gH—d”
::
Bud”
::
£t_body_size
(
ušt32_t
 
body_size
) {

87 
ušt8_t
 
x
 = *
»š‹½»t_ÿ¡
<cÚ¡ ušt8_t*>(
buf_
 + 11);

88 *
	g»š‹½»t_ÿ¡
<
	gušt32_t
*>(
	gbuf_
 + 8èğ
htÚl
(
body_size
 << 8);

89 *
	g»š‹½»t_ÿ¡
<
	gušt8_t
*>(
	gbuf_
 + 11èğ
x
;

92 
	gH—d”
::
Bud”
::
£t_ext_couÁ
(
ušt8_t
 
ext_couÁ
) {

93 *
»š‹½»t_ÿ¡
<
ušt8_t
*>(
buf_
 + 11èğ
ext_couÁ
;

96 
	gH—d”
::
Bud”
::
£t_ext_Ën
(
ušt16_t
 
ext_Ën
) {

97 *
»š‹½»t_ÿ¡
<
ušt16_t
*>(
buf_
 + 12èğ
htÚs
(
ext_Ën
);

101 
	gExtH—d”
::
P¬£r
::P¬£r(
ušt8_t
 
ext_couÁ
, cÚ¡ * 
buf
)

102 : 
ext_couÁ_
(
ext_couÁ
), 
ext_buf_
(
buf
)

106 
boŞ
 
	gExtH—d”
::
P¬£r
::
IsV®id
(
ušt16_t
 
ext_Ën
) const

108 
ušt16_t
 
Ën
 = 0;

110 
	gi
 = 0; i < ()
	gext_couÁ_
; i++) {

111 
	gpos
 = 
i
 * 
kUn™Size
;

112 
	gËn
 +ğ
¡©ic_ÿ¡
<
ušt8_t
>(*(
ext_buf_
 + 
pos
 + 1));

115 ià(
	gËn
 !ğ
ext_Ën
) {

116 
LOG
(
ERROR
) << "invalidƒxtras†ength,ƒxpected†en="

117 << 
ext_Ën
 << ", buˆaùu®†’=" << 
Ën
;

118  
	gçl£
;

121  
	gŒue
;

124 
boŞ
 
	gExtH—d”
::
P¬£r
::
G‘ExtI‹m
(
šdex
, 
ušt8_t
 *
ty³
, ušt8_ˆ*
Ën
)

126 ià(
	gšdex
 > 
	gext_couÁ_
) {

127 
LOG
(
WARNING
è<< "šv®idƒxŒa šdex: " << 
	gšdex
;

128  
	gçl£
;

131 
	gpos
 = 
šdex
 * 
kUn™Size
;

132 *
	gty³
 = 
¡©ic_ÿ¡
<
ušt8_t
>(*(
ext_buf_
 + 
pos
));

133 *
	gËn
 = 
¡©ic_ÿ¡
<
ušt8_t
>(*(
ext_buf_
 + 
pos
 + 1));

135  
	gŒue
;

138 
	gExtH—d”
::
Bud”
::Bud”(* 
buf
)

139 : 
ext_couÁ_
(0), 
ext_buf_
(
buf
)

143 
	gExtH—d”
::
Bud”
::
AddExtI‹m
(
ušt8_t
 
ty³
, ušt8_ˆ
Ën
)

145 
	gpos
 = 
ext_couÁ_
 * 
kUn™Size
;

146 *(
	gext_buf_
 + 
	gpos
èğ
¡©ic_ÿ¡
<>(
ty³
);

147 *(
	gext_buf_
 + 
	gpos
 + 1èğ
¡©ic_ÿ¡
<>(
Ën
);

148 
	gext_couÁ_
++;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/protocol.h

1 #iâdeà
LDD_NET_PROTOCOL_H_


2 
	#LDD_NET_PROTOCOL_H_


	)

4 
	~<¡dšt.h
>

6 
Çme¥aû
 
	gldd
 {

7 
Çme¥aû
 
	gÃt
 {

21 şas 
	cH—d”
 {

22 
	gpublic
:

23 cÚ¡ 
size_t
 
kBy‹Size
 = 16;

24 cÚ¡ 
ušt8_t
 
	gkMagic
 = 0xA1;

26 
	eTy³
 {

28 
	gkReque¡
 = 0,

29 
	gkPšg
,

30 
	gkCªûl
,

33 
	gkRe¥Ú£
 = 128,

34 
	gkPÚg
,

35 
	gkLa¡
,

36 
	gkEnd
,

39 şas 
	cP¬£r
 {

40 
	gpublic
:

41 
P¬£r
(cÚ¡ * 
buf
);

42 
boŞ
 
IsV®id
() const;

44 
ušt8_t
 
ty³
() const;

45 
ušt32_t
 
id
() const;

46 
ušt16_t
 
body_ty³
() const;

47 
ušt32_t
 
body_size
() const;

48 
ušt8_t
 
ext_couÁ
() const;

49 
ušt16_t
 
ext_Ën
() const;

50 
	g´iv©e
:

51 cÚ¡ * 
buf_
;

54 şas 
	cBud”
 {

55 
	gpublic
:

56 
Bud”
(* 
buf
);

57 
Bud
();

59 
£t_ty³
(
ušt8_t
 
ty³
);

60 
£t_id
(
ušt32_t
 
id
);

61 
£t_body_ty³
(
ušt16_t
 
body_ty³
);

62 
£t_body_size
(
ušt32_t
 
body_size
);

63 
£t_ext_couÁ
(
ušt8_t
 
ext_couÁ
);

64 
£t_ext_Ën
(
ušt16_t
 
ext_Ën
);

65 
	g´iv©e
:

66 * 
buf_
;

70 şas 
	cExtH—d”
 {

71 
	gpublic
:

72 cÚ¡ 
kUn™Size
 = 2;

73 
ušt32_t
 
size
(
couÁ
è{  
	gcouÁ
 * 2; }

75 şas 
	cP¬£r
 {

76 
	gpublic
:

77 
P¬£r
(
ušt8_t
 
ext_couÁ
, cÚ¡ * 
buf
);

78 
boŞ
 
IsV®id
(
ušt16_t
 
ext_Ën
) const;

80 
boŞ
 
G‘ExtI‹m
(
šdex
, 
ušt8_t
 *
ty³
, ušt8_ˆ*
Ën
);

81 
	g´iv©e
:

82 
ušt8_t
 
ext_couÁ_
;

83 cÚ¡ * 
	gext_buf_
;

86 şas 
	cBud”
 {

87 
	gpublic
:

88 
Bud”
(* 
buf
);

89 
AddExtI‹m
(
ušt8_t
 
ty³
, ušt8_ˆ
Ën
);

90 
	g´iv©e
:

91 
ext_couÁ_
;

92 * 
	gext_buf_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_checker.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"pul£_check”.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gPul£Check”
::
Pul£Check”
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
R•Ü‹r
& 
»pÜ‹r
,

12 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

13 : 
tim”_
(
ev’t_loİ
),

14 
»pÜ‹r_
(
»pÜ‹r
),

15 
š‹rv®_
(
š‹rv®
),

16 
ruÂšg_
(
çl£
)

20 
	gPul£Check”
::
S¹
() {

21 
CHECK
(!
ruÂšg
());

22 
	gruÂšg_
 = 
Œue
;

23 
	gut
::
TimeDiff
 
td
 = 
š‹rv®
() * 2;

24 
DLOG
(
INFO
) << "PulseChecker call start,…ulse interval: "

25 << 
	gtd
.
ToMli£cÚds
();

27 
tim”
().
AsyncWa™
(

28 
boo¡
::
bšd
(&
Pul£Check”
::
R•Üt
, 
this
),

29 
š‹rv®
() * 2);

32 
	gPul£Check”
::
Stİ
() {

33 
CHECK
(
ruÂšg
());

34 
	gruÂšg_
 = 
çl£
;

36 
tim”
().
Cªûl
();

39 
	gPul£Check”
::
NÙifyIncomšgPul£
() {

40 ià(
ruÂšg
()) {

41 
IncomšgPul£
();

45 
	gPul£Check”
::
NÙifyIncomšgPack‘
() {

46 ià(
ruÂšg
()) {

47 
IncomšgPack‘
();

51 
	gSŒiùPul£Check”
::
IncomšgPul£
() {

52 
ut
::
TimeDiff
 
td
 = 
š‹rv®
() * 2;

53 
DLOG
(
INFO
) << "StrictPulseChecker call IncomingPulse, interval: "

54 << 
	gtd
.
ToMli£cÚds
();

55 
tim”
().
AsyncWa™
(

56 
boo¡
::
bšd
(&
SŒiùPul£Check”
::
R•Üt
, 
this
),

57 
š‹rv®
() * 2);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_checker.h

4 #iâdeà
LDD_NET_INTERNAL_PULSE_CHECKER_H_


5 
	#LDD_NET_INTERNAL_PULSE_CHECKER_H_


	)

7 
	~<boo¡/funùiÚ.hµ
>

8 
	~"ldd/Ãt/ev’t.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gEv’tLoİ
;

15 şas 
	cPul£Check”
 {

16 
	gpublic
:

17 
boo¡
::
	tfunùiÚ
<()> 
	tR•Ü‹r
;

19 
Pul£Check”
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
R•Ü‹r
& 
»pÜ‹r
,

20 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
);

21 
	gvœtu®
 ~
Pul£Check”
() {}

22 
S¹
();

23 
Stİ
();

24 
NÙifyIncomšgPul£
();

25 
NÙifyIncomšgPack‘
();

26 
boŞ
 
ruÂšg
(ècÚ¡ {  
	gruÂšg_
; }

27 
	g´Ùeùed
:

28 
vœtu®
 
IncomšgPul£
() = 0;

29 
vœtu®
 
IncomšgPack‘
() = 0;

30 
R•Üt
(ècÚ¡ { 
»pÜ‹r_
(); }

31 cÚ¡ 
	gut
::
TimeDiff
& 
š‹rv®
(ècÚ¡ {  
š‹rv®_
; }

32 
	gTim”Ev’t
& 
tim”
(è{  
	gtim”_
; }

33 
	g´iv©e
:

34 
Tim”Ev’t
 
tim”_
;

35 
R•Ü‹r
 
	g»pÜ‹r_
;

36 
	gut
::
TimeDiff
 
š‹rv®_
;

37 
boŞ
 
	gruÂšg_
;

40 şas 
	cSŒiùPul£Check”
 : 
public
 
Pul£Check”
 {

41 
public
:

42 
SŒiùPul£Check”
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
R•Ü‹r
& 
»pÜ‹r
,

43 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

44 : 
Pul£Check”
(
ev’t_loİ
, 
»pÜ‹r
, 
š‹rv®
) {}

45 
vœtu®
 
IncomšgPul£
();

46 
vœtu®
 
IncomšgPack‘
() {

47 
DLOG
(
INFO
) << "enter IncomingPacket,‚othingo do in StrictPulseChecker";

51 şas 
	cR–axedPul£Check”
 : 
public
 
SŒiùPul£Check”
 {

52 
public
:

53 
R–axedPul£Check”
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
R•Ü‹r
& 
»pÜ‹r
,

54 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

55 : 
SŒiùPul£Check”
(
ev’t_loİ
, 
»pÜ‹r
, 
š‹rv®
) {}

56 
vœtu®
 
IncomšgPack‘
() {

57 
DLOG
(
INFO
) << "enter IncomingPacket, call NotifyIncomingPulse in RelaxedPulseChecker";

58 
NÙifyIncomšgPul£
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_emitter.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~"pul£_em™‹r.h
"

8 
Çme¥aû
 
	gldd
 {

9 
Çme¥aû
 
	gÃt
 {

11 
	gPul£Em™‹r
::
S¹
(
boŞ
 
em™
) {

12 
CHECK
(!
ruÂšg
());

13 
	gruÂšg_
 = 
Œue
;

14 ià(
	gem™
) {

15 
Pul£
();

17 
DoS¹
();

20 
	gPul£Em™‹r
::~
Pul£Em™‹r
() {

21 
tim”
().
Cªûl
();

24 
	gPul£Em™‹r
::
Stİ
() {

25 
CHECK
(
ruÂšg
());

26 
	gruÂšg_
 = 
çl£
;

27 
tim”
().
Cªûl
();

30 
	gPul£Em™‹r
::
NÙifyIncomšgPul£
() {

31 ià(
ruÂšg
()) {

32 
IncomšgPul£
();

36 
	gPul£Em™‹r
::
NÙifyIncomšgPack‘
() {

37 ià(
ruÂšg
()) {

38 
IncomšgPack‘
();

42 
	gPul£Em™‹r
::
NÙifyOutgošgPack‘
() {

43 
DLOG
(
INFO
) << "enter NotifyOutgoingPacket";

44 ià(
ruÂšg
()) {

45 
DLOG
(
INFO
) << "PulseEmitter call OutgoingPacket";

46 
OutgošgPack‘
();

50 
	gClockPul£Em™‹r
::
DoS¹
() {

51 
DLOG
(
INFO
) << "ClockPulseEmitter call DoStart, interval: "

52 << 
š‹rv®
().
ToMli£cÚds
();

53 
tim”
().
AsyncWa™
(

54 
boo¡
::
bšd
(&
ClockPul£Em™‹r
::
DoPul£
, 
this
), 
š‹rv®
());

57 
	gClockPul£Em™‹r
::
DoPul£
() {

58 
Pul£
();

59 
DLOG
(
INFO
) << "ClockPulseEmitter call DoPulse, interval: "

60 << 
š‹rv®
().
ToMli£cÚds
();

61 
tim”
().
AsyncWa™
(

62 
boo¡
::
bšd
(&
ClockPul£Em™‹r
::
DoPul£
, 
this
), 
š‹rv®
());

65 
	gR•lyPul£Em™‹r
::
DoS¹
() {

68 
R•lyPul£Em™‹r
::
IncomšgPul£
() {

69 
Pul£
();

72 
	gLazyPul£Em™‹r
::
DoS¹
() {

73 
DLOG
(
INFO
) << "LazyPulseEmitter call DoStart, interval: "

74 << 
š‹rv®
().
ToMli£cÚds
();

75 
tim”
().
AsyncWa™
(

76 
boo¡
::
bšd
(&
LazyPul£Em™‹r
::
Pul£
, 
this
), 
š‹rv®
());

79 
	gLazyPul£Em™‹r
::
OutgošgPack‘
() {

80 
DLOG
(
INFO
) << "enter OutgoingPacket, interval: "

81 << 
š‹rv®
().
ToMli£cÚds
();

82 
tim”
().
AsyncWa™
(

83 
boo¡
::
bšd
(&
LazyPul£Em™‹r
::
Pul£
, 
this
), 
š‹rv®
());

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_emitter.h

4 #iâdeà
LDD_NET_INTERNAL_PULSE_EMITTER_H_


5 
	#LDD_NET_INTERNAL_PULSE_EMITTER_H_


	)

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~"ldd/Ãt/ev’t.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cPul£Em™‹r
 : 
boo¡
::
nÚcİyabË
 {

15 
public
:

16 
boo¡
::
	tfunùiÚ
<()> 
	tPul£r
;

17 
Pul£Em™‹r
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
Pul£r
& 
pul£r
,

18 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

19 : 
tim”_
(
ev’t_loİ
), 
pul£r_
(
pul£r
), 
š‹rv®_
(
š‹rv®
),

20 
ruÂšg_
(
çl£
) {}

21 
	gvœtu®
 ~
Pul£Em™‹r
();

22 
S¹
(
boŞ
 
em™
 = 
çl£
);

23 
Stİ
();

24 
boŞ
 
ruÂšg
(ècÚ¡ {  
	gruÂšg_
; }

26 
NÙifyIncomšgPul£
();

27 
NÙifyIncomšgPack‘
();

28 
NÙifyOutgošgPack‘
();

29 
	g´Ùeùed
:

30 
vœtu®
 
DoS¹
() = 0;

31 
vœtu®
 
IncomšgPul£
() = 0;

32 
vœtu®
 
IncomšgPack‘
() = 0;

33 
vœtu®
 
OutgošgPack‘
() = 0;

34 
Pul£
(è{ 
pul£r_
(); }

35 cÚ¡ 
	gut
::
TimeDiff
& 
š‹rv®
(ècÚ¡ {  
š‹rv®_
; }

36 
	gTim”Ev’t
& 
tim”
(è{  
	gtim”_
; }

37 
	g´iv©e
:

38 
Tim”Ev’t
 
tim”_
;

39 
Pul£r
 
	gpul£r_
;

40 
	gut
::
TimeDiff
 
š‹rv®_
;

41 
boŞ
 
	gruÂšg_
;

44 şas 
	cClockPul£Em™‹r
 : 
public
 
Pul£Em™‹r
 {

45 
public
:

46 
ClockPul£Em™‹r
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
Pul£r
& 
pul£r
,

47 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

48 : 
Pul£Em™‹r
(
ev’t_loİ
, 
pul£r
, 
š‹rv®
) {}

49 
vœtu®
 
DoS¹
();

50 
vœtu®
 
IncomšgPul£
() {}

51 
vœtu®
 
IncomšgPack‘
() {}

52 
vœtu®
 
OutgošgPack‘
() {}

53 
	g´iv©e
:

54 
DoPul£
();

57 şas 
	cR•lyPul£Em™‹r
 : 
public
 
Pul£Em™‹r
 {

58 
public
:

59 
R•lyPul£Em™‹r
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
Pul£r
& 
pul£r
,

60 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

61 : 
Pul£Em™‹r
(
ev’t_loİ
, 
pul£r
, 
š‹rv®
) {}

62 
vœtu®
 
DoS¹
();

63 
vœtu®
 
IncomšgPul£
();

64 
vœtu®
 
IncomšgPack‘
() {}

65 
vœtu®
 
OutgošgPack‘
() {}

68 şas 
	cLazyPul£Em™‹r
 : 
public
 
Pul£Em™‹r
 {

69 
public
:

70 
LazyPul£Em™‹r
(
Ev’tLoİ
* 
ev’t_loİ
, cÚ¡ 
Pul£r
& 
pul£r
,

71 cÚ¡ 
ut
::
TimeDiff
& 
š‹rv®
)

72 : 
Pul£Em™‹r
(
ev’t_loİ
, 
pul£r
, 
š‹rv®
) {}

73 
vœtu®
 
DoS¹
();

74 
vœtu®
 
IncomšgPul£
() {}

75 
vœtu®
 
IncomšgPack‘
() {}

76 
vœtu®
 
OutgošgPack‘
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/server_impl.cc

4 
	~<boo¡/make_sh¬ed.hµ
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<glog/loggšg.h
>

7 
	~"£rv”_im¶.h
"

8 
	~"chªÃl_im¶.h
"

9 
	~"ev’t_loİ_im¶.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
usšg
 
Çme¥aû
 
	gboo¡
;

16 
	gÇme¥aû
 {

18 cÚ¡ 
	gkDeçuÉPul£IÁ”v®
 = 100;

19 cÚ¡ 
	gkDeçuÉB©chAcû±
 = 10;

20 cÚ¡ 
	gkDeçuÉR—dBufãrSize
 = 4;

21 cÚ¡ 
	gkDeçuÉWr™eBufãrSize
 = 4;

23 
	gS”v”
::
O±iÚs
 
Sª™izeO±iÚs
(cÚ¡ 
S”v”
::O±iÚs& 
İtiÚs
) {

24 
S”v”
::
O±iÚs
 
o
(
İtiÚs
);

25 ià(
	go
.
	gpul£_š‹rv®
 <= 0) {

26 
o
.
pul£_š‹rv®
 = 
kDeçuÉPul£IÁ”v®
;

28 ià(
	go
.
	gb©ch_acû±
 <= 0) {

29 
o
.
b©ch_acû±
 = 
kDeçuÉB©chAcû±
;

31 ià(
	go
.
	gth»ads_di¥©chšg
 < 0 ||

32 
	go
.
	gth»ads_di¥©chšg
 > 
	gS”v”
::
kHashšg
) {

33 
o
.
th»ads_di¥©chšg
 = 
S”v”
::
kNÜm®
;

36  
	go
;

41 #ifdeà
RES_COUNTER


42 
	gut
::
Atomic
<
ušt64_t
> 
S”v”
::
Im¶
::
Ãxt_id_
;

43 
	gut
::
Atomic
<
ušt64_t
> 
S”v”
::
Im¶
::
ä“_id_
;

46 
	gS”v”
::
O±iÚs
::Options()

47 : 
pul£_š‹rv®
(
kDeçuÉPul£IÁ”v®
),

48 
pul£_»Ïxed_checkšg
(
çl£
),

49 
pul£_Ïzy_em™tšg
(
çl£
),

50 
b©ch_acû±
(
kDeçuÉB©chAcû±
),

51 
nÙify_cÚÃùed
(
NULL
),

52 
nÙify_şo£d
(
NULL
),

53 
th»ads
(
NULL
),

54 
th»ads_di¥©chšg
(
kNÜm®
),

55 
»ad_bufãr_size
(
kDeçuÉR—dBufãrSize
),

56 
wr™e_bufãr_size
(
kDeçuÉWr™eBufãrSize
)

60 
	gS”v”
::
Im¶
::Im¶(
S”v”
* 
£rv”
, cÚ¡ 
O±iÚs
& 
İtiÚs
)

61 : 
£rv”_
(
£rv”
),

62 
İtiÚs_
(
Sª™izeO±iÚs
(
İtiÚs
)),

63 
li¡’”_
(
NULL
),

64 
th»ad_idx_
(0)

68 
	gS”v”
::
Im¶
::~Impl() {

69 
Stİ
();

72 
boŞ
 
	gS”v”
::
Im¶
::
S¹
(
Li¡’”
::Im¶* 
li¡’”
) {

73 
CHECK_NOTNULL
(
li¡’”
);

74 
CHECK
(
li¡’”_
 =ğ
NULL
);

75 ià(!
	gli¡’”
->
IsO³n
()) {

76  
	gçl£
;

78 
	gli¡’”_
 = 
li¡’”
;

79 
	gev’t_
.
»£t
(
Ãw
 
FdEv’t
(
li¡’”_
->
ev’t_loİ
()));

80 
Acû±
();

81  
	gŒue
;

84 
	gS”v”
::
Im¶
::
Acû±
() {

85 
ev’t_
->
AsyncWa™
(
li¡’”_
->
fd
(), 
FdEv’t
::
kR—dabË
,

86 
boo¡
::
bšd
(&
S”v”
::
Im¶
::
HªdËAcû±
, 
this
, 
_1
));

89 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
S”v”
::
Im¶
::
NewChªÃl
() {

90 
Ev’tLoİ
* 
ev’t_loİ
 = 
li¡’”_
->event_loop();

91 ià(
İtiÚs
().
	gth»ads
 && !İtiÚs().th»ads->
em±y
()) {

92 
	gev’t_loİ
 = 
İtiÚs
().
th»ads
->
©
(

93 
th»ad_idx_
++ % 
İtiÚs
().
th»ads
->
size
()).
ev’t_loİ
();

94 
DLOG
(
INFO
è<< "NewChªÃl,ƒv’t_loİ: " << 
	gev’t_loİ


95 << ",ƒv’t_ba£: " << 
	gev’t_loİ
->
	gim¶_
->
ev’t_ba£
();

98  
	gmake_sh¬ed
<
	gChªÃl
>(
	gev’t_loİ
, 
	gthis
);

101 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
S”v”
::
Im¶
::
NewChªÃl
(cÚ¡ 
Add»ss
& 
addr
) {

102 
Ev’tLoİ
* 
ev’t_loİ
 = 
li¡’”_
->event_loop();

103 ià(
İtiÚs
().
	gth»ads
 && !İtiÚs().th»ads->
em±y
()) {

104 
	gev’t_loİ
 = 
İtiÚs
().
th»ads
->
©
(

105 
addr
.
ToU32
(è% 
İtiÚs
().
th»ads
->
size
()).
ev’t_loİ
();

106 
DLOG
(
INFO
è<< "NewCahÂ– w™h‡ddr,ƒv’t_loİ: " << 
	gev’t_loİ


107 << ",ƒv’t_ba£: " << 
	gev’t_loİ
->
	gim¶_
->
ev’t_ba£
();

110  
	gmake_sh¬ed
<
	gChªÃl
>(
	gev’t_loİ
, 
	gthis
);

113 
	gS”v”
::
Im¶
::
O³nTh»adChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
) {

114 
chªÃl
->
im¶_
->
O³n
();

117 
	gS”v”
::
Im¶
::
O³nChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
) {

118 ià(
chªÃl
->
ev’t_loİ
(è!ğ
li¡’”_
->event_loop()) {

119 
chªÃl
->
ev’t_loİ
()->
QueueInLoİ
(

120 
boo¡
::
bšd
(&
Im¶
::
O³nTh»adChªÃl
, 
chªÃl
));

122 
	gchªÃl
->
	gim¶_
->
O³n
();

126 
	gS”v”
::
Im¶
::
HªdËAcû±
() {

127 
n
 = 0;

128 
	gn
++ < 
İtiÚs
().
	gb©ch_acû±
) {

129 
sockaddr_¡Üage
 
	gaddr_¡Üage
;

130 
sockËn_t
 
	gadd¾’
 = (
addr_¡Üage
);

131 
	gfd
 = 
acû±
(
li¡’”_
->
fd
(), (
sockaddr
*)&
addr_¡Üage
, &
add¾’
);

132 ià(
	gfd
 < 0) {

133 ià(
	g”ºo
 !ğ
EAGAIN
 && 
”ºo
 !ğ
EWOULDBLOCK
) {

134 
PLOG
(
INFO
) << "Accept";

138 
Add»ss
 
	gaddr
;

139 ià(
	gaddr_¡Üage
.
	gss_çmy
 =ğ
AF_INET
) {

140 
sockaddr_š
* 
addr_š
 = (sockaddr_š*)&
addr_¡Üage
;

141 
	gaddr
 = 
Add»ss
(
addr_š
->
sš_addr
);

142 
LOG
(
INFO
è<< "acû±ed from : " << 
	gaddr
.
ToSŒšg
()

143 << ",†i¡’ fd:" << 
	gli¡’”_
->
fd
()

144 << ", cl›Á fd: " << 
	gfd
;

145 } ià(
	gaddr_¡Üage
.
	gss_çmy
 =ğ
AF_INET6
) {

146 
LOG
(
WARNING
) << "inet 6 socket connected,‚ot supported";

147 
şo£
(
fd
);

150 
LOG
(
ERROR
) << "unknown socket family connected";

151 
şo£
(
fd
);

155 #ifdeà
RES_COUNTER


156 
	gÃxt_id_
++;

159 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl
;

160 ià(
İtiÚs
().
	gth»ads_di¥©chšg
 =ğ
kHashšg
) {

161 
chªÃl
 = 
NewChªÃl
(
addr
);

163 
	gchªÃl
 = 
NewChªÃl
();

165 
	gchªÃl
->
	gim¶_
->
£t_sock‘
(
fd
);

166 
O³nChªÃl
(
chªÃl
);

168 
Acû±
();

171 
	gS”v”
::
Im¶
::
Stİ
() {

172 ià(
li¡’”_
) {

173 
ev’t_
.
»£t
();

174 
	gli¡’”_
 = 
NULL
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/server_impl.h

4 #iâdeà
LDD_NET_INTERNAL_SERVER_IMPL_H_


5 
	#LDD_NET_INTERNAL_SERVER_IMPL_H_


	)

7 
	~"ldd/Ãt/£rv”.h
"

8 
	~"li¡’”_im¶.h
"

9 
	~"ldd/Ãt/ev’t.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cS”v”
::
Im¶
 {

15 
public
:

16 
ex¶ic™
 
Im¶
(
S”v”
* 
£rv”
, cÚ¡ 
O±iÚs
& 
İtiÚs
);

17 ~
Im¶
();

19 
boŞ
 
S¹
(
Li¡’”
::
Im¶
* 
li¡’”
);

20 
Stİ
();

22 
S”v”
* 
owÃr
(è{  
	g£rv”_
; }

23 cÚ¡ 
	gO±iÚs
& 
İtiÚs
(è{  
	gİtiÚs_
; }

24 
	g´iv©e
:

25 
Acû±
();

26 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
NewChªÃl
();

27 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
NewChªÃl
(cÚ¡ 
Add»ss
& 
addr
);

29 
HªdËAcû±
();

30 
O³nChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

31 
O³nTh»adChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

33 
S”v”
* 
	g£rv”_
;

34 
O±iÚs
 
	gİtiÚs_
;

35 
	gLi¡’”
::
Im¶
* 
li¡’”_
;

36 
	gboo¡
::
scİed_±r
<
FdEv’t
> 
ev’t_
;

37 
ušt32_t
 
	gth»ad_idx_
;

39 #ifdeà
RES_COUNTER


40 
	g´iv©e
:

42 
ä›nd
 
şass
 
St
;

43 
ä›nd
 
şass
 
	gIncomšgChªÃl
;

44 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

45 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

46 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

47 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/task.cc

4 
	~<ev’t2/ev’t.h
>

5 
	~<glog/loggšg.h
>

7 
	~<ldd/Ãt/bufãr.h
>

9 
	~"sk.h
"

11 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

13 #ifdeà
RES_COUNTER


14 
	gut
::
Atomic
<
ušt64_t
> 
Task
::
Ãxt_id_
;

15 
	gut
::
Atomic
<
ušt64_t
> 
Task
::
ä“_id_
;

18 
	gTask
::
Task
()

19 : 
is_£t_
(
çl£
),

20 
fd_
(-1),

21 
pos_
(0)

23 #ifdeà
RES_COUNTER


24 
	gÃxt_id_
++;

28 
	gTask
::~
Task
()

30 #ifdeà
RES_COUNTER


31 
ä“_id_
++;

35 
	gTask
::
S‘
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
bufãr
, 
fd
)

37 
CHECK
(
is_£t_
 =ğ
çl£
);

38 
CHECK
(
fd
 > 0);

40 
DLOG
(
INFO
è<< "£ˆsk, bufã¸by‹s: " << 
	gbufãr
->
size
()

41 << ", fd: " << 
	gfd
;

43 
	gbufãr_
 = 
bufãr
;

44 
	gfd_
 = 
fd
;

45 
	gpos_
 = 0;

46 
	gis_£t_
 = 
Œue
;

49 
	gTask
::
Re£t
()

51 ià(!
is_£t_
) {

55 
	gbufãr_
.
»£t
();

56 
	gfd_
 = -1;

57 
	gpos_
 = 0;

58 
	gis_£t_
 = 
çl£
;

61 
	gR—dTask
::
R—d
()

63 
CHECK
(
is_£t_
);

65 
	g»maš
 = 
bufãr_
->
size
(è- 
pos_
;

66 ià(
	g»maš
 <= 0) {

67 
LOG
(
WARNING
è<< "fd: " << 
fd_


68 << ",„emaš by‹ : " << 
»maš


69 << ", bufã¸size: " << 
bufãr_
->
size
()

70 << ",…o : " << 
pos_
;

71  
	gENOBUFS
;

75 *
	gp
 = 
cÚ¡_ÿ¡
<*>(
bufãr_
->
d©a
());

76 
	gp
 +ğ
pos_
;

77 
	gby‹s
 = 
»ad
(
fd_
, 
p
, 
»maš
);

78 ià(
	gby‹s
 > 0) {

79 
DLOG
(
INFO
è<< "fd: " << 
	gfd_


80 << ",„—d by‹s: " << 
	gby‹s
;

81 
	gpos_
 +ğ
by‹s
;

82 
	g»maš
 -ğ
by‹s
;

84 ià(
	gby‹s
 == 0) {

85 
DLOG
(
ERROR
è<< "sock‘ i şo£d wh’„—d, fd: " << 
fd_
;

86  
	gECONNRESET
;

88 ià(
	gby‹s
 == -1) {

89 ià(
”ºo
 =ğ
EINTR
) {

92 ià(
	g”ºo
 =ğ
EAGAIN


93 || 
”ºo
 =ğ
EWOULDBLOCK
) {

94 
DLOG
(
INFO
è<< "sock‘ would blcok, fd: " << 
fd_
;

95  
	g”ºo
;

98 
DLOG
(
ERROR
è<< "uÃx³ùƒ¼Ü wh’„—d sock‘: " << 
	gfd_


99 << ",ƒ¼no: " << 
	g”ºo
 << ",ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
);

100  
	g”ºo
;

103 } 
	g»maš
 > 0);

105 ià(
	gpos_
 =ğ
bufãr_
->
size
()) {

106 
DLOG
(
INFO
è<< "»adask com¶‘e,„—d by‹s: " << 
pos_


107 << ", fd: " << 
fd_
;

111 
LOG
(
FATAL
è<< "unknowÀ”rÜ wh’„—d sock‘, fd: " << 
	gfd_
;

116 
	gR—dTask
::
Wr™e
()

118 
LOG
(
FATAL
) << "should‚ot call write in„eadask";

122 
	gWr™eTask
::
Wr™e
()

124 
CHECK_GE
(
fd_
, 0);

126 
	g»maš
 = 
bufãr_
->
size
(è- 
pos_
;

127 ià(
	g»maš
 <= 0) {

129 
LOG
(
WARNING
è<< "wr™by‹ i : " << 
»maš


130 << ", fd: " << 
fd_
;

135 
	gby‹s
 = 
£nd
(
fd_
, &(
bufãr_
->
d©a
()[
pos_
]), 
»maš
, 
MSG_NOSIGNAL
);

136 ià(
	gby‹s
 > 0) {

137 
DLOG
(
INFO
è<< "wr™by‹s: " << 
	gby‹s


138 << ", fd: " << 
	gfd_
;

139 
	gpos_
 +ğ
by‹s
;

140 
	g»maš
 -ğ
by‹s
;

142 ià(
	gby‹s
 == 0) {

143 
DLOG
(
INFO
) << "socket is closed when write";

144  
	gECONNRESET
;

146 ià(
	gby‹s
 == -1) {

147 ià(
”ºo
 =ğ
EINTR
) {

150 ià(
	g”ºo
 =ğ
EAGAIN


151 || 
”ºo
 =ğ
EWOULDBLOCK
) {

152 
DLOG
(
INFO
) << "socket would block when write";

153  
	g”ºo
;

155 ià(
	g”ºo
 =ğ
EPIPE
) {

156 
DLOG
(
ERROR
) << "socket is closed by client";

157  
	g”ºo
;

160 
DLOG
(
ERROR
è<< "uÃx³ùedƒ¼Ü wh’ wr™e: " << 
¡»¼Ü
(
”ºo
);

161  
	g”ºo
;

164 } 
	g»maš
 > 0);

166 ià(
	gpos_
 =ğ
bufãr_
->
size
()) {

167 
DLOG
(
INFO
è<< "wr™com¶‘e, wr™by‹s: " << 
pos_


168 << ", fd: " << 
fd_
;

172 
LOG
(
FATAL
è<< "unknowÀ”rÜ wh’ wr™sock‘, fd: " << 
	gfd_


173 << ",„emaš: " << 
	g»maš


174 << ",…os: " << 
	gpos_


175 << ", bufã¸size: " << 
	gbufãr_
->
size
();

180 
	gWr™eTask
::
R—d
()

182 
LOG
(
FATAL
) << "should‚ot call„ead in writeask";

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/task.h

4 #iâdeà
__TASK_H__


5 
	#__TASK_H__


	)

7 
	~<boo¡/funùiÚ.hµ
>

9 
şass
 
	gBufãr
;

11 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

13 şas 
	cTask
 {

14 
	gpublic
:

15 
Task
();

16 
	gvœtu®
 ~
Task
();

18 
S‘
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
bufãr
, 
fd
);

19 
boŞ
 
IsS‘
(è{  
	gis_£t_
; }

20 
Re£t
();

21 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> &
bufãr
(è{  
bufãr_
; }

23 
sock‘
(è{  
	gfd_
; }

25 
vœtu®
 
R—d
() = 0;

26 
vœtu®
 
Wr™e
() = 0;

28 
	g´Ùeùed
:

29 
boŞ
 
is_£t_
;

30 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
bufãr_
;

31 
	gfd_
;

33 
ušt32_t
 
	gpos_
;

35 #ifdeà
RES_COUNTER


36 
	g´iv©e
:

37 
ä›nd
 
şass
 
St
;

38 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

39 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

40 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

41 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

45 şas 
	cR—dTask
 : 
public
 
Task
 {

46 
public
:

47 
vœtu®
 
R—d
();

48 
vœtu®
 
Wr™e
();

51 şas 
	cWr™eTask
 : 
public
 
Task
 {

52 
public
:

53 
vœtu®
 
R—d
();

54 
vœtu®
 
Wr™e
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/listener.cc

4 
	~"ldd/Ãt/li¡’”.h
"

5 
	~"š‹º®/li¡’”_im¶.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

10 
	gLi¡’”
::
Li¡’”
(
Ev’tLoİ
* 
ev’t_loİ
)

11 : 
im¶_
(
Ãw
 
Im¶
(
ev’t_loİ
))

15 
Li¡’”
::~Listener() {

16 
d–‘e
 
im¶_
;

19 
boŞ
 
	gLi¡’”
::
O³n
(cÚ¡ 
Endpošt
& 
’dpošt
) {

20  
im¶_
->
O³n
(
’dpošt
);

23 
	gLi¡’”
::
Clo£
() {

24 
im¶_
->
Clo£
();

27 
Ev’tLoİ
* 
	gLi¡’”
::
ev’t_loİ
() const {

28  
im¶_
->
ev’t_loİ
();

31 
boŞ
 
	gLi¡’”
::
IsO³n
() const {

32  
im¶_
->
IsO³n
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/listener.h

4 #iâdeà
LDD_NET_LISTENER_H_


5 
	#LDD_NET_LISTENER_H_


	)

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~"ldd/Ãt/’dpošt.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gEv’tLoİ
;

14 
şass
 
	gEndpošt
;

16 şas 
	cLi¡’”
 : 
boo¡
::
nÚcİyabË
 {

17 
public
:

18 
şass
 
Im¶
;

19 
Li¡’”
(
Ev’tLoİ
* 
ev’t_loİ
);

20 ~
Li¡’”
();

22 
boŞ
 
O³n
(cÚ¡ 
Endpošt
& 
’dpošt
);

23 
Clo£
();

25 
Ev’tLoİ
* 
ev’t_loİ
() const;

26 
boŞ
 
IsO³n
() const;

27 
	g´iv©e
:

28 
Im¶
* 
im¶_
;

29 
ä›nd
 
şass
 
	gS”v”
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/message.h

4 #iâdeà
LDD_NET_MESSAGE_H_


5 
	#LDD_NET_MESSAGE_H_


	)

7 
	~<¡dšt.h
>

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 
št32_t
 
	tMes§geId
;

13 
ušt16_t
 
	tMes§geTy³
;

14 
št16_t
 
	tCode
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/main.cc

1 
	~<glog/loggšg.h
>

2 
	~<gæags/gæags.h
>

3 
	~<ldd/Ãt/ş›Á.h
>

4 
	~<ldd/Ãt/chªÃl.h
>

5 
	~<ldd/Ãt/ev’t_loİ.h
>

6 
	~<ldd/Ãt/’dpošt.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

10 
DEFINE_št32
(
pul£
, 1000, "");

11 
DEFINE_št32
(
cÚÃù
, 10, "");

12 
DEFINE_št32
(
»sŞve
, 10, "");

13 
DEFINE_¡ršg
(
ho¡
, "localhost", "");

14 
DEFINE_št32
(
pÜt
, 9230, "");

15 
DEFINE_¡ršg
(
»que¡
, "This ishe„equest", "");

16 
DEFINE_¡ršg
(
exŒa
, "This isheƒxtra", "");

17 
DEFINE_št32
(
echo
, 1, "");

19 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

20 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

23 
NÙifyCÚÃùšg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

24 
LOG
(
INFO
è<< "CÚÃùšg " << 
c
->
³”_’dpošt
().
ToSŒšg
();

27 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

28 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

31 
	$maš
(
¬gc
, ** 
¬gv
) {

32 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

33 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

34 
FLAGS_¡d”¹h»shŞd
 = 0;

35 
	`LOG
(
INFO
) << "main";

37 
ldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

38 
ldd
::
Ãt
::
Cl›Á
::
O±iÚs
 
İtiÚs
;

39 
İtiÚs
.
pul£_š‹rv®
 = 
FLAGS_pul£
;

40 
İtiÚs
.
cÚÃù_timeout
 = 
FLAGS_cÚÃù
;

41 
İtiÚs
.
»sŞve_timeout
 = 
FLAGS_»sŞve
;

42 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

43 
İtiÚs
.
nÙify_cÚÃùšg
 = 
NÙifyCÚÃùšg
;

44 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

46 
ldd
::
Ãt
::
Cl›Á
 
	`ş›Á
(
İtiÚs
);

47 
ş›Á
.
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
FLAGS_echo
);

48 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
c
 = 
ş›Á
.
	`C»©e
(

49 &
ev’t_loİ
, 
FLAGS_ho¡
, 
FLAGS_pÜt
);

50 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

51 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
FLAGS_»que¡
, 
FLAGS_exŒa
);

52 
c
->
	`Po¡
(
msg
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(100), 
Œue
);

53 
ev’t_loİ
.
	`Run
();

54 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/omsg.cc

4 
	~<glog/loggšg.h
>

5 
	~"omsg.h
"

7 
boŞ
 
	gMyEm™Msg
::
In™
(
Paylßd
* 
»que¡
,

8 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

9 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) {

10 
LOG
(
INFO
è<< "OutMsg S’d: " << 
¡r_


11 << ", size: " << 
¡r_
.
size
();

12 
	gldd
::
Ãt
::
Bufãr
 
buf
(
¡r_
);

13 
	g»que¡
->
S‘Body
(
buf
);

14 
LOG
(
INFO
) << "OutMsgƒxtra: "

15 << 
	g¡r2_


17 << 
	g¡r2_
.
size
();

19 
CHECK
(
»que¡
->
S‘ExŒa
(1, 
ldd
::
Ãt
::
Bufãr
(
¡r2_
)));

20  
	gŒue
;

23 
boŞ
 
	gMyEm™Msg
::
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

24 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) {

25 
¡d
::
¡ršg
 
s
(
»¥Ú£
.
body
().
d©a
(),„e¥Ú£.body().
size
());

26 
LOG
(
INFO
è<< "OutMsg Recv: " << 
	g»¥Ú£
.
body
().
ToSŒšg
();

27 
LOG
(
INFO
è<< " ExŒa:" << 
	g»¥Ú£
.
exŒas
().
©
(1).
ToSŒšg
();

28  
	gŒue
;

31 
	gMyEm™Msg
::
	$DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) {

32 
	`LOG
(
INFO
è<< "OutMsg DÚe: " << 
»suÉ
.
	`ToSŒšg
(è<< " ,„‘uº code: " <<„esuÉ.
	`code
();

33 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/omsg.h

4 #iâdeà
OMSG_H_


5 
	#OMSG_H_


	)

7 
	~<ldd/Ãt/outgošg_msg.h
>

9 
şass
 
	gMyEm™Msg
 : 
public
 
ldd
::
Ãt
::
Ty³dOutgošgMsg
<1333> {

10 
public
:

11 
MyEm™Msg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
¡r2
)

12 : 
¡r_
(
¡r
), 
¡r2_
(
¡r2
) {}

14 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

15 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

16 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
);

17 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

18 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
);

19 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
);

20 
	g´iv©e
:

21 
¡d
::
¡ršg
 
¡r_
;

22 
	g¡d
::
¡ršg
 
¡r2_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/imsg.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

10 
	gMyEchoMsg
::
	$In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) {

11 
·ylßd_
 = 
»que¡
;

12 
	`LOG
(
INFO
è<< "MyEchoMsg::In™(): " << 
·ylßd_
.
	`body
().
	`ToSŒšg
();

13 
	`LOG
(
INFO
è<< " ExŒa: " << 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
();

14 ià(
n_
 < 
couÁ_
) {

15 *
Ãxt
 = 
kEm™
;

17 *
Ãxt
 = 
kDÚe
;

19 
	}
}

21 
	gMyEchoMsg
::
	$Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) {

22 
	`LOG
(
INFO
) << "MyEchoMsg::Emit()";

23 
	`CHECK_LT
(
n_
, 
couÁ_
);

24 *
»¥Ú£
 = 
·ylßd_
;

25 ià(++
n_
 < 
couÁ_
) {

26 *
Ãxt
 = 
kEm™
;

28 *
Ãxt
 = 
kDÚe
;

30 
	}
}

32 
	gMyEchoMsg
::
	$DÚe
(
Code
* 
code
) {

33 
	`LOG
(
INFO
) << "MyEchoMsg::Done()";

34 *
code
 = 
couÁ_
;

35 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

36 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
·ylßd_
.
	`body
().
	`ToSŒšg
(),

37 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
());

38 
	`chªÃl
()->
	`Po¡
(
msg
);

39 
	}
}

41 
	gMyEchoMsg
::
	$Cªûl
() {

42 
	`LOG
(
INFO
) << "MyEchoMsg::Cancel()";

43 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/imsg.h

4 #iâdeà
IMSG_H_


5 
	#IMSG_H_


	)

7 
	~<ldd/Ãt/šcomšg_msg.h
>

9 
şass
 
	gMyEchoMsg
 : 
public
 
ldd
::
Ãt
::
Ty³dIncomšgMsg
<1333> {

10 
public
:

11 
MyEchoMsg
(
size_t
 
couÁ
è: 
couÁ_
(couÁ), 
n_
(0) {}

12 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
);

13 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
);

14 
vœtu®
 
DÚe
(
Code
* 
code
);

15 
vœtu®
 
Cªûl
();

16 
	g´iv©e
:

17 
size_t
 
couÁ_
;

18 
size_t
 
	gn_
;

19 
Paylßd
 
	g·ylßd_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/main.cc

4 
	~<gæags/gæags.h
>

5 
	~<glog/loggšg.h
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~<ldd/Ãt/£rv”.h
>

8 
	~<ldd/Ãt/li¡’”.h
>

9 
	~<ldd/Ãt/ev’t_loİ.h
>

10 
	~"imsg.h
"

11 
	~"omsg.h
"

13 
DEFINE_št32
(
pÜt
, 9230, "");

14 
DEFINE_št32
(
echo
, 1, "");

16 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

17 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

20 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

21 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

24 
	$maš
(
¬gc
, ** 
¬gv
) {

25 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

26 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

27 
FLAGS_¡d”¹h»shŞd
 = 0;

29 
ldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

30 
ldd
::
Ãt
::
Li¡’”
 
	`li¡’”
(&
ev’t_loİ
);

32 
ldd
::
Ãt
::
Endpošt
 
	`loÿl
(
FLAGS_pÜt
);

33 ià(!
li¡’”
.
	`O³n
(
loÿl
)) {

34 
	`LOG
(
ERROR
è<< "Li¡’ oÀ" << 
loÿl
.
	`ToSŒšg
() << " failed";

37 
ldd
::
Ãt
::
S”v”
::
O±iÚs
 
İtiÚs
;

38 
İtiÚs
.
pul£_š‹rv®
 = 1000;

39 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

40 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

42 
ldd
::
Ãt
::
S”v”
 
	`£rv”
(
İtiÚs
);

43 ià(!
£rv”
.
	`S¹
(&
li¡’”
)) {

44 
	`LOG
(
ERROR
) << "Start on†istener failed";

47 
£rv”
.
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
FLAGS_echo
);

48 
ev’t_loİ
.
	`Run
();

49 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/outgoing_msg.cc

1 
	~<glog/loggšg.h
>

2 
	~<boo¡/bšd.hµ
>

3 
	~"ldd/Ãt/outgošg_msg.h
"

4 
	~"š‹º®/outgošg_msg_im¶.h
"

6 
Çme¥aû
 
	gldd
 {

7 
Çme¥aû
 
	gÃt
 {

10 
	g¡d
::
m­
<
OutgošgMsg
::
Ty³
, 
	gDyÇmicOutgošgMsg
::
NextF»e
> 
DyÇmicOutgošgMsg
::
¡©_
;

13 
	gOutgošgMsg
::
OutgošgMsg
()

14 : 
im¶_
(
Ãw
 
Im¶
(
this
))

16 
DLOG
(
INFO
) << "outgoing msg ctor,‚ew impl";

19 
	gOutgošgMsg
::~
OutgošgMsg
() {

20 
DLOG
(
INFO
) << "outgoing msg dtor, delete impl";

21 
d–‘e
 
	gim¶_
;

24 
	gOutgošgMsg
::
Id
 
OutgošgMsg
::
id
() const {

25  
im¶_
->
id
();

28 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
OutgošgMsg
::
chªÃl
() const {

29  
im¶_
->
chªÃl
();

32 
	gOutgošgMsg
::
Cªûl
() {

33 
chªÃl
()->
ev’t_loİ
()->
QueueInLoİ
(

34 
boo¡
::
bšd
(&
OutgošgMsg
::
DoCªûl
, 
sh¬ed_äom_this
()));

37 
	gOutgošgMsg
::
DoCªûl
() {

38 
im¶_
->
Cªûl
();

41 
	gDyÇmicOutgošgMsg
::
DyÇmicOutgošgMsg
(
Ty³
 
ty³
)

42 : 
ty³_
(
ty³
)

45 
Inc
(
ty³_
);

49 
	gDyÇmicOutgošgMsg
::~
DyÇmicOutgošgMsg
()

52 
Dec
(
ty³_
);

56 
	gDyÇmicOutgošgMsg
::
£t_ty³
(
Ty³
 
ty³
)

58 
ty³_
 = 
ty³
;

61 
Inc
(
ty³_
);

66 
	gDyÇmicOutgošgMsg
::
Inc
(
Ty³
 
ty³
)

68 
STAT_IT
 
pos
 = 
¡©_
.
fšd
(
ty³
);

69 ià(
	gpos
 !ğ
¡©_
.
’d
()) {

70 (*(
pos
->
£cÚd
.
Ãxt_id_
))++;

72 
	g¡d
::
·œ
<
STAT_IT
, 
	gboŞ
> 
	g»s
 =

73 
¡©_
.
š£¹
(
¡d
::
make_·œ
(
ty³
, 
NextF»e
() ));

75 ià(
	g»s
.
	g£cÚd
) {

76 
	gpos
 = 
»s
.
fœ¡
;

77 (*(
	gpos
->
	g£cÚd
.
	gÃxt_id_
))++;

79 
LOG
(
ERROR
) << "insert‡tomic uint64_t failed";

84 
	gDyÇmicOutgošgMsg
::
Dec
(
Ty³
 
ty³
)

86 
STAT_IT
 
pos
 = 
¡©_
.
fšd
(
ty³
);

87 ià(
	gpos
 !ğ
¡©_
.
’d
()) {

88 (*(
pos
->
£cÚd
.
ä“_id_
))++;

90 
LOG
(
ERROR
è<< "nÙ found dyÇmiømsgy³: " << 
	gty³
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/outgoing_msg.h

1 #iâdeà
LDD_NET_OUTGOING_MSG_H_


2 
	#LDD_NET_OUTGOING_MSG_H_


	)

4 
	~<m­
>

5 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~<ldd/ut/time_diff.h
>

8 
	~"ldd/Ãt/·ylßd.h
"

9 
	~"ldd/Ãt/bufãr.h
"

10 
	~"ldd/Ãt/»suÉ.h
"

12 
Çme¥aû
 
	gldd
 {

13 
Çme¥aû
 
	gÃt
 {

15 
şass
 
	gChªÃl
;

17 
şass
 
	gOutgošgMsg
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
OutgošgMsg
>,

18 
´iv©e
 
	gboo¡
::
nÚcİyabË
 {

19 
public
:

20 
şass
 
Im¶
;

21 
	gldd
::
	tÃt
::
	tPaylßd
 Payload;

22 
	gldd
::
	tÃt
::
	tMes§geId
 
	tId
;

23 
	gldd
::
	tÃt
::
	tMes§geTy³
 
	tTy³
;

24 
	gldd
::
	tÃt
::
	tResuÉ
 Result;

26 
	gvœtu®
 ~
OutgošgMsg
();

27 
vœtu®
 
Ty³
 
ty³
() const = 0;

29 
Id
 
id
() const;

30 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
() const;

33 
Cªûl
();

34 
	g´Ùeùed
:

35 
OutgošgMsg
();

36 
vœtu®
 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

37 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

38 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) = 0;

39 
vœtu®
 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

40 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) = 0;

41 
vœtu®
 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) = 0;

42 
	g´iv©e
:

43 
DoCªûl
();

44 
Im¶
 *
	gim¶_
;

45 
ä›nd
 
şass
 
	gChªÃl
;

46 
ä›nd
 
şass
 
	gOutgošgReque¡
;

47 
ä›nd
 
şass
 
	gIncomšgRe¥Ú£
;

48 
ä›nd
 
şass
 
	gIncomšgEnd
;

51 
	g‹m¶©e
 <
Mes§geTy³
 
	gN
>

52 şas 
	cTy³dOutgošgMsg
 : 
public
 
OutgošgMsg
 {

53 
public
:

54 cÚ¡ 
Ty³
 
kTy³
 = 
N
;

55 
Ty³
 
ty³
(ècÚ¡ {  
	gkTy³
; }

56 
	g´Ùeùed
:

57 
vœtu®
 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

58 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

59 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) = 0;

60 
vœtu®
 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

61 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) = 0;

62 
vœtu®
 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) = 0;

65 şas 
	cDyÇmicOutgošgMsg
 : 
public
 
OutgošgMsg
 {

66 
public
:

67 ~
DyÇmicOutgošgMsg
();

68 
£t_ty³
(
Ty³
 
ty³
);

69 
Ty³
 
ty³
(ècÚ¡ {  
	gty³_
; }

70 
	g´Ùeùed
:

71 
DyÇmicOutgošgMsg
(): 
ty³_
(0) {}

72 
DyÇmicOutgošgMsg
(
Ty³
 
ty³
);

73 
vœtu®
 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

74 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

75 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) = 0;

76 
vœtu®
 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

77 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) = 0;

78 
vœtu®
 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) = 0;

79 
	g´iv©e
:

80 
Ty³
 
ty³_
;

83 
	g´iv©e
:

84 
ä›nd
 
şass
 
St
;

86 
	sNextF»e
 {

87 
NextF»e
()

88 : 
Ãxt_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>()),

89 
ä“_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>())

90 { *
Ãxt_id_
 = 0; *
	gä“_id_
 = 0; }

91 ~
NextF»e
() {}

93 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
Ãxt_id_
;

94 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
ä“_id_
;

97 
	g¡d
::
m­
<
Ty³
, 
	gNextF»e
> 
	g¡©_
;

99 
	g¡d
::
	tm­
<
	tTy³
, 
	tNextF»e
>::
	t™”©Ü
 
	tSTAT_IT
;

101 
Inc
(
Ty³
 
ty³
);

102 
Dec
(
Ty³
 
ty³
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/payload.cc

4 
	~"·ylßd.h
"

6 
Çme¥aû
 
	gldd
 {

7 
Çme¥aû
 
	gÃt
 {

9 #ifdeà
RES_COUNTER


10 
	gut
::
Atomic
<
ušt64_t
> 
Paylßd
::
Ãxt_id_
;

11 
	gut
::
Atomic
<
ušt64_t
> 
Paylßd
::
ä“_id_
;

14 
	gPaylßd
::
Paylßd
()

16 #ifdeà
RES_COUNTER


17 
Ãxt_id_
++;

21 
	gPaylßd
::
Paylßd
(cÚ¡ Paylßd &
lßd
)

23 
body_
 = 
lßd
.body_;

24 
	gexŒas_
 = 
lßd
.
exŒas_
;

26 #ifdeà
RES_COUNTER


27 
	gÃxt_id_
++;

38 
	gPaylßd
::~
Paylßd
()

40 #ifdeà
RES_COUNTER


41 
ä“_id_
++;

46 
boŞ
 
	gPaylßd
::
S‘Body
(cÚ¡ 
Bufãr
& 
bufãr
) {

47 ià(
bufãr
.
size
(è<ğ
kMaxBodyL’
) {

48 
body_
 = 
bufãr
;

49  
	gŒue
;

51  
	gçl£
;

54 
boŞ
 
	gPaylßd
::
S‘ExŒa
(
ušt8_t
 
id
, cÚ¡ 
Bufãr
& 
bufãr
) {

55 ià(
	gbufãr
.
size
(è<ğ
kMaxExŒaL’
) {

56 
exŒas_
[
id
] = 
bufãr
;

57  
	gŒue
;

59  
	gçl£
;

62 
	gPaylßd
::
D–ExŒa
(
ušt8_t
 
id
) {

63 
exŒas_
.
”a£
(
id
);

66 
	gPaylßd
::
CË¬ExŒas
() {

67 
exŒas_
.
ş—r
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/payload.h

4 #iâdeà
LDD_NET_PAYLOAD_H_


5 
	#LDD_NET_PAYLOAD_H_


	)

7 
	~<¡dšt.h
>

8 
	~<m­
>

9 
	~<ldd/Ãt/bufãr.h
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cPaylßd
 {

15 
	gpublic
:

16 cÚ¡ 
size_t
 
kMaxBodyL’
 = (1<<24) - 1;

17 cÚ¡ 
size_t
 
	gkMaxExŒaL’
 = (1<<8) - 1;

19 
Paylßd
();

20 
Paylßd
(cÚ¡ Paylßd &
lßd
);

23 ~
Paylßd
();

25 cÚ¡ 
	gBufãr
& 
body
(ècÚ¡ {  
	gbody_
; }

26 cÚ¡ 
	gBufãrM­
& 
exŒas
(ècÚ¡ {  
	gexŒas_
; }

28 
boŞ
 
S‘Body
(cÚ¡ 
Bufãr
& 
bufãr
);

29 
boŞ
 
S‘ExŒa
(
ušt8_t
 
id
, cÚ¡ 
Bufãr
& 
bufãr
);

30 
D–ExŒa
(
ušt8_t
 
id
);

31 
CË¬ExŒas
();

32 
	g´iv©e
:

33 
Bufãr
 
body_
;

34 
BufãrM­
 
	gexŒas_
;

36 #ifdeà
RES_COUNTER


37 
	g´iv©e
:

38 
ä›nd
 
şass
 
St
;

39 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

40 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

41 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

42 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/registry.h

4 #iâdeà
LDD_NET_REGISTRY_H_


5 
	#LDD_NET_REGISTRY_H_


	)

7 
	~<m­
>

8 
	~"ldd/Ãt/çùÜy.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

20 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gTag
 = >

21 şas 
	cRegi¡ry
 {

22 
public
:

23 
vœtu®
 ~
Regi¡ry
();

26 
	g‹m¶©e
 <
şass
 
	gD
>

27 
Regi¡”
(
Tag
 
n
) {

28 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>());

30 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
>

31 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
) {

32 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
));

34 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
>

35 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
) {

36 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
));

38 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
>

39 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
) {

40 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
));

42 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
>

43 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
) {

44 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
));

46 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
>

47 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
) {

48 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
));

50 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
>

51 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
) {

52 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
));

54 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
>

55 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
) {

56 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
, 
a7
));

58 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
>

59 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
) {

60 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
, 
a7
, 
a8
));

62 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
>

63 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
) {

64 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
, 
a7
, 
a8
, 
a9
));

66 
	g‹m¶©e
 <
şass
 
	gD
, cÏs 
	gA1
, cÏs 
	gA2
, cÏs 
	gA3
, cÏs 
	gA4
, cÏs 
	gA5
, cÏs 
	gA6
, cÏs 
	gA7
, cÏs 
	gA8
, cÏs 
	gA9
, cÏs 
	gA10
>

67 
Regi¡”
(
Tag
 
n
, 
A1
 
a1
, 
A2
 
a2
, 
A3
 
a3
, 
A4
 
a4
, 
A5
 
a5
, 
A6
 
a6
, 
A7
 
a7
, 
A8
 
a8
, 
A9
 
a9
, 
A10
 
a10
) {

68 
Regi¡”FaùÜy
(
n
, 
FaùÜy
<
T
>::
‹m¶©e
 
NewFaùÜy
<
D
>(
a1
, 
a2
, 
a3
, 
a4
, 
a5
, 
a6
, 
a7
, 
a8
, 
a9
, 
a10
));

71 
T
* 
New
(
Tag
 
n
) const;

72 
	gboo¡
::
sh¬ed_±r
<
T
> 
MakeSh¬ed
(
Tag
 
n
) const;

73 
	g´iv©e
:

74 
Regi¡”FaùÜy
(
Tag
 
n
, 
FaùÜy
<
T
>* 
f
);

75 
	g¡d
::
m­
<
Tag
, 
	gFaùÜy
<
	gT
>*> 
	gçùÜ›s_
;

78 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gTag
>

79 
šlše
 
	gRegi¡ry
<
	gT
, 
	gTag
>::
Regi¡”FaùÜy
(
Tag
 
n
, 
FaùÜy
<
T
>* 
f
) {

80 
ty³Çme
 
	t¡d
::
	tm­
<
	tTag
, 
	tFaùÜy
<
	tT
>*>::
	t™”©Ü
 iterator;

81 
	g¡d
::
·œ
<
™”©Ü
, 
	gboŞ
> 
	g»suÉ
 = 
çùÜ›s_
.
š£¹
(
¡d
::
make_·œ
(
n
, 
f
));

82 ià(!
	g»suÉ
.
	g£cÚd
) {

83 
d–‘e
 
	g»suÉ
.
	gfœ¡
->
	g£cÚd
;

84 
	g»suÉ
.
	gfœ¡
->
	g£cÚd
 = 
f
;

88 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gTag
>

89 
šlše
 
T
* 
	gRegi¡ry
<
	gT
, 
	gTag
>::
New
(
Tag
 
n
) const {

90 
ty³Çme
 
	t¡d
::
	tm­
<
	tTag
, 
	tFaùÜy
<
	tT
>*>::
	tcÚ¡_™”©Ü
 
	t™”©Ü
;

91 
™”©Ü
 
	g™”
 = 
çùÜ›s_
.
fšd
(
n
);

92 ià(
	g™”
 =ğ
çùÜ›s_
.
’d
()) {

93  
NULL
;

95  
	g™”
->
	g£cÚd
->
New
();

98 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gTag
>

99 
šlše
 
	gboo¡
::
sh¬ed_±r
<
T
> 
Regi¡ry
<T, 
	gTag
>::
MakeSh¬ed
(
Tag
 
n
) const {

100 
ty³Çme
 
	t¡d
::
	tm­
<
	tTag
, 
	tFaùÜy
<
	tT
>*>::
	tcÚ¡_™”©Ü
 
	t™”©Ü
;

101 
™”©Ü
 
	g™”
 = 
çùÜ›s_
.
fšd
(
n
);

102 ià(
	g™”
 =ğ
çùÜ›s_
.
’d
()) {

103  
boo¡
::
sh¬ed_±r
<
T
>();

105  
	g™”
->
	g£cÚd
->
MakeSh¬ed
();

108 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gTag
>

109 
šlše
 
	gRegi¡ry
<
	gT
, 
	gTag
>::~
Regi¡ry
() {

110 
ty³Çme
 
	t¡d
::
	tm­
<
	tTag
, 
	tFaùÜy
<
	tT
>*>::
	t™”©Ü
 iterator;

111 
™”©Ü
 
	g™”
 = 
çùÜ›s_
.
begš
(); i‹¸!ğçùÜ›s_.
’d
(); ++iter) {

112 
d–‘e
 
	g™”
->
	g£cÚd
;

114 
	gçùÜ›s_
.
ş—r
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/result.cc

4 
	~<glog/loggšg.h
>

5 
	~"»suÉ.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

10 cÚ¡ 
	g¡d
::
¡ršg
& 
ResuÉ
::
ToSŒšg
() const {

11 
ty³_
) {

12 
kOk
: {

13 
¡d
::
¡ršg
 
s
("Ok");

14  
	gs
;

16 
	gkFaed
: {

17 
¡d
::
¡ršg
 
s
("Failed");

18  
	gs
;

20 
	gkTimedOut
: {

21 
¡d
::
¡ršg
 
s
("TimedOut");

22  
	gs
;

24 
	gkCªûËd
: {

25 
¡d
::
¡ršg
 
s
("Canceled");

26  
	gs
;

29 
LOG
(
FATAL
) << "Invalid„esultype";

31 
	g¡d
::
¡ršg
 
s
("Unknown");

32  
	gs
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/result.h

4 #iâdeà
LDD_NET_RESULT_H_


5 
	#LDD_NET_RESULT_H_


	)

7 
	~<¡ršg
>

8 
	~"ldd/Ãt/mes§ge.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 şas 
	cResuÉ
 {

14 
	gpublic
:

15 
	eTy³
 { 
kOk
, 
	gkFaed
, 
	gkTimedOut
, 
	gkCªûËd
 };

16 
ResuÉ
 
Ok
(
Code
 
code
è{  ResuÉ(
kOk
, code); }

17 
ResuÉ
 
Faed
(è{  ResuÉ(
kFaed
); }

18 
ResuÉ
 
TimedOut
(è{  ResuÉ(
kTimedOut
); }

19 
ResuÉ
 
CªûËd
(è{  ResuÉ(
kCªûËd
); }

21 
boŞ
 
IsOk
(ècÚ¡ {  
	gty³_
 =ğ
kOk
; }

22 
boŞ
 
IsFaed
(ècÚ¡ {  
	gty³_
 =ğ
kFaed
; }

23 
boŞ
 
IsTimedOut
(ècÚ¡ {  
	gty³_
 =ğ
kTimedOut
; }

24 
boŞ
 
IsCªûËd
(ècÚ¡ {  
	gty³_
 =ğ
kCªûËd
; }

26 cÚ¡ 
	g¡d
::
¡ršg
& 
ToSŒšg
() const;

28 
Code
 
code
(ècÚ¡ {  
	gcode_
; }

29 
	g´iv©e
:

30 
ResuÉ
(
Ty³
 
ty³
è: 
ty³_
Ñy³), 
code_
(0) {}

31 
ResuÉ
(
Ty³
 
ty³
, 
št16_t
 
code
è: 
ty³_
Ñy³), 
code_
(code) {}

33 
Ty³
 
	gty³_
;

34 
Code
 
	gcode_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/sample/a.cc

4 
	~"a.h
"

5 
	~<boo¡/»f.hµ
>

6 
	~<¡dio.h
>

8 
	gA
 : 
public
 
Msg
 {

9 
A
() {}

10 
Te¡
() {

11 
´štf
("A::Test()\n");

15 
	gB
 : 
public
 
Msg
 {

16 
B
(
x
è: 
x_
(x) {}

17 
Te¡
() {

18 
´štf
("B::Te¡(è%d\n", 
x_
);

20 
	gx_
;

23 
	gC
 : 
public
 
Msg
 {

24 
C
(
x
, 
y
è: 
x_
(x), 
y_
(y) {}

25 
Te¡
() {

26 
´štf
("C::Te¡(è%d %d\n", 
x_
, 
y_
);

28 
	gx_
;

29 
	gy_
;

32 
	$maš
() {

33 
i
 = 5, 
j
 = 6, 
k
 = 7;

34 
FaùÜy
* 
ç
 = FaùÜy::
NewFaùÜy
<
A
>();

35 
Msg
* 
ma
 = 
ç
->
	`New
();

37 
FaùÜy
* 
fb
 = FaùÜy::
NewFaùÜy
<
B
>(
boo¡
::
	`»f
(
i
));

38 
Msg
* 
mb
 = 
fb
->
	`New
();

40 
FaùÜy
* 
fc
 = FaùÜy::
NewFaùÜy
<
C
>(
j
, 
k
);

41 
Msg
* 
mc
 = 
fc
->
	`New
();

43 
ma
->
	`Te¡
();

44 
mb
->
	`Te¡
();

45 
mc
->
	`Te¡
();

46 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/sample/a.h

4 #iâdeà
_A_H_


5 
	#_A_H_


	)

7 
şass
 
	gNÚeArg
;

9 
	sMsg
 {

10 
	mvœtu®
 ~
Msg
() {}

11 
vœtu®
 
Te¡
() = 0;

14 
	sFaùÜy
 {

15 
	mvœtu®
 ~
FaùÜy
() {}

16 
vœtu®
 
Msg
* 
New
() const = 0;

19 
	m‹m¶©e
 <
şass
 
	mT
, cÏs 
	mA1
, cÏs 
	mA2
>

20 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
);

21 
	m‹m¶©e
 <
şass
 
	mT
, cÏs 
	mA1
>

22 
FaùÜy
* 
NewFaùÜy
(
A1
 
a1
);

23 
	m‹m¶©e
 <
şass
 
	mT
>

24 
FaùÜy
* 
NewFaùÜy
();

27 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gA1
 = 
NÚeArg
, cÏs 
	gA2
 = NoneArg>

28 
FaùÜyIm¶
 : 
public
 
FaùÜy
 {

29 
FaùÜyIm¶
(
A1
 
a1
, 
A2
 
a2
)

30 :
a1_
(
a1
), 
a2_
(
a2
) {}

31 
Msg
* 
New
(ècÚ¡ {  
Ãw
 
T
(
a1_
, 
a2_
); }

32 
A1
 
	ga1_
;

33 
A2
 
	ga2_
;

36 
	g‹m¶©e
 <
şass
 
	gT
>

37 
	gFaùÜyIm¶
<
	gT
, 
	gNÚeArg
, NÚeArg> : 
public
 
FaùÜy
 {

38 
FaùÜyIm¶
() {}

39 
Msg
* 
New
(ècÚ¡ {  
Ãw
 
T
(); }

42 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gA1
>

43 
	gFaùÜyIm¶
<
	gT
, 
	gA1
, 
	gNÚeArg
> : 
public
 
FaùÜy
{

44 
FaùÜyIm¶
(
A1
 
a1
)

45 :
a1_
(
a1
) {}

46 
Msg
* 
New
(ècÚ¡ {  
Ãw
 
T
(
a1_
); }

47 
A1
 
	ga1_
;

50 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gA1
, cÏs 
	gA2
>

51 
šlše
 
FaùÜy
* 
	gFaùÜy
::
	$NewFaùÜy
(
A1
 
a1
, 
A2
 
a2
) {

52  
Ãw
 
FaùÜyIm¶
<
T
, 
A1
, 
A2
>(
a1
, 
a2
);

53 
	}
}

54 
	g‹m¶©e
 <
şass
 
	gT
, cÏs 
	gA1
>

55 
šlše
 
FaùÜy
* 
	gFaùÜy
::
	$NewFaùÜy
(
A1
 
a1
) {

56  
Ãw
 
FaùÜyIm¶
<
T
, 
A1
>(
a1
);

57 
	}
}

58 
	g‹m¶©e
 <
şass
 
	gT
>

59 
šlše
 
FaùÜy
* 
	gFaùÜy
::
	$NewFaùÜy
() {

60  
Ãw
 
FaùÜyIm¶
<
T
>();

61 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/server.cc

4 
	~"£rv”.h
"

5 
	~"š‹º®/£rv”_im¶.h
"

7 
Çme¥aû
 
	gldd
 {

8 
Çme¥aû
 
	gÃt
 {

10 
	gS”v”
::
S”v”
(cÚ¡ 
O±iÚs
& 
İtiÚs
)

11 : 
im¶_
(
Ãw
 
Im¶
(
this
, 
İtiÚs
))

15 
	gS”v”
::~
S”v”
() {

16 
d–‘e
 
im¶_
;

19 
boŞ
 
	gS”v”
::
S¹
(
Li¡’”
* 
li¡’”
) {

20  
im¶_
->
S¹
(
li¡’”
->impl_);

23 
	gS”v”
::
Stİ
() {

24 
im¶_
->
Stİ
();

27 cÚ¡ 
	gS”v”
::
O±iÚs
& 
S”v”
::
İtiÚs
() const {

28  
im¶_
->
İtiÚs
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/server.h

4 #iâdeà
LDD_NET_SERVER_H_


5 
	#LDD_NET_SERVER_H_


	)

7 
	~<boo¡/funùiÚ.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

10 
	~"ldd/Ãt/šcomšg_msg_»gi¡ry.h
"

11 
	~"ldd/Ãt/ev’t_loİ.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

16 
şass
 
	gLi¡’”
;

18 şas 
	cS”v”
 : 
public
 
IncomšgMsgRegi¡ry
 {

19 
public
:

20 
	eTh»adDi¥©chPŞicy
 {

21 
kNÜm®
,

22 
	gkHashšg
,

24 
şass
 
	gIm¶
;

25 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

26 
	sO±iÚs
 {

29 
	gpul£_š‹rv®
;

33 
boŞ
 
	gpul£_»Ïxed_checkšg
;

37 
boŞ
 
	gpul£_Ïzy_em™tšg
;

41 
	gb©ch_acû±
;

45 
NÙif›r
 
	gnÙify_cÚÃùed
;

49 
NÙif›r
 
	gnÙify_şo£d
;

54 
	gboo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
>* 
th»ads
;

58 
	gth»ads_di¥©chšg
;

62 
	g»ad_bufãr_size
;

63 
	gwr™e_bufãr_size
;

65 
O±iÚs
();

68 
ex¶ic™
 
S”v”
(cÚ¡ 
O±iÚs
& 
İtiÚs
);

69 ~
S”v”
();

71 
boŞ
 
S¹
(
Li¡’”
* 
li¡’”
);

72 
Stİ
();

74 cÚ¡ 
	gO±iÚs
& 
İtiÚs
() const;

75 
	g´iv©e
:

76 
Im¶
* 
im¶_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/stat.cc

4 
	~<glog/loggšg.h
>

5 
	~<o¡»am
>

6 
	~"¡©.h
"

7 
	~"š‹º®/chªÃl_im¶.h
"

8 
	~"š‹º®/ev’t_loİ_im¶.h
"

9 
	~"š‹º®/šcomšg_msg_im¶.h
"

10 
	~"š‹º®/outgošg_msg_im¶.h
"

11 
	~"š‹º®/ev’t_im¶.h
"

12 
	~"·ylßd.h
"

13 
	~"bufãr.h
"

14 
	~"š‹º®/sk.h
"

15 
	~"šcomšg_msg.h
"

17 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

19 
St
 
	gSt
::
š¡ªû_
;

21 
	gSt
::
St
()

26 
¡d
::
¡ršg
 
St
::
dyÇmic_šcomšg_msg_¡©
() const

28 
DyÇmicIncomšgMsg
::
STAT_IT
 
™
 = DyÇmicIncomšgMsg::
¡©_
.
begš
();

29 
	g¡d
::
o¡ršg¡»am
 
os
;

30 ; 
	g™
 !ğ
DyÇmicIncomšgMsg
::
¡©_
.
’d
(); it++) {

32 
ušt64_t
 
	gÃxt_id
 = *(
™
->
£cÚd
.
Ãxt_id_
);

33 
ušt64_t
 
	gä“_id
 = *(
™
->
£cÚd
.
ä“_id_
);

35 
	gos
 << " " << 
	g™
->
	gfœ¡
;

36 
	gos
 << "[" << 
	gä“_id
;

37 
	gos
 << ":" << 
	gÃxt_id
;

38 
	gos
 << ":" << 
	gÃxt_id
 - 
	gä“_id
;

39 
	gos
 << "] ";

42  
	gos
.
¡r
();

45 
	g¡d
::
¡ršg
 
St
::
dyÇmic_outgošg_msg_¡©
() const

47 
DyÇmicOutgošgMsg
::
STAT_IT
 
™
 = DyÇmicOutgošgMsg::
¡©_
.
begš
();

48 
	g¡d
::
o¡ršg¡»am
 
os
;

49 ; 
	g™
 !ğ
DyÇmicOutgošgMsg
::
¡©_
.
’d
(); it++) {

51 
ušt64_t
 
	gÃxt_id
 = *(
™
->
£cÚd
.
Ãxt_id_
);

52 
ušt64_t
 
	gä“_id
 = *(
™
->
£cÚd
.
ä“_id_
);

54 
	gos
 << " " << 
	g™
->
	gfœ¡
;

55 
	gos
 << "[" << 
	gä“_id
;

56 
	gos
 << ":" << 
	gÃxt_id
;

57 
	gos
 << ":" << 
	gÃxt_id
 - 
	gä“_id
;

58 
	gos
 << "] ";

61  
	gos
.
¡r
();

66 
	g¡d
::
¡ršg
 
St
::
Stus
() const

68 
¡d
::
o¡ršg¡»am
 
os
;

70 #ifdeà
RES_COUNTER


71 
ušt64_t
 
	gÃxt_id
 = 
IncomšgChªÃl
::
Ãxt_id
();

72 
ušt64_t
 
	gä“_id
 = 
IncomšgChªÃl
::
ä“_id
();

73 
	gos
 << " in_chªÃl[" << 
	gä“_id


74 << ":" << 
	gÃxt_id


75 << ":" << 
	gÃxt_id
 - 
	gä“_id


78 
	gÃxt_id
 = 
S”v”
::
Im¶
::
Ãxt_id
();

79 
	gä“_id
 = 
S”v”
::
Im¶
::
ä“_id
();

80 
	gos
 << " in_fd[" << 
	gä“_id


81 << ":" << 
	gÃxt_id


82 << ":" << 
	gÃxt_id
 - 
	gä“_id


85 
	gÃxt_id
 = 
OutgošgChªÃl
::
Ãxt_id
();

86 
	gä“_id
 = 
OutgošgChªÃl
::
ä“_id
();

87 
	gos
 << " out_chªÃl[" << 
	gä“_id


88 << ":" << 
	gÃxt_id


89 << ":" << 
	gÃxt_id
 - 
	gä“_id


92 
	gÃxt_id
 = 
Cl›Á
::
Im¶
::
Ãxt_id
();

93 
	gä“_id
 = 
Cl›Á
::
Im¶
::
ä“_id
();

94 
	gos
 << " out_fd[" << 
	gä“_id


95 << ":" << 
	gÃxt_id


96 << ":" << 
	gÃxt_id
 - 
	gä“_id


99 
	gÃxt_id
 = 
IncomšgMsg
::
Im¶
::
Ãxt_id
();

100 
	gä“_id
 = 
IncomšgMsg
::
Im¶
::
ä“_id
();

101 
	gos
 << " imsg[" << 
	gä“_id


102 << ":" << 
	gÃxt_id


103 << ":" << 
	gÃxt_id
 - 
	gä“_id


106 
	gos
 << 
dyÇmic_šcomšg_msg_¡©
();

109 
	gÃxt_id
 = 
OutgošgMsg
::
Im¶
::
Ãxt_id
();

110 
	gä“_id
 = 
OutgošgMsg
::
Im¶
::
ä“_id
();

111 
	gos
 << " omsg[" << 
	gä“_id


112 << ":" << 
	gÃxt_id


113 << ":" << 
	gÃxt_id
 - 
	gä“_id


117 
	gos
 << 
dyÇmic_outgošg_msg_¡©
();

120 
	gÃxt_id
 = 
Ev’tLoİ
::
Im¶
::
Ãxt_id
();

121 
	gä“_id
 = 
Ev’tLoİ
::
Im¶
::
ä“_id
();

122 
	gos
 << " funùÜ[" << 
	gä“_id


123 << ":" << 
	gÃxt_id


124 << ":" << 
	gÃxt_id
 - 
	gä“_id


127 
	gÃxt_id
 = 
FdEv’t
::
Im¶
::
Ãxt_id
();

128 
	gä“_id
 = 
FdEv’t
::
Im¶
::
ä“_id
();

129 
	gos
 << " fdev[" << 
	gä“_id


130 << ":" << 
	gÃxt_id


131 << ":" << 
	gÃxt_id
 - 
	gä“_id


134 
	gÃxt_id
 = 
Tim”Ev’t
::
Im¶
::
Ãxt_id
();

135 
	gä“_id
 = 
Tim”Ev’t
::
Im¶
::
ä“_id
();

136 
	gos
 << "im”ev[" << 
	gä“_id


137 << ":" << 
	gÃxt_id


138 << ":" << 
	gÃxt_id
 - 
	gä“_id


141 
	gÃxt_id
 = 
SigÇlEv’t
::
Im¶
::
Ãxt_id
();

142 
	gä“_id
 = 
SigÇlEv’t
::
Im¶
::
ä“_id
();

143 
	gos
 << " sigev[" << 
	gä“_id


144 << ":" << 
	gÃxt_id


145 << ":" << 
	gÃxt_id
 - 
	gä“_id


148 
	gÃxt_id
 = 
Paylßd
::
Ãxt_id
();

149 
	gä“_id
 = 
Paylßd
::
ä“_id
();

150 
	gos
 << "…aylßd[" << 
	gä“_id


151 << ":" << 
	gÃxt_id


152 << ":" << 
	gÃxt_id
 - 
	gä“_id


155 
	gÃxt_id
 = 
Bufãr
::
Ãxt_id
();

156 
	gä“_id
 = 
Bufãr
::
ä“_id
();

157 
	gos
 << " bufãr[" << 
	gä“_id


158 << ":" << 
	gÃxt_id


159 << ":" << 
	gÃxt_id
 - 
	gä“_id


162 
	gÃxt_id
 = 
Task
::
Ãxt_id
();

163 
	gä“_id
 = 
Task
::
ä“_id
();

164 
	gos
 << "ask[" << 
	gä“_id


165 << ":" << 
	gÃxt_id


166 << ":" << 
	gÃxt_id
 - 
	gä“_id


170  
	gos
.
¡r
();

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/stat.h

4 #iâdeà
__STAT_H__


5 
	#__STAT_H__


	)

7 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

9 şas 
	cSt
 {

10 
	gpublic
:

11 ~
St
() {}

13 
¡d
::
¡ršg
 
Stus
() const;

14 
	gSt
 &
š¡ªû
(è{  
	gš¡ªû_
; }

16 
	g´iv©e
:

17 
St
();

18 
St
 
	gš¡ªû_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/main.cc

1 
	~<glog/loggšg.h
>

2 
	~<gæags/gæags.h
>

3 
	~<boo¡/bšd.hµ
>

4 
	~<ldd/Ãt/ş›Á.h
>

5 
	~<ldd/Ãt/chªÃl.h
>

6 
	~<ldd/Ãt/ev’t_loİ.h
>

7 
	~<ldd/Ãt/ev’t.h
>

8 
	~<ldd/Ãt/’dpošt.h
>

9 
	~<sigÇl.h
>

10 
	~"omsg.h
"

12 
DEFINE_¡ršg
(
ho¡
, "localhost", "");

13 
DEFINE_št32
(
pÜt
, 9230, "");

14 
DEFINE_št32
(
pul£_š‹rv®
, 1000, "");

15 
DEFINE_št32
(
cÚÃù_timeout
, 10, "");

16 
DEFINE_št32
(
»sŞve_timeout
, 10, "");

17 
DEFINE_¡ršg
(
»que¡
, "This ishe„equest", "");

18 
DEFINE_¡ršg
(
exŒa
, "This isheƒxtra", "");

19 
DEFINE_št32
(
cÚÃùiÚs
, 1, "");

20 
DEFINE_št32
(
cÚcu¼’cy
, 1, "");

21 
DEFINE_boŞ
(
£nd
, 
Œue
, "send msg on start");

24 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

25 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

28 
NÙifyCÚÃùšg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

29 
LOG
(
INFO
è<< "CÚÃùšg " << 
c
->
³”_’dpošt
().
ToSŒšg
();

32 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

33 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

36 
Info
 
	gg_šfo
;

37 
	gldd
::
Ãt
::
Tim”Ev’t
* 
g_tim”
;

38 
	g¡d
::
veùÜ
<
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> > 
chªÃls
;

40 
	gldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

42 
	$OnTim”
() {

43 
a
 = 0;

44 
b
 = 0;

45 
c
 = 0;

46 
¯
 = 
g_šfo
.
»que¡s
;

47 
bb
 = 
g_šfo
.
sucûss
;

48 
cc
 = 
g_šfo
.
çed
;

49 
	`LOG
(
ERROR
è<< "»que¡s: " << 
¯
 - 
a


50 << " sucûss: " << 
bb
 - 
b


51 << " faed: " << 
cc
 - 
c
;

52 
a
 = 
¯
;

53 
b
 = 
bb
;

54 
c
 = 
cc
;

64 
g_tim”
->
	`AsyncWa™
(
OnTim”
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

65 
	}
}

67 
	$SigÇl
() {

69 
¡d
::
veùÜ
<
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> >::
™”©Ü
 
™
;

70 
™
 = 
chªÃls
.
	`begš
(); iˆ!ğchªÃls.
	`’d
(); it++) {

71 
	`LOG
(
INFO
è<< "chªÃÈ" << (*
™
)->
	`Çme
(è<< " u£ couÁ: " << (*™).
	`u£_couÁ
();

72 (*
™
)->
	`Clo£
();

75 
ev’t_loİ
.
	`Stİ
();

76 
	}
}

78 
	$maš
(
¬gc
, ** 
¬gv
) {

79 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

80 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

81 
FLAGS_¡d”¹h»shŞd
 = 0;

82 
FLAGS_logto¡d”r
=
Œue
;

83 
	`LOG
(
INFO
) << "main";

85 
ldd
::
Ãt
::
SigÇlEv’t
 
	`sigÇl
(&
ev’t_loİ
);

86 
sigÇl
.
	`Add
(
SIGINT
);

87 
sigÇl
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
SigÇl
, 
_1
));

89 
ldd
::
Ãt
::
Cl›Á
::
O±iÚs
 
İtiÚs
;

90 
İtiÚs
.
pul£_š‹rv®
 = 
FLAGS_pul£_š‹rv®
;

91 
İtiÚs
.
cÚÃù_timeout
 = 
FLAGS_cÚÃù_timeout
;

92 
İtiÚs
.
»sŞve_timeout
 = 
FLAGS_»sŞve_timeout
;

93 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

94 
İtiÚs
.
nÙify_cÚÃùšg
 = 
NÙifyCÚÃùšg
;

95 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

96 
ldd
::
Ãt
::
Cl›Á
 
	`ş›Á
(
İtiÚs
);

99 
g_tim”
 = 
Ãw
 
ldd
::
Ãt
::
	`Tim”Ev’t
(&
ev’t_loİ
);

100 
g_tim”
->
	`AsyncWa™
(
OnTim”
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

101 
i
 = 0; i < 
FLAGS_cÚÃùiÚs
; ++i) {

102 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
c
 = 
ş›Á
.
	`C»©e
(

103 &
ev’t_loİ
, 
FLAGS_ho¡
, 
FLAGS_pÜt
);

104 
	`DLOG
(
INFO
è<< "ü—‹‡ chªÃl: " << 
c
->
	`Çme
();

105 
chªÃls
.
	`push_back
(
c
);

106 ià(
FLAGS_£nd
) {

107 
i
 = 0; i < 
FLAGS_cÚcu¼’cy
; ++i) {

108 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

109 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
FLAGS_»que¡
, 
FLAGS_exŒa
);

110 
c
->
	`Po¡
(
msg
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1), 
Œue
);

115 
ev’t_loİ
.
	`Run
();

117 
chªÃls
.
	`ş—r
();

119 
	`LOG
(
INFO
) << "processƒxit";

122 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/omsg.cc

4 
	~<boo¡/make_sh¬ed.hµ
>

5 
	~<glog/loggšg.h
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"omsg.h
"

8 
DECLARE_¡ršg
(
»que¡
);

9 
DECLARE_¡ršg
(
exŒa
);

10 
DECLARE_št32
(
cÚÃùiÚs
);

11 
DECLARE_št32
(
cÚcu¼’cy
);

13 
Info
 
g_šfo
;

15 
	gMyEm™Msg
::
MyEm™Msg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
¡r2
)

16 : 
¡r_
(
¡r
), 
¡r2_
(
¡r2
), 
¡•_
(0), 
ts_
(
ldd
::
ut
::
Time¡amp
::
	$Now
())

18 
	`DLOG
(
INFO
) << "MyEmitMsg ctor called";

19 
	}
}

21 
	gMyEm™Msg
::~
	$MyEm™Msg
()

23 
	`DLOG
(
INFO
) << "MyEmitMsg dtor called";

24 
	}
}

26 
boŞ
 
	gMyEm™Msg
::
In™
(
Paylßd
* 
»que¡
,

27 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

28 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) {

29 
¡•_
 = 1;

31 
	gldd
::
Ãt
::
Bufãr
 
buf
(
¡r_
);

32 
	g»que¡
->
S‘Body
(
buf
);

34 
CHECK
(
»que¡
->
S‘ExŒa
(1, 
ldd
::
Ãt
::
Bufãr
(
¡r2_
)));

35  
	gŒue
;

38 
boŞ
 
	gMyEm™Msg
::
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

39 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) {

40 
¡•_
 = 2;

41 
	g¡d
::
¡ršg
 
s
(
»¥Ú£
.
body
().
d©a
(),„e¥Ú£.body().
size
());

44  
	gŒue
;

47 
	gMyEm™Msg
::
	$DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) {

48 ià(!
»suÉ
.
	`IsOk
()) {

49 
	`LOG
(
ERROR
è<< "OutMsg " << 
»suÉ
.
	`ToSŒšg
()

50 << " id=" << 
	`id
()

51 << " s‹p=" << 
¡•_


52 << "ime=" << (
ldd
::
ut
::
Time¡amp
::
	`Now
(è- 
ts_
).
	`ToMli£cÚds
();

53 
g_šfo
.
çed
++;

55 
g_šfo
.
sucûss
++;

57 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

58 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
FLAGS_»que¡
, 
FLAGS_exŒa
);

59 
	`chªÃl
()->
	`Po¡
(
msg
, 
ldd
::
ut
::
TimeDiff
::
	`Mli£cÚds
(5), 
Œue
);

60 
g_šfo
.
»que¡s
++;

61 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/omsg.h

4 #iâdeà
OMSG_H_


5 
	#OMSG_H_


	)

7 
	~<ldd/Ãt/outgošg_msg.h
>

8 
	~<ldd/ut/time¡amp.h
>

10 
	sInfo
 {

11 
	mldd
::
ut
::
Atomic
<> 
»que¡s
;

12 
	mldd
::
ut
::
Atomic
<> 
sucûss
;

13 
	mldd
::
ut
::
Atomic
<> 
çed
;

16 
şass
 
	gMyEm™Msg
 : 
public
 
ldd
::
Ãt
::
Ty³dOutgošgMsg
<2000> {

17 
public
:

18 
MyEm™Msg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
¡r2
);

19 
	gvœtu®
 ~
MyEm™Msg
();

21 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

22 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

23 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
);

24 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

25 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
);

26 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
);

27 
	g´iv©e
:

28 
¡d
::
¡ršg
 
¡r_
;

29 
	g¡d
::
¡ršg
 
¡r2_
;

30 
	g¡•_
;

31 
	gldd
::
ut
::
Time¡amp
 
ts_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/imsg.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"imsg.h
"

9 
	gMyEchoMsg
::
	$In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) {

10 
·ylßd_
 = 
»que¡
;

13 *
Ãxt
 = 
kEm™
;

14 
	}
}

16 
	gMyEchoMsg
::
	$Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) {

18 *
Ãxt
 = 
kDÚe
;

19 
	}
}

21 
	gMyEchoMsg
::
	$DÚe
(
Code
* 
code
) {

23 *
code
 = 0;

24 
	}
}

26 
	gMyEchoMsg
::
	$Cªûl
() {

28 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/imsg.h

4 #iâdeà
IMSG_H_


5 
	#IMSG_H_


	)

7 
	~<ldd/Ãt/šcomšg_msg.h
>

9 
şass
 
	gMyEchoMsg
 : 
public
 
ldd
::
Ãt
::
Ty³dIncomšgMsg
<2000> {

10 
public
:

11 
MyEchoMsg
() {}

12 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
);

13 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
);

14 
vœtu®
 
DÚe
(
Code
* 
code
);

15 
vœtu®
 
Cªûl
();

16 
	g´iv©e
:

17 
Paylßd
 
·ylßd_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/main.cc

4 
	~<boo¡/bšd.hµ
>

5 
	~<gæags/gæags.h
>

6 
	~<glog/loggšg.h
>

7 
	~<ldd/Ãt/chªÃl.h
>

8 
	~<ldd/Ãt/£rv”.h
>

9 
	~<ldd/Ãt/li¡’”.h
>

10 
	~<ldd/Ãt/ev’t_loİ.h
>

11 
	~<ldd/ut/©omic.h
>

12 
	~<ldd/Ãt/ev’t.h
>

13 
	~<ldd/Ãt/¡©.h
>

14 
	~"imsg.h
"

15 
	~<sigÇl.h
>

17 
	gldd
::
ut
::
Atomic
<> 
g_cÚn
;

18 
	gldd
::
Ãt
::
Tim”Ev’t
* 
g_tim”
;

20 
DEFINE_št32
(
pÜt
, 9230, "");

21 
DEFINE_št32
(
echo
, 1, "");

22 
DEFINE_št32
(
th»ad
, 1, "");

23 
DEFINE_št32
(
pul£_š‹rv®
, 1000, "");

24 
DEFINE_boŞ
(
pul£_»Ïxed_checkšg
, 
çl£
, "");

25 
DEFINE_boŞ
(
pul£_Ïzy_em™tšg
, 
çl£
, "");

27 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gboo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> > 
chªÃls
;

29 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

30 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
()

31 << ", fd: " << 
c
->
sock‘
();

32 
	gg_cÚn
++;

34 
	gchªÃls
.
š£¹
(
¡d
::
make_·œ
(
c
->
³”_’dpošt
().
ToSŒšg
(), c));

37 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

38 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
()

39 << ", sock‘: " << 
c
->
sock‘
()

40 << ", m­ƒËms: " << 
chªÃls
.
size
();

41 
	gg_cÚn
--;

43 
	gchªÃls
.
”a£
(
c
->
³”_’dpošt
().
ToSŒšg
());

46 
	$OnTim”
() {

47 
	`LOG
(
ERROR
è<< "cÚn: " << 
g_cÚn
;

49 
¡d
::
¡ršg
 
¡©
 = 
ldd
::
Ãt
::
St
::
	`š¡ªû
().
	`Stus
();

50 ià(!
¡©
.
	`em±y
()) {

51 
	`LOG
(
INFO
è<< "lddÃˆ¡©us: " << 
¡©
;

54 
g_tim”
->
	`AsyncWa™
(
OnTim”
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

55 
	}
}

57 
	gboo¡
::
±r_veùÜ
<
ldd
::
Ãt
::
Ev’tLoİTh»ad
> 
th»ads
;

59 
OnSigÇl
(, 
ldd
::
Ãt
::
Ev’tLoİ
* 
e
) {

60 
¡d
::
m­
<¡d::
¡ršg
, 
	gboo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> >::
™”©Ü
 
c_™
;

61 
	gc_™
 = 
chªÃls
.
begš
(); c_™ !ğchªÃls.
’d
(); c_it++) {

62 
LOG
(
INFO
è<< "şo£ chªÃl: " << 
	gc_™
->
	g£cÚd
->
Çme
();

63 
	gc_™
->
	g£cÚd
->
Clo£
();

65 
	gchªÃls
.
ş—r
();

67 
	gboo¡
::
±r_veùÜ
<
ldd
::
Ãt
::
Ev’tLoİTh»ad
>::
™”©Ü
 
™
 = 
th»ads
.
begš
();

68 ; 
	g™
 !ğ
th»ads
.
’d
(); ++it) {

69 
	g™
->
Stİ
();

71 
	ge
->
Stİ
();

74 
	$maš
(
¬gc
, ** 
¬gv
) {

75 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

76 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

77 
FLAGS_logto¡d”r
=
Œue
;

78 
FLAGS_¡d”¹h»shŞd
=2;

80 
ldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

81 
ldd
::
Ãt
::
Li¡’”
 
	`li¡’”
(&
ev’t_loİ
);

82 
ldd
::
Ãt
::
SigÇlEv’t
 
	`sig
(&
ev’t_loİ
);

83 
sig
.
	`Add
(
SIGINT
);

84 
sig
.
	`AsyncWa™
(

85 
boo¡
::
	`bšd
(&
OnSigÇl
, 
_1
, &
ev’t_loİ
));

87 
ldd
::
Ãt
::
Endpošt
 
	`loÿl
(
FLAGS_pÜt
);

88 ià(!
li¡’”
.
	`O³n
(
loÿl
)) {

89 
	`LOG
(
ERROR
è<< "Li¡’ oÀ" << 
loÿl
.
	`ToSŒšg
() << " failed";

93 
i
 = 0; i < 
FLAGS_th»ad
; i++) {

94 
ldd
::
Ãt
::
Ev’tLoİTh»ad
* 
th»ad
 = 
Ãw
†dd::net::EventLoopThread;

95 
th»ad
->
	`S¹
();

96 
th»ads
.
	`push_back
(
th»ad
);

99 
ldd
::
Ãt
::
S”v”
::
O±iÚs
 
İtiÚs
;

100 
İtiÚs
.
pul£_š‹rv®
 = 
FLAGS_pul£_š‹rv®
;

101 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

102 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

103 
İtiÚs
.
th»ads
 = &threads;

104 
İtiÚs
.
pul£_»Ïxed_checkšg
 = 
FLAGS_pul£_»Ïxed_checkšg
;

105 
İtiÚs
.
pul£_Ïzy_em™tšg
 = 
FLAGS_pul£_Ïzy_em™tšg
;

107 
g_tim”
 = 
Ãw
 
ldd
::
Ãt
::
	`Tim”Ev’t
(&
ev’t_loİ
);

108 
g_tim”
->
	`AsyncWa™
(
OnTim”
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

110 
ldd
::
Ãt
::
S”v”
 
	`£rv”
(
İtiÚs
);

111 ià(!
£rv”
.
	`S¹
(&
li¡’”
)) {

112 
	`LOG
(
ERROR
) << "Start on†istener failed";

115 
£rv”
.
Regi¡”IncomšgMsg
<
MyEchoMsg
>();

116 
ev’t_loİ
.
	`Run
();

117 
i
 = 0; i < 
FLAGS_th»ad
; i++) {

118 
th»ads
[
i
].
	`Još
();

120 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/imsg.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

10 
	gMyEchoMsg
::
	$In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) {

11 
·ylßd_
 = 
»que¡
;

12 
	`LOG
(
INFO
è<< "MyEchoMsg::In™(): " << 
·ylßd_
.
	`body
().
	`ToSŒšg
();

13 
	`LOG
(
INFO
è<< " ExŒa: " << 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
();

14 ià(
n_
 < 
couÁ_
) {

15 *
Ãxt
 = 
kEm™
;

17 *
Ãxt
 = 
kDÚe
;

19 
	}
}

21 
	gMyEchoMsg
::
	$Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) {

22 
	`LOG
(
INFO
) << "MyEchoMsg::Emit()";

23 
	`CHECK_LT
(
n_
, 
couÁ_
);

24 *
»¥Ú£
 = 
·ylßd_
;

25 ià(++
n_
 < 
couÁ_
) {

26 *
Ãxt
 = 
kEm™
;

28 *
Ãxt
 = 
kDÚe
;

30 
	}
}

32 
	gMyEchoMsg
::
	$DÚe
(
Code
* 
code
) {

33 
	`LOG
(
INFO
) << "MyEchoMsg::Done()";

34 *
code
 = 
couÁ_
;

35 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

36 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
·ylßd_
.
	`body
().
	`ToSŒšg
(),

37 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
());

38 
	`chªÃl
()->
	`Po¡
(
msg
);

39 
	}
}

41 
	gMyEchoMsg
::
	$Cªûl
() {

42 
	`LOG
(
INFO
) << "MyEchoMsg::Cancel()";

43 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/imsg.h

4 #iâdeà
IMSG_H_


5 
	#IMSG_H_


	)

7 
	~<ldd/Ãt/šcomšg_msg.h
>

9 
şass
 
	gMyEchoMsg
 : 
public
 
ldd
::
Ãt
::
Ty³dIncomšgMsg
<1333> {

10 
public
:

11 
MyEchoMsg
(
size_t
 
couÁ
è: 
couÁ_
(couÁ), 
n_
(0) {}

12 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
);

13 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
);

14 
vœtu®
 
DÚe
(
Code
* 
code
);

15 
vœtu®
 
Cªûl
();

16 
	g´iv©e
:

17 
size_t
 
couÁ_
;

18 
size_t
 
	gn_
;

19 
Paylßd
 
	g·ylßd_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/main.cc

1 
	~<glog/loggšg.h
>

2 
	~<gæags/gæags.h
>

3 
	~<ldd/Ãt/ş›Á.h
>

4 
	~<ldd/Ãt/chªÃl.h
>

5 
	~<ldd/Ãt/ev’t_loİ.h
>

6 
	~<ldd/Ãt/’dpošt.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

10 
DEFINE_št32
(
pul£
, 1000, "");

11 
DEFINE_št32
(
cÚÃù
, 10, "");

12 
DEFINE_št32
(
»sŞve
, 10, "");

13 
DEFINE_¡ršg
(
ho¡
, "localhost", "");

14 
DEFINE_št32
(
pÜt
, 9230, "");

15 
DEFINE_¡ršg
(
»que¡
, "This ishe„equest", "");

16 
DEFINE_¡ršg
(
exŒa
, "This isheƒxtra", "");

17 
DEFINE_št32
(
echo
, 1, "");

19 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

20 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

23 
NÙifyCÚÃùšg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

24 
LOG
(
INFO
è<< "CÚÃùšg " << 
c
->
³”_’dpošt
().
ToSŒšg
();

27 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

28 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

31 
	$maš
(
¬gc
, ** 
¬gv
) {

32 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

33 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

34 
FLAGS_¡d”¹h»shŞd
 = 0;

35 
	`LOG
(
INFO
) << "main";

37 
ldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

38 
ldd
::
Ãt
::
Cl›Á
::
O±iÚs
 
İtiÚs
;

39 
İtiÚs
.
pul£_š‹rv®
 = 
FLAGS_pul£
;

40 
İtiÚs
.
cÚÃù_timeout
 = 
FLAGS_cÚÃù
;

41 
İtiÚs
.
»sŞve_timeout
 = 
FLAGS_»sŞve
;

42 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

43 
İtiÚs
.
nÙify_cÚÃùšg
 = 
NÙifyCÚÃùšg
;

44 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

47 
ldd
::
Ãt
::
Cl›Á
 
	`ş›Á
(
İtiÚs
);

48 
ş›Á
.
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
FLAGS_echo
);

49 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
c
 = 
ş›Á
.
	`C»©e
(

50 &
ev’t_loİ
, 
FLAGS_ho¡
, 
FLAGS_pÜt
);

53 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

54 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
FLAGS_»que¡
, 
FLAGS_exŒa
);

55 
c
->
	`Po¡
(
msg
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(100), 
Œue
);

57 
ev’t_loİ
.
	`Run
();

58 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/omsg.cc

4 
	~<glog/loggšg.h
>

5 
	~"omsg.h
"

7 
boŞ
 
	gMyEm™Msg
::
In™
(
Paylßd
* 
»que¡
,

8 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

9 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) {

10 
LOG
(
INFO
è<< "OutMsg S’d: " << 
¡r_
;

11 
	gldd
::
Ãt
::
Bufãr
 
buf
(
¡r_
);

12 
	g»que¡
->
S‘Body
(
buf
);

13 
LOG
(
INFO
è<< "XXX " << 
	g¡r2_
;

14 
CHECK
(
»que¡
->
S‘ExŒa
(1, 
ldd
::
Ãt
::
Bufãr
(
¡r2_
)));

15  
	gŒue
;

18 
boŞ
 
	gMyEm™Msg
::
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

19 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) {

20 
¡d
::
¡ršg
 
s
(
»¥Ú£
.
body
().
d©a
(),„e¥Ú£.body().
size
());

21 
LOG
(
INFO
è<< "OutMsg Recv: " << 
	g»¥Ú£
.
body
().
ToSŒšg
();

22 
LOG
(
INFO
è<< " ExŒa:" << 
	g»¥Ú£
.
exŒas
().
©
(1).
ToSŒšg
();

23  
	gŒue
;

26 
	gMyEm™Msg
::
	$DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) {

27 
	`LOG
(
INFO
è<< "OutMsg DÚe: " << 
»suÉ
.
	`ToSŒšg
(è<< " " <<„esuÉ.
	`code
();

28 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/omsg.h

4 #iâdeà
OMSG_H_


5 
	#OMSG_H_


	)

7 
	~<ldd/Ãt/outgošg_msg.h
>

9 
şass
 
	gMyEm™Msg
 : 
public
 
ldd
::
Ãt
::
Ty³dOutgošgMsg
<1333> {

10 
public
:

11 
MyEm™Msg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
¡r2
)

12 : 
¡r_
(
¡r
), 
¡r2_
(
¡r2
) {}

14 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

15 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

16 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
);

17 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

18 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
);

19 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
);

20 
	g´iv©e
:

21 
¡d
::
¡ršg
 
¡r_
;

22 
	g¡d
::
¡ršg
 
¡r2_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/event_loop/main.cc

4 
	~<ldd/Ãt/ev’t_loİ.h
>

6 
	~<glog/loggšg.h
>

7 
	~<boo¡/bšd.hµ
>

9 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

11 
	$func
(
no
)

13 
	`LOG
(
INFO
è<< "funørun,‚o: " << 
no
;

14 
	}
}

16 
	$maš
()

21 
Ev’tLoİ
 
loİ
;

23 
	`LOG
(
INFO
) << "poiter size: " << (*);

24 
i
 = 0; i < 100000000; i++) {

25 
	`LOG
(
INFO
è<< "šdex: " << 
i
;

26 
loİ
.
	`QueueInLoİ
(
boo¡
::
	`bšd
(&
func
, 
i
));

33 
Ev’tLoİTh»ad
 
loİ_th»ad
;

34 
Ev’tLoİ
 *
loİ
 = 
loİ_th»ad
.
	`ev’t_loİ
();

35 
	`CHECK_NOTNULL
(
loİ
);

37 
loİ_th»ad
.
	`S¹
();

39 
i
 = 0; i < 100000; i++) {

40 
loİ
->
	`QueueInLoİ
(
boo¡
::
	`bšd
(&
func
, 
i
));

43 
	`¦“p
(5);

45 
loİ_th»ad
.
	`Stİ
();

46 
loİ_th»ad
.
	`Još
();

50 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/imsg.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

10 
	gMyEchoMsg
::
	$In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) {

11 
·ylßd_
 = 
»que¡
;

12 
	`LOG
(
INFO
è<< "MyEchoMsg::In™(): " << 
·ylßd_
.
	`body
().
	`ToSŒšg
();

13 
	`LOG
(
INFO
è<< " ExŒa: " << 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
();

14 ià(
n_
 < 
couÁ_
) {

15 *
Ãxt
 = 
kEm™
;

17 *
Ãxt
 = 
kDÚe
;

19 
	}
}

21 
	gMyEchoMsg
::
	$Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) {

22 
	`LOG
(
INFO
) << "MyEchoMsg::Emit()";

23 
	`CHECK_LT
(
n_
, 
couÁ_
);

24 *
»¥Ú£
 = 
·ylßd_
;

25 ià(++
n_
 < 
couÁ_
) {

26 *
Ãxt
 = 
kEm™
;

28 *
Ãxt
 = 
kDÚe
;

30 
	}
}

32 
	gMyEchoMsg
::
	$DÚe
(
Code
* 
code
) {

33 
	`LOG
(
INFO
) << "MyEchoMsg::Done()";

34 *
code
 = 
couÁ_
;

35 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

36 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
·ylßd_
.
	`body
().
	`ToSŒšg
(),

37 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
());

38 
	`chªÃl
()->
	`Po¡
(
msg
);

39 
	}
}

41 
	gMyEchoMsg
::
	$Cªûl
() {

42 
	`LOG
(
INFO
) << "MyEchoMsg::Cancel()";

43 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/imsg.h

4 #iâdeà
IMSG_H_


5 
	#IMSG_H_


	)

7 
	~<ldd/Ãt/šcomšg_msg.h
>

9 
şass
 
	gMyEchoMsg
 : 
public
 
ldd
::
Ãt
::
Ty³dIncomšgMsg
<1333> {

10 
public
:

11 
MyEchoMsg
(
size_t
 
couÁ
è: 
couÁ_
(couÁ), 
n_
(0) {}

12 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
);

13 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
);

14 
vœtu®
 
DÚe
(
Code
* 
code
);

15 
vœtu®
 
Cªûl
();

16 
	g´iv©e
:

17 
size_t
 
couÁ_
;

18 
size_t
 
	gn_
;

19 
Paylßd
 
	g·ylßd_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/main.cc

4 
	~<gæags/gæags.h
>

5 
	~<glog/loggšg.h
>

7 
	~<boo¡/bšd.hµ
>

9 
	~<ldd/Ãt/chªÃl.h
>

10 
	~<ldd/Ãt/£rv”.h
>

11 
	~<ldd/Ãt/li¡’”.h
>

12 
	~<ldd/Ãt/ev’t.h
>

13 
	~<ldd/Ãt/ev’t_loİ.h
>

14 
	~<ldd/Ãt/¡©.h
>

15 
	~"imsg.h
"

16 
	~"omsg.h
"

18 
DEFINE_št32
(
pÜt
, 9230, "");

19 
DEFINE_št32
(
echo
, 1, "");

21 
	gldd
::
Ãt
::
Ev’tLoİ
 
ev’t_loİ
;

22 
	gldd
::
Ãt
::
Tim”Ev’t
 
tim”
(&
ev’t_loİ
);

24 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

25 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

28 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

29 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

32 
	$OnTim”
()

34 
ldd
::
Ãt
::
St
::
	`š¡ªû
().
	`Stus
();

35 
tim”
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
OnTim”
),

36 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

37 
	}
}

39 
	$maš
(
¬gc
, ** 
¬gv
) {

40 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
çl£
);

41 
googË
::
	`In™GoogËLoggšg
(
¬gv
[0]);

42 
FLAGS_¡d”¹h»shŞd
 = 0;

44 
ldd
::
Ãt
::
Li¡’”
 
	`li¡’”
(&
ev’t_loİ
);

46 
ldd
::
Ãt
::
Endpošt
 
	`loÿl
(
FLAGS_pÜt
);

47 ià(!
li¡’”
.
	`O³n
(
loÿl
)) {

48 
	`LOG
(
ERROR
è<< "Li¡’ oÀ" << 
loÿl
.
	`ToSŒšg
() << " failed";

51 
ldd
::
Ãt
::
S”v”
::
O±iÚs
 
İtiÚs
;

52 
İtiÚs
.
pul£_š‹rv®
 = 1000;

53 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

54 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

56 
ldd
::
Ãt
::
S”v”
 
	`£rv”
(
İtiÚs
);

57 ià(!
£rv”
.
	`S¹
(&
li¡’”
)) {

58 
	`LOG
(
ERROR
) << "Start on†istener failed";

61 
£rv”
.
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
FLAGS_echo
);

63 
tim”
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
OnTim”
),

64 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(1));

66 
ev’t_loİ
.
	`Run
();

67 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/omsg.cc

4 
	~<glog/loggšg.h
>

5 
	~"omsg.h
"

7 
boŞ
 
	gMyEm™Msg
::
In™
(
Paylßd
* 
»que¡
,

8 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

9 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) {

10 
LOG
(
INFO
è<< "OutMsg S’d: " << 
¡r_
;

11 
	gldd
::
Ãt
::
Bufãr
 
buf
(
¡r_
);

12 
	g»que¡
->
S‘Body
(
buf
);

13 
LOG
(
INFO
è<< "XXX " << 
	g¡r2_
;

14 
CHECK
(
»que¡
->
S‘ExŒa
(1, 
ldd
::
Ãt
::
Bufãr
(
¡r2_
)));

15  
	gŒue
;

18 
boŞ
 
	gMyEm™Msg
::
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

19 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) {

20 
¡d
::
¡ršg
 
s
(
»¥Ú£
.
body
().
d©a
(),„e¥Ú£.body().
size
());

21 
LOG
(
INFO
è<< "OutMsg Recv: " << 
	g»¥Ú£
.
body
().
ToSŒšg
();

22 
LOG
(
INFO
è<< " ExŒa:" << 
	g»¥Ú£
.
exŒas
().
©
(1).
ToSŒšg
();

23  
	gŒue
;

26 
	gMyEm™Msg
::
	$DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) {

27 
	`LOG
(
INFO
è<< "OutMsg DÚe: " << 
»suÉ
.
	`ToSŒšg
(è<< " " <<„esuÉ.
	`code
();

28 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/omsg.h

4 #iâdeà
OMSG_H_


5 
	#OMSG_H_


	)

7 
	~<ldd/Ãt/outgošg_msg.h
>

9 
şass
 
	gMyEm™Msg
 : 
public
 
ldd
::
Ãt
::
Ty³dOutgošgMsg
<1333> {

10 
public
:

11 
MyEm™Msg
(cÚ¡ 
¡d
::
¡ršg
& 
¡r
, cÚ¡ std::¡ršg& 
¡r2
)

12 : 
¡r_
(
¡r
), 
¡r2_
(
¡r2
) {}

14 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

15 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

16 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
);

17 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

18 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
);

19 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
);

20 
	g´iv©e
:

21 
¡d
::
¡ršg
 
¡r_
;

22 
	g¡d
::
¡ršg
 
¡r2_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/atomic/main.cc

4 
	~<io¡»am
>

6 
	~"ldd/ut/©omic.h
"

7 
	~"ldd/ut/©omic_št.h
"

9 
usšg
 
Çme¥aû
 
	g¡d
;

11 
	$maš
()

13 
ldd
::
ut
::
AtomicIÁ
 
my_št
;

15 
my_št
++;

16 
cout
 << 
my_št
 << 
’dl
;

17 
my_št
++;

18 
cout
 << 
my_št
 << 
’dl
;

19 
my_št
--;

20 
cout
 << 
my_št
 << 
’dl
;

23 
ldd
::
ut
::
Atomic
<
št64_t
> 
	`my_št64
(0);

24 
my_št64
++;

25 
cout
 << 
my_št64
 << 
’dl
;

26 
my_št64
+=100;

27 
cout
 << 
my_št64
 << 
’dl
;

28 
my_št64
-=10;

29 
cout
 << 
my_št64
 << 
’dl
;

32 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/common.h

1 #iâdeà
__COMMON_H__


2 
	#__COMMON_H__


	)

4 
H—¹B—t
(
fd
);

5 
G‘
(
fd
);

6 
Put
(
fd
);

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/get.cc

1 
	~<glog/loggšg.h
>

2 
	~"commÚ.h
"

3 
	~"ldd/Ãt/´ÙocŞ.h
"

4 
	~"x_sock‘.h
"

6 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

8 
	$G‘
(
fd
)

10 
h—d”
[
H—d”
::
kBy‹Size
];

12 
H—d”
::
Bud”
 
	`hdr
(
h—d”
);

13 
hdr
.
	`£t_ty³
(
H—d”
::
kReq
);

14 
hdr
.
	`£t_id
(0);

15 
hdr
.
	`£t_body_ty³
(1);

16 
hdr
.
	`£t_body_size
(1);

17 
hdr
.
	`Bud
();

19 
»t
 = 
	`x_£nd
(
fd
, 
h—d”
, 
H—d”
::
kBy‹Size
);

20 ià(
»t
 == -1) {

21 
	`LOG
(
INFO
è<< "£nd g‘ h—d” faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

24 ià(
»t
 == 0) {

25 
	`LOG
(
INFO
) << "send get header failed, socket„eset by server";

29 
body
[1] = {'a'};

30 
»t
 = 
	`x_£nd
(
fd
, 
body
, 1);

31 ià(
»t
 == -1) {

32 
	`LOG
(
INFO
è<< "£nd g‘ body faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

35 ià(
»t
 == 0) {

36 
	`LOG
(
INFO
) << "send get body failed, socket„eset by server";

41 
»t
 = 
	`x_»cv
(
fd
, 
h—d”
, 
H—d”
::
kBy‹Size
);

42 ià(
»t
 == -1) {

43 
	`LOG
(
INFO
è<< "»cv g‘ h—d” faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

46 ià(
»t
 == 0) {

47 
	`LOG
(
INFO
) << "revc get header failed, socket„eset by server";

51 
H—d”
::
P¬£r
 
	`·r£r
(
h—d”
);

52 ià(!
·r£r
.
	`IsV®id
()) {

53 
	`LOG
(
INFO
) << "invalid„esponse header";

57 
»t
 = 
	`x_»cv
(
fd
, 
body
, 1);

58 ià(
»t
 == -1) {

59 
	`LOG
(
INFO
è<< "»cv g‘ body faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

62 ià(
»t
 == 0) {

63 
	`LOG
(
INFO
) << "revc get body failed, socket„eset by server";

67 
	`LOG
(
INFO
è<< "G‘ ok,„esuÉ i " << 
body
[0];

70 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/heartbeat.cc

1 
	~<glog/loggšg.h
>

2 
	~<¡ršg.h
>

3 
	~"commÚ.h
"

4 
	~"ldd/Ãt/´ÙocŞ.h
"

5 
	~"x_sock‘.h
"

7 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

9 
	$H—¹B—t
(
fd
)

11 
buf
[
H—d”
::
kBy‹Size
];

13 
H—d”
::
Bud”
 
	`hdr
(
buf
);

14 
hdr
.
	`£t_ty³
(
H—d”
::
kReqTick
);

15 
hdr
.
	`£t_id
(0);

16 
hdr
.
	`£t_body_ty³
(0);

17 
hdr
.
	`£t_body_size
(0);

18 
hdr
.
	`Bud
();

20 
»t
 = 
	`x_£nd
(
fd
, 
buf
, 
H—d”
::
kBy‹Size
);

21 ià(
»t
 != 12) {

22 
	`LOG
(
INFO
) << "send failed";

26 
	`LOG
(
INFO
) << "success send first…acketo 9527";

28 
»t
 = 
	`x_»cv
(
fd
, 
buf
, 
H—d”
::
kBy‹Size
);

29 ià(
»t
 == -1) {

30 
	`LOG
(
INFO
è<< "»cv secÚd h—¹ faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

33 ià(
»t
 == 0) {

34 
	`LOG
(
INFO
) << "recv second heart failed, socket closed by server";

38 
H—d”
::
P¬£r
 
	`·r£r
(
buf
);

39 ià(!
·r£r
.
	`IsV®id
()) {

40 
	`LOG
(
INFO
) << "first heart beat is invalid";

44 
	`LOG
(
INFO
) << "recv first heart beat success";

47 
	`¦“p
(5);

49 
hdr
.
	`£t_ty³
(
H—d”
::
kReqTick
);

50 
hdr
.
	`£t_id
(1);

51 
hdr
.
	`£t_body_ty³
(0);

52 
hdr
.
	`£t_body_size
(0);

53 
hdr
.
	`Bud
();

55 
»t
 = 
	`x_£nd
(
fd
, 
buf
, 
H—d”
::
kBy‹Size
);

56 ià(
»t
 !ğ
H—d”
::
kBy‹Size
) {

57 
	`LOG
(
INFO
) << "send failed";

60 
	`LOG
(
INFO
) << "success send second…acketo 9527";

62 
»t
 = 
	`x_»cv
(
fd
, 
buf
, 
H—d”
::
kBy‹Size
);

63 ià(
»t
 == -1) {

64 
	`LOG
(
INFO
è<< "»cv secÚd h—¹ faed,ƒ¼=" << 
	`¡»¼Ü
(
”ºo
);

67 ià(
»t
 == 0) {

68 
	`LOG
(
INFO
) << "recv second heart failed, socket closed by server";

72 
H—d”
::
P¬£r
 
	`·r£r
(
buf
);

73 ià(!
·r£r
.
	`IsV®id
()) {

74 
	`LOG
(
INFO
) << "second heart beat is invalid";

78 
	`LOG
(
INFO
) << "recv second heart beat success";

81 
	`LOG
(
INFO
) << "HeartBeat ok";

84 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/main.cc

1 
	~<uni¡d.h
>

2 
	~<glog/loggšg.h
>

3 
	~<io¡»am
>

4 
	~"commÚ.h
"

5 
	~"x_sock‘.h
"

7 
usšg
 
Çme¥aû
 
	g¡d
;

9 
	$U§ge
(*
š¡ªûÇme
)

11 
cout
 << "U§g: " << 
š¡ªûÇme
 << " <ho¡> <pÜt> <‹¡ i‹m>" << 
’dl
;

12 
cout
 << 
’dl
;

13 
cout
 << "‹¡ i‹m†i¡:" << 
’dl
;

14 
cout
 << "1.H—¹H—t" << 
’dl
;

15 
cout
 << "2.G‘" << 
’dl
;

16 
cout
 << "3.Put" << 
’dl
;

17 
cout
 << 
’dl
;

19 
	}
}

21 (*
	tTe¡Func
)(
	tfd
);

23 
	sTe¡I‹m
 {

24 *
Çme
;

25 
Te¡Func
 
func
;

28 
Te¡I‹m
 
g_‹¡_™ems
[] = {

29 {"H—¹B—t", 
H—¹B—t
},

30 {"G‘", 
G‘
},

31 {"Put", 
Put
}

32 
	}
};

34 
	$Run
(
fd
, 
¡ršg
 &
‹¡_™em
)

36 
i
 = 0; i < ()((
g_‹¡_™ems
)/(
Te¡I‹m
)); i++) {

37 ià(
	`¡rcmp
(
‹¡_™em
.
	`c_¡r
(), 
g_‹¡_™ems
[
i
].
Çme
) == 0) {

38 
g_‹¡_™ems
[
i
].
	`func
(
fd
);

42 
	}
}

44 
	$maš
(
¬gc
, *
¬gv
[])

46 ià(
¬gc
 != 4) {

47 
	`U§ge
(
¬gv
[0]);

51 
¡ršg
 
	`ho¡
(
¬gv
[1]);

52 
pÜt
 = 
	`©oi
(
¬gv
[2]);

53 
¡ršg
 
	`‹¡_™em
(
¬gv
[3]);

55 
cout
 << "ho¡ : " << 
ho¡
 << 
’dl
;

56 
cout
 << "pÜˆ : " << 
pÜt
 << 
’dl
;

57 
cout
 << "‹¡ i‹m: " << 
‹¡_™em
 << 
’dl
;

60 
fd
 = 
	`x_ü—‹_tı_ş›Á
(
ho¡
.
	`c_¡r
(), 
pÜt
);

61 ià(
fd
 == -1) {

62 
cout
 << "cÚÃˆtØ" << 
ho¡
 << ":" << 
pÜt
 << " faed" << 
’dl
;

67 
	`Run
(
fd
, 
‹¡_™em
);

70 
	`x_şo£
(
fd
);

73 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/put.cc

1 
	~<glog/loggšg.h
>

2 
	~"commÚ.h
"

4 
	$Put
(
fd
)

6 
	`LOG
(
INFO
) << "Put called";

9 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/x_socket.cc

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/¡©.h
>

5 
	~<sys/sock‘.h
>

6 
	~<sys/£ndfe.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtdb.h
>

9 
	~<¬·/š‘.h
>

10 
	~<Ãtš‘/tı.h
>

11 
	~<fú.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

15 
	~"x_sock‘.h
"

17 
	$x_£t_sock_deçuÉ_İt
(
s
)

20 
Ú
 = 1;

21 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
Ú
, (on));

22 ià(
»suÉ
 < 0) {

23 
	`şo£
(
s
);

27 
Ú
 = 1;

28 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*)&
Ú
, (on));

31 
lšg”
 
İtv®
;

32 
İtv®
.
l_Úoff
 = 1;

33 
İtv®
.
l_lšg”
 = 60;

34 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_LINGER
, (*)&
İtv®
, (
lšg”
));

35 iàĞ
»suÉ
 < 0 ) {

36 
	`şo£
Ğ
s
 );

40 
Ën
 = 2 * 1024 * 1024;

41 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*)&
Ën
, (len));

42 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
Ën
, (len));

45 
	}
}

49 
	$x_£t_sock_no_d–ay
(
s
)

51 
İt
;

52 
sockËn_t
 
İ’
;

54 
İ’
 =  
İt
;

55 ià(
	`g‘sockİt
(
s
, 
IPPROTO_TCP
, 1 , &
İt
, &
İ’
) == -1) {

59 ià(
İt
 == 1) {

62 
İt
 = 1;

63 
	`£tsockİt
(
s
, 
IPPROTO_TCP
, 1 , &
İt
, ( opt ));

66 
	}
}

68 
	$x_£t_sock_no_block
(
s
)

70 
æags
;

72 ià((
æags
 = 
	`fú
(
s
, 
F_GETFL
, 
NULL
)) < 0) {

76 ià(
	`fú
(
s
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) == -1) {

81 
	}
}

84 
	$x_ü—‹_tı_£rv”
(cÚ¡ *
l
, 
ÍÜt
)

86 
sockaddr_š
 
addr
;

87 
s
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 0 );

88 iàĞ
s
 == -1 ) {

92 
	`x_£t_sock_deçuÉ_İt
(
s
);

94 
addr
.
sš_çmy
 = 
AF_INET
;

95 ià(
	`¡rcmp
(
l
, "0.0.0.0") == 0) {

96 
addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

99 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
Ğ
l
 );

101 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
ÍÜt
 );

103 ià(
	`bšd
(
s
, (
sockaddr
 *)&
addr
, (
sockaddr_š
)) == -1 ) {

104 
	`şo£
Ğ
s
);

105 
s
 = -1;

109 ià(
	`li¡’
(
s
, 
MAX_LISTEN_QUEUE
 ) == -1 ) {

110 
	`şo£
(
s
);

111 
s
 = -1;

115  
s
;

116 
	}
}

119 
	$x_ü—‹_tı_ş›Á
(cÚ¡ *
r
, 
½Üt
)

121 
sockaddr_š
 
addr
;

122 
»suÉ
;

123 
Ú
 = 1;

124 
fd
;

126 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

127 iàĞ
fd
 == -1 ) {

131 
»suÉ
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
Ú
, (on));

132 ià(
»suÉ
 < 0 ) {

133 
	`şo£
(
fd
);

134 
fd
 = -1;

138 
Ú
 = 1;

139 
»suÉ
 = 
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
Ú
, (on));

140 
»suÉ
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*è& 
Ú
, (on));

142 
addr
.
sš_çmy
 = 
AF_INET
;

143 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
r
);

144 
addr
.
sš_pÜt
 = 
	`htÚs
(
½Üt
);

145 
»suÉ
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *è& 
addr
, (sockaddr));

146 iàĞ
»suÉ
 != 0 ) {

147 
	`şo£
(
fd
);

148 
fd
 = -1;

152  
fd
;

153 
	}
}

155 
	$x_acû±
(
li¡’_fd
, *

, *
pÜt
)

157 
fd
 = -1;

158 
sockaddr_š
 
»mÙe
;

159 
Ën
 = 0;

161 
ReAcû±
:

163 
Ën
 = Ğ
sockaddr_š
 );

165 
fd
 = 
	`acû±
(
li¡’_fd
, (
sockaddr
 *)&
»mÙe
, (
sockËn_t
 *)&
Ën
);

166 ià(
fd
 == -1) {

167 
”r
 = 
”ºo
;

168 iàĞ
”r
 =ğ
EINTR
 ||ƒ¼ =ğ
EAGAIN
 ) {

169 
ReAcû±
;

172 #ifdeà 
EPROTO


173 ià(
”r
 =ğ
EPROTO
 ||ƒ¼ =ğ
ECONNABORTED
) {

174 
ReAcû±
;

177 ià(
”r
 =ğ
ECONNABORTED
 ) {

178 
ReAcû±
;

184 
	`x_£t_sock_no_d–ay
(
fd
);

186 iàĞ
pÜt
 !ğ
NULL
 ) {

187 *
pÜt
 = 
	`Áohs
(
»mÙe
.
sš_pÜt
);

190 iàĞ

 !ğ
NULL
 ) {

191 
	`¡rıy
Ğ

, 
	`š‘_Áß
(
»mÙe
.
sš_addr
));

194  
fd
;

195 
	}
}

198 
	$x_şo£
(
fd
)

200 
	`shutdown
(
fd
, 
SHUT_RDWR
);

202 
	`şo£
(
fd
);

204 
fd
 = -1;

207 
	}
}

209 
	$x_£nd
(
fd
, *
buf
, 
Ën
)

212 
by‹s
 = -1;

214 
Ëngth
 = 
Ën
;

217 
ReS’d
:

219 
by‹s
 = 
	`£nd
(
fd
, 
buf
, 
Ëngth
, 0);

220 iàĞ
by‹s
 > 0 ) {

221 
Ëngth
 -ğ
by‹s
;

222 
buf
 +ğ
by‹s
;

225 ià(
by‹s
 == -1) {

226 ià(
”ºo
 =ğ
EINTR
) {

227 
ReS’d
;

231 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
) {

232 
ReS’d
;

236 }  
Ëngth
 > 0 && 
by‹s
 > 0 );

238 iàĞ
Ëngth
 == 0 ) {

239 
by‹s
 = 
Ën
;

242  
by‹s
;

243 
	}
}

245 
	$x_»cvby‹s
(
fd
, *
buf
, 
Ën
)

247 
by‹s
 = -1;

249 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ën
, 0);

251  
by‹s
;

252 
	}
}

254 
	$x_»cv
(
fd
, *
buf
, 
Ën
)

256 
by‹s
 = -1;

258 
Ëngth
 = 
Ën
;

261 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ëngth
, 0);

262 iàĞ
by‹s
 > 0 ) {

263 
Ëngth
 -ğ
by‹s
;

264 
buf
 +ğ
by‹s
;

267 }  
Ëngth
 > 0 && 
by‹s
 > 0 );

269 iàĞ
Ëngth
 == 0 ) {

270 
by‹s
 = 
Ën
;

273  
by‹s
;

274 
	}
}

279 
	$x_»cv_w™h_timeout
(
fd
, *
buf
, 
Ën
, 
timeout
)

281 
by‹s
 = -1;

282 
Ëngth
 = 
Ën
;

284 ià(
timeout
 <= 0 ) {

285  
	`x_»cv
(
fd
, 
buf
, 
Ën
);

288 iàĞ
fd
 < 0 ) {

292 
fd_£t
 
r£t
;

293 
timev®
 
tv
;

294 
tv
.
tv_£c
 = 
timeout
;

295 
tv
.
tv_u£c
 = 0;

297  
tv
.
tv_£c
 > 0 && 
Ëngth
 > 0 && 
fd
 >= 0) {

299 
	`FD_ZERO
(&
r£t
);

300 
	`FD_SET
(
fd
, &
r£t
);

302 
»tv®
 = 
	`£Ëù
(
fd
 + 1, &
r£t
, 
NULL
, NULL, &
tv
);

303 iàĞ
»tv®
 == 0 ) {

307 iàĞ
»tv®
 < 0 ) {

308 iàĞ
”ºo
 =ğ
EINTR
 ) {

315 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ëngth
, 0);

316 ià(
by‹s
 > 0) {

317 
Ëngth
 -ğ
by‹s
;

318 
buf
 +ğ
by‹s
;

320 iàĞ
by‹s
 == 0 ) {

323 ià(
by‹s
 == -1) {

324 iàĞ
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
 ) {

333 
by‹s
 = 
Ën
 - 
Ëngth
;

335  
by‹s
;

336 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/x_socket.h

1 #iâdeà
_X_SOCKET_H__


2 
	#_X_SOCKET_H__


	)

4 
	#TTL_VALUE
 255

	)

6 
	#MAX_LISTEN_QUEUE
 5

	)

8 #ifdeà
__ılu¥lus


12 
x_£t_sock_deçuÉ_İt
(
s
);

13 
x_£t_sock_no_d–ay
(
s
);

14 
x_£t_sock_no_block
(
s
);

16 
x_ü—‹_tı_£rv”
(cÚ¡ *
l
, 
ÍÜt
);

17 
x_acû±
(
li¡’_fd
, *

, *
pÜt
);

18 
x_ü—‹_tı_ş›Á
(cÚ¡ *
r
, 
½Üt
);

19 
x_şo£
(
fd
);

20 
x_£nd
(
fd
, *
buf
, 
Ën
);

21 
x_»cv
(
fd
, *
buf
, 
Ën
);

22 
x_»cvby‹s
(
fd
, *
buf
, 
Ën
);

23 
x_»cv_w™h_timeout
(
fd
, *
buf
, 
Ën
, 
timeout
);

26 #ifdeà
__ılu¥lus


	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/main.cc

1 
	~<uni¡d.h
>

2 
	~<glog/loggšg.h
>

3 
	~<io¡»am
>

4 
	~"x_sock‘.h
"

6 
usšg
 
Çme¥aû
 
	g¡d
;

8 
	$maš
(
¬gc
, *
¬gv
[])

10 
i
 = 0; i < 100; i++) {

11 
fd
 = 
	`x_ü—‹_tı_ş›Á
("127.0.0.1", 9527);

12 ià(
fd
 == -1) {

16 
	`u¦“p
(100);

19 
	`x_şo£
(
fd
);

23 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/x_socket.cc

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/¡©.h
>

5 
	~<sys/sock‘.h
>

6 
	~<sys/£ndfe.h
>

7 
	~<Ãtš‘/š.h
>

8 
	~<Ãtdb.h
>

9 
	~<¬·/š‘.h
>

10 
	~<Ãtš‘/tı.h
>

11 
	~<fú.h
>

12 
	~<”ºo.h
>

13 
	~<¡ršg.h
>

15 
	~"x_sock‘.h
"

17 
	$x_£t_sock_deçuÉ_İt
(
s
)

20 
Ú
 = 1;

21 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
Ú
, (on));

22 ià(
»suÉ
 < 0) {

23 
	`şo£
(
s
);

27 
Ú
 = 1;

28 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*)&
Ú
, (on));

31 
lšg”
 
İtv®
;

32 
İtv®
.
l_Úoff
 = 1;

33 
İtv®
.
l_lšg”
 = 60;

34 
»suÉ
 = 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_LINGER
, (*)&
İtv®
, (
lšg”
));

35 iàĞ
»suÉ
 < 0 ) {

36 
	`şo£
Ğ
s
 );

40 
Ën
 = 2 * 1024 * 1024;

41 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_RCVBUF
, (*)&
Ën
, (len));

42 
	`£tsockİt
(
s
, 
SOL_SOCKET
, 
SO_SNDBUF
, (*)&
Ën
, (len));

45 
	}
}

49 
	$x_£t_sock_no_d–ay
(
s
)

51 
İt
;

52 
sockËn_t
 
İ’
;

54 
İ’
 =  
İt
;

55 ià(
	`g‘sockİt
(
s
, 
IPPROTO_TCP
, 1 , &
İt
, &
İ’
) == -1) {

59 ià(
İt
 == 1) {

62 
İt
 = 1;

63 
	`£tsockİt
(
s
, 
IPPROTO_TCP
, 1 , &
İt
, ( opt ));

66 
	}
}

68 
	$x_£t_sock_no_block
(
s
)

70 
æags
;

72 ià((
æags
 = 
	`fú
(
s
, 
F_GETFL
, 
NULL
)) < 0) {

76 ià(
	`fú
(
s
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
) == -1) {

81 
	}
}

84 
	$x_ü—‹_tı_£rv”
(cÚ¡ *
l
, 
ÍÜt
)

86 
sockaddr_š
 
addr
;

87 
s
 = 
	`sock‘
Ğ
AF_INET
, 
SOCK_STREAM
, 0 );

88 iàĞ
s
 == -1 ) {

92 
	`x_£t_sock_deçuÉ_İt
(
s
);

94 
addr
.
sš_çmy
 = 
AF_INET
;

95 ià(
	`¡rcmp
(
l
, "0.0.0.0") == 0) {

96 
addr
.
sš_addr
.
s_addr
 = 
INADDR_ANY
;

99 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
Ğ
l
 );

101 
addr
.
sš_pÜt
 = 
	`htÚs
Ğ
ÍÜt
 );

103 ià(
	`bšd
(
s
, (
sockaddr
 *)&
addr
, (
sockaddr_š
)) == -1 ) {

104 
	`şo£
Ğ
s
);

105 
s
 = -1;

109 ià(
	`li¡’
(
s
, 
MAX_LISTEN_QUEUE
 ) == -1 ) {

110 
	`şo£
(
s
);

111 
s
 = -1;

115  
s
;

116 
	}
}

119 
	$x_ü—‹_tı_ş›Á
(cÚ¡ *
r
, 
½Üt
)

121 
sockaddr_š
 
addr
;

122 
»suÉ
;

123 
Ú
 = 1;

124 
fd
;

126 
fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0);

127 iàĞ
fd
 == -1 ) {

131 
»suÉ
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*è&
Ú
, (on));

132 ià(
»suÉ
 < 0 ) {

133 
	`şo£
(
fd
);

134 
fd
 = -1;

138 
Ú
 = 1;

139 
»suÉ
 = 
	`£tsockİt
(
fd
, 
IPPROTO_TCP
, 
TCP_NODELAY
, (*)&
Ú
, (on));

140 
»suÉ
 = 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*è& 
Ú
, (on));

142 
addr
.
sš_çmy
 = 
AF_INET
;

143 
addr
.
sš_addr
.
s_addr
 = 
	`š‘_addr
(
r
);

144 
addr
.
sš_pÜt
 = 
	`htÚs
(
½Üt
);

145 
»suÉ
 = 
	`cÚÃù
(
fd
, (
sockaddr
 *è& 
addr
, (sockaddr));

146 iàĞ
»suÉ
 != 0 ) {

147 
	`şo£
(
fd
);

148 
fd
 = -1;

152  
fd
;

153 
	}
}

155 
	$x_acû±
(
li¡’_fd
, *

, *
pÜt
)

157 
fd
 = -1;

158 
sockaddr_š
 
»mÙe
;

159 
Ën
 = 0;

161 
ReAcû±
:

163 
Ën
 = Ğ
sockaddr_š
 );

165 
fd
 = 
	`acû±
(
li¡’_fd
, (
sockaddr
 *)&
»mÙe
, (
sockËn_t
 *)&
Ën
);

166 ià(
fd
 == -1) {

167 
”r
 = 
”ºo
;

168 iàĞ
”r
 =ğ
EINTR
 ||ƒ¼ =ğ
EAGAIN
 ) {

169 
ReAcû±
;

172 #ifdeà 
EPROTO


173 ià(
”r
 =ğ
EPROTO
 ||ƒ¼ =ğ
ECONNABORTED
) {

174 
ReAcû±
;

177 ià(
”r
 =ğ
ECONNABORTED
 ) {

178 
ReAcû±
;

184 
	`x_£t_sock_no_d–ay
(
fd
);

186 iàĞ
pÜt
 !ğ
NULL
 ) {

187 *
pÜt
 = 
	`Áohs
(
»mÙe
.
sš_pÜt
);

190 iàĞ

 !ğ
NULL
 ) {

191 
	`¡rıy
Ğ

, 
	`š‘_Áß
(
»mÙe
.
sš_addr
));

194  
fd
;

195 
	}
}

198 
	$x_şo£
(
fd
)

200 
	`shutdown
(
fd
, 
SHUT_RDWR
);

202 
	`şo£
(
fd
);

204 
fd
 = -1;

207 
	}
}

209 
	$x_£nd
(
fd
, *
buf
, 
Ën
)

212 
by‹s
 = -1;

214 
Ëngth
 = 
Ën
;

217 
ReS’d
:

219 
by‹s
 = 
	`£nd
(
fd
, 
buf
, 
Ëngth
, 0);

220 iàĞ
by‹s
 > 0 ) {

221 
Ëngth
 -ğ
by‹s
;

222 
buf
 +ğ
by‹s
;

225 ià(
by‹s
 == -1) {

226 ià(
”ºo
 =ğ
EINTR
) {

227 
ReS’d
;

231 ià(
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
) {

232 
ReS’d
;

236 }  
Ëngth
 > 0 && 
by‹s
 > 0 );

238 iàĞ
Ëngth
 == 0 ) {

239 
by‹s
 = 
Ën
;

242  
by‹s
;

243 
	}
}

245 
	$x_»cvby‹s
(
fd
, *
buf
, 
Ën
)

247 
by‹s
 = -1;

249 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ën
, 0);

251  
by‹s
;

252 
	}
}

254 
	$x_»cv
(
fd
, *
buf
, 
Ën
)

256 
by‹s
 = -1;

258 
Ëngth
 = 
Ën
;

261 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ëngth
, 0);

262 iàĞ
by‹s
 > 0 ) {

263 
Ëngth
 -ğ
by‹s
;

264 
buf
 +ğ
by‹s
;

267 }  
Ëngth
 > 0 && 
by‹s
 > 0 );

269 iàĞ
Ëngth
 == 0 ) {

270 
by‹s
 = 
Ën
;

273  
by‹s
;

274 
	}
}

279 
	$x_»cv_w™h_timeout
(
fd
, *
buf
, 
Ën
, 
timeout
)

281 
by‹s
 = -1;

282 
Ëngth
 = 
Ën
;

284 ià(
timeout
 <= 0 ) {

285  
	`x_»cv
(
fd
, 
buf
, 
Ën
);

288 iàĞ
fd
 < 0 ) {

292 
fd_£t
 
r£t
;

293 
timev®
 
tv
;

294 
tv
.
tv_£c
 = 
timeout
;

295 
tv
.
tv_u£c
 = 0;

297  
tv
.
tv_£c
 > 0 && 
Ëngth
 > 0 && 
fd
 >= 0) {

299 
	`FD_ZERO
(&
r£t
);

300 
	`FD_SET
(
fd
, &
r£t
);

302 
»tv®
 = 
	`£Ëù
(
fd
 + 1, &
r£t
, 
NULL
, NULL, &
tv
);

303 iàĞ
»tv®
 == 0 ) {

307 iàĞ
»tv®
 < 0 ) {

308 iàĞ
”ºo
 =ğ
EINTR
 ) {

315 
by‹s
 = 
	`»cv
(
fd
, 
buf
, 
Ëngth
, 0);

316 ià(
by‹s
 > 0) {

317 
Ëngth
 -ğ
by‹s
;

318 
buf
 +ğ
by‹s
;

320 iàĞ
by‹s
 == 0 ) {

323 ià(
by‹s
 == -1) {

324 iàĞ
”ºo
 =ğ
EINTR
 ||ƒ¼nØ=ğ
EAGAIN
 ) {

333 
by‹s
 = 
Ën
 - 
Ëngth
;

335  
by‹s
;

336 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/x_socket.h

1 #iâdeà
_X_SOCKET_H__


2 
	#_X_SOCKET_H__


	)

4 
	#TTL_VALUE
 255

	)

6 
	#MAX_LISTEN_QUEUE
 5

	)

8 #ifdeà
__ılu¥lus


12 
x_£t_sock_deçuÉ_İt
(
s
);

13 
x_£t_sock_no_d–ay
(
s
);

14 
x_£t_sock_no_block
(
s
);

16 
x_ü—‹_tı_£rv”
(cÚ¡ *
l
, 
ÍÜt
);

17 
x_acû±
(
li¡’_fd
, *

, *
pÜt
);

18 
x_ü—‹_tı_ş›Á
(cÚ¡ *
r
, 
½Üt
);

19 
x_şo£
(
fd
);

20 
x_£nd
(
fd
, *
buf
, 
Ën
);

21 
x_»cv
(
fd
, *
buf
, 
Ën
);

22 
x_»cvby‹s
(
fd
, *
buf
, 
Ën
);

23 
x_»cv_w™h_timeout
(
fd
, *
buf
, 
Ën
, 
timeout
);

26 #ifdeà
__ılu¥lus


	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/deadline_timer/main.cc

3 
	~<uni¡d.h
>

4 
	~<±h»ad.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/asio.hµ
>

7 
	~<glog/loggšg.h
>

9 
	gboo¡
::
asio
::
io_£rviû
 
g_io_£rviû
;

10 
	gboo¡
::
asio
::
io_£rviû
::
wÜk
 
g_wÜk
(
g_io_£rviû
);

11 
	gboo¡
::
asio
::
d—dlše_tim”
 
g_tim”
(
g_io_£rviû
);

13 
tim”_hªdËr
(cÚ¡ 
boo¡
::
sy¡em
::
”rÜ_code
 &
”rÜ
)

15 ià(
”rÜ
) {

16 
LOG
(
ERROR
è<< "”rmsg=" << 
”rÜ
.
mes§ge
();

20 
LOG
(
INFO
) << "timerimeout";

25 *
	$wÜk”
(*
¬g
)

27 
g_io_£rviû
.
	`run
();

29  
NULL
;

30 
	}
}

32 
	$maš
()

34 
±h»ad_t
 
tid
;

35 
»t
 = 
	`±h»ad_ü—‹
(&
tid
, 
NULL
, 
wÜk”
, NULL);

36 ià(
»t
 != 0) {

37 
	`LOG
(
FATAL
) << "pthread create failed";

41 
¡d
::
size_t
 
»maš_tim”s
;

43 
»maš_tim”s
 = 
g_tim”
.
	`expœes_äom_now
(
boo¡
::
posix_time
::
	`mli£cÚds
(3000));

44 
	`LOG
(
INFO
è<< "1,„emaš_tim” ğ" << 
»maš_tim”s
;

45 
g_tim”
.
	`async_wa™
(

46 
boo¡
::
	`bšd
(
tim”_hªdËr
, boo¡::
asio
::
¶aûhŞd”s
::
”rÜ
));

51 
»maš_tim”s
 = 
g_tim”
.
	`expœes_äom_now
(
boo¡
::
posix_time
::
	`mli£cÚds
(5000));

52 
	`LOG
(
INFO
è<< "2,„emaš_tim” ğ" << 
»maš_tim”s
;

53 
g_tim”
.
	`async_wa™
(

54 
boo¡
::
	`bšd
(
tim”_hªdËr
, boo¡::
asio
::
¶aûhŞd”s
::
”rÜ
));

56 
	`LOG
(
INFO
) << "sleep 3 s";

57 
	`¦“p
(3);

59 
»maš_tim”s
 = 
g_tim”
.
	`expœes_äom_now
(
boo¡
::
posix_time
::
	`mli£cÚds
(3000));

60 
	`LOG
(
INFO
è<< "3,„emaš_tim” ğ" << 
»maš_tim”s
;

61 
g_tim”
.
	`async_wa™
(

62 
boo¡
::
	`bšd
(
tim”_hªdËr
, boo¡::
asio
::
¶aûhŞd”s
::
”rÜ
));

64 
	`±h»ad_još
(
tid
, 
NULL
);

67 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/event/main.cc

3 
	~<sys/sock‘.h
>

4 
	~<sys/wa™.h
>

5 
	~<sigÇl.h
>

6 
	~<uni¡d.h
>

7 
	~<Ãtdb.h
>

8 
	~<glog/loggšg.h
>

9 
	~<sys/ioùl.h
>

11 
	~<¡ršg.h
>

12 
	~<”ºo.h
>

13 
	~<glog/loggšg.h
>

14 
	~<boo¡/bšd.hµ
>

15 
	~"ldd/Ãt/ev’t_loİ.h
"

16 
	~"ldd/Ãt/ev’t.h
"

17 
	~"ldd/ut/time¡amp.h
"

19 
usšg
 
Çme¥aû
 
	gldd
;

20 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

21 
usšg
 
Çme¥aû
 
	gldd
::
ut
;

23 
	$func
()

26 
	}
}

28 
	$£t_noblockšg
(
fd
)

30 
nÚblockšg
 = 1;

31 
	`ioùl
(
fd
, 
FIONBIO
, (*)&
nÚblockšg
);

32 
	}
}

34 
S’dMsg
(
fd
, cÚ¡ 
¡d
::
¡ršg
 &
msg
)

36 
»t
 = 
wr™e
(
fd
, 
msg
.
d©a
(), msg.
size
());

37 ià(
	g»t
 == -1) {

44 
	$HªdËTim”
() {

45 
	`årštf
(
¡d”r
, "HandleTimer\n");

46 
	}
}

48 
	$HªdËR—d
(
fd
, 
ev’t
) {

49 
	`årštf
(
¡d”r
, "HªdËR—d fd=%dƒv’t=%d\n", 
fd
, 
ev’t
);

50 
	}
}

52 
Ev’tLoİ
* 
	gg_loİ
 = 
NULL
;

54 
	$HªdËSigÇl
(
sig
) {

55 
	`årštf
(
¡d”r
, "hªdËSigÇÈ%d", 
sig
);

56 
g_loİ
->
	`Stİ
();

57 
	}
}

59 
	$HªdËStİ
() {

60 
g_loİ
->
	`Stİ
();

61 
	}
}

63 
	$maš
(
¬gc
, *
¬gv
[])

66 
FLAGS_¡d”¹h»shŞd
 = 0;

67 
fd
[2];

68 
»t
 = 
	`sock‘·œ
(
AF_UNIX
, 
SOCK_STREAM
, 0, 
fd
);

69 ià(
»t
 == -1) {

77 
g_loİ
 = 
Ãw
 
	`Ev’tLoİ
();

78 
SigÇlEv’t
* 
sig
 = 
Ãw
 
	`SigÇlEv’t
(
g_loİ
);

79 
sig
->
	`Add
(
SIGTERM
);

80 
sig
->
	`Add
(
SIGINT
);

81 
sig
->
	`Add
(
SIGQUIT
);

82 
sig
->
	`AsyncWa™
(
boo¡
::
	`bšd
(&
HªdËSigÇl
, 
_1
));

84 
Tim”Ev’t
* 
tim”
 = 
Ãw
 
	`Tim”Ev’t
(
g_loİ
);

85 
tim”
->
	`AsyncWa™
(
HªdËTim”
, 
ut
::
TimeDiff
::
	`SecÚds
(1));

87 
FdEv’t
* 
fdev’t
 = 
Ãw
 
	`FdEv’t
(
g_loİ
);

88 
fdev’t
->
	`AsyncWa™
(
fd
[1], 
FdEv’t
::
kR—dabË
,

89 
boo¡
::
	`bšd
(&
HªdËR—d
, 
fd
[1], 
_1
),

90 
TimeDiff
::
	`Mli£cÚds
(3000));

92 
Tim”Ev’t
* 
tim”2
 = 
Ãw
 
	`Tim”Ev’t
(
g_loİ
);

93 
tim”2
->
	`AsyncWa™
(
HªdËStİ
, 
ut
::
Time¡amp
::
	`Now
(è+ ut::
TimeDiff
::
	`SecÚds
(5));

95 
	`S’dMsg
(
fd
[0], "hello");

96 
g_loİ
->
	`Run
();

97 
d–‘e
 
fdev’t
;

98 
d–‘e
 
tim”2
;

99 
d–‘e
 
tim”
;

100 
d–‘e
 
sig
;

101 
d–‘e
 
g_loİ
;

103 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/file_lock/main.cc

1 
	~<boo¡/š‹½roûss/sync/fe_lock.hµ
>

3 
	$maš
()

7 
boo¡
::
š‹½roûss
::
fe_lock
 
	`æock
("my_file");

10 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/noblocking_accept/main.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/bšd.hµ
>

6 
	~<boo¡/asio.hµ
>

8 şas 
	cmy_acû±Ü
 : 
public
 
boo¡
::
asio
::

::
tı
::
acû±Ü
 {

9 
public
:

10 
ex¶ic™
 
my_acû±Ü
(
boo¡
::
asio
::
io_£rviû
& io_service)

11 : 
boo¡
::
asio
::

::
tı
::
	$acû±Ü
(
io_£rviû
)

15 
‹m¶©e
 <
ty³Çme
 
IoCÚŒŞCommªd
>

16 
	$io_cÚŒŞ
(
IoCÚŒŞCommªd
& 
commªd
)

18 
boo¡
::
sy¡em
::
”rÜ_code
 
ec
;

19 
this
->
£rviû
.
	`io_cÚŒŞ
Ñhis->
im¶em’tiÚ
, 
commªd
, 
ec
);

20 
boo¡
::
asio
::
d‘a
::
	`throw_”rÜ
(
ec
);

21 
	}
}

24 
	gboo¡
::
asio
::
io_£rviû
 
g_ios
;

26 
my_acû±Ü
 
g_acû±Ü
(
g_ios
);

27 
	gboo¡
::
asio
::

::
tı
::
sock‘
 
g_sock‘
(
g_ios
);

29 
HªdËAcû±
(cÚ¡ 
boo¡
::
sy¡em
::
”rÜ_code
& 
e
)

31 ià(
e
) {

32 
LOG
(
ERROR
è<< "acû±ƒ¼Ü:ƒ¼msg=" << 
e
.
mes§ge
();

36 
	gg_sock‘
.
şo£
();

38 
	gcouÁ
 = 0;

40 
	gboo¡
::
sy¡em
::
”rÜ_code
 
ec
;

41 
	gg_acû±Ü
.
acû±
(
g_sock‘
, 
ec
);

42 ià(
	gec
) {

43 
LOG
(
ERROR
) << "acceptƒrror,ƒrrval="

44 << 
	gec
.
v®ue
()

46 << 
	gec
.
mes§ge
();

51 
	gg_sock‘
.
şo£
();

53 
	gcouÁ
++;

54 
LOG
(
INFO
è<< "acû± " << 
	gcouÁ
 << " socket";

57 
	gg_acû±Ü
.
async_acû±
(
g_sock‘


58 , 
boo¡
::
bšd
(&
HªdËAcû±


59 , 
boo¡
::
asio
::
¶aûhŞd”s
::
”rÜ
)

63 
	$maš
(
¬gc
, *
¬gv
[])

65 
Œy
 {

66 
boo¡
::
asio
::

::
tı
::
’dpošt
 
	`’dpošt
(boo¡::asio::::tı::
	`v4
()

68 
g_acû±Ü
.
	`İ’
(
’dpošt
.
	`´ÙocŞ
());

69 
g_acû±Ü
.
	`£t_İtiÚ
(

70 
boo¡
::
asio
::

::
tı
::
acû±Ü
::
	`»u£_add»ss
(
Œue
));

71 
g_acû±Ü
.
	`bšd
(
’dpošt
);

72 
g_acû±Ü
.
	`li¡’
();

74 
	`ÿtch
 (
boo¡
::
sy¡em
::
sy¡em_”rÜ
 &
e
) {

75 
	`LOG
(
ERROR
è<< "li¡’ƒ¼Ü:ƒ¼msg=" << 
e
.
	`wh©
();

78 
	`ÿtch
 (...) {

79 
	`LOG
(
FATAL
) << "listen faile, unknownƒxception";  -1;

82 
boo¡
::
asio
::
sock‘_ba£
::
nÚ_blockšg_io
 
	`commªd
(
Œue
);

83 
g_acû±Ü
.
	`io_cÚŒŞ
(
commªd
);

86 
g_acû±Ü
.
	`async_acû±
(
g_sock‘


87 , 
boo¡
::
	`bšd
(&
HªdËAcû±


88 , 
boo¡
::
asio
::
¶aûhŞd”s
::
”rÜ
));

90 
g_ios
.
	`run
();

92 
	`g‘ch¬
();

95 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/event_loop_test.cc

4 
	~<ldd/Ãt/ev’t_loİ.h
>

5 
	~<ldd/Ãt/ev’t_loİ_th»ad_poŞ.h
>

7 
	~<g‹¡/g‹¡.h
>

8 
	~<glog/loggšg.h
>

10 
	~<boo¡/bšd.hµ
>

12 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

14 şas 
	cMyEv’tLoİ
 {

15 
	mpublic
:

16 
	$MyEv’tLoİ
(è: 
	$ok_
(
çl£
) {}

17 ~
	$MyEv’tLoİ
(è{
	}
}

19 
boŞ
 
In™
();

20 
Fš®ize
();

22 
boŞ
 
RunInLoİ
();

23 
boŞ
 
QueueInLoİ
();

25 
	g´iv©e
:

26 
Func
(
no
);

28 
	g´iv©e
:

29 
Ev’tLoİ
 
loİ_
;

31 
boŞ
 
	gok_
;

34 
	gMyEv’tLoİ
::
	$Func
(
no
)

36 
	`LOG
(
INFO
è<< "funørun,‚o: " << 
no
;

37 
ok_
 = 
Œue
;

38 
loİ_
.
	`Stİ
();

39 
	}
}

41 
boŞ
 
	gMyEv’tLoİ
::
	$In™
()

43 
	`LOG
(
INFO
) << "Enter init";

44  
Œue
;

45 
	}
}

47 
	gMyEv’tLoİ
::
	$Fš®ize
()

49 
	`LOG
(
INFO
) << "Enter Finalize";

50 
	}
}

52 
boŞ
 
	gMyEv’tLoİ
::
	$RunInLoİ
()

54 
loİ_
.
	`RunInLoİ
(
boo¡
::
	`bšd
(&
MyEv’tLoİ
::
Func
, 
this
, 1));

56 
loİ_
.
	`Run
();

58 ià(!
ok_
) {

59  
çl£
;

62 
ok_
 = 
çl£
;

64  
Œue
;

65 
	}
}

67 
boŞ
 
	gMyEv’tLoİ
::
	$QueueInLoİ
()

69 
loİ_
.
	`QueueInLoİ
(
boo¡
::
	`bšd
(&
MyEv’tLoİ
::
Func
, 
this
, 2));

71 
loİ_
.
	`Run
();

73 ià(!
ok_
) {

74  
çl£
;

77 
ok_
 = 
çl£
;

79  
Œue
;

80 
	}
}

84 şas 
	cMyEv’tLoİTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

85 
public
:

86 
vœtu®
 
S‘Up
();

87 
vœtu®
 
T—rDown
();

89 
	m´Ùeùed
:

90 
MyEv’tLoİ
 
loİ_
;

93 
	gMyEv’tLoİTe¡
::
	$S‘Up
()

95 
loİ_
.
	`In™
();

96 
	}
}

98 
	gMyEv’tLoİTe¡
::
	$T—rDown
()

100 
loİ_
.
	`Fš®ize
();

101 
	}
}

104 
	$TEST_F
(
MyEv’tLoİTe¡
, 
Ev’tLoİTe¡
)

106 
	`ASSERT_TRUE
(
loİ_
.
	`RunInLoİ
());

107 
	`ASSERT_TRUE
(
loİ_
.
	`QueueInLoİ
());

108 
	}
}

112 şas 
	cMyEv’tLoİTh»ad
 {

113 
	mpublic
:

114 
	$MyEv’tLoİTh»ad
(è: 
	$ok_
(
çl£
) {}

115 ~
	$MyEv’tLoİTh»ad
(è{
	}
}

117 
boŞ
 
In™
();

118 
Fš®ize
();

120 
boŞ
 
RunInLoİ
();

121 
boŞ
 
QueueInLoİ
();

123 
	g´iv©e
:

124 
Func
(
no
);

126 
	g´iv©e
:

127 
Ev’tLoİTh»ad
 
loİ_th»ad_
;

129 
boŞ
 
	gok_
;

132 
	gMyEv’tLoİTh»ad
::
	$Func
(
no
)

134 
	`LOG
(
INFO
è<< "funørun,‚o: " << 
no
;

135 
ok_
 = 
Œue
;

136 
	}
}

138 
boŞ
 
	gMyEv’tLoİTh»ad
::
	$In™
()

140 
	`LOG
(
INFO
) << "Enter init";

141 
loİ_th»ad_
.
	`S¹
();

142  
Œue
;

143 
	}
}

145 
	gMyEv’tLoİTh»ad
::
	$Fš®ize
()

147 
	`LOG
(
INFO
) << "Enter Finalize";

149 
loİ_th»ad_
.
	`Stİ
();

150 
loİ_th»ad_
.
	`Još
();

151 
	}
}

153 
boŞ
 
	gMyEv’tLoİTh»ad
::
	$RunInLoİ
()

155 
loİ_th»ad_
.
	`ev’t_loİ
()->
	`RunInLoİ
(
boo¡
::
	`bšd
(&
MyEv’tLoİTh»ad
::
Func
, 
this
, 1));

157 
	`u¦“p
(100*1000);

159 ià(!
ok_
) {

160  
çl£
;

163 
ok_
 = 
çl£
;

165  
Œue
;

166 
	}
}

168 
boŞ
 
	gMyEv’tLoİTh»ad
::
	$QueueInLoİ
()

170 
loİ_th»ad_
.
	`ev’t_loİ
()->
	`QueueInLoİ
(
boo¡
::
	`bšd
(&
MyEv’tLoİTh»ad
::
Func
, 
this
, 2));

172 
	`u¦“p
(100*1000);

174 ià(!
ok_
) {

175  
çl£
;

178 
ok_
 = 
çl£
;

180  
Œue
;

181 
	}
}

185 şas 
	cMyEv’tLoİTh»adTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

186 
public
:

187 
vœtu®
 
S‘Up
();

188 
vœtu®
 
T—rDown
();

190 
	m´Ùeùed
:

191 
MyEv’tLoİTh»ad
 
loİ_
;

194 
	gMyEv’tLoİTh»adTe¡
::
	$S‘Up
()

196 
loİ_
.
	`In™
();

197 
	}
}

199 
	gMyEv’tLoİTh»adTe¡
::
	$T—rDown
()

201 
loİ_
.
	`Fš®ize
();

202 
	}
}

205 
	$TEST_F
(
MyEv’tLoİTh»adTe¡
, 
Ev’tLoİTh»adTe¡
)

207 
	`ASSERT_TRUE
(
loİ_
.
	`RunInLoİ
());

208 
	`ASSERT_TRUE
(
loİ_
.
	`QueueInLoİ
());

209 
	}
}

214 
	#THREAD_COUNT
 10

	)

216 şas 
	cMyEv’tLoİTh»adPoŞ
 {

217 
	mpublic
:

218 
	$MyEv’tLoİTh»adPoŞ
(è: 
	$loİ_th»ad_poŞ_
(&
loİ_
) {}

219 ~
	$MyEv’tLoİTh»adPoŞ
(è{
	}
}

221 
boŞ
 
In™
();

222 
Fš®ize
();

224 
boŞ
 
RunInLoİ
();

225 
boŞ
 
QueueInLoİ
();

227 
	g´iv©e
:

228 
Func
(
no
);

230 
	g´iv©e
:

231 
Ev’tLoİ
 
loİ_
;

232 
Ev’tLoİTh»adPoŞ
 
	gloİ_th»ad_poŞ_
;

234 
boŞ
 
	gok_
[
THREAD_COUNT
];

237 
	gMyEv’tLoİTh»adPoŞ
::
	$Func
(
no
)

239 
	`LOG
(
INFO
è<< "funørun,‚o: " << 
no
;

240 
ok_
[
no
] = 
Œue
;

241 
	}
}

243 
boŞ
 
	gMyEv’tLoİTh»adPoŞ
::
	$In™
()

245 
	`LOG
(
INFO
) << "Enter init";

246 
i
 = 0; i < 
THREAD_COUNT
; i++) {

247 
ok_
[
i
] = 
çl£
;

250 
loİ_th»ad_poŞ_
.
	`S‘Th»adNum
(
THREAD_COUNT
);

251 ià(!
loİ_th»ad_poŞ_
.
	`S¹
()) {

252 
	`LOG
(
ERROR
) << "thread…ool start failed";

253  
çl£
;

256  
Œue
;

257 
	}
}

259 
	gMyEv’tLoİTh»adPoŞ
::
	$Fš®ize
()

261 
	`LOG
(
INFO
) << "Enter Finalize";

263 
loİ_th»ad_poŞ_
.
	`Stİ
();

265 
	}
}

267 
boŞ
 
	gMyEv’tLoİTh»adPoŞ
::
	$RunInLoİ
()

269 
i
 = 0; i < 
THREAD_COUNT
; i++) {

270 
loİ_th»ad_poŞ_
.
	`G‘NextLoİ
()->
	`RunInLoİ
(

271 
boo¡
::
	`bšd
(&
MyEv’tLoİTh»adPoŞ
::
Func
, 
this
, 
i
));

274 
	`u¦“p
(200*1000);

276 
boŞ
 
ok
 = 
Œue
;

277 
i
 = 0; i < 
THREAD_COUNT
; i++) {

278 ià(!
ok_
[
i
]) {

279 
ok
 = 
çl£
;

282 
ok_
[
i
] = 
çl£
;

285  
ok
;

286 
	}
}

288 
boŞ
 
	gMyEv’tLoİTh»adPoŞ
::
	$QueueInLoİ
()

290 
i
 = 0; i < 
THREAD_COUNT
; i++) {

291 
loİ_th»ad_poŞ_
.
	`G‘NextLoİ
()->
	`QueueInLoİ
(

292 
boo¡
::
	`bšd
(&
MyEv’tLoİTh»adPoŞ
::
Func
, 
this
, 
i
));

295 
	`u¦“p
(200*1000);

297 
boŞ
 
ok
 = 
Œue
;

298 
i
 = 0; i < 
THREAD_COUNT
; i++) {

299 ià(!
ok_
[
i
]) {

300 
ok
 = 
çl£
;

303 
ok_
[
i
] = 
çl£
;

306  
ok
;

307 
	}
}

311 şas 
	cMyEv’tLoİTh»adPoŞTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

312 
public
:

313 
vœtu®
 
S‘Up
();

314 
vœtu®
 
T—rDown
();

316 
	m´Ùeùed
:

317 
MyEv’tLoİTh»adPoŞ
 
loİ_
;

320 
	gMyEv’tLoİTh»adPoŞTe¡
::
	$S‘Up
()

322 
loİ_
.
	`In™
();

323 
	}
}

325 
	gMyEv’tLoİTh»adPoŞTe¡
::
	$T—rDown
()

327 
loİ_
.
	`Fš®ize
();

328 
	}
}

331 
	$TEST_F
(
MyEv’tLoİTh»adPoŞTe¡
, 
Ev’tLoİTh»adTe¡
)

333 
	`ASSERT_TRUE
(
loİ_
.
	`RunInLoİ
());

334 
	`ASSERT_TRUE
(
loİ_
.
	`QueueInLoİ
());

335 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/event_test.cc

4 
	~<¡ršg.h
>

5 
	~<”ºo.h
>

6 
	~<±h»ad.h
>

8 
	~<boo¡/bšd.hµ
>

10 
	~<ldd/Ãt/ev’t.h
>

11 
	~<ldd/Ãt/ev’t_loİ.h
>

13 
	~<g‹¡/g‹¡.h
>

14 
	~<glog/loggšg.h
>

16 
	~"x_sock‘.h
"

18 
usšg
 
Çme¥aû
 
	gldd
::
ut
;

19 
usšg
 
Çme¥aû
 
	gldd
::
Ãt
;

21 şas 
	cTCPS”v”
 {

22 
	mpublic
:

23 
	$TCPS”v”
(è: 
	`pÜt_
(0), 
	`fd_
(-1), 
	`tid_
(0), 
	$qu™_
(
çl£
) {}

24 ~
	$TCPS”v”
(è{
	}
}

26 
boŞ
 
In™
(
pÜt
);

28 
boŞ
 
S¹
();

29 
Stİ
();

31 
	g´iv©e
:

32 
R—lWÜk
();

33 *
wÜk_func
(*
¬g
);

35 
	g´iv©e
:

36 
pÜt_
;

37 
	gfd_
;

39 
±h»ad_t
 
	gtid_
;

40 
boŞ
 
	gqu™_
;

43 
boŞ
 
	gTCPS”v”
::
	$In™
(
pÜt
)

45 
s
 = 
	`x_ü—‹_tı_£rv”
("0.0.0.0", 
pÜt
);

46 ià(
s
 == -1) {

47 
	`LOG
(
ERROR
) << "createcp server failed";

48  
çl£
;

51 
fd_
 = 
s
;

53  
Œue
;

54 
	}
}

56 
boŞ
 
	gTCPS”v”
::
	$S¹
()

58 
rc
 = 
	`±h»ad_ü—‹
(&
tid_
, 
NULL
, 
TCPS”v”
::
wÜk_func
, 
this
);

59 ià(
rc
 == -1) {

60 
	`LOG
(
ERROR
è<< "ü—‹h»adƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

61  
çl£
;

64 
	`u¦“p
(10*1000);

66  
Œue
;

67 
	}
}

69 
	gTCPS”v”
::
	$Stİ
()

71 
qu™_
 = 
Œue
;

73 
	`şo£
(
fd_
);

75 
rc
 = 
	`±h»ad_još
(
tid_
, 
NULL
);

76 ià(
rc
 == -1) {

77 
	`LOG
(
ERROR
è<< "±h»ad jošƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

81 
	`LOG
(
INFO
) << "serverhreadƒxit";

82 
	}
}

84 *
	gTCPS”v”
::
	$wÜk_func
(*
¬g
)

86 
	`CHECK_NOTNULL
(
¬g
);

88 
TCPS”v”
 *
£lf
 = (TCPS”v” *)
¬g
;

90 
£lf
->
	`R—lWÜk
();

92  
NULL
;

93 
	}
}

96 
	gTCPS”v”
::
	$R—lWÜk
()

98 !
qu™_
) {

99 

[32];

100 
pÜt
;

101 
şi_fd
 = 
	`x_acû±
(
fd_
, 

, &
pÜt
);

102 ià(
şi_fd
 == -1) {

103 
	`LOG
(
ERROR
) << "accept client failed";

107 
	`LOG
(
INFO
è<< "acû±‡ cl›Á: " << 

 << ":" << 
pÜt
;

109 !
qu™_
) {

110 
buf
[1024];

111 
by‹s
 = 
	`x_»cvby‹s
(
şi_fd
, 
buf
, 1024);

112 ià(
by‹s
 <= 0) {

113 
	`LOG
(
ERROR
è<< "»cvƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

114 
	`şo£
(
şi_fd
);

118 
buf
[
by‹s
] = '\0';

120 
	`LOG
(
INFO
è<< "»cv‡ msg: " << 
buf
;

122 
rc
 = 
	`x_£nd
(
şi_fd
, 
buf
, 
by‹s
);

123 ià(
rc
 == -1) {

124 
	`LOG
(
ERROR
è<< "£ndƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

125 
	`şo£
(
şi_fd
);

129 
	`LOG
(
INFO
è<< "echØ¨msgØş›Á, msg†’: " << 
by‹s
;

132 
	}
}

136 şas 
	cTCPCl›Á
 {

137 
	mpublic
:

138 
	$TCPCl›Á
(
Ev’tLoİ
 *
ev’t_loİ
)

139 : 
	`fd_
(0),

140 
	`ev’t_loİ_
(
ev’t_loİ
),

141 
	`ev_
(
ev’t_loİ
),

142 
	$ok_
(
çl£
) {}

144 ~
	$TCPCl›Á
(è{ 
	`Clo£
(); 
	}
}

146 
boŞ
 
In™
(
pÜt
);

148 
Echo
(cÚ¡ 
¡d
::
¡ršg
 &
msg
);

150 
boŞ
 
	$ok
(è{  
ok_
; 
	}
}

152 
Clo£
();

154 
	g´iv©e
:

155 
OnWr™e
(
ev’ts
);

156 
OnR—d
(
ev’ts
);

158 
	g´iv©e
:

159 
fd_
;

161 
Ev’tLoİ
 *
	gev’t_loİ_
;

162 
FdEv’t
 
	gev_
;

164 
	g¡d
::
¡ršg
 
msg_
;

166 
boŞ
 
	gok_
;

169 
boŞ
 
	gTCPCl›Á
::
	$In™
(
pÜt
)

171 
fd_
 = 
	`x_ü—‹_tı_ş›Á
("0.0.0.0", 
pÜt
);

172 ià(
fd_
 == -1) {

173 
	`LOG
(
ERROR
è<< "ü—‹ı cl›Áƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

174  
çl£
;

177 
rc
 = 
	`evut_make_sock‘_nÚblockšg
(
fd_
);

178 ià(
rc
 != 0) {

179 
	`LOG
(
ERROR
è<< "maksock‘Ønoblockšg faed, fd: " << 
fd_
;

180  
çl£
;

183  
Œue
;

184 
	}
}

186 
	gTCPCl›Á
::
Echo
(cÚ¡ 
¡d
::
¡ršg
 &
msg
)

188 
msg_
 = 
msg
;

190 
TimeDiff
 
	gtd
 = TimeDiff::
Mli£cÚds
(50);

191 
	gev_
.
AsyncWa™
(
fd_
,

192 
FdEv’t
::
kWr™abË
,

193 
boo¡
::
bšd
(&
TCPCl›Á
::
OnWr™e
, 
this
, 
_1
)

194 , 
td
);

197 
	gTCPCl›Á
::
	$OnWr™e
(
ev’ts
)

199 ià(!(
ev’ts
 & 
FdEv’t
::
kWr™abË
)) {

200 
	`LOG
(
ERROR
) << "writeƒventsimeout";

204 
rc
 = 
	`x_£nd
(
fd_
, 
cÚ¡_ÿ¡
<*>(
msg_
.
	`c_¡r
()), msg_.
	`size
());

205 ià(
rc
 == -1) {

206 
	`LOG
(
ERROR
è<< "£nd msg faed, msg: " << 
msg_
;

210 
	`LOG
(
INFO
è<< "£nd‡ msg: " << 
msg_
;

212 
TimeDiff
 
td
 = TimeDiff::
	`Mli£cÚds
(500);

213 
ev_
.
	`AsyncWa™
(
fd_
,

214 
FdEv’t
::
kR—dabË
,

215 
boo¡
::
	`bšd
(&
TCPCl›Á
::
OnR—d
, 
this
, 
_1
),

216 
td
);

217 
	}
}

219 
	gTCPCl›Á
::
	$OnR—d
(
ev’ts
)

221 
	`LOG
(
INFO
) << "Enter OnRead";

224 ià(!(
ev’ts
 & 
FdEv’t
::
kR—dabË
)) {

225 
	`LOG
(
ERROR
è<< "»adƒv’t timeout,ƒv’ts: " << 
ev’ts
;

229 
buf
[1024] = {0};

230 
	`LOG
(
INFO
è<< "»ad fd: " << 
fd_
;

231 
rc
 = 
	`x_»cvby‹s
(
fd_
, 
buf
, 1024);

232 ià(
rc
 == -1) {

233 
	`LOG
(
ERROR
) << "recv msg failed";

237 ià(
msg_
 =ğ
buf
) {

238 
ok_
 = 
Œue
;

240 
ok_
 = 
çl£
;

244 
ev’t_loİ_
->
	`Stİ
();

245 
	}
}

247 
	gTCPCl›Á
::
	$Clo£
()

249 ià(
fd_
 != -1) {

250 
	`şo£
(
fd_
);

251 
fd_
 = -1;

253 
	}
}

257 şas 
	cMyFdEv’t
 {

258 
	mpublic
:

259 
	$MyFdEv’t
(è: 
	$ş›Á_
(&
loİ_
) {}

260 ~
	$MyFdEv’t
(è{
	}
}

262 
boŞ
 
In™
();

263 
Fš®ize
();

265 
boŞ
 
Echo
(cÚ¡ 
¡d
::
¡ršg
 &
msg
);

267 
	g´iv©e
:

268 
Ev’tLoİ
 
loİ_
;

269 
TCPS”v”
 
	g£rv”_
;

270 
TCPCl›Á
 
	gş›Á_
;

273 
boŞ
 
	gMyFdEv’t
::
	$In™
()

275 
boŞ
 
»t
 = 
£rv”_
.
	`In™
(60000);

276 ià(!
»t
) {

277 
	`LOG
(
ERROR
) << "init server failed";

278  
çl£
;

281 ià(!
£rv”_
.
	`S¹
()) {

282 
	`LOG
(
ERROR
) << "start server failed";

283  
çl£
;

286 
»t
 = 
ş›Á_
.
	`In™
(60000);

287 ià(!
»t
) {

288 
	`LOG
(
ERROR
) << "init client failed";

289  
çl£
;

292  
Œue
;

293 
	}
}

295 
	gMyFdEv’t
::
	$Fš®ize
()

297 
£rv”_
.
	`Stİ
();

298 
ş›Á_
.
	`Clo£
();

299 
	}
}

301 
boŞ
 
	gMyFdEv’t
::
Echo
(cÚ¡ 
¡d
::
¡ršg
 &
msg
)

303 
ş›Á_
.
Echo
(
msg
);

304 
	gloİ_
.
Run
();

305 
	gş›Á_
.
Clo£
();

307  
	gş›Á_
.
ok
();

311 şas 
	cMyTim”Ev’t
 {

312 
	mpublic
:

313 
	$MyTim”Ev’t
(è: 
	`ok_
(
çl£
)

314 , 
	`tim”_
(&
ev’t_loİ_
)

315 , 
	$wa™_ms_
(0) {}

316 ~
	$MyTim”Ev’t
(è{
	}
}

318 
boŞ
 
In™
();

319 
Fš®ize
();

321 
boŞ
 
Wa™
(
ušt64_t
 
wa™_ms
);

323 
	g´iv©e
:

324 
OnExpœe
();

325 
OnWa™
();

327 
	g´iv©e
:

328 
boŞ
 
ok_
;

329 
Time¡amp
 
	gt1_
;

330 
Time¡amp
 
	gt2_
;

332 
Ev’tLoİ
 
	gev’t_loİ_
;

333 
Tim”Ev’t
 
	gtim”_
;

334 
ušt64_t
 
	gwa™_ms_
;

337 
boŞ
 
	gMyTim”Ev’t
::
	$In™
()

339 
	`LOG
(
INFO
) << "Enter MyTimerEvent::Init";

341  
Œue
;

342 
	}
}

344 
	gMyTim”Ev’t
::
	$Fš®ize
()

346 
	`LOG
(
INFO
) << "Enter MyTimerEvent::Finalize";

347 
	}
}

349 
boŞ
 
	gMyTim”Ev’t
::
	$Wa™
(
ušt64_t
 
wa™_ms
)

351 
wa™_ms_
 = 
wa™_ms
;

352 
t1_
 = 
Time¡amp
::
	`Now
();

353 
tim”_
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
MyTim”Ev’t
::
OnWa™
, 
this
),

354 
TimeDiff
::
	`Mli£cÚds
(
wa™_ms
));

356 
ev’t_loİ_
.
	`Run
();

358  
ok_
;

359 
	}
}

361 
	gMyTim”Ev’t
::
	$OnWa™
()

363 
t2_
 = 
Time¡amp
::
	`Now
();

365 
	`LOG
(
INFO
) << "Enter OnWait";

367 
TimeDiff
 
td
 = 
t2_
 - 
t1_
;

369 
ušt64_t
 
u£d_time
 = 
td
.
	`ToMli£cÚds
();

370 ià(
u£d_time
 < 
wa™_ms_
 || used_time > wait_ms_ + 10) {

371 
	`LOG
(
ERROR
) << "waitimerƒrror";

372 
ok_
 = 
çl£
;

373 
ev’t_loİ_
.
	`Stİ
();

377 
	`LOG
(
INFO
è<< "tim” u£dime: " << 
u£d_time
 << "ms";

380 
ok_
 = 
Œue
;

381 
ev’t_loİ_
.
	`Stİ
();

386 
Time¡amp
 
t
 = Time¡amp::
	`Now
();

387 
t
 +ğ
TimeDiff
::
	`Mli£cÚds
(100);

390 
tim”_
.
	`ExpœesAt
(&
t
);

392 
	}
}

396 şas 
	cMyFdEv’tTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

397 
public
:

398 
vœtu®
 
S‘Up
();

399 
vœtu®
 
T—rDown
();

401 
	m´Ùeùed
:

402 
MyFdEv’t
 
my_ev’t_
;

405 
	gMyFdEv’tTe¡
::
	$S‘Up
()

407 
my_ev’t_
.
	`In™
();

408 
	}
}

410 
	gMyFdEv’tTe¡
::
	$T—rDown
()

412 
my_ev’t_
.
	`Fš®ize
();

413 
	}
}

416 
	$TEST_F
(
MyFdEv’tTe¡
, 
FDEv’tTe¡
)

418 
	`ASSERT_TRUE
(
my_ev’t_
.
	`Echo
("Hello world"));

419 
	}
}

423 şas 
	cMyTim”Ev’tTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

424 
public
:

425 
vœtu®
 
S‘Up
();

426 
vœtu®
 
T—rDown
();

428 
	m´Ùeùed
:

429 
MyTim”Ev’t
 
my_ev’t_
;

432 
	gMyTim”Ev’tTe¡
::
	$S‘Up
()

434 
my_ev’t_
.
	`In™
();

435 
	}
}

437 
	gMyTim”Ev’tTe¡
::
	$T—rDown
()

439 
my_ev’t_
.
	`Fš®ize
();

440 
	}
}

443 
	$TEST_F
(
MyTim”Ev’tTe¡
, 
Tim”Ev’tTe¡
)

446 
	`ASSERT_TRUE
(
my_ev’t_
.
	`Wa™
(100));

447 
	}
}

451 şas 
	cMySigÇlEv’t
 {

452 
	mpublic
:

453 
	$MySigÇlEv’t
(è: 
	`sig_ev_
(&
loİ_
), 
	$ok_
(
çl£
) {}

454 ~
	$MySigÇlEv’t
(è{
	}
}

456 
boŞ
 
In™
();

457 
Fš®ize
();

459 
boŞ
 
Wa™SigÇl
();

460 
boŞ
 
RemoveSigÇl
();

461 
boŞ
 
SigÇlTimeout
();

463 
	g´iv©e
:

464 
SigHªdËr
(
sig
);

466 
	g´iv©e
:

467 
Ev’tLoİ
 
loİ_
;

468 
SigÇlEv’t
 
	gsig_ev_
;

470 
boŞ
 
	gok_
;

473 
boŞ
 
	gMySigÇlEv’t
::
	$In™
()

475 
	`LOG
(
INFO
) << "Enter MySignalEvent::Init";

476  
Œue
;

477 
	}
}

479 
	gMySigÇlEv’t
::
	$Fš®ize
()

481 
	`LOG
(
INFO
) << "Enter MySignalEvent::Finalize";

482 
	}
}

484 
boŞ
 
	gMySigÇlEv’t
::
	$Wa™SigÇl
()

486 
boŞ
 
»t
 = 
sig_ev_
.
	`Add
(
SIGUSR1
);

487 ià(!
»t
) {

488 
	`LOG
(
ERROR
) << "add signal SIGUSR1 failed";

489  
çl£
;

492 
sig_ev_
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
MySigÇlEv’t
::
SigHªdËr
, 
this
, 
_1
));

494 
pid_t
 
pid
 = 
	`g‘pid
();

495 
	`LOG
(
INFO
è<< "Wa™ sigÇl,…id: " << 
pid
;

497 
rc
 = 
	`kl
(
pid
, 
SIGUSR1
);

498 ià(
rc
 == -1) {

499 
	`LOG
(
ERROR
è<< "£nd sigÇÈ”rÜ: " << 
	`¡»¼Ü
(
”ºo
);

500  
çl£
;

503 
loİ_
.
	`Run
();

506 ià(!
ok_
) {

507  
çl£
;

510 
ok_
 = 
çl£
;

512 
»t
 = 
sig_ev_
.
	`Remove
(
SIGUSR1
);

513 ià(!
»t
) {

514 
	`LOG
(
ERROR
) << "remove SIGUSR1 failed";

515  
çl£
;

518  
Œue
;

519 
	}
}

521 
boŞ
 
	gMySigÇlEv’t
::
	$RemoveSigÇl
()

523 
boŞ
 
»t
 = 
sig_ev_
.
	`Add
(
SIGUSR1
);

524 ià(!
»t
) {

525  
çl£
;

528 
»t
 = 
sig_ev_
.
	`Remove
(
SIGUSR1
);

529 ià(!
»t
) {

530 
	`LOG
(
ERROR
) << "remove sig SIGUSR1 failed";

531  
çl£
;

535 
pid_t
 
pid
 = 
	`g‘pid
();

536 
rc
 = 
	`kl
(
pid
, 
SIGUSR1
);

537 ià(
rc
 == -1) {

538 
	`LOG
(
ERROR
è<< "£nd sigÇÈSIGUSR1ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

539  
çl£
;

542 
loİ_
.
	`Run
();

544 
sig_ev_
.
	`Remove
(
SIGUSR1
);

546 ià(!
ok_
) {

547  
çl£
;

551  
Œue
;

552 
	}
}

554 
boŞ
 
	gMySigÇlEv’t
::
	$SigÇlTimeout
()

556 
boŞ
 
ok
 = 
sig_ev_
.
	`Add
(
SIGUSR1
);

557 ià(!
ok
) {

558  
çl£
;

561 
sig_ev_
.
	`AsyncWa™
(
boo¡
::
	`bšd
(&
MySigÇlEv’t
::
SigHªdËr
, 
this
, 
_1
),

562 
TimeDiff
::
	`Mli£cÚds
(100));

564 
	`u¦“p
(110);

566 
loİ_
.
	`Run
();

568 ià(!
ok_
) {

569 
	`LOG
(
ERROR
) << "signalimeoutƒrror";

570  
çl£
;

573 
ok_
 = 
çl£
;

577 
ok
 = 
sig_ev_
.
	`Remove
(
SIGUSR1
);

578 ià(!
ok
) {

579 
	`LOG
(
ERROR
) << "remove SIGUSR1 failed in SignalTimeout func";

580  
çl£
;

584  
Œue
;

585 
	}
}

587 
	gMySigÇlEv’t
::
	$SigHªdËr
(
sig
)

589 
sig
) {

591 
	`LOG
(
INFO
) << "signalimeout ok";

592 
ok_
 = 
Œue
;

594 
SIGUSR1
:

595 
	`LOG
(
INFO
) << "recv SIGUSR1";

596 
ok_
 = 
Œue
;

599 
	`LOG
(
ERROR
è<< "uÄegi¡”ed sigÇl: " << 
sig
;

600 
ok_
 = 
çl£
;

604 
loİ_
.
	`Stİ
();

605 
	}
}

609 şas 
	cMySigÇlEv’tTe¡
 : 
public
 
‹¡šg
::
Te¡
 {

610 
public
:

611 
vœtu®
 
S‘Up
();

612 
vœtu®
 
T—rDown
();

614 
	m´Ùeùed
:

615 
MySigÇlEv’t
 
my_ev’t_
;

618 
	gMySigÇlEv’tTe¡
::
	$S‘Up
()

620 
my_ev’t_
.
	`In™
();

621 
	}
}

623 
	gMySigÇlEv’tTe¡
::
	$T—rDown
()

625 
my_ev’t_
.
	`Fš®ize
();

626 
	}
}

629 
	$TEST_F
(
MySigÇlEv’tTe¡
, 
SigÇlEv’tTe¡
)

631 
	`ASSERT_TRUE
(
my_ev’t_
.
	`RemoveSigÇl
());

632 
	`ASSERT_TRUE
(
my_ev’t_
.
	`Wa™SigÇl
());

633 
	`ASSERT_TRUE
(
my_ev’t_
.
	`SigÇlTimeout
());

634 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/imsg.cc

4 
	~<glog/loggšg.h
>

5 
	~<boo¡/make_sh¬ed.hµ
>

6 
	~<ldd/Ãt/chªÃl.h
>

7 
	~"imsg.h
"

8 
	~"omsg.h
"

9 
	~"my_lddÃt.h
"

12 
boŞ
 
	gecho_
 = 
çl£
;

14 
	gMyEchoMsg
::
	$In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) {

15 
·ylßd_
 = 
»que¡
;

17 
	`LOG
(
INFO
è<< "MyEchoMsg::In™(): " << 
·ylßd_
.
	`body
().
	`ToSŒšg
();

18 
	`LOG
(
INFO
è<< " ExŒa: " << 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
();

21 ià(
REQUEST
 !ğ
·ylßd_
.
	`body
().
	`ToSŒšg
()

22 || 
EXTRAS
 !ğ
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
()) {

23 
	`LOG
(
ERROR
) << "unexpect body orƒxtra";

24 
ldd_Ãt_
->
	`£t_ok
(
çl£
);

29 
ldd_Ãt_
->
	`£t_ok
(
çl£
);

32 ià(
n_
 < 
couÁ_
) {

33 *
Ãxt
 = 
kEm™
;

35 *
Ãxt
 = 
kDÚe
;

37 
	}
}

39 
	gMyEchoMsg
::
	$Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) {

40 
	`LOG
(
INFO
) << "MyEchoMsg::Emit()";

41 
	`CHECK_LT
(
n_
, 
couÁ_
);

42 *
»¥Ú£
 = 
·ylßd_
;

44 ià(++
n_
 < 
couÁ_
) {

45 *
Ãxt
 = 
kEm™
;

47 *
Ãxt
 = 
kDÚe
;

49 
	}
}

51 
	gMyEchoMsg
::
	$DÚe
(
Code
* 
code
) {

52 
	`LOG
(
INFO
) << "MyEchoMsg::Done()";

53 *
code
 = 
couÁ_
;

55 ià(
echo_
) {

56 
	`LOG
(
INFO
) << "echo complete";

57 
ldd_Ãt_
->
	`ev’t_loİ
()->
	`Stİ
();

60 ià(!
echo_
) {

61 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

62 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
ldd_Ãt_
, 
·ylßd_
.
	`body
().
	`ToSŒšg
(),

63 
·ylßd_
.
	`exŒas
().
	`©
(1).
	`ToSŒšg
());

64 
	`chªÃl
()->
	`Po¡
(
msg
);

66 
echo_
 = 
Œue
;

68 
	}
}

70 
	gMyEchoMsg
::
	$Cªûl
() {

71 
	`LOG
(
INFO
) << "MyEchoMsg::Cancel()";

72 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/imsg.h

4 #iâdeà
IMSG_H_


5 
	#IMSG_H_


	)

7 
	~<ldd/Ãt/šcomšg_msg.h
>

9 
şass
 
	gMyLddN‘
;

11 
şass
 
	gMyEchoMsg
 : 
public
 
ldd
::
Ãt
::
Ty³dIncomšgMsg
<1333> {

12 
public
:

13 
MyEchoMsg
(
MyLddN‘
 *
ldd_Ãt
è: 
couÁ_
(1), 
n_
(0), 
ldd_Ãt_
(ldd_net) {}

14 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
);

15 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
);

16 
vœtu®
 
DÚe
(
Code
* 
code
);

17 
vœtu®
 
Cªûl
();

18 
	g´iv©e
:

19 
size_t
 
couÁ_
;

20 
size_t
 
	gn_
;

21 
Paylßd
 
	g·ylßd_
;

23 
MyLddN‘
 *
	gldd_Ãt_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/lddnet_test.cc

4 
	~<glog/loggšg.h
>

5 
	~<g‹¡/g‹¡.h
>

7 
	~"my_lddÃt.h
"

9 şas 
	cMyLddN‘Te¡
 : 
public
 
‹¡šg
::
Te¡
 {

10 
public
:

11 
vœtu®
 
S‘Up
();

12 
vœtu®
 
T—rDown
();

14 
	m´Ùeùed
:

15 
MyLddN‘
 
my_ldd_Ãt_
;

18 
	gMyLddN‘Te¡
::
	$S‘Up
()

20 
my_ldd_Ãt_
.
	`In™
();

21 
	}
}

23 
	gMyLddN‘Te¡
::
	$T—rDown
()

25 
my_ldd_Ãt_
.
	`Fš®ize
();

26 
	}
}

28 
	$TEST_F
(
MyLddN‘Te¡
, 
LddN‘Te¡
)

30 
	`ASSERT_TRUE
(
my_ldd_Ãt_
.
	`Echo
());

31 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/my_lddnet.cc

4 
	~<glog/loggšg.h
>

5 
	~<ldd/Ãt/chªÃl.h
>

6 
	~<ldd/Ãt/’dpošt.h
>

8 
	~"imsg.h
"

9 
	~"omsg.h
"

10 
	~"my_lddÃt.h
"

12 cÚ¡ 
	g¡d
::
¡ršg
 
REQUEST
 = "This ishe„equest";

13 cÚ¡ 
	g¡d
::
¡ršg
 
EXTRAS
 = "This isheƒxtra";

15 cÚ¡ 
	g¡d
::
¡ršg
 
SERVER_HOST
 = "localhost";

16 cÚ¡ 
	gSERVER_PORT
 = 60000;

18 cÚ¡ 
	gPULSE
 = 1000;

19 cÚ¡ 
	gCONNECT
 = 10;

20 cÚ¡ 
	gRESOLVE
 = 10;

23 
NÙifyCÚÃùed
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

24 
LOG
(
INFO
è<< "CÚÃùed " << 
c
->
³”_’dpošt
().
ToSŒšg
();

27 
NÙifyCÚÃùšg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

28 
LOG
(
INFO
è<< "CÚÃùšg " << 
c
->
³”_’dpošt
().
ToSŒšg
();

31 
NÙifyClo£d
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
>& 
c
) {

32 
LOG
(
INFO
è<< "Clo£d " << 
c
->
³”_’dpošt
().
ToSŒšg
();

35 
boŞ
 
	gMyLddN‘
::
	$In™
()

38 
ldd
::
Ãt
::
Endpošt
 
	`loÿl
(
SERVER_PORT
);

39 ià(!
li¡’”_
.
	`O³n
(
loÿl
)) {

40 
	`LOG
(
ERROR
è<< "Li¡’ oÀ" << 
loÿl
.
	`ToSŒšg
() << " failed";

41  
çl£
;

44 
ldd
::
Ãt
::
S”v”
::
O±iÚs
 
so
;

45 
so
.
pul£_š‹rv®
 = 1000;

46 
so
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

47 
so
.
nÙify_şo£d
 = 
NÙifyClo£d
;

49 
£rv”_
.
	`»£t
(
Ãw
 
ldd
::
Ãt
::
	`S”v”
(
so
));

50 ià(!
£rv”_
->
	`S¹
(&
li¡’”_
)) {

51 
	`LOG
(
ERROR
) << "Start on†istener failed";

52  
çl£
;

55 
£rv”_
->
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
this
);

58 
ldd
::
Ãt
::
Cl›Á
::
O±iÚs
 
İtiÚs
;

59 
İtiÚs
.
pul£_š‹rv®
 = 
PULSE
;

60 
İtiÚs
.
cÚÃù_timeout
 = 
CONNECT
;

61 
İtiÚs
.
»sŞve_timeout
 = 
RESOLVE
;

62 
İtiÚs
.
nÙify_cÚÃùed
 = 
NÙifyCÚÃùed
;

63 
İtiÚs
.
nÙify_cÚÃùšg
 = 
NÙifyCÚÃùšg
;

64 
İtiÚs
.
nÙify_şo£d
 = 
NÙifyClo£d
;

67 
ş›Á_
.
	`»£t
(
Ãw
 
ldd
::
Ãt
::
	`Cl›Á
(
İtiÚs
));

68 
ş›Á_
->
Regi¡”IncomšgMsg
<
MyEchoMsg
>(
this
);

70  
Œue
;

71 
	}
}

73 
	gMyLddN‘
::
	$Fš®ize
()

75 
	`LOG
(
INFO
) << "Enter Finalize";

76 
	}
}

78 
boŞ
 
	gMyLddN‘
::
	$Echo
()

81 
boo¡
::
sh¬ed_±r
<
ldd
::
Ãt
::
ChªÃl
> 
c
 = 
ş›Á_
->
	`C»©e
(

82 &
loİ_
, 
SERVER_HOST
, 
SERVER_PORT
);

85 
boo¡
::
sh¬ed_±r
<
MyEm™Msg
> 
msg
 =

86 
boo¡
::
make_sh¬ed
<
MyEm™Msg
>(
this
, 
REQUEST
, 
EXTRAS
);

87 
c
->
	`Po¡
(
msg
, 
ldd
::
ut
::
TimeDiff
::
	`SecÚds
(100), 
Œue
);

89 
loİ_
.
	`Run
();

91  
ok_
;

92 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/my_lddnet.h

4 
	~<ldd/Ãt/ş›Á.h
>

5 
	~<ldd/Ãt/£rv”.h
>

6 
	~<ldd/Ãt/ev’t_loİ.h
>

7 
	~<ldd/Ãt/li¡’”.h
>

9 cÚ¡ 
¡d
::
¡ršg
 
REQUEST
;

10 cÚ¡ 
¡d
::
¡ršg
 
EXTRAS
;

12 şas 
	cMyLddN‘
 {

13 
	mpublic
:

14 
	$MyLddN‘
(è: 
	`li¡’”_
(&
loİ_
), 
	$ok_
(
Œue
) {}

15 ~
	$MyLddN‘
(è{
	}
}

17 
boŞ
 
In™
();

18 
Fš®ize
();

20 
boŞ
 
Echo
();

22 
	$£t_ok
(
boŞ
 
ok
è{ 
ok_
 = ok; 
	}
}

24 
	gldd
::
Ãt
::
Ev’tLoİ
 *
	$ev’t_loİ
(è{  &
loİ_
; 
	}
}

26 
	g´iv©e
:

27 
ldd
::
Ãt
::
Ev’tLoİ
 
loİ_
;

28 
	gldd
::
Ãt
::
Li¡’”
 
li¡’”_
;

29 
	gboo¡
::
scİed_±r
<
ldd
::
Ãt
::
S”v”
> 
£rv”_
;

30 
	gboo¡
::
scİed_±r
<
ldd
::
Ãt
::
Cl›Á
> 
ş›Á_
;

32 
boŞ
 
	gok_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/omsg.cc

4 
	~<glog/loggšg.h
>

5 
	~"omsg.h
"

6 
	~"my_lddÃt.h
"

8 
boŞ
 
	gMyEm™Msg
::
In™
(
Paylßd
* 
»que¡
,

9 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

10 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
) {

11 
LOG
(
INFO
è<< "OutMsg S’d: " << 
¡r_
;

12 
	gldd
::
Ãt
::
Bufãr
 
buf
(
¡r_
);

13 
	g»que¡
->
S‘Body
(
buf
);

14 
LOG
(
INFO
è<< "XXX " << 
	g¡r2_
;

15 
CHECK
(
»que¡
->
S‘ExŒa
(1, 
ldd
::
Ãt
::
Bufãr
(
¡r2_
)));

16  
	gŒue
;

19 
boŞ
 
	gMyEm™Msg
::
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

20 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
) {

21 
LOG
(
INFO
è<< "OutMsg Recv: " << 
»¥Ú£
.
body
().
ToSŒšg
();

22 
LOG
(
INFO
è<< " ExŒa:" << 
	g»¥Ú£
.
exŒas
().
©
(1).
ToSŒšg
();

24 ià(
	g»¥Ú£
.
body
().
ToSŒšg
(è!ğ
REQUEST


25 || 
»¥Ú£
.
exŒas
().
©
(1).
ToSŒšg
(è!ğ
EXTRAS
) {

26 
LOG
(
ERROR
) << "unexpected„esponse orƒxtras";

27 
	gldd_Ãt_
->
£t_ok
(
çl£
);

30  
	gŒue
;

33 
	gMyEm™Msg
::
	$DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
) {

34 
	`LOG
(
INFO
è<< "OutMsg DÚe: " << 
»suÉ
.
	`ToSŒšg
(è<< " " <<„esuÉ.
	`code
();

35 
	}
}

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/omsg.h

4 #iâdeà
OMSG_H_


5 
	#OMSG_H_


	)

7 
	~<ldd/Ãt/outgošg_msg.h
>

9 
şass
 
	gMyLddN‘
;

11 
şass
 
	gMyEm™Msg
 : 
public
 
ldd
::
Ãt
::
Ty³dOutgošgMsg
<1333> {

12 
public
:

13 
MyEm™Msg
(
MyLddN‘
 *
ldd_Ãt
,

14 cÚ¡ 
¡d
::
¡ršg
& 
¡r
,

15 cÚ¡ 
¡d
::
¡ršg
& 
¡r2
)

16 : 
ldd_Ãt_
(
ldd_Ãt
),

17 
¡r_
(
¡r
),

18 
¡r2_
(
¡r2
) {}

20 
boŞ
 
In™
(
Paylßd
* 
»que¡
,

21 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
,

22 
ldd
::
ut
::
TimeDiff
* 
dÚe_timeout
);

23 
boŞ
 
Recv
(cÚ¡ 
Paylßd
& 
»¥Ú£
,

24 
ldd
::
ut
::
TimeDiff
* 
»cv_timeout
);

25 
DÚe
(cÚ¡ 
ResuÉ
& 
»suÉ
);

27 
	g´iv©e
:

28 
MyLddN‘
 *
ldd_Ãt_
;

29 
	g¡d
::
¡ršg
 
¡r_
;

30 
	g¡d
::
¡ršg
 
¡r2_
;

	@/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/x_socket.h

1 #iâdeà
_X_SOCKET_H__


2 
	#_X_SOCKET_H__


	)

4 
	#TTL_VALUE
 255

	)

6 
	#SOCK_TYPE_NULL
 0

	)

7 
	#SOCK_TYPE_UNICAST_TCP_SERVER
 1

	)

8 
	#SOCK_TYPE_UNICAST_TCP_CLIENT
 2

	)

9 
	#SOCK_TYPE_UNICAST_UDP_SERVER
 3

	)

10 
	#SOCK_TYPE_UNICAST_UDP_CLIENT
 4

	)

11 
	#SOCK_TYPE_FILEOUTPUT
 5

	)

12 
	#SOCK_TYPE_THIS_LINK
 6

	)

14 
	#MAX_LISTEN_QUEUE
 5

	)

16 #ifdeà
__ılu¥lus


20 
x_£t_sock_deçuÉ_İt
(
s
);

21 
x_£t_sock_no_d–ay
(
s
);

23 
x_ü—‹_tı_£rv”
(cÚ¡ *
l
, 
ÍÜt
);

24 
x_acû±
(
li¡’_fd
, *

, *
pÜt
);

25 
x_ü—‹_tı_ş›Á
(cÚ¡ *
r
, 
½Üt
);

26 
x_şo£
(
fd
);

27 
x_£nd
(
fd
, *
buf
, 
Ën
);

28 
x_»cv
(
fd
, *
buf
, 
Ën
);

29 
x_»cvby‹s
(
fd
, *
buf
, 
Ën
);

30 
x_»cv_w™h_timeout
(
fd
, *
buf
, 
Ën
, 
timeout
);

33 #ifdeà
__ılu¥lus


	@address.h

4 #iâdeà
LDD_NET_ADDRESS_H_


5 
	#LDD_NET_ADDRESS_H_


	)

7 
	~<Ãtš‘/š.h
>

8 
	~<¡ršg
>

9 
	~<boo¡/İ”©Üs.hµ
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
şass
 
	gAdd»ss
 : 
boo¡
::
equ®™y_com·¿bË
<
Add»ss
> {

15 
public
:

16 
	eFamy
 {

17 
V4
 = 
AF_INET
,

18 
	gV6
 = 
AF_INET6
,

21 
Add»ss
(
Famy
 
çmy
 = 
V4
);

22 
Add»ss
(cÚ¡ 
š_addr
& 
addr
);

23 
Add»ss
(cÚ¡ 
š6_addr
& 
addr
);

24 
Add»ss
(
ušt32_t
 
addr
);

26 
Add»ss
 
FromSŒšg
(cÚ¡ 
¡d
::
¡ršg
& 
s
, 
Famy
 
çmy
 = 
V4
);

27 
Add»ss
 
Any
(
Famy
 
çmy
 = 
V4
);

28 
Add»ss
 
Loİback
(
Famy
 
çmy
 = 
V4
);

30 
Famy
 
çmy
(ècÚ¡ {  
	gçmy_
; }

31 
boŞ
 
IsUn¥ecif›d
() const;

32 
boŞ
 
IsLoİback
() const;

33 
boŞ
 
IsV4
(ècÚ¡ {  
	gçmy_
 =ğ
V4
; }

34 
boŞ
 
IsV6
(ècÚ¡ {  
	gçmy_
 =ğ
V6
; }

35 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

38 cÚ¡ 
	gš_addr
& 
ToV4
() const;

39 
ušt32_t
 
ToU32
() const;

40 
boŞ
 
IsCÏssA
() const;

41 
boŞ
 
IsCÏssB
() const;

42 
boŞ
 
IsCÏssC
() const;

43 
boŞ
 
IsMuÉiÿ¡
() const;

46 cÚ¡ 
	gš6_addr
& 
ToV6
() const;

48 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Add»ss
& 
rhs
) const;

49 
	g´iv©e
:

51 
š_addr
 
v4
;

52 
š6_addr
 
	gv6
;

53 } 
	gaddr_
;

54 
Famy
 
	gçmy_
;

	@backtrace.h

4 #iâdeà
__BACK_TRACE__


5 
	#__BACK_TRACE__


	)

7 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

9 
dump_Œaû
(cÚ¡ 
¡d
::
¡ršg
 &
func_Çme
);

	@buffer.h

1 #iâdeà
LDD_NET_BUFFER_H_


2 
	#LDD_NET_BUFFER_H_


	)

4 
	~<¡ršg
>

5 
	~<m­
>

6 
	~<boo¡/sh¬ed_±r.hµ
>

7 
	~<ldd/ut/©omic.h
>

9 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

11 şas 
	cBufãr
 {

12 
	gpublic
:

13 
Bufãr
();

14 
ex¶ic™
 
Bufãr
(
size_t
 
size
);

15 
ex¶ic™
 
Bufãr
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

16 
ex¶ic™
 
Bufãr
(cÚ¡ * 
p
, 
size_t
 
l
);

18 
Bufãr
(cÚ¡ Bufã¸&
bufãr
);

21 ~
Bufãr
();

23 
Re£t
(
size_t
 
size
);

24 
Re£t
(cÚ¡ 
¡d
::
¡ršg
& 
s
);

25 
Re£t
();

27 
boŞ
 
IsEm±y
(ècÚ¡ {  
size
() == 0u; }

29 * 
d©a
(è{  
	gd©a_
.
g‘
(); }

30 cÚ¡ * 
d©a
(ècÚ¡ {  
	gd©a_
.
g‘
(); }

31 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

33 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

36 
Shršk
(
size_t
 
n
);

39 
ReSize
(
size_t
 
n
);

40 * 
±r
(è{  
	gd©a_
.
g‘
(); }

41 cÚ¡ * 
±r
(ècÚ¡ {  
	gd©a_
.
g‘
(); }

42 
size_t
 
Ën
(ècÚ¡ {  
	gsize_
; }

44 
	g´iv©e
:

45 
boo¡
::
sh¬ed_±r
<> 
d©a_
;

46 
size_t
 
	gsize_
;

49 #ifdeà
RES_COUNTER


50 
	g´iv©e
:

51 
ä›nd
 
şass
 
St
;

52 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

53 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

54 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

55 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

59 
	g¡d
::
	tm­
<
	tušt8_t
, 
	tBufãr
> 
	tBufãrM­
;

	@client.h

4 #iâdeà
LDD_NET_CLIENT_H_


5 
	#LDD_NET_CLIENT_H_


	)

7 
	~<boo¡/funùiÚ.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<ldd/Ãt/šcomšg_msg_»gi¡ry.h
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 
şass
 
	gEv’tLoİ
;

15 
şass
 
	gEndpošt
;

16 
şass
 
	gChªÃl
;

18 şas 
	cCl›Á
 : 
public
 
IncomšgMsgRegi¡ry
 {

19 
public
:

20 
şass
 
Im¶
;

21 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

22 
	sO±iÚs
 {

25 
	gpul£_š‹rv®
;

29 
boŞ
 
	gpul£_»Ïxed_checkšg
;

33 
boŞ
 
	gpul£_Ïzy_em™tšg
;

37 
	g»sŞve_timeout
;

41 
	gcÚÃù_timeout
;

45 
	gcÚÃù_d–ay_couÁ
;

49 
	gcÚÃù_d–ay_time_š™Ÿl
;

53 
	gcÚÃù_d–ay_time_fš®
;

58 
	gcÚÃù_d–ay_time_¡•
;

62 
NÙif›r
 
	gnÙify_cÚÃùed
;

66 
NÙif›r
 
	gnÙify_cÚÃùšg
;

70 
NÙif›r
 
	gnÙify_şo£d
;

74 
	gsock‘_»ad_bufãr_size
;

76 
O±iÚs
();

79 
ex¶ic™
 
Cl›Á
(cÚ¡ 
O±iÚs
& 
İtiÚs
);

80 ~
Cl›Á
();

82 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

83 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

84 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

85 cÚ¡ 
Endpošt
& 
»mÙe
);

87 cÚ¡ 
	gO±iÚs
& 
İtiÚs
() const;

88 
	g´iv©e
:

89 
Im¶
 *
im¶_
;

	@event.h

4 #iâdeà
LDD_NET_EVENT_H_


5 
	#LDD_NET_EVENT_H_


	)

7 
	~<boo¡/nÚcİyabË.hµ
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<ldd/ut/time¡amp.h
>

10 
	~<ldd/ut/time_diff.h
>

12 
Çme¥aû
 
	gldd
 {

13 
Çme¥aû
 
	gÃt
 {

15 
şass
 
	gEv’tLoİ
;

17 şas 
	cFdEv’t
 : 
boo¡
::
nÚcİyabË
 {

18 
public
:

19 
şass
 
Im¶
;

20 
	eTy³
 {

21 
	gkR—dabË
 = 1,

22 
	gkWr™abË
 = 2,

24 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

25 
FdEv’t
(
Ev’tLoİ
* 
loİ
);

26 ~
FdEv’t
();

27 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
);

28 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

29 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

30 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

31 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

32 
Cªûl
();

33 
	g´Ùeùed
:

34 
Im¶
* 
im¶_
;

37 şas 
	cTim”Ev’t
 : 
boo¡
::
nÚcİyabË
 {

38 
public
:

39 
şass
 
Im¶
;

40 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

41 
Tim”Ev’t
(
Ev’tLoİ
* 
loİ
);

42 ~
Tim”Ev’t
();

44 
boŞ
 
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
);

45 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

46 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

47 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

48 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

49 
Cªûl
();

50 
	g´iv©e
:

51 
Im¶
* 
im¶_
;

54 şas 
	cSigÇlEv’t
 : 
boo¡
::
nÚcİyabË
 {

55 
public
:

56 
şass
 
Im¶
;

57 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

58 
SigÇlEv’t
(
Ev’tLoİ
* 
loİ
);

59 ~
SigÇlEv’t
();

61 
boŞ
 
Add
(
signo
);

62 
boŞ
 
Remove
(
signo
);

63 
boŞ
 
CË¬
();

65 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
);

66 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

67 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

68 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

69 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

70 
Cªûl
();

71 
	g´iv©e
:

72 
Im¶
* 
im¶_
;

	@event_loop.h

4 #iâdeà
LDD_NET_EVENT_LOOP_H_


5 
	#LDD_NET_EVENT_LOOP_H_


	)

7 
	~<ev’t2/ev’t.h
>

8 
	~<boo¡/nÚcİyabË.hµ
>

9 
	~<boo¡/funùiÚ.hµ
>

10 
	~<boo¡/scİed_±r.hµ
>

11 
	~<ldd/ut/©omic.h
>

12 
	~<ldd/ut/th»ad.h
>

14 
Çme¥aû
 
	gldd
 {

15 
Çme¥aû
 
	gÃt
 {

17 şas 
	cEv’tLoİ
 : 
´iv©e
 
boo¡
::
nÚcİyabË
 {

18 
public
:

19 
şass
 
Im¶
;

20 
	gboo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

21 
Ev’tLoİ
();

22 
ex¶ic™
 
Ev’tLoİ
(::
ev’t_ba£
 *
ba£
);

23 ~
Ev’tLoİ
();

25 
Run
();

26 
Stİ
();

27 
Aá”FÜk
();

29 
RunInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

30 
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

31 
ev’t_ba£
 *event_base();

32 
	g´iv©e
:

33 
ä›nd
 
şass
 
FdEv’t
;

34 
ä›nd
 
şass
 
	gSigÇlEv’t
;

35 
ä›nd
 
şass
 
	gTim”Ev’t
;

36 
ä›nd
 
şass
 
	gChªÃl
;

37 
ä›nd
 
şass
 
	gLi¡’”
;

38 
ä›nd
 
şass
 
	gS”v”
;

39 
ä›nd
 
şass
 
	gCl›Á
;

40 
Im¶
* 
	gim¶_
;

43 şas 
	cEv’tLoİTh»ad
 : 
´iv©e
 
boo¡
::
nÚcİyabË
 {

44 
public
:

45 
boo¡
::
	tfunùiÚ
<()> 
	tFunùÜ
;

46 
Ev’tLoİTh»ad
();

47 ~
Ev’tLoİTh»ad
();

49 
boŞ
 
S¹
(cÚ¡ 
FunùÜ
& 
´e
 = 
NULL
, cÚ¡ FunùÜ& 
po¡
 = NULL);

50 
Stİ
();

51 
Još
();

53 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
.
g‘
(); }

54 cÚ¡ 
	gut
::
Th»ad
* 
th»ad
(ècÚ¡ {  
th»ad_
.
g‘
(); }

55 
	g´iv©e
:

56 
Run
(cÚ¡ 
FunùÜ
& 
´e
, cÚ¡ FunùÜ& 
po¡
);

57 
	eS‹
 {

58 
	gkS¹šg
,

59 
	gkRuÂšg
,

60 
	gkStİpšg
,

61 
	gkJoššg
,

62 
	gkStİ³d
,

64 
	gboo¡
::
scİed_±r
<
Ev’tLoİ
> 
ev’t_loİ_
;

65 
	gboo¡
::
scİed_±r
<
ut
::
Th»ad
> 
th»ad_
;

66 
	gut
::
Atomic
<
S‹
> 
¡©e_
;

	@incoming_msg.h

1 #iâdeà
LDD_NET_INCOMING_MSG_H_


2 
	#LDD_NET_INCOMING_MSG_H_


	)

4 
	~<m­
>

5 
	~<boo¡/’abË_sh¬ed_äom_this.hµ
>

6 
	~<boo¡/nÚcİyabË.hµ
>

7 
	~"ldd/Ãt/·ylßd.h
"

8 
	~"ldd/Ãt/mes§ge.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gChªÃl
;

15 
şass
 
	gIncomšgMsg
 : 
public
 
boo¡
::
’abË_sh¬ed_äom_this
<
IncomšgMsg
>,

16 
´iv©e
 
	gboo¡
::
nÚcİyabË
 {

17 
public
:

18 
şass
 
Im¶
;

19 
	gldd
::
	tÃt
::
	tPaylßd
 Payload;

20 
	gldd
::
	tÃt
::
	tMes§geId
 
	tId
;

21 
	gldd
::
	tÃt
::
	tMes§geTy³
 
	tTy³
;

22 
	gldd
::
	tÃt
::
	tCode
 Code;

24 
	eAùiÚ
 { 
	gkWa™
, 
	gkEm™
, 
	gkDÚe
 };

26 
	gvœtu®
 ~
IncomšgMsg
();

27 
vœtu®
 
Ty³
 
ty³
() const = 0;

29 
Id
 
id
() const;

30 
boŞ
 
IsCªûËd
() const;

31 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
() const;

35 
NÙify
(
boŞ
 
dÚe
 = 
çl£
);

36 
	g´Ùeùed
:

37 
IncomšgMsg
();

39 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

41 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

43 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

45 
vœtu®
 
Cªûl
() = 0;

46 
	g´iv©e
:

47 
DoNÙify
(
boŞ
);

48 
Im¶
* 
	gim¶_
;

49 
ä›nd
 
şass
 
	gChªÃl
;

50 
ä›nd
 
şass
 
	gIncomšgReque¡
;

51 
ä›nd
 
şass
 
	gIncomšgCªûl
;

54 
	g‹m¶©e
 <
Mes§geTy³
 
	gN
>

55 şas 
	cTy³dIncomšgMsg
 : 
public
 
IncomšgMsg
 {

56 
public
:

57 cÚ¡ 
Ty³
 
kTy³
 = 
N
;

58 
Ty³
 
ty³
(ècÚ¡ {  
	gkTy³
; }

59 
	g´Ùeùed
:

60 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

61 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

62 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

63 
vœtu®
 
Cªûl
() {}

67 şas 
	cDyÇmicIncomšgMsg
 : 
public
 
IncomšgMsg
 {

68 
public
:

69 ~
DyÇmicIncomšgMsg
();

70 
£t_ty³
(
Ty³
 
ty³
);

71 
Ty³
 
ty³
(ècÚ¡ {  
	gty³_
; }

72 
	g´Ùeùed
:

73 
DyÇmicIncomšgMsg
(è: 
ty³_
(0) {}

74 
vœtu®
 
In™
(cÚ¡ 
Paylßd
& 
»que¡
, 
AùiÚ
* 
Ãxt
) = 0;

75 
vœtu®
 
Em™
(
Paylßd
* 
»¥Ú£
, 
AùiÚ
* 
Ãxt
) = 0;

76 
vœtu®
 
DÚe
(
Code
* 
code
) = 0;

77 
vœtu®
 
Cªûl
() {}

78 
	g´iv©e
:

79 
Ty³
 
ty³_
;

82 
	g´iv©e
:

83 
ä›nd
 
şass
 
St
;

85 
	sNextF»e
 {

86 
NextF»e
()

87 : 
Ãxt_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>()),

88 
ä“_id_
(
Ãw
 
ut
::
Atomic
<
ušt64_t
>())

89 { *
Ãxt_id_
 = 0; *
	gä“_id_
 = 0; }

90 ~
NextF»e
() {}

92 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
Ãxt_id_
;

93 
	gboo¡
::
sh¬ed_±r
<
ut
::
Atomic
<
ušt64_t
> > 
ä“_id_
;

96 
	g¡d
::
m­
<
Ty³
, 
	gNextF»e
> 
	g¡©_
;

98 
	g¡d
::
	tm­
<
	tTy³
, 
	tNextF»e
>::
	t™”©Ü
 
	tSTAT_IT
;

100 
Inc
(
Ty³
 
ty³
);

101 
Dec
(
Ty³
 
ty³
);

	@internal/channel_impl.h

4 #iâdeà
LDD_INTERNAL_CHANNEL_IMPL_H_


5 
	#LDD_INTERNAL_CHANNEL_IMPL_H_


	)

7 
	~<boo¡/ªy.hµ
>

8 
	~<boo¡/funùiÚ.hµ
>

9 
	~<boo¡/scİed_±r.hµ
>

10 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

11 
	~<boo¡/±r_cÚš”/±r_deque.hµ
>

13 
	~"ldd/Ãt/šcomšg_msg_»gi¡ry.h
"

14 
	~"ldd/Ãt/chªÃl.h
"

15 
	~"ldd/Ãt/ev’t.h
"

16 
	~"ldd/Ãt/’dpošt.h
"

17 
	~"ldd/Ãt/£rv”.h
"

18 
	~"ldd/Ãt/ş›Á.h
"

19 
	~"£rv”_im¶.h
"

20 
	~"ş›Á_im¶.h
"

21 
	~"´ÙocŞ.h
"

22 
	~"sk.h
"

25 
Çme¥aû
 
	gldd
 {

26 
Çme¥aû
 
	gÃt
 {

28 
şass
 
	gOutgošgPack‘
;

29 
şass
 
	gPul£Em™‹r
;

30 
şass
 
	gPul£Check”
;

31 
şass
 
	gOutgošgChªÃl
;

33 şas 
	cEv’tCtx
 {

34 
	gpublic
:

35 
Ev’tCtx
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
> &
owÃr


36 , 
ChªÃl
::
Im¶
 *
im¶
)

37 : 
owÃr_
(
owÃr
)

38 , 
im¶_
(
im¶
)

40 #ifdeà
RES_COUNTER


41 
	gÃxt_id_
++;

45 ~
Ev’tCtx
() {

46 #ifdeà
RES_COUNTER


47 
	gä“_id_
++;

51 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr_
;

52 
	gChªÃl
::
Im¶
 *
im¶_
;

54 #ifdeà
RES_COUNTER


55 
	g´iv©e
:

56 
ä›nd
 
şass
 
St
;

57 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

58 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

59 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

60 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

64 şas 
	cDnsCtx
 {

65 
	gpublic
:

66 
DnsCtx
(
OutgošgChªÃl
 *
oc


67 , cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
> &
owÃr


68 , 
evdns_ba£
 *
dns_ba£
)

69 : 
oc_
(
oc
)

70 , 
owÃr_
(
owÃr
)

71 , 
dns_ba£_
(
dns_ba£
)

73 #ifdeà
RES_COUNTER


74 
	gÃxt_id_
++;

77 ~
DnsCtx
() {

78 #ifdeà
RES_COUNTER


79 
	gä“_id_
++;

83 
OutgošgChªÃl
 *
	goc_
;

84 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr_
;

85 
evdns_ba£
 *
	gdns_ba£_
;

87 #ifdeà
RES_COUNTER


88 
	g´iv©e
:

89 
ä›nd
 
şass
 
St
;

90 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

91 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

92 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

93 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

97 şas 
	cChªÃl
::
Im¶
 {

98 
public
:

99 
boo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

100 
ChªÃl
 
	tOwÃr
;

101 
	gChªÃl
::
	tTy³
 Type;

104 
	gkR—dH—d”
=0,

105 
	gkR—dBody
,

109 
Im¶
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
);

110 
	gvœtu®
 ~
Im¶
();

112 
vœtu®
 
Ty³
 
ty³
() const = 0;

113 
vœtu®
 
O³n
() = 0;

114 
Clo£
();

115 
Clo£Sock‘
();

116 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
() const = 0;

118 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const = 0;

119 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
; }

120 
ev’t_ba£
 *event_base();

121 
S‹
 
¡©e
(ècÚ¡ {  
	g¡©e_
; }

122 
£t_¡©e
(
S‹
 
¡©e
è{ 
	g¡©e_
 = state; }

123 
£t_sock‘
(
sock‘
);

125 
	gH—d”
::
P¬£r
 
h—d”
(è{  
H—d”
::P¬£r(
h—d”_
->
d©a
()); }

127 cÚ¡ 
	gEndpošt
& 
£lf_’dpošt
(ècÚ¡ {  
	g£lf_’dpošt_
; }

128 cÚ¡ 
	gEndpošt
& 
³”_’dpošt
(ècÚ¡ {  
	g³”_’dpošt_
; }

129 
ušt64_t
 
id
(ècÚ¡ {  
	gid_
; }

131 
Po¡
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
OutgošgMsg
>& 
mes§ge
,

132 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

134 
boŞ
 
AddIncomšgMsg
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
IncomšgMsg
>& 
šcomšg_msg
);

135 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
G‘IncomšgMsg
(

136 
št32_t
 
id
, 
boŞ
 
»move
 = 
çl£
);

137 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
G‘OutgošgMsg
(

138 
št32_t
 
id
, 
boŞ
 
»move
 = 
çl£
);

139 
Wr™e
(
OutgošgPack‘
* 
·ck‘
);

141 
sock‘
(è{  
	gsock‘_
; }

142 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
owÃr
(è{  
owÃr_
->
sh¬ed_äom_this
(); }

144 
št32_t
 
NextOutgošgMsgId
() {

145  (++
	goutgošg_msg_id_
) & 0x7fffffff;

148 
£t_cÚ‹xt
(cÚ¡ 
boo¡
::
ªy
& 
cÚ‹xt
)

149 { 
cÚ‹xt_
 = 
cÚ‹xt
; }

151 cÚ¡ 
	gboo¡
::
ªy
& 
cÚ‹xt
() const

152 {  
cÚ‹xt_
; }

154 
vœtu®
 
OnPšg
() = 0;

155 
vœtu®
 
OnPÚg
() = 0;

156 
vœtu®
 
OnE¼Ü
() = 0;

157 
vœtu®
 
OnClo£
() = 0;

158 
vœtu®
 
DoPul£
() = 0;

159 
vœtu®
 
OnCÚÃù
(
”rÜ
) = 0;

161 
OnIncomšgPack‘
();

162 
OnOutgošgPack‘
();

163 
OnPul£Faed
();

165 
	g´Ùeùed
:

166 
ä›nd
 
şass
 
Pack‘R—d”
;

167 
boŞ
 
FlEndpošts
(boŞ 
»mÙe
);

168 
NÙify
(cÚ¡ 
NÙif›r
& 
nÙif›r
);

169 
CË¬IncomšgMsg
();

170 
CË¬OutgošgMsg
();

172 
AddEv’t
(
æag
è{ 
S‘Ev’t
(
ev’ts_
 | flag); }

173 
D–Ev’t
(
æag
è{ 
S‘Ev’t
(
ev’ts_
 & ~flag); }

174 
S‘Ev’t
(
ev’ts
);

176 
OnR—d
();

177 
OnWr™e
();

178 
R—dH—d”
();

179 
R—dBody
();

180 
ProûssPack‘
();

181 
DoWr™e
();

183 
Ev’tNÙify
(
fd
, 
wh©
, *
¬g
);

185 
R—lWr™e
();

187 
	gsock‘_
;

188 
R—dTask
 
	g»ad_h—d”_sk_
;

189 
R—dTask
 
	g»ad_body_sk_
;

190 
Wr™eTask
 
	gwr™e_sk_
;

191 
Ev’tCtx
 *
	gev’t_ùx_
;

193 
	g´iv©e
:

194 
¡d
::
	tm­
<
	tšt32_t
, 
	tboo¡
::
	tsh¬ed_±r
<
	tOutgošgMsg
> > 
	tOutgošgMsgM­
;

195 
	g¡d
::
	tm­
<
	tšt32_t
, 
	tboo¡
::
	tsh¬ed_±r
<
	tIncomšgMsg
> > 
	tIncomšgMsgM­
;

197 
OwÃr
* 
	gowÃr_
;

198 
Ev’tLoİ
* 
	gev’t_loİ_
;

199 
S‹
 
	g¡©e_
;

201 
	gev’ts_
;

202 
	g»ad_¡©e_
;

203 
ev’t
 *
	gsock‘_ev_
;

205 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
h—d”_
;

206 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
·ck‘_
;

207 
	g·ck‘_size_
;

209 
IncomšgMsgM­
 
	gimsgs_
;

210 
OutgošgMsgM­
 
	gomsgs_
;

212 
	gboo¡
::
±r_deque
<
OutgošgPack‘
> 
³ndšg_·ck‘s_
;

213 
	gboo¡
::
±r_veùÜ
<
OutgošgPack‘
> 
wr™šg_·ck‘s_
;

214 
	g¡d
::
deque
<
boo¡
::
sh¬ed_±r
<
Bufãr
> > 
wr™šg_bufãrs_
;

216 
št32_t
 
	goutgošg_msg_id_
;

218 
	gboo¡
::
ªy
 
cÚ‹xt_
;

219 
ušt64_t
 
	gid_
;

221 
	g´Ùeùed
:

222 
Endpošt
 
£lf_’dpošt_
;

223 
Endpošt
 
	g³”_’dpošt_
;

224 
	gboo¡
::
scİed_±r
<
Pul£Em™‹r
> 
pul£_em™‹r_
;

225 
	gboo¡
::
scİed_±r
<
Pul£Check”
> 
pul£_check”_
;

227 
	g´iv©e
:

228 
ut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

231 şas 
	cIncomšgChªÃl
 : 
public
 
ChªÃl
::
Im¶
 {

232 
ChªÃl
::
	tIm¶
 
	tSu³r
;

233 
	gpublic
:

234 
ChªÃl
::
	tTy³
 Type;

235 
IncomšgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

236 
S”v”
::
Im¶
* 
£rv”
);

237 
	gvœtu®
 ~
IncomšgChªÃl
();

238 
vœtu®
 
Ty³
 
ty³
(ècÚ¡ {  
	gChªÃl
::
kIncomšg
; }

239 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const;

241 
vœtu®
 
O³n
();

242 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
(ècÚ¡ {  
	g£rv”_
->
owÃr
(); }

243 
	g´iv©e
:

244 
In™Pul£
();

245 
vœtu®
 
OnPšg
();

246 
vœtu®
 
OnPÚg
();

247 
vœtu®
 
OnE¼Ü
();

248 
vœtu®
 
OnClo£
();

249 
vœtu®
 
DoPul£
();

250 
vœtu®
 
OnCÚÃù
(
”rÜ
) {}

252 cÚ¡ 
	gS”v”
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
£rv”_
->options(); }

253 
	g´iv©e
:

254 
S”v”
::
Im¶
* 
£rv”_
;

256 #ifdeà
RES_COUNTER


257 
	g´iv©e
:

258 
ä›nd
 
şass
 
St
;

259 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

260 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

261 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

262 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

266 şas 
	cOutgošgChªÃl
 : 
public
 
ChªÃl
::
Im¶
 {

267 
public
:

268 
ChªÃl
::
	tIm¶
 
	tSu³r
;

269 
	gChªÃl
::
	tTy³
 Type;

272 
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

273 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

274 
OutgošgChªÃl
(
OwÃr
* 
owÃr
, 
Ev’tLoİ
* 
ev’t_loİ
,

275 
Cl›Á
::
Im¶
* 
ş›Á
, cÚ¡ 
Endpošt
& 
»mÙe
);

276 
	gvœtu®
 ~
OutgošgChªÃl
();

278 
vœtu®
 
Ty³
 
ty³
(ècÚ¡ {  
	gChªÃl
::
kOutgošg
; }

279 
vœtu®
 
	g¡d
::
¡ršg
 
Çme
() const;

281 
vœtu®
 
O³n
();

282 
vœtu®
 
IncomšgMsgRegi¡ry
* 
»gi¡ry
(ècÚ¡ {  
	gş›Á_
->
owÃr
(); }

283 
	g´iv©e
:

284 
In™Pul£
();

285 
vœtu®
 
OnPšg
();

286 
vœtu®
 
OnPÚg
();

287 
vœtu®
 
OnE¼Ü
();

288 
vœtu®
 
OnClo£
();

289 
vœtu®
 
DoPul£
();

291 
DoCÚÃù
();

292 
RecÚÃù
();

293 
ResŞve
();

294 
OnResŞveTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
);

295 
OnResŞve
(
”rcode


296 , 
evut_addršfo
 *
addr


297 , *
±r
);

298 
DoResŞve
(
”rcode
, 
evut_addršfo
 *
addr
);

299 
CÚÃù
();

300 
OnCÚÃùTimeout
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
o
);

301 
vœtu®
 
OnCÚÃù
(
”rÜ
);

303 
AsyncCÚÃù
(cÚ¡ 
¡d
::
¡ršg
 &
ho¡


304 , 
ušt16_t
 
pÜt


305 , 
timeout
);

307 
D–ayCÚÃù
();

308 
DoD–ayCÚÃù
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>&);

310 cÚ¡ 
	gCl›Á
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
ş›Á_
->options(); }

312 
	g´iv©e
:

313 
Cl›Á
::
Im¶
* 
ş›Á_
;

314 
Tim”Ev’t
 
	gtim”_
;

316 
	g¡d
::
¡ršg
 
ho¡_
;

317 
ušt16_t
 
	gpÜt_
;

318 
boŞ
 
	gÃed_»sŞve_
;

319 
	gcÚÃù_çu»_
;

320 
boŞ
 
	gcÚÃù_d–ay_
;

321 
evdns_g‘addršfo_»que¡
 *
	gdns_»q_
;

322 
DnsCtx
 *
	gdns_ùx_
;

324 #ifdeà
RES_COUNTER


325 
	g´iv©e
:

326 
ä›nd
 
şass
 
St
;

327 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

328 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

329 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

330 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/client_impl.h

4 #iâdeà
LDD_NET_INTERNAL_CLIENT_IMPL_H_


5 
	#LDD_NET_INTERNAL_CLIENT_IMPL_H_


	)

7 
	~"ldd/Ãt/ş›Á.h
"

9 
Çme¥aû
 
	gldd
 {

10 
Çme¥aû
 
	gÃt
 {

12 şas 
	cCl›Á
::
Im¶
 {

13 
public
:

14 
Im¶
(
Cl›Á
* 
ş›Á
, cÚ¡ Cl›Á::
O±iÚs
& 
İtiÚs
);

16 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

17 cÚ¡ 
¡d
::
¡ršg
& 
ho¡
, 
ušt16_t
 
pÜt
);

18 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
C»©e
(
Ev’tLoİ
* 
ev’t_loİ
,

19 cÚ¡ 
Endpošt
& 
»mÙe
);

21 
Cl›Á
* 
owÃr
(ècÚ¡ {  
	gş›Á_
; }

22 cÚ¡ 
	gCl›Á
::
O±iÚs
& 
İtiÚs
(ècÚ¡ {  
İtiÚs_
; }

24 
	g´iv©e
:

25 
Cl›Á
* 
ş›Á_
;

26 
	gCl›Á
::
O±iÚs
 
İtiÚs_
;

28 #ifdeà
RES_COUNTER


29 
	g´iv©e
:

31 
ä›nd
 
şass
 
St
;

32 
ä›nd
 
şass
 
	gOutgošgChªÃl
;

33 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

34 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

35 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

36 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/event_impl.h

4 #iâdeà
LDD_NET_INTERNAL_EVENT_IMPL_H_


5 
	#LDD_NET_INTERNAL_EVENT_IMPL_H_


	)

7 
	~<ev’t2/ev’t.h
>

9 
	~<£t
>

10 
	~<m­
>

12 
	~<boo¡/sh¬ed_±r.hµ
>

13 
	~<boo¡/w—k_±r.hµ
>

14 
	~"ldd/Ãt/ev’t.h
"

15 
	~"ev’t_loİ_im¶.h
"

17 
Çme¥aû
 
	gldd
 {

18 
Çme¥aû
 
	gÃt
 {

20 şas 
	cFdEv’t
::
Im¶
 {

21 cÚ¡ 
kTimedOut
 = 4;

22 
	gpublic
:

23 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

24 ~
Im¶
();

27 
	gkNoTime
 = 0,

28 
	gkTimeDiff
,

29 
	gkTime¡amp


32 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
);

33 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

34 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

35 
AsyncWa™
(
fd
, 
ev’ts
, cÚ¡ 
FunùÜ
& 
hªdËr
,

36 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

37 
Cªûl
();

39 
	g´Ùeùed
:

40 
S¹
(
fd
, 
ev’ts
);

41 
NÙify
(
fd
, 
wh©
, *
¬g
);

43 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

45 
ev’t
 *
	gev_
;

47 
	gldd
::
ut
::
TimeDiff
 
time_diff_
;

48 
	gldd
::
ut
::
Time¡amp
 
time_¡amp_
;

50 
	gtime_æag_
;

52 
FunùÜ
 
	ghªdËr_
;

53 
št8_t
 
	gæags_
;

54 
boŞ
 
	gaùive_
;

56 #ifdeà
RES_COUNTER


57 
	g´iv©e
:

58 
ä›nd
 
şass
 
St
;

59 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

60 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

61 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

62 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

66 şas 
	cTim”Ev’t
::
Im¶
 {

67 
public
:

68 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

69 ~
Im¶
();

72 
	gkNoTime
 = 0,

73 
	gkTimeDiff
,

74 
	gkTime¡amp


77 
boŞ
 
ExpœesAt
(
ldd
::
ut
::
Time¡amp
* 
time
);

78 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

79 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

80 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

81 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

82 
Cªûl
();

84 
	g´iv©e
:

85 
S¹
();

86 
OnTim”
(
fd
, 
wh©
, *
¬g
);

88 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

90 
ev’t
 *
	gtim”_ev_
;

91 
	gldd
::
ut
::
TimeDiff
 
time_diff_
;

92 
	gldd
::
ut
::
Time¡amp
 
time_¡amp_
;

93 
	gtime_æag_
;

95 
	gldd
::
ut
::
Time¡amp
 
¡¬t_¡amp_
;

97 
FunùÜ
 
	ghªdËr_
;

98 
boŞ
 
	gaùive_
;

100 #ifdeà
RES_COUNTER


101 
	g´iv©e
:

102 
ä›nd
 
şass
 
St
;

103 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

104 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

105 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

106 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

110 şas 
	cSigÇlEv’t
::
Im¶
 {

111 
public
:

112 
Im¶
(
Ev’tLoİ
::Im¶* 
loİ
);

113 ~
Im¶
();

115 
boŞ
 
Add
(
signo
);

116 
boŞ
 
Remove
(
signo
);

117 
boŞ
 
CË¬
();

119 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
);

120 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

121 cÚ¡ 
ldd
::
ut
::
Time¡amp
& 
timeout
);

122 
AsyncWa™
(cÚ¡ 
FunùÜ
& 
hªdËr
,

123 cÚ¡ 
ldd
::
ut
::
TimeDiff
& 
timeout
);

124 
Cªûl
();

126 
	g´iv©e
:

127 
OnSigÇl
(
fd
, 
wh©
, *
¬g
);

128 
OnTim”
(
fd
, 
wh©
, *
¬g
);

130 
	gEv’tLoİ
::
Im¶
* 
loİ_
;

131 
ev’t
 *
	gtim”_ev_
;

132 
	g¡d
::
m­
<, 
	gev’t
 *> 
	gsig_ev_
;

134 
FunùÜ
 
	ghªdËr_
;

136 #ifdeà
RES_COUNTER


137 
	g´iv©e
:

138 
ä›nd
 
şass
 
St
;

139 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

140 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

141 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

142 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/event_loop_impl.h

4 #iâdeà
LDD_NET_INTERNAL_EVENT_LOOP_IMPL_H_


5 
	#LDD_NET_INTERNAL_EVENT_LOOP_IMPL_H_


	)

7 
	~<±h»ad.h
>

8 
	~<ev’t2/ev’t.h
>

9 
	~"ldd/Ãt/ev’t_loİ.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cEv’tLoİ
::
Im¶
 {

15 
public
:

16 
Im¶
();

17 
ex¶ic™
 
Im¶
(::
ev’t_ba£
 *
ba£
);

18 ~
Im¶
();

20 
Run
();

21 
Stİ
();

22 
Aá”FÜk
();

23 
RunInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

24 
QueueInLoİ
(cÚ¡ 
FunùÜ
& 
hªdËr
);

26 
ev’t_ba£
 *ev’t_ba£(è{  
	gev’t_ba£_
; }

28 
	g´iv©e
:

29 
Po¡
(cÚ¡ 
FunùÜ
& 
funùÜ
);

30 
PeNÙify
(
fd
, 
wh©
, *
¬g
);

31 
R—lStİ
();

32 
In™
();

34 
	g´iv©e
:

35 
ev’t_ba£
 *
ev’t_ba£_
;

37 
	gfd_
[2];

38 &
	g»ad_fd_
;

39 &
	gwr™e_fd_
;

40 
ev’t
 *
	g»ad_ev_
;

42 
±h»ad_t
 
	gtid_
;

44 #ifdeà
RES_COUNTER


45 
	g´iv©e
:

46 
ä›nd
 
şass
 
St
;

47 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

48 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

49 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

50 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/incoming_msg_impl.h

4 #iâdeà
LDD_NET_INTERNAL_INCOMING_MSG_IMPL_H_


5 
	#LDD_NET_INTERNAL_INCOMING_MSG_IMPL_H_


	)

7 
	~"ldd/Ãt/šcomšg_msg.h
"

8 
	~"ldd/ut/©omic.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 
şass
 
	gChªÃl
;

14 
şass
 
	gOutgošgRe¥Ú£
;

16 şas 
	cIncomšgMsg
::
Im¶
 {

17 
public
:

18 
ldd
::
	tÃt
::
	tPaylßd
 Payload;

19 
	gldd
::
	tÃt
::
	tCode
 Code;

20 
	gldd
::
	tÃt
::
	tMes§geId
 
	tId
;

21 
	gldd
::
	tÃt
::
	tMes§geTy³
 
	tTy³
;

23 
Im¶
(
IncomšgMsg
* 
m
)

24 : 
owÃr_
(
m
), 
id_
(-1), 
ÿnûËd_
(
çl£
),

25 
wa™šg_
(
çl£
),

26 
»¥Ú£_
(
NULL
)

28 #ifdeà
RES_COUNTER


29 
	gÃxt_id_
++;

33 
	gvœtu®
 ~
Im¶
();

35 
	gboo¡
::
sh¬ed_±r
<
IncomšgMsg
> 
owÃr
() const {

36  
owÃr_
->
sh¬ed_äom_this
();

38 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
(ècÚ¡ {  
chªÃl_
; }

39 
Id
 
id
(ècÚ¡ {  
	gid_
; }

40 
boŞ
 
IsCªûËd
(ècÚ¡ {  
	gÿnûËd_
; }

42 
In™
(
Id
 
id
, cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

43 
NÙify
(
boŞ
 
dÚe
);

45 
OnReque¡
(cÚ¡ 
Paylßd
& 
·ylßd
);

46 
DoEm™
();

47 
DoDÚe
();

48 
DoCªûl
();

49 
	g´iv©e
:

50 
Wr™eRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
);

51 
Wr™eDÚe
(
Code
 
code
);

53 
	g´iv©e
:

54 
IncomšgMsg
* 
owÃr_
;

55 
Id
 
	gid_
;

56 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl_
;

57 
boŞ
 
	gÿnûËd_
;

58 
boŞ
 
	gwa™šg_
;

59 
OutgošgRe¥Ú£
* 
	g»¥Ú£_
;

62 #ifdeà
RES_COUNTER


63 
	g´iv©e
:

64 
ä›nd
 
şass
 
St
;

65 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

66 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

67 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

68 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/listener_impl.h

4 #iâdeà
LDD_NET_INTERNAL_LISTENER_IMPL_H_


5 
	#LDD_NET_INTERNAL_LISTENER_IMPL_H_


	)

7 
	~"ldd/Ãt/’dpošt.h
"

8 
	~"ldd/Ãt/li¡’”.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 şas 
	cLi¡’”
::
Im¶
 {

14 
public
:

15 
Im¶
(
Ev’tLoİ
* 
ev’t_loİ
);

16 ~
Im¶
();

18 
boŞ
 
O³n
(cÚ¡ 
Endpošt
& 
’dpošt
);

19 
Clo£
();

21 
boŞ
 
IsO³n
(ècÚ¡ {  
	gfd_
 >= 0; }

22 
Ev’tLoİ
* 
ev’t_loİ
(ècÚ¡ {  
	gev’t_loİ_
; }

23 
fd
(ècÚ¡ {  
	gfd_
; }

24 
	g´iv©e
:

25 
Ev’tLoİ
* 
ev’t_loİ_
;

26 
	gfd_
;

	@internal/outgoing_msg_impl.h

4 #iâdeà
LDD_NET_INTERNAL_OUTGOING_MSG_IMPL_H_


5 
	#LDD_NET_INTERNAL_OUTGOING_MSG_IMPL_H_


	)

7 
	~<boo¡/sh¬ed_±r.hµ
>

8 
	~<boo¡/scİed_±r.hµ
>

9 
	~"ldd/Ãt/ev’t.h
"

10 
	~"ldd/Ãt/outgošg_msg.h
"

11 
	~"chªÃl_im¶.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

16 
şass
 
	gOutgošgReque¡
;

17 
şass
 
	gChªÃl
;

19 şas 
	cOutgošgMsg
::
Im¶
 {

20 cÚ¡ 
kDeçuÉS’dTimeout
 = 5;

21 cÚ¡ 
	gkDeçuÉRecvTimeout
 = 200;

22 cÚ¡ 
	gkDeçuÉNextTimeout
 = 100;

23 cÚ¡ 
	gkDeçuÉDÚeTimeout
 = 300;

24 
	gpublic
:

25 
Im¶
(
OutgošgMsg
* 
owÃr
)

26 : 
owÃr_
(
owÃr
), 
id_
(-1), 
»que¡_
(
NULL
), 
dÚe_
(
çl£
), 
š™_
(false)

28 #ifdeà
RES_COUNTER


29 
	gÃxt_id_
++;

33 ~
Im¶
() {

34 #ifdeà
RES_COUNTER


35 
	gä“_id_
++;

40 
	gboo¡
::
sh¬ed_±r
<
OutgošgMsg
> 
owÃr
() const {

41  
owÃr_
->
sh¬ed_äom_this
();

44 
Id
 
id
(ècÚ¡ {  
	gid_
; }

45 cÚ¡ 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
(ècÚ¡ {  
chªÃl_
; }

47 
In™
(
Id
 
id
, cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
,

48 cÚ¡ 
ut
::
TimeDiff
& 
£nd_timeout
);

49 
boŞ
 
OnReque¡
(
Paylßd
* 
·ylßd
);

50 
OnRe¥Ú£
(cÚ¡ 
Paylßd
& 
·ylßd
, 
boŞ
 
Ï¡
, 
Code
 
code
);

51 
OnOk
(
Code
 
code
);

52 
OnCªûl
();

53 
OnFaed
();

54 
OnTimeout
();

56 
Cªûl
();

57 
	g´iv©e
:

58 
DoCªûl
();

59 
OnTimeout
(
Tim”Ev’t
* 
tim”
);

60 
S‘Tim”
(
Tim”Ev’t
* 
tim”
, cÚ¡ 
ut
::
TimeDiff
& 
timeout
,

61 cÚ¡ 
ut
::
TimeDiff
& 
deçuÉ_timeout
);

63 
CË¬Tim”
();

64 
CË¬Reque¡
();

65 
CËªUp
();

66 
	g´iv©e
:

67 
OutgošgMsg
* 
owÃr_
;

68 
Id
 
	gid_
;

69 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
chªÃl_
;

70 
	gboo¡
::
scİed_±r
<
Tim”Ev’t
> 
tim”1_
;

71 
	gboo¡
::
scİed_±r
<
Tim”Ev’t
> 
tim”2_
;

72 
OutgošgReque¡
* 
	g»que¡_
;

73 
boŞ
 
	gdÚe_
;

74 
boŞ
 
	gš™_
;

76 #ifdeà
RES_COUNTER


77 
	g´iv©e
:

78 
ä›nd
 
şass
 
St
;

79 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

80 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

81 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

82 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/server_impl.h

4 #iâdeà
LDD_NET_INTERNAL_SERVER_IMPL_H_


5 
	#LDD_NET_INTERNAL_SERVER_IMPL_H_


	)

7 
	~"ldd/Ãt/£rv”.h
"

8 
	~"li¡’”_im¶.h
"

9 
	~"ldd/Ãt/ev’t.h
"

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cS”v”
::
Im¶
 {

15 
public
:

16 
ex¶ic™
 
Im¶
(
S”v”
* 
£rv”
, cÚ¡ 
O±iÚs
& 
İtiÚs
);

17 ~
Im¶
();

19 
boŞ
 
S¹
(
Li¡’”
::
Im¶
* 
li¡’”
);

20 
Stİ
();

22 
S”v”
* 
owÃr
(è{  
	g£rv”_
; }

23 cÚ¡ 
	gO±iÚs
& 
İtiÚs
(è{  
	gİtiÚs_
; }

24 
	g´iv©e
:

25 
Acû±
();

26 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
NewChªÃl
();

27 
	gboo¡
::
sh¬ed_±r
<
ChªÃl
> 
NewChªÃl
(cÚ¡ 
Add»ss
& 
addr
);

29 
HªdËAcû±
();

30 
O³nChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

31 
O³nTh»adChªÃl
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
ChªÃl
>& 
chªÃl
);

33 
S”v”
* 
	g£rv”_
;

34 
O±iÚs
 
	gİtiÚs_
;

35 
	gLi¡’”
::
Im¶
* 
li¡’”_
;

36 
	gboo¡
::
scİed_±r
<
FdEv’t
> 
ev’t_
;

37 
ušt32_t
 
	gth»ad_idx_
;

39 #ifdeà
RES_COUNTER


40 
	g´iv©e
:

42 
ä›nd
 
şass
 
St
;

43 
ä›nd
 
şass
 
	gIncomšgChªÃl
;

44 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

45 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

46 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

47 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@internal/task.h

4 #iâdeà
__TASK_H__


5 
	#__TASK_H__


	)

7 
	~<boo¡/funùiÚ.hµ
>

9 
şass
 
	gBufãr
;

11 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

13 şas 
	cTask
 {

14 
	gpublic
:

15 
Task
();

16 
	gvœtu®
 ~
Task
();

18 
S‘
(cÚ¡ 
boo¡
::
sh¬ed_±r
<
Bufãr
> &
bufãr
, 
fd
);

19 
boŞ
 
IsS‘
(è{  
	gis_£t_
; }

20 
Re£t
();

21 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> &
bufãr
(è{  
bufãr_
; }

23 
sock‘
(è{  
	gfd_
; }

25 
vœtu®
 
R—d
() = 0;

26 
vœtu®
 
Wr™e
() = 0;

28 
	g´Ùeùed
:

29 
boŞ
 
is_£t_
;

30 
	gboo¡
::
sh¬ed_±r
<
Bufãr
> 
bufãr_
;

31 
	gfd_
;

33 
ušt32_t
 
	gpos_
;

35 #ifdeà
RES_COUNTER


36 
	g´iv©e
:

37 
ä›nd
 
şass
 
St
;

38 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

39 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

40 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

41 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

45 şas 
	cR—dTask
 : 
public
 
Task
 {

46 
public
:

47 
vœtu®
 
R—d
();

48 
vœtu®
 
Wr™e
();

51 şas 
	cWr™eTask
 : 
public
 
Task
 {

52 
public
:

53 
vœtu®
 
R—d
();

54 
vœtu®
 
Wr™e
();

	@payload.h

4 #iâdeà
LDD_NET_PAYLOAD_H_


5 
	#LDD_NET_PAYLOAD_H_


	)

7 
	~<¡dšt.h
>

8 
	~<m­
>

9 
	~<ldd/Ãt/bufãr.h
>

11 
Çme¥aû
 
	gldd
 {

12 
Çme¥aû
 
	gÃt
 {

14 şas 
	cPaylßd
 {

15 
	gpublic
:

16 cÚ¡ 
size_t
 
kMaxBodyL’
 = (1<<24) - 1;

17 cÚ¡ 
size_t
 
	gkMaxExŒaL’
 = (1<<8) - 1;

19 
Paylßd
();

20 
Paylßd
(cÚ¡ Paylßd &
lßd
);

23 ~
Paylßd
();

25 cÚ¡ 
	gBufãr
& 
body
(ècÚ¡ {  
	gbody_
; }

26 cÚ¡ 
	gBufãrM­
& 
exŒas
(ècÚ¡ {  
	gexŒas_
; }

28 
boŞ
 
S‘Body
(cÚ¡ 
Bufãr
& 
bufãr
);

29 
boŞ
 
S‘ExŒa
(
ušt8_t
 
id
, cÚ¡ 
Bufãr
& 
bufãr
);

30 
D–ExŒa
(
ušt8_t
 
id
);

31 
CË¬ExŒas
();

32 
	g´iv©e
:

33 
Bufãr
 
body_
;

34 
BufãrM­
 
	gexŒas_
;

36 #ifdeà
RES_COUNTER


37 
	g´iv©e
:

38 
ä›nd
 
şass
 
St
;

39 
	gut
::
Atomic
<
ušt64_t
> 
Ãxt_id_
;

40 
	gut
::
Atomic
<
ušt64_t
> 
ä“_id_
;

41 cÚ¡ 
ušt64_t
 
Ãxt_id
(è{  
	gÃxt_id_
; }

42 cÚ¡ 
ušt64_t
 
ä“_id
(è{  
	gä“_id_
; }

	@result.h

4 #iâdeà
LDD_NET_RESULT_H_


5 
	#LDD_NET_RESULT_H_


	)

7 
	~<¡ršg
>

8 
	~"ldd/Ãt/mes§ge.h
"

10 
Çme¥aû
 
	gldd
 {

11 
Çme¥aû
 
	gÃt
 {

13 şas 
	cResuÉ
 {

14 
	gpublic
:

15 
	eTy³
 { 
kOk
, 
	gkFaed
, 
	gkTimedOut
, 
	gkCªûËd
 };

16 
ResuÉ
 
Ok
(
Code
 
code
è{  ResuÉ(
kOk
, code); }

17 
ResuÉ
 
Faed
(è{  ResuÉ(
kFaed
); }

18 
ResuÉ
 
TimedOut
(è{  ResuÉ(
kTimedOut
); }

19 
ResuÉ
 
CªûËd
(è{  ResuÉ(
kCªûËd
); }

21 
boŞ
 
IsOk
(ècÚ¡ {  
	gty³_
 =ğ
kOk
; }

22 
boŞ
 
IsFaed
(ècÚ¡ {  
	gty³_
 =ğ
kFaed
; }

23 
boŞ
 
IsTimedOut
(ècÚ¡ {  
	gty³_
 =ğ
kTimedOut
; }

24 
boŞ
 
IsCªûËd
(ècÚ¡ {  
	gty³_
 =ğ
kCªûËd
; }

26 cÚ¡ 
	g¡d
::
¡ršg
& 
ToSŒšg
() const;

28 
Code
 
code
(ècÚ¡ {  
	gcode_
; }

29 
	g´iv©e
:

30 
ResuÉ
(
Ty³
 
ty³
è: 
ty³_
Ñy³), 
code_
(0) {}

31 
ResuÉ
(
Ty³
 
ty³
, 
št16_t
 
code
è: 
ty³_
Ñy³), 
code_
(code) {}

33 
Ty³
 
	gty³_
;

34 
Code
 
	gcode_
;

	@server.h

4 #iâdeà
LDD_NET_SERVER_H_


5 
	#LDD_NET_SERVER_H_


	)

7 
	~<boo¡/funùiÚ.hµ
>

8 
	~<boo¡/sh¬ed_±r.hµ
>

9 
	~<boo¡/±r_cÚš”/±r_veùÜ.hµ
>

10 
	~"ldd/Ãt/šcomšg_msg_»gi¡ry.h
"

11 
	~"ldd/Ãt/ev’t_loİ.h
"

13 
Çme¥aû
 
	gldd
 {

14 
Çme¥aû
 
	gÃt
 {

16 
şass
 
	gLi¡’”
;

18 şas 
	cS”v”
 : 
public
 
IncomšgMsgRegi¡ry
 {

19 
public
:

20 
	eTh»adDi¥©chPŞicy
 {

21 
kNÜm®
,

22 
	gkHashšg
,

24 
şass
 
	gIm¶
;

25 
	gboo¡
::
	tfunùiÚ
<(cÚ¡ 
	tboo¡
::
	tsh¬ed_±r
<
	tChªÃl
>&)> 
	tNÙif›r
;

26 
	sO±iÚs
 {

29 
	gpul£_š‹rv®
;

33 
boŞ
 
	gpul£_»Ïxed_checkšg
;

37 
boŞ
 
	gpul£_Ïzy_em™tšg
;

41 
	gb©ch_acû±
;

45 
NÙif›r
 
	gnÙify_cÚÃùed
;

49 
NÙif›r
 
	gnÙify_şo£d
;

54 
	gboo¡
::
±r_veùÜ
<
Ev’tLoİTh»ad
>* 
th»ads
;

58 
	gth»ads_di¥©chšg
;

62 
	g»ad_bufãr_size
;

63 
	gwr™e_bufãr_size
;

65 
O±iÚs
();

68 
ex¶ic™
 
S”v”
(cÚ¡ 
O±iÚs
& 
İtiÚs
);

69 ~
S”v”
();

71 
boŞ
 
S¹
(
Li¡’”
* 
li¡’”
);

72 
Stİ
();

74 cÚ¡ 
	gO±iÚs
& 
İtiÚs
() const;

75 
	g´iv©e
:

76 
Im¶
* 
im¶_
;

	@stat.h

4 #iâdeà
__STAT_H__


5 
	#__STAT_H__


	)

7 
Çme¥aû
 
	gldd
 {‚ame¥aû 
	gÃt
 {

9 şas 
	cSt
 {

10 
	gpublic
:

11 ~
St
() {}

13 
¡d
::
¡ršg
 
Stus
() const;

14 
	gSt
 &
š¡ªû
(è{  
	gš¡ªû_
; }

16 
	g´iv©e
:

17 
St
();

18 
St
 
	gš¡ªû_
;

	@
1
.
0
134
7883
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/address.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/address.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/backtrace.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/backtrace.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/buffer.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/buffer.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/channel.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/channel.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/client.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/client.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/endpoint.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/endpoint.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop_thread_pool.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/event_loop_thread_pool.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/factory.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/incoming_msg_registry.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/channel_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/channel_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/client_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/client_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_loop_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/event_loop_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_msg_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_msg_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_packet.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/incoming_packet.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/listener_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/listener_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_msg_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_msg_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_packet.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/outgoing_packet.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/protocol.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/protocol.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_checker.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_checker.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_emitter.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/pulse_emitter.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/server_impl.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/server_impl.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/task.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/internal/task.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/listener.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/listener.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/message.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/omsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/client/omsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/imsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/imsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/other/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/outgoing_msg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/outgoing_msg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/payload.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/payload.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/registry.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/result.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/result.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/sample/a.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/sample/a.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/server.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/server.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/stat.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/stat.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/omsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/client/omsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/imsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/imsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/benchmark/server/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/imsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/imsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/omsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/client/omsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/event_loop/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/imsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/imsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/omsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test/server/omsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/atomic/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/common.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/get.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/heartbeat.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/put.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/x_socket.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/client/x_socket.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/x_socket.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/concurrency_connect/x_socket.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/deadline_timer/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/event/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/file_lock/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/test1/noblocking_accept/main.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/event_loop_test.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/event_test.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/imsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/imsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/lddnet_test.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/my_lddnet.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/my_lddnet.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/omsg.cc
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/omsg.h
/home/libin3-s/qdev/CloudSrv/trunk/lddcode/net/ut/x_socket.h
address.h
backtrace.h
buffer.h
client.h
event.h
event_loop.h
incoming_msg.h
internal/channel_impl.h
internal/client_impl.h
internal/event_impl.h
internal/event_loop_impl.h
internal/incoming_msg_impl.h
internal/listener_impl.h
internal/outgoing_msg_impl.h
internal/server_impl.h
internal/task.h
payload.h
result.h
server.h
stat.h
